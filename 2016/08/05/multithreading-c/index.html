<!DOCTYPE html>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="UTF-8">

    

    

    <title>C++多线程并发-来源泰课在线 | Coderss</title>
    <meta name="author" content="coder">
    <meta name="version" content="1.0.0">
    <meta name="keywords" content="">
    <meta name="description" content="C++多线程编程相关详解笔记 
简介线程/进程
当前机器的单核红利结束
多线程拥有自身优势
API日益成熟,操作系统和标准库已经支持多线程

总结来说:要在数据IO和计算找平衡点
123新建process进程单元  linux通过fork和execvewindows则通过createProcess
对于进程有signal信号,对于线程不支持这个东西
早期操作系统对多线程支持并不是很好,93年对UNIX和Linux的thread概念提出,posix Threads的标准也确立起来
多线程的特点:是">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <meta name="baidu-site-verification" content="F0CXvmUgA9">

    
    
    <link rel="icon" href="/favicon.png">
    

    <link rel="stylesheet" href="/css/style.css">
</head>
<body>

    <div class="app">
        <header class="header clearfix">
    <div id="nav" class="nav">
    <button id="open-panel" class="open-panel"><i class="icon-library"></i></button>

    <nav class="nav-inner">

        
        
        <li class="nav-item">
            <a class="nav-link" href="/">首页</a>
        </li>
        
        
        
        <li class="nav-item">
            <a class="nav-link" href="/categories/back-end">Java栈</a>
        </li>
        
        
        
        <li class="nav-item">
            <a class="nav-link" href="/categories/cpp">C/C++</a>
        </li>
        
        
        
        <li class="nav-item">
            <a class="nav-link" href="/categories/go">Golang</a>
        </li>
        
        
        
        <li class="nav-item">
            <a class="nav-link" href="/categories/cloud">System</a>
        </li>
        
        
        
        <li class="nav-item">
            <a class="nav-link" href="/categories/reverse">Reverse</a>
        </li>
        
        
        
        <li class="nav-item">
            <a class="nav-link" href="/categories/data">BigData</a>
        </li>
        
        
        
        <li class="nav-item">
            <a class="nav-link" href="/categories/ai">Math/AI</a>
        </li>
        
        
        
        <li class="nav-item nav-item-tag">
            <a id="nav-tag" class="nav-link" href="#">标签</a>
            <div id="nav-tags" class="nav-tag-wrap">
                <i class="nav-tag-arrow"></i>
                
  <div class="widget-wrap">
    <h3 class="widget-title">
        <i class="icon-tag vm"></i>
        <span class="vm">Tags</span>
    </h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/AI/">AI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Boost库/">Boost库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Collection/">Collection</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cpp编程/">Cpp编程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Fescar/">Fescar</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Gc/">Gc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/K8s/">K8s</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MapReduce/">MapReduce</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Math/">Math</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python计算库/">Python计算库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Sharding-jdbc/">Sharding-jdbc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SkyWalking/">SkyWalking</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spark/">Spark</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TensorFlow/">TensorFlow</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Turi/">Turi</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Windows系统/">Windows系统</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Windows驱动/">Windows驱动</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Yarn/">Yarn</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/assembly/">assembly</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/c-cpp语言/">c/cpp语言</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/debug/">debug</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/design/">design</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dubbo/">dubbo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/eth/">eth</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/flume/">flume</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go/">go</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go-kernel/">go-kernel</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/io/">io</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/">java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/juc/">juc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kubernetes/">kubernetes</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/map/">map</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mfc/">mfc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/microservice/">microservice</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mybatis/">mybatis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/netty/">netty</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python-book/">python-book</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/qt/">qt</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sentinel/">sentinel</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/skycoin/">skycoin</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spring/">spring</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spring-cloud/">spring-cloud</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/stl/">stl</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tomcat/">tomcat</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/x86-Windows系统总结/">x86 Windows系统总结</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/中台/">中台</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/内网穿透/">内网穿透</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/分布式文件系统/">分布式文件系统</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/多线程编程/">多线程编程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/架构/">架构</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/消息队列/">消息队列</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/网络编程/">网络编程</a></li></ul>
    </div>
  </div>


            </div>
        </li>
        
        
        
        <li class="nav-item">
            <a class="nav-link" href="/archives">归档</a>
        </li>
        
        
        

    </nav>
</div>

    <aside id="aside" class="aside">
    <div id="aside-mask" class="aside-mask"></div>
    <div id="aside-inner" class="aside-inner">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit"><i class="icon-search-stroke"></i></button><input type="hidden" name="sitesearch" value="http://www.coderss.cn"></form>

        
        
        
        
        

        
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#简介"><span class="toc-number">1.</span> <span class="toc-text">简介</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#线程-进程"><span class="toc-number">1.1.</span> <span class="toc-text">线程/进程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#平衡点"><span class="toc-number">1.2.</span> <span class="toc-text">平衡点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#问题"><span class="toc-number">1.3.</span> <span class="toc-text">问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#新概念"><span class="toc-number">1.4.</span> <span class="toc-text">新概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#示例"><span class="toc-number">1.5.</span> <span class="toc-text">示例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#取threadid"><span class="toc-number">1.6.</span> <span class="toc-text">取threadid</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sleep"><span class="toc-number">1.7.</span> <span class="toc-text">sleep</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#资源共享问题"><span class="toc-number">2.</span> <span class="toc-text">资源共享问题</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#多线程重要原则"><span class="toc-number">2.1.</span> <span class="toc-text">多线程重要原则</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#构造问题"><span class="toc-number">3.</span> <span class="toc-text">构造问题</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#示例-1"><span class="toc-number">3.1.</span> <span class="toc-text">示例</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#原子操作问题"><span class="toc-number">4.</span> <span class="toc-text">原子操作问题</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#mutex问题"><span class="toc-number">5.</span> <span class="toc-text">mutex问题</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#误用点"><span class="toc-number">5.1.</span> <span class="toc-text">误用点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#正确使用"><span class="toc-number">5.2.</span> <span class="toc-text">正确使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#lock-guard"><span class="toc-number">5.3.</span> <span class="toc-text">lock_guard</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#thread交互问题"><span class="toc-number">6.</span> <span class="toc-text">thread交互问题</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#join-deatch"><span class="toc-number">6.1.</span> <span class="toc-text">join/deatch</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#信号"><span class="toc-number">6.2.</span> <span class="toc-text">信号</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#yield"><span class="toc-number">6.2.1.</span> <span class="toc-text">yield</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#消息"><span class="toc-number">6.3.</span> <span class="toc-text">消息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#condition-variable"><span class="toc-number">6.4.</span> <span class="toc-text">condition_variable</span></a></li></ol></li></ol>
        
    </div>
</aside>

</header>

        <div id="content" class="content"><article class="article" itemscope="" itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            C++多线程并发-来源泰课在线
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="/2016/08/05/multithreading-c/">
    
    <i class="icon-calendar"></i>
    
    <time datetime="2016-08-05T01:28:27.000Z" itemprop="datePublished">2016-08-05</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag"></i>
    <a class="article-tag-link" href="/tags/多线程编程/">多线程编程</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <p>C++多线程编程相关详解笔记<br><a id="more"></a> </p>
<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><h2 id="线程-进程"><a href="#线程-进程" class="headerlink" title="线程/进程"></a>线程/进程</h2><ul>
<li>当前机器的单核红利结束</li>
<li>多线程拥有自身优势</li>
<li>API日益成熟,操作系统和标准库已经支持多线程</li>
</ul>
<p>总结来说:要在数据IO和计算找平衡点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">新建process进程单元  </span><br><span class="line">linux通过fork和execve</span><br><span class="line">windows则通过createProcess</span><br></pre></td></tr></table></figure>
<p>对于进程有<code>signal</code>信号,对于线程不支持这个东西</p>
<p>早期操作系统对多线程支持并不是很好,93年对UNIX和Linux的thread概念提出,<code>posix Threads</code>的标准也确立起来</p>
<p>多线程的特点:是对于内存空间都是共享的</p>
<p>这样很高效的共享数据,在多线程也能充分利用多核的</p>
<p>而且操作系统和标准库都支持多线程编程,<code>Posix Thread</code></p>
<p>所以用c++都可以用一套标准代码写多线程跑windows和linux</p>
<h2 id="平衡点"><a href="#平衡点" class="headerlink" title="平衡点"></a>平衡点</h2><blockquote>
<p>数据IO和计算</p>
</blockquote>
<p>http的服务如果发生网络瓶颈点一般都会出现在数据io上</p>
<p>而一些数据计算都是在计算瓶颈上</p>
<p>计算服务并不是一味的多线程好</p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><ul>
<li><p>死锁</p>
<p>虽然死锁很烦,但是死锁很容易察觉到问题,不像并发访问数据很难发现问题</p>
</li>
<li><p>乱序</p>
</li>
<li><p>并发访问数据造成的问题</p>
<p>因并发访问,数据错乱,把其他线程资源释放和重复释放</p>
</li>
<li><p>低效率</p>
<p>在多线程切换的时候效率也会低,有些工作还不如单线程工作</p>
</li>
</ul>
<h2 id="新概念"><a href="#新概念" class="headerlink" title="新概念"></a>新概念</h2><ul>
<li>高阶接口: (async,future)</li>
<li>低阶接口:(thread, mutex)</li>
</ul>
<h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">helloworld</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"hello world\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">//开启一个线程</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="function">thread <span class="title">t</span><span class="params">(helloworld)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//线程中介</span></span><br><span class="line">    t.join();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cmath&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">calculate</span><span class="params">(<span class="keyword">double</span> v)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> v * v;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> Iter, <span class="keyword">typename</span> Fun&gt;</span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">visitRange</span><span class="params">(Iter iterBegin,Iter IterEnd,Fun fun)</span></span>&#123;</span><br><span class="line">    <span class="keyword">double</span> v = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> iter = iterBegin; iter != IterEnd; iter ++)&#123;</span><br><span class="line">        v += fun(*iter);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> v;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">double</span>&gt; v;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; ++i) &#123;</span><br><span class="line">        v.push_back(i);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"size:"</span> &lt;&lt; v.size() &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">double</span> value = <span class="number">0.0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; info: v) &#123;</span><br><span class="line">        value += calculate(info);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"value:"</span> &lt;&lt; value &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="comment">//以上单线程进行了计算</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果多线程进行计算</span></span><br><span class="line">    <span class="comment">//两个线程都遍历一半的数据进行工作</span></span><br><span class="line">    <span class="keyword">auto</span> iter = v.begin() + (v.size() / <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">auto</span> iterEnd = v.end();</span><br><span class="line">    <span class="comment">//计算前半段</span></span><br><span class="line">    <span class="keyword">double</span> anotherV = <span class="number">0.0</span>;</span><br><span class="line">    <span class="comment">//std::function</span></span><br><span class="line">    std::thread s([&amp;anotherV, iter, iterEnd]()-&gt;double&#123;</span><br><span class="line">        anotherV = visitRange(iter, iterEnd, calculate);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//计算后半段</span></span><br><span class="line">    <span class="keyword">auto</span> halfV = visitRange(v.begin(), iter, calculate);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//清理工作</span></span><br><span class="line">    s.join();</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"halfV:"</span> &lt;&lt; (halfV + anotherV) &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="取threadid"><a href="#取threadid" class="headerlink" title="取threadid"></a>取threadid</h2><p>程序运行中,一部分代码在主线程,一部分在额外线程跑的</p>
<p>有<code>std::this_thread::get_id()</code>得到了线程的<code>threadid</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt;  <span class="string">"thread id:"</span> &lt;&lt; (<span class="built_in">std</span>::this_thread::get_id()) &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br></pre></td></tr></table></figure>
<h2 id="sleep"><a href="#sleep" class="headerlink" title="sleep"></a>sleep</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;chrono&gt; //处理时间头</span></span></span><br><span class="line"><span class="built_in">std</span>::this_thread::sleep_for(<span class="built_in">std</span>::chrono::milliseconds(<span class="number">100</span>));<span class="comment">//暂停多少时间 100毫秒</span></span><br></pre></td></tr></table></figure>
<h1 id="资源共享问题"><a href="#资源共享问题" class="headerlink" title="资源共享问题"></a>资源共享问题</h1><p>同一个值放给3个thread去算</p>
<p>算出来的汇合值有严重问题</p>
<p>那如何给每个线程一个值,最终结合将各个结果值相加,说白了避免了资源的共享</p>
<h2 id="多线程重要原则"><a href="#多线程重要原则" class="headerlink" title="多线程重要原则"></a>多线程重要原则</h2><ul>
<li>如果没有必要的话,线程间不要共享资源,出错的可能性最低</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">printAll</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b, <span class="keyword">int</span> c)</span></span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"a:"</span> &lt;&lt; a &lt;&lt; <span class="string">",b:"</span> &lt;&lt; b &lt;&lt; <span class="string">",c:"</span> &lt;&lt; c &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b, <span class="keyword">int</span>&amp; c)</span></span>&#123;</span><br><span class="line">    c = a+b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">testThreadInit</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> a=<span class="number">3</span>;</span><br><span class="line">    <span class="keyword">int</span> b=<span class="number">4</span>;</span><br><span class="line">    <span class="keyword">int</span> c=<span class="number">5</span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="function">thread <span class="title">t</span><span class="params">([=]()</span></span>&#123;printAll(a, b, c);&#125;);</span><br><span class="line">    t.join();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//效率更高一点</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="function">thread <span class="title">t1</span><span class="params">(printAll, a, b, c)</span></span>;</span><br><span class="line">    t1.join();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//但是第二种可能会出错,第一个函数,后面的参数都是函数参数,后面参数都是值拷贝</span></span><br><span class="line">    <span class="comment">//printAll没有影响但是如下情况</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="function">thread <span class="title">t2</span><span class="params">(add ,a ,b, c)</span></span>;</span><br><span class="line">    t2.join();</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"after add:"</span> &lt;&lt; c &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>; <span class="comment">// 直接抛错</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="function">thread <span class="title">t3</span><span class="params">([=, &amp;c]()</span></span>&#123;</span><br><span class="line">        add(a, b, c);</span><br><span class="line">    &#125;);</span><br><span class="line">    t3.join();</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"after add:"</span> &lt;&lt; c &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>; <span class="comment">//7</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    testThreadInit();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当然如果这样写也可以执行</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">std::thread t2(add ,a ,b, std::ref(c));</span><br></pre></td></tr></table></figure>
<p>在上面的情况下还是推荐用lambda的方式去执行</p>
<p>比如如下情况</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">printString</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; info, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; info2)</span></span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"info:"</span> &lt;&lt; info &lt;&lt; <span class="string">",info2:"</span> &lt;&lt; info2 &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">std</span>::<span class="function"><span class="built_in">string</span> <span class="title">s1</span><span class="params">(<span class="string">"hello"</span>)</span></span>;</span><br><span class="line"><span class="built_in">std</span>::<span class="function"><span class="built_in">string</span> <span class="title">s2</span><span class="params">(<span class="string">"hello2"</span>)</span></span>;</span><br><span class="line">std::thread t4(printString, std::ref(s1), std::ref(s2));</span><br><span class="line"><span class="built_in">std</span>::<span class="function">thread <span class="title">t5</span><span class="params">([&amp;]()</span></span>&#123;</span><br><span class="line">	printString(s1, s2);</span><br><span class="line">&#125;);</span><br><span class="line">t4.join();</span><br><span class="line">t5.join();</span><br></pre></td></tr></table></figure>
<p>这样省略很多</p>
<h1 id="构造问题"><a href="#构造问题" class="headerlink" title="构造问题"></a>构造问题</h1><h2 id="示例-1"><a href="#示例-1" class="headerlink" title="示例"></a>示例</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Log</span>&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    Log(<span class="keyword">int</span> id, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; fileName):m_id(id)&#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"create id:"</span> &lt;&lt; id &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">        m_f.open(filename.c_str(), <span class="built_in">std</span>::fstream::out);</span><br><span class="line">    &#125;</span><br><span class="line">    ~Log()&#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"bye id:"</span> &lt;&lt; m_id &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    	m_f.close();	</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">log</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; info)</span></span>&#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; info;</span><br><span class="line">		m_f &lt;&lt; info;</span><br><span class="line">        m_f.flush();<span class="comment">//不flush的话,必须等buffer满或者close才刷到磁盘</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">int</span> m_id;</span><br><span class="line">    <span class="built_in">std</span>::fstream m_f;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> Log <span class="title">log</span><span class="params">(<span class="number">1</span>, <span class="string">"log.log"</span>)</span></span>;</span><br><span class="line">    <span class="built_in">log</span>.<span class="built_in">log</span>(<span class="string">"hello"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> Log <span class="title">log</span><span class="params">(<span class="number">2</span>, <span class="string">"log.log"</span>)</span></span>;</span><br><span class="line">    <span class="built_in">log</span>.<span class="built_in">log</span>(<span class="string">"world"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    test();</span><br><span class="line">    test2();<span class="comment">//当两个文件时一样的情况下,log输出会是怎样</span></span><br><span class="line">    <span class="comment">//answer</span></span><br><span class="line">    <span class="comment">//1:hello</span></span><br><span class="line">    <span class="comment">//2:world</span></span><br><span class="line">    <span class="comment">//3:hello world</span></span><br><span class="line">    <span class="comment">//4:world hello</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt;<span class="string">"bye main"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="comment">//create id:1</span></span><br><span class="line">    <span class="comment">//create id:2</span></span><br><span class="line">    <span class="comment">//bye main</span></span><br><span class="line">    <span class="comment">//bye id:2</span></span><br><span class="line">    <span class="comment">//bye id:1</span></span><br><span class="line">    <span class="comment">//符合static的特点</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>写入文件的是答案是2,<code>world</code></p>
<p>如果static是在外部,作为单例的存在就没有问题</p>
<p>这跟操作系统有关,以<code>linux</code>为例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">当fstream会打开一个文件</span><br><span class="line"></span><br><span class="line">得到文件的指针头,指向文件内容,并将内容写入,内核会刷到磁盘</span><br><span class="line"></span><br><span class="line">当第二次log起来又会去一次打开文件,但是文件的指针头还是原来的起点于是就覆盖了,因为文件指针头是一样的</span><br></pre></td></tr></table></figure>
<blockquote>
<p> <code>m_f.flush()</code></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">写不写也重要,写了就是world不写就是hello,因为flush要等buffer满才会刷入,或者close</span><br><span class="line">如果没加flush,就会在析构的时候进行写入</span><br><span class="line">而这个时候hello的函数栈是后进先出,所以hello是最后写入形成了hello而不是world</span><br></pre></td></tr></table></figure>
<h1 id="原子操作问题"><a href="#原子操作问题" class="headerlink" title="原子操作问题"></a>原子操作问题</h1><p>多线程下对共享资源的操作</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Counter</span>&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">addCount</span><span class="params">()</span></span>&#123;</span><br><span class="line">        m_count++; <span class="comment">//写入寄存器, 寄存器加1, 再写入内存</span></span><br><span class="line">        <span class="comment">//如果保证加的时候线程不切换</span></span><br><span class="line">        <span class="comment">//切换线程的时候保证之前的count++操作已经ok</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">count</span><span class="params">()</span> <span class="keyword">const</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> m_count;</span><br><span class="line">    &#125;</span><br><span class="line">    Counter():m_count(<span class="number">0</span>)&#123;&#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">int</span> m_count;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>保证共享资源的操作必须在一个线程内操作并且操作完成才切换线程</p>
<p>原子操作就如上要求</p>
<blockquote>
<p>最小不可再分割的操作</p>
</blockquote>
<p>用Atomic包装后:写入寄存器, 寄存器加1, 再写入内存这三步就做成一步且不可分割</p>
<p>Java最先实现了Atomic,C++11引入</p>
<p>c++11又做了很多扩展,读写以及比较级造成的接口复杂,简单还是和Java差不多</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;atomic&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Counter</span>&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">addCount</span><span class="params">()</span></span>&#123;</span><br><span class="line">        m_count++; <span class="comment">//写入寄存器, 寄存器加1, 再写入内存</span></span><br><span class="line">        <span class="comment">//如果保证加的时候线程不切换</span></span><br><span class="line">        <span class="comment">//切换线程的时候保证之前的count++操作已经ok</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">count</span><span class="params">()</span> <span class="keyword">const</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> m_count;</span><br><span class="line">    &#125;</span><br><span class="line">    Counter():m_count(<span class="number">0</span>)&#123;&#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="built_in">std</span>::atomic&lt;<span class="keyword">int</span>&gt; m_count;</span><br><span class="line"><span class="comment">//    std::atomic_int m_count;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">todo</span><span class="params">(Counter&amp; counter)</span></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; ++i) &#123;</span><br><span class="line">        counter.addCount();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Counter counter;</span><br><span class="line">    <span class="built_in">std</span>::<span class="function">thread <span class="title">t1</span><span class="params">([&amp;counter]()</span></span>&#123;</span><br><span class="line">        todo(counter);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="built_in">std</span>::<span class="function">thread <span class="title">t2</span><span class="params">([&amp;counter]()</span></span>&#123;</span><br><span class="line">        todo(counter);</span><br><span class="line">    &#125;);</span><br><span class="line">    t1.join();</span><br><span class="line">    t2.join();</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; counter.count() &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>复杂的情况,内置函数</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//atomic </span></span><br><span class="line"><span class="comment">// ++ -- + - * / 默认重载了操作符</span></span><br><span class="line"><span class="comment">//expert fetch_add fetch_</span></span><br><span class="line"></span><br><span class="line">m_count.fetch_add(<span class="number">1</span>);<span class="comment">//也可以加1</span></span><br></pre></td></tr></table></figure>
<h1 id="mutex问题"><a href="#mutex问题" class="headerlink" title="mutex问题"></a>mutex问题</h1><p>原子操作两个不同的变量进行操作</p>
<p>那这两个不同的变量就分割操作,并不是原子性</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;atomic&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Counter</span>&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">count</span><span class="params">()</span> <span class="keyword">const</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> m_count;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">lockMutex</span><span class="params">()</span></span>&#123;</span><br><span class="line">        m_mutex.lock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">unlockMutex</span><span class="params">()</span></span>&#123;</span><br><span class="line">        m_mutex.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    Counter():m_totalResource(<span class="number">0</span>),m_count(<span class="number">0</span>)&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">addCount</span><span class="params">()</span></span>&#123;</span><br><span class="line">        m_count++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">addTotalResource</span><span class="params">()</span></span>&#123;</span><br><span class="line">        m_totalResource++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">totalResource</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> m_totalResource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="built_in">std</span>::mutex m_mutex;</span><br><span class="line">    <span class="built_in">std</span>::atomic&lt;<span class="keyword">int</span>&gt; m_count;</span><br><span class="line">    <span class="built_in">std</span>::atomic&lt;<span class="keyword">int</span>&gt; m_totalResource;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">Iter</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">void</span> <span class="title">readWork</span>(<span class="title">Counter</span> &amp;<span class="title">c</span>, <span class="title">double</span> &amp;<span class="title">totalValue</span>, <span class="title">Iter</span> <span class="title">b</span>, <span class="title">Iter</span> <span class="title">e</span>)&#123;</span></span><br><span class="line">    <span class="keyword">for</span> (; b != e; ++b) &#123;</span><br><span class="line">        c.lockMutex();</span><br><span class="line">        c.addCount();</span><br><span class="line">        c.addTotalResource();</span><br><span class="line">        c.unlockMutex();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="误用点"><a href="#误用点" class="headerlink" title="误用点"></a>误用点</h2><p>小心出现死锁</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (; b != e; ++b) &#123;</span><br><span class="line">    c.lockMutex();</span><br><span class="line">    c.addCount();</span><br><span class="line">    c.addTotalResource();</span><br><span class="line">    <span class="comment">//c.unlockMutex(); //忘记了unlock</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (; b != e; ++b) &#123;</span><br><span class="line">    c.lockMutex();</span><br><span class="line">    c.lockMutex();<span class="comment">// 不支持重入,没有自持锁计数,也锁死</span></span><br><span class="line">    c.addCount();</span><br><span class="line">    c.addTotalResource();</span><br><span class="line">    c.unlockMutex();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">debugPrintInfo</span><span class="params">(Counter &amp;c)</span></span>&#123;</span><br><span class="line">    c.lockMutex();</span><br><span class="line">    c.unlockMutex();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (; b != e; ++b) &#123;</span><br><span class="line">    c.lockMutex();</span><br><span class="line">    debugPrintInfo(c);<span class="comment">// 不支持重入,没有自持锁计数,也锁死</span></span><br><span class="line">    c.addCount();</span><br><span class="line">    c.addTotalResource();</span><br><span class="line">    c.unlockMutex();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//抛异常案例</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">doSomeThing</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(rand()% <span class="number">10</span> == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="string">"bad"</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"lucky\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">    c.lockMutex();</span><br><span class="line">	doSomeThing(); <span class="comment">//异常抛出</span></span><br><span class="line">    c.unlockMutex();</span><br><span class="line">&#125;<span class="keyword">catch</span>(...)&#123;</span><br><span class="line">    c.unlockMutex();<span class="comment">//如果这个代码这样写的话,用临界值太痛苦了</span></span><br><span class="line">    <span class="comment">//因为不知道这个doSomeThing是否是在try里面抛出异常</span></span><br><span class="line">    <span class="comment">//又或者根本不知道锁是否在异常阶段锁住的</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="正确使用"><a href="#正确使用" class="headerlink" title="正确使用"></a>正确使用</h2><p>在类的内部使用临界区,不暴露出去</p>
<p>这样内部处理掉了<code>每个需要修改数据</code>成员方法的临界区</p>
<p><img src="/2016/08/05/multithreading-c/image-01.png" width="450px"></p>
<p>当然也可以这样做,通过模板类mutex锁包装变量在函数栈退出的时候解锁</p>
<p><img src="/2016/08/05/multithreading-c/image-02.png" width="450px"></p>
<p><img src="/2016/08/05/multithreading-c/image-03.png" width="350px"></p>
<h2 id="lock-guard"><a href="#lock-guard" class="headerlink" title="lock_guard"></a>lock_guard</h2><p><img src="/2016/08/05/multithreading-c/image-04.png" width="450px"></p>
<p>用std的<code>lock_guard</code>可以替换掉自己实现的模板类</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;mutex&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">BankAccount</span>&#123;</span></span><br><span class="line">    BankAccount(<span class="keyword">int</span> b):Balance(b) &#123;&#125;</span><br><span class="line">    <span class="keyword">int</span> Balance;</span><br><span class="line">    <span class="built_in">std</span>::mutex Mutex;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//转账,多线程操作</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">transferMoney</span><span class="params">(BankAccount&amp; a, BankAccount&amp; b, <span class="keyword">int</span> money)</span></span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::lock_guard&lt;<span class="built_in">std</span>::mutex&gt; lockA(a.Mutex);</span><br><span class="line">    <span class="built_in">std</span>::lock_guard&lt;<span class="built_in">std</span>::mutex&gt; lockB(b.Mutex);</span><br><span class="line">    <span class="keyword">if</span>(a.Balance &lt;= money) <span class="keyword">return</span>;<span class="comment">//没这么多钱</span></span><br><span class="line">    a.Balance -= money;</span><br><span class="line">    b.Balance += money;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//以上代码单线程跑也会死锁</span></span><br><span class="line">    <span class="comment">//BankAccount(100);</span></span><br><span class="line">    <span class="comment">//transferMoney(a, a, 10); 自己转自己就over了,然后就死锁了</span></span><br><span class="line">    <span class="comment">//所以加上if(&amp;a == &amp;b)return;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//多线程还是会死锁</span></span><br><span class="line"><span class="comment">//thread1</span></span><br><span class="line"><span class="comment">//transferMoney(a, b 10);</span></span><br><span class="line"><span class="comment">//thread2</span></span><br><span class="line"><span class="comment">//transferMoney(b, a, 10);</span></span><br><span class="line"><span class="comment">//这类环境下也会死锁</span></span><br></pre></td></tr></table></figure>
<p><img src="/2016/08/05/multithreading-c/image-05.png" width="450px"></p>
<p>这样比较地址小的锁去锁住,大家锁相同的就行了</p>
<p>这样标准库也有简易写法如下</p>
<p><img src="/2016/08/05/multithreading-c/image-06.png" width="450px"></p>
<p><code>std::lock</code>保证按某种特定顺序锁定去锁</p>
<p><code>std::lock</code>只负责锁,所以要用<code>std::lock_guard</code>去解锁</p>
<p>要让<code>std::lock_guard</code>只负责锁,就得传入<code>std::adopt_lock</code>告知已经锁住了</p>
<h1 id="thread交互问题"><a href="#thread交互问题" class="headerlink" title="thread交互问题"></a>thread交互问题</h1><h2 id="join-deatch"><a href="#join-deatch" class="headerlink" title="join/deatch"></a>join/deatch</h2><p>在main函数如果没有进行thread的join,则默认会进行调用abort导致程序进行dumped</p>
<p>而且会让main函数栈的对象资源无法正常进行析构</p>
<p>对于生成thread的两种做法</p>
<ul>
<li>一种自我管理并且处理</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"joinTest.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;thread&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Obj</span>&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    Obj()&#123;<span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"hello "</span>;&#125;</span><br><span class="line">    ~Obj()&#123;<span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"world\n"</span>;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">joinWorker</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">detachWorker</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Obj obj;</span><br><span class="line">    <span class="built_in">std</span>::<span class="function">thread <span class="title">j</span><span class="params">(joinWorker)</span></span>;</span><br><span class="line">    <span class="keyword">if</span>(j.joinable())&#123;</span><br><span class="line">        j.join();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>生成之后就不管了</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Obj</span>&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    Obj()&#123;<span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"hello "</span>;&#125;</span><br><span class="line">    ~Obj()&#123;<span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"world\n"</span>;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">detachWorker</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Obj obj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">std</span>::<span class="function">thread <span class="title">w</span><span class="params">(detachWorker)</span></span>;</span><br><span class="line">w.detach();</span><br></pre></td></tr></table></figure>
<p>做一个事情,然后并不需要想管理这个线程,调用detach,如果detach的线程比主线程的生命周期长,主线程结束会直接杀掉detach</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">detachWorker</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::this_thread::sleep_for(<span class="built_in">std</span>::chrono::seconds(<span class="number">10</span>));</span><br><span class="line">    Obj obj;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">std</span>::<span class="function">thread <span class="title">w</span><span class="params">(detachWorker)</span></span>;</span><br><span class="line">w.detach();</span><br><span class="line"></span><br><span class="line"><span class="comment">//只打印了hello</span></span><br></pre></td></tr></table></figure>
<p>所以一般都自己做管理</p>
<p><img src="/2016/08/05/multithreading-c/image-07.png" width="400px"></p>
<p>在析构做join</p>
<h2 id="信号"><a href="#信号" class="headerlink" title="信号"></a>信号</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;atomic&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="built_in">std</span>::mutex mutex;</span><br><span class="line"><span class="built_in">std</span>::atomic&lt;<span class="keyword">bool</span>&gt; ready&#123;<span class="literal">false</span>&#125;; <span class="comment">//线程的通知信号</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">worker</span><span class="params">(<span class="keyword">int</span> i)</span></span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (!ready)&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"hello world "</span> &lt;&lt; i &lt;&lt; <span class="string">"\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> threadCount = <span class="number">4</span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::thread&gt; pool;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; threadCount; ++i) &#123;</span><br><span class="line">        pool.emplace_back(worker, i);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ready = <span class="literal">true</span>; <span class="comment">//通知不死循环</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> &amp;v: pool)&#123;</span><br><span class="line">        <span class="keyword">if</span>(v.joinable())</span><br><span class="line">            v.join();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"bye bye\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//程序输出:</span></span><br><span class="line"><span class="comment">//hello world hello world hello world hello world 2301</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//bye bye</span></span><br></pre></td></tr></table></figure>
<p>跑下来 iostream的输出流是乱序的</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">worker</span><span class="params">(<span class="keyword">int</span> i)</span></span>&#123;</span><br><span class="line">    mutex.lock();</span><br><span class="line">    <span class="keyword">while</span> (!ready)&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"hello world "</span> &lt;&lt; i &lt;&lt; <span class="string">"\n"</span>;</span><br><span class="line">    mutex.unlock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样就有序了</p>
<p>当然使用printf也可以做到有序输出</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"hello world "</span> &lt;&lt; i &lt;&lt; <span class="string">"\n"</span>;</span><br><span class="line"><span class="comment">//而如果使用上面的cout</span></span><br><span class="line"><span class="comment">//其实显示的就是如下的操作</span></span><br><span class="line"><span class="comment">//std::cout .operator &lt;&lt; ("hello world");</span></span><br><span class="line"><span class="comment">//std::cout .operator &lt;&lt; (i);</span></span><br><span class="line"><span class="comment">//那这样就不是原子操作,若干个操作肯定不是线程安全</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//但是使用了printf("hello world %d \n", i);就不会乱序,因为printf具有原子操作</span></span><br></pre></td></tr></table></figure>
<p>但是这种while的判断是个活锁</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (!ready)&#123;</span><br><span class="line">    <span class="comment">//用这种方式检查值的ok,是非常低效的</span></span><br><span class="line">    <span class="comment">//这是一个活锁,导致ready一直在处于运行判断中</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样的情况再好的机器,也是浪费cpu的资源</p>
<h3 id="yield"><a href="#yield" class="headerlink" title="yield"></a>yield</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (!ready)&#123;</span><br><span class="line">    <span class="built_in">std</span>::this_thread::yield();</span><br><span class="line">    <span class="comment">//改良当程序跑到这,把cpu释放出来让给其他线程</span></span><br><span class="line">    <span class="comment">//但是尽管我把线程释放了,但是其他线程也占用了,其他让步了,我又占据了</span></span><br><span class="line">    <span class="comment">//yield仅能使一个线程从运行状态转到可运行状态，而不是等待或阻塞状态</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>能否过段时间检查一下过段时间检查一下?</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (!ready)&#123;</span><br><span class="line">    <span class="built_in">std</span>::this_thread::sleep_for(<span class="built_in">std</span>::chrono::seconds(<span class="number">1</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那就让每个线程都睡眠一下</p>
<h2 id="消息"><a href="#消息" class="headerlink" title="消息"></a>消息</h2><p>单线程版本</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;list&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;chrono&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Message</span>&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    Message(<span class="built_in">std</span>::<span class="built_in">string</span> d):m_data(<span class="built_in">std</span>::move(d))&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> <span class="built_in">std</span>::<span class="function"><span class="built_in">string</span>&amp; <span class="title">data</span><span class="params">()</span></span>&#123; <span class="keyword">return</span> m_data;&#125;;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> m_data;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">list</span>&lt;Message&gt; globalList;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">worker</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(!globalList.empty())&#123;</span><br><span class="line">        <span class="keyword">auto</span> iter = globalList.begin();</span><br><span class="line">        <span class="comment">// do real work and erase it</span></span><br><span class="line">        globalList.erase(iter);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; ++i) &#123;</span><br><span class="line">        globalList.push_back(<span class="string">"this is a test"</span> + <span class="built_in">std</span>::to_string(i));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    worker();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; ++i) &#123;</span><br><span class="line">        <span class="built_in">std</span>::this_thread::sleep_for(<span class="built_in">std</span>::chrono::microseconds(<span class="number">30</span>));</span><br><span class="line">        globalList.push_back(<span class="built_in">std</span>::<span class="built_in">string</span>(<span class="string">"second"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"before size:"</span> &lt;&lt; globalList.size() &lt;&lt;<span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">    worker();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"after size:"</span> &lt;&lt; globalList.size() &lt;&lt;<span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>多线程版本</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;list&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;chrono&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Message</span>&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    Message(<span class="built_in">std</span>::<span class="built_in">string</span> d):m_data(<span class="built_in">std</span>::move(d))&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> <span class="built_in">std</span>::<span class="function"><span class="built_in">string</span>&amp; <span class="title">data</span><span class="params">()</span></span>&#123; <span class="keyword">return</span> m_data;&#125;;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> m_data;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">std</span>::mutex mutex;</span><br><span class="line"><span class="built_in">std</span>::atomic&lt;<span class="keyword">bool</span>&gt; ready&#123;<span class="literal">false</span>&#125;;</span><br><span class="line"><span class="built_in">std</span>::atomic&lt;<span class="keyword">bool</span>&gt; quit&#123;<span class="literal">false</span>&#125;;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">list</span>&lt;Message&gt; globalList;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">worker</span><span class="params">(<span class="keyword">int</span> i)</span></span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (!ready)&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span>(!quit)&#123;</span><br><span class="line">        <span class="built_in">std</span>::lock_guard&lt;<span class="built_in">std</span>::mutex&gt; lock(mutex);</span><br><span class="line">        <span class="keyword">if</span>(globalList.empty()) <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">auto</span> iter = globalList.begin();</span><br><span class="line">        <span class="comment">// do real work and erase it</span></span><br><span class="line">        globalList.erase(iter);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> threadCount = <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; ++i) &#123;</span><br><span class="line">        globalList.push_back(<span class="string">"this is a test"</span> + <span class="built_in">std</span>::to_string(i));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::thread&gt; pool;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; threadCount; ++i) &#123;</span><br><span class="line">        pool.emplace_back(<span class="built_in">std</span>::thread(worker, i));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"before size:"</span> &lt;&lt; globalList.size() &lt;&lt;<span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    ready = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; ++i) &#123;</span><br><span class="line">        <span class="built_in">std</span>::lock_guard&lt;<span class="built_in">std</span>::mutex&gt; lock(mutex);</span><br><span class="line">        <span class="built_in">std</span>::this_thread::sleep_for(<span class="built_in">std</span>::chrono::microseconds(<span class="number">30</span>));</span><br><span class="line">        globalList.push_back(<span class="built_in">std</span>::<span class="built_in">string</span>(<span class="string">"second"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)&#123;</span><br><span class="line">        <span class="built_in">std</span>::lock_guard&lt;<span class="built_in">std</span>::mutex&gt; lock(mutex);</span><br><span class="line">        <span class="keyword">if</span>(globalList.empty())&#123;</span><br><span class="line">            quit = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;v : pool) &#123;</span><br><span class="line">        <span class="keyword">if</span>(v.joinable())</span><br><span class="line">            v.join();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"after size:"</span> &lt;&lt; globalList.size() &lt;&lt;<span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="condition-variable"><a href="#condition-variable" class="headerlink" title="condition_variable"></a>condition_variable</h2><p><code>std::unique_lock&lt;std::mutex&gt; lock(mutex);</code><br>常用的是<code>std::lock_guard</code></p>
<p>区别在于unique_lock搭配cv来</p>
<p> <code>cv.wait(lock, []{ return quit || !globalList.empty();});</code><br>cv在wait的时候,会等待后面lambda的条件成真<br>这个时候会把lock释放,但是lock_guard却不能释放,因为这得函数出栈才行<br>所以得搭配unique_lock来</p>
<blockquote>
<p>示例代码</p>
</blockquote>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;atomic&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;condition_variable&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;list&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;thread&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Message</span>&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">const</span> <span class="built_in">std</span>::<span class="function"><span class="built_in">string</span>&amp; <span class="title">data</span><span class="params">()</span> <span class="keyword">const</span></span>&#123;<span class="keyword">return</span> m_data;&#125;</span><br><span class="line">    Message(<span class="built_in">std</span>::<span class="built_in">string</span> d = <span class="built_in">std</span>::<span class="built_in">string</span>()):m_data(<span class="built_in">std</span>::move(d))&#123;&#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> m_data;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//全局变量</span></span><br><span class="line"><span class="built_in">std</span>::atomic&lt;<span class="keyword">int</span>&gt; totalSize(<span class="number">0</span>);</span><br><span class="line"><span class="built_in">std</span>::mutex mutex;</span><br><span class="line"><span class="built_in">std</span>::condition_variable cv;</span><br><span class="line"><span class="built_in">std</span>::atomic&lt;<span class="keyword">bool</span>&gt; ready&#123;<span class="literal">false</span>&#125;;</span><br><span class="line"><span class="keyword">bool</span> quit&#123;<span class="literal">false</span>&#125;;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">list</span>&lt;Message&gt; globalList;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">worker</span><span class="params">(<span class="keyword">int</span> i)</span></span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (!ready)&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    Message msg;</span><br><span class="line">    <span class="keyword">while</span> (!quit)&#123;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">std</span>::unique_lock&lt;<span class="built_in">std</span>::mutex&gt; lock(mutex);</span><br><span class="line">            <span class="comment">//常用的是std::lock_guard</span></span><br><span class="line">            <span class="comment">//区别在于unique_lock搭配cv来</span></span><br><span class="line">            cv.wait(lock, []&#123; <span class="keyword">return</span> quit || !globalList.empty();&#125;);</span><br><span class="line">            <span class="comment">//cv在wait的时候,会等待后面lambda的条件成真</span></span><br><span class="line">            <span class="comment">//这个时候会把lock释放,但是lock_guard却不能释放,因为这得函数出栈才行</span></span><br><span class="line">            <span class="comment">//所以得搭配unique_lock来</span></span><br><span class="line">            <span class="keyword">if</span>(quit)</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            <span class="keyword">auto</span> iter = globalList.begin();</span><br><span class="line">            msg = <span class="built_in">std</span>::move(*iter);</span><br><span class="line">            globalList.erase(iter);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        totalSize += <span class="built_in">strlen</span>(msg.data().c_str());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> threadCount = <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">50000</span>; ++i) &#123;</span><br><span class="line">        globalList.push_back(<span class="string">"this is a tst"</span> + <span class="built_in">std</span>::to_string(i));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::thread&gt; pool;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> k = <span class="number">0</span>; k &lt; threadCount; ++k) &#123;</span><br><span class="line">        pool.emplace_back(<span class="built_in">std</span>::thread(worker, k));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ready = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">2000</span>; ++j) &#123;</span><br><span class="line">        <span class="built_in">std</span>::lock_guard&lt;<span class="built_in">std</span>::mutex&gt; lock(mutex);</span><br><span class="line">        globalList.push_back(<span class="built_in">std</span>::<span class="built_in">string</span>(<span class="string">"second"</span>));</span><br><span class="line">        cv.notify_one();<span class="comment">//唤醒单个线程通知运行处理以上新增的数据</span></span><br><span class="line">        <span class="comment">//这样降低了CPU的使用率,因为处理线程只有一个</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)&#123;</span><br><span class="line">        <span class="built_in">std</span>::lock_guard&lt;<span class="built_in">std</span>::mutex&gt; lock(mutex);</span><br><span class="line">        <span class="keyword">if</span> (globalList.empty())&#123;</span><br><span class="line">            quit = <span class="literal">true</span>;</span><br><span class="line">            cv.notify_all();<span class="comment">//唤醒所有线程,退出逻辑</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>cv.wait();</code>直接这样写也可以,等唤醒后就往下执行了</p>

        
    </section>
</article>



<div class="comments">
    <div id="disqus_thread">
        <p class="comment-tips">国内查看评论需要代理~</p>
    </div>
    <script>
    window.disqus_config = function () {
        this.language = 'zh';
        this.page.url = 'http://www.coderss.cn/2016/08/05/multithreading-c/';
        this.page.title = 'C++多线程并发-来源泰课在线';
        this.page.identifier = '2016/08/05/multithreading-c/';
    };
    (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        s.src = 'https://name.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>

</div>
        <footer class="footer">
    Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, Theme by <a href="https://github.com/sanonz/hexo-theme-concise" target="_blank">Concise</a>
</footer>

<script type="text/javascript" src="//s13.cnzz.com/z_stat.php?id=1234567890&amp;web_id=1234567890"></script>


    </div>

    <script type="text/javascript" src="https://cdn.bootcss.com/jquery/1.9.0/jquery.min.js"></script>
    
    <script type="text/javascript" src="/js/scrollspy.min.js"></script>
    
    <script type="text/javascript">
        $(function() {
            var nodes = {
                nav: $('#nav'),
                aside: $('#aside'),
                navTags: $('#nav-tags')
            };

            $('#open-panel, #aside-mask').on('click', function() {
                nodes.aside.toggleClass('panel-show');
            });
            $('#nav-tag').on('click', function(event) {
                event.preventDefault();console.log(nodes.navTags.attr('class'))
                nodes.navTags.toggleClass('tag-show');console.log(nodes.navTags.attr('class'))
            })/*.hover(function() {
                nodes.navTags.addClass('tag-show');
            }, function() {
                nodes.navTags.removeClass('tag-show');
            });*/

            
            $(document.body).scrollspy({target: '#aside-inner'});
            
        });
    </script>

</body>
</html>
