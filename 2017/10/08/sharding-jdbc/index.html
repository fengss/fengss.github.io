<!DOCTYPE html>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="UTF-8">

    

    

    <title>数据库分表分片工具-sharding-jdbc | Coderss</title>
    <meta name="author" content="coder">
    <meta name="version" content="1.0.0">
    <meta name="keywords" content="">
    <meta name="description" content="sharding-jdbc 相关的源码详解笔记 
简介
从mybatis层开始,主要经过如下
12345678//Executor层DefaultSqlSession-&amp;gt;CachingExecutor-&amp;gt;BaseExecutor-&amp;gt;SimpleExecutor|//Statement层RoutingStatementHandler-&amp;gt;PreparedStatementHandler|//Sharding-jdbc Statement层ShardingPrepareStat">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <meta name="baidu-site-verification" content="F0CXvmUgA9">

    
    
    <link rel="icon" href="/favicon.png">
    

    <link rel="stylesheet" href="/css/style.css">
</head>
<body>

    <div class="app">
        <header class="header clearfix">
    <div id="nav" class="nav">
    <button id="open-panel" class="open-panel"><i class="icon-library"></i></button>

    <nav class="nav-inner">

        
        
        <li class="nav-item">
            <a class="nav-link" href="/">首页</a>
        </li>
        
        
        
        <li class="nav-item">
            <a class="nav-link" href="/categories/back-end">Java栈</a>
        </li>
        
        
        
        <li class="nav-item">
            <a class="nav-link" href="/categories/cpp">C/C++</a>
        </li>
        
        
        
        <li class="nav-item">
            <a class="nav-link" href="/categories/go">Golang</a>
        </li>
        
        
        
        <li class="nav-item">
            <a class="nav-link" href="/categories/cloud">System</a>
        </li>
        
        
        
        <li class="nav-item">
            <a class="nav-link" href="/categories/data">BigData</a>
        </li>
        
        
        
        <li class="nav-item">
            <a class="nav-link" href="/categories/ai">Math/AI</a>
        </li>
        
        
        
        <li class="nav-item">
            <a class="nav-link" href="/book">计划</a>
        </li>
        
        
        
        <li class="nav-item nav-item-tag">
            <a id="nav-tag" class="nav-link" href="#">标签</a>
            <div id="nav-tags" class="nav-tag-wrap">
                <i class="nav-tag-arrow"></i>
                
  <div class="widget-wrap">
    <h3 class="widget-title">
        <i class="icon-tag vm"></i>
        <span class="vm">Tags</span>
    </h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/AI/">AI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Boost库/">Boost库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Collection/">Collection</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cpp编程/">Cpp编程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Fescar/">Fescar</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Gc/">Gc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/K8s/">K8s</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MapReduce/">MapReduce</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Math/">Math</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mesos/">Mesos</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python计算库/">Python计算库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Scikit/">Scikit</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Sharding-jdbc/">Sharding-jdbc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SkyWalking/">SkyWalking</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SofaMesh/">SofaMesh</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spark/">Spark</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TensorFlow/">TensorFlow</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TroubleShoot/">TroubleShoot</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Turi/">Turi</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Windows内核/">Windows内核</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Windows内核驱动/">Windows内核驱动</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Yarn/">Yarn</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/assembly/">assembly</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/c-cpp语言/">c/cpp语言</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/debug/">debug</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/design/">design</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dubbo/">dubbo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/eth/">eth</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/flume/">flume</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go/">go</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go-kernel/">go-kernel</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/io/">io</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/">java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/juc/">juc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/map/">map</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mfc/">mfc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/microservice/">microservice</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mybatis/">mybatis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/netty/">netty</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python-book/">python-book</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/qt/">qt</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/skycoin/">skycoin</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spring/">spring</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spring-cloud/">spring-cloud</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/stl/">stl</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tomcat/">tomcat</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/中台/">中台</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/内网穿透/">内网穿透</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/分布式文件系统/">分布式文件系统</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/多线程编程/">多线程编程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/架构/">架构</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/消息队列/">消息队列</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/网络编程/">网络编程</a></li></ul>
    </div>
  </div>


            </div>
        </li>
        
        
        
        <li class="nav-item">
            <a class="nav-link" href="/archives">归档</a>
        </li>
        
        
        

    </nav>
</div>

    <aside id="aside" class="aside">
    <div id="aside-mask" class="aside-mask"></div>
    <div id="aside-inner" class="aside-inner">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit"><i class="icon-search-stroke"></i></button><input type="hidden" name="sitesearch" value="http://www.coderss.cn"></form>

        
        
        
        

        
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#简介"><span class="toc-number">1.</span> <span class="toc-text">简介</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#解析"><span class="toc-number">1.1.</span> <span class="toc-text">解析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#词法解析"><span class="toc-number">1.1.1.</span> <span class="toc-text">词法解析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Lexer-词法解析器"><span class="toc-number">1.1.1.1.</span> <span class="toc-text">Lexer 词法解析器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Token-词法标记"><span class="toc-number">1.1.1.2.</span> <span class="toc-text">Token 词法标记</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Sql解析"><span class="toc-number">1.1.2.</span> <span class="toc-text">Sql解析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#SQLParser"><span class="toc-number">1.1.2.1.</span> <span class="toc-text">SQLParser</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SQL表达式"><span class="toc-number">1.1.2.2.</span> <span class="toc-text">SQL表达式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#StatementParser"><span class="toc-number">1.1.2.3.</span> <span class="toc-text">StatementParser</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#SelectStatementParser"><span class="toc-number">1.1.2.3.1.</span> <span class="toc-text">SelectStatementParser</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#InsertStatementParser"><span class="toc-number">1.1.2.3.2.</span> <span class="toc-text">InsertStatementParser</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#UpdateStatementParser"><span class="toc-number">1.1.2.3.3.</span> <span class="toc-text">UpdateStatementParser</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#DeleteStatementParser"><span class="toc-number">1.1.2.3.4.</span> <span class="toc-text">DeleteStatementParser</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#路由"><span class="toc-number">1.2.</span> <span class="toc-text">路由</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#改写"><span class="toc-number">1.3.</span> <span class="toc-text">改写</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#归并"><span class="toc-number">1.4.</span> <span class="toc-text">归并</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#分布式主键"><span class="toc-number">1.5.</span> <span class="toc-text">分布式主键</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#DefaultKeyGenerator"><span class="toc-number">1.5.1.</span> <span class="toc-text">DefaultKeyGenerator</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HostNameKeyGenerator"><span class="toc-number">1.5.2.</span> <span class="toc-text">HostNameKeyGenerator</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IPKeyGenerator"><span class="toc-number">1.5.3.</span> <span class="toc-text">IPKeyGenerator</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IPSectionKeyGenerator"><span class="toc-number">1.5.4.</span> <span class="toc-text">IPSectionKeyGenerator</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#注意事项"><span class="toc-number">2.</span> <span class="toc-text">注意事项</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#SQL"><span class="toc-number">2.1.</span> <span class="toc-text">SQL</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#支持项"><span class="toc-number">2.2.</span> <span class="toc-text">支持项</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#不支持项"><span class="toc-number">2.3.</span> <span class="toc-text">不支持项</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#示例"><span class="toc-number">2.4.</span> <span class="toc-text">示例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#支持的SQL"><span class="toc-number">2.4.1.</span> <span class="toc-text">支持的SQL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#不支持的SQL"><span class="toc-number">2.4.2.</span> <span class="toc-text">不支持的SQL</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#性能测试"><span class="toc-number">3.</span> <span class="toc-text">性能测试</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#单线程25w"><span class="toc-number">3.1.</span> <span class="toc-text">单线程25w</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#多线程42w"><span class="toc-number">3.2.</span> <span class="toc-text">多线程42w</span></a></li></ol></li></ol>
        
    </div>
</aside>

</header>

        <div id="content" class="content"><article class="article" itemscope="" itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            数据库分表分片工具-sharding-jdbc
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="/2017/10/08/sharding-jdbc/">
    
    <i class="icon-calendar"></i>
    
    <time datetime="2017-10-08T07:57:44.000Z" itemprop="datePublished">2017-10-08</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag"></i>
    <a class="article-tag-link" href="/tags/Sharding-jdbc/">Sharding-jdbc</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <p>sharding-jdbc 相关的源码详解笔记<br><a id="more"></a> </p>
<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p><img src="/2017/10/08/sharding-jdbc/image_01.png" width="350px"></p>
<p>从<code>mybatis</code>层开始,主要经过如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Executor层</span></span><br><span class="line">DefaultSqlSession-&gt;CachingExecutor-&gt;BaseExecutor-&gt;SimpleExecutor</span><br><span class="line">|</span><br><span class="line"><span class="comment">//Statement层</span></span><br><span class="line">RoutingStatementHandler-&gt;PreparedStatementHandler</span><br><span class="line">|</span><br><span class="line"><span class="comment">//Sharding-jdbc Statement层</span></span><br><span class="line">ShardingPrepareStatement-&gt;PrepareStatementRoutingEngine-&gt;ParsingSQLRouter(解析Sql)</span><br></pre></td></tr></table></figure>
<h2 id="解析"><a href="#解析" class="headerlink" title="解析"></a>解析</h2><p><img src="/2017/10/08/sharding-jdbc/image-17.png" width="400px"></p>
<p><code>ParsingSQLRouter</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> SQLRouteResult <span class="title">route</span><span class="params">(<span class="keyword">final</span> String logicSQL, <span class="keyword">final</span> List&lt;Object&gt; parameters, <span class="keyword">final</span> SQLStatement sqlStatement)</span> </span>&#123;</span><br><span class="line">    GeneratedKey generatedKey = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (sqlStatement <span class="keyword">instanceof</span> InsertStatement) &#123;</span><br><span class="line">        generatedKey = getGenerateKey(shardingRule, (InsertStatement) sqlStatement, parameters);</span><br><span class="line">    &#125;</span><br><span class="line">    SQLRouteResult result = <span class="keyword">new</span> SQLRouteResult(sqlStatement, generatedKey);</span><br><span class="line">    ShardingConditions shardingConditions = OptimizeEngineFactory.newInstance(shardingRule, sqlStatement, parameters, generatedKey).optimize();</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> != generatedKey) &#123;</span><br><span class="line">        setGeneratedKeys(result, generatedKey);</span><br><span class="line">    &#125;</span><br><span class="line">    RoutingResult routingResult = route(sqlStatement, shardingConditions);</span><br><span class="line">    SQLRewriteEngine rewriteEngine = <span class="keyword">new</span> SQLRewriteEngine(shardingRule, logicSQL, databaseType, sqlStatement, shardingConditions, parameters);</span><br><span class="line">    <span class="keyword">boolean</span> isSingleRouting = routingResult.isSingleRouting();</span><br><span class="line">    <span class="keyword">if</span> (sqlStatement <span class="keyword">instanceof</span> SelectStatement &amp;&amp; <span class="keyword">null</span> != ((SelectStatement) sqlStatement).getLimit()) &#123;</span><br><span class="line">        processLimit(parameters, (SelectStatement) sqlStatement, isSingleRouting);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//sql改写</span></span><br><span class="line">    SQLBuilder sqlBuilder = rewriteEngine.rewrite(!isSingleRouting);</span><br><span class="line">    <span class="keyword">for</span> (TableUnit each : routingResult.getTableUnits().getTableUnits()) &#123;</span><br><span class="line">        <span class="comment">//解析Sql并改写sql后add添加进去</span></span><br><span class="line">        result.getRouteUnits().add(<span class="keyword">new</span> RouteUnit(each.getDataSourceName(), rewriteEngine.generateSQL(each, sqlBuilder, shardingDataSourceMetaData)));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (showSQL) &#123;</span><br><span class="line">        SQLLogger.logSQL(logicSQL, sqlStatement, result.getRouteUnits());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="词法解析"><a href="#词法解析" class="headerlink" title="词法解析"></a>词法解析</h3><h4 id="Lexer-词法解析器"><a href="#Lexer-词法解析器" class="headerlink" title="Lexer 词法解析器"></a>Lexer 词法解析器</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 分析下一个词法标记.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* <span class="doctag">@see</span> #currentToken</span></span><br><span class="line"><span class="comment">* <span class="doctag">@see</span> #offset</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">nextToken</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    skipIgnoredToken();</span><br><span class="line">    <span class="keyword">if</span> (isVariableBegin()) &#123; <span class="comment">// 变量</span></span><br><span class="line">        currentToken = <span class="keyword">new</span> Tokenizer(input, dictionary, offset).scanVariable();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isNCharBegin()) &#123; <span class="comment">// N\</span></span><br><span class="line">        currentToken = <span class="keyword">new</span> Tokenizer(input, dictionary, ++offset).scanChars();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isIdentifierBegin()) &#123; <span class="comment">// Keyword + Literals.IDENTIFIER</span></span><br><span class="line">        currentToken = <span class="keyword">new</span> Tokenizer(input, dictionary, offset).scanIdentifier();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isHexDecimalBegin()) &#123; <span class="comment">// 十六进制</span></span><br><span class="line">        currentToken = <span class="keyword">new</span> Tokenizer(input, dictionary, offset).scanHexDecimal();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isNumberBegin()) &#123; <span class="comment">// 数字（整数+浮点数）</span></span><br><span class="line">        currentToken = <span class="keyword">new</span> Tokenizer(input, dictionary, offset).scanNumber();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isSymbolBegin()) &#123; <span class="comment">// 符号</span></span><br><span class="line">        currentToken = <span class="keyword">new</span> Tokenizer(input, dictionary, offset).scanSymbol();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isCharsBegin()) &#123; <span class="comment">// 字符串，例如："abc"</span></span><br><span class="line">        currentToken = <span class="keyword">new</span> Tokenizer(input, dictionary, offset).scanChars();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isEnd()) &#123; <span class="comment">// 结束</span></span><br><span class="line">        currentToken = <span class="keyword">new</span> Token(Assist.END, <span class="string">""</span>, offset);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// 分析错误，无符合条件的词法标记</span></span><br><span class="line">        currentToken = <span class="keyword">new</span> Token(Assist.ERROR, <span class="string">""</span>, offset);</span><br><span class="line">    &#125;</span><br><span class="line">    offset = currentToken.getEndPosition();</span><br><span class="line">    <span class="comment">// System.out.println("| " + currentToken.getLiterals() + " | " + currentToken.getType() + " | " + currentToken.getEndPosition() + " |");</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 跳过忽略的词法标记</span></span><br><span class="line"><span class="comment"> * 1. 空格</span></span><br><span class="line"><span class="comment"> * 2. SQL Hint</span></span><br><span class="line"><span class="comment"> * 3. SQL 注释</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">skipIgnoredToken</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 空格</span></span><br><span class="line">    offset = <span class="keyword">new</span> Tokenizer(input, dictionary, offset).skipWhitespace();</span><br><span class="line">    <span class="comment">// SQL Hint</span></span><br><span class="line">    <span class="keyword">while</span> (isHintBegin()) &#123;</span><br><span class="line">        offset = <span class="keyword">new</span> Tokenizer(input, dictionary, offset).skipHint();</span><br><span class="line">        offset = <span class="keyword">new</span> Tokenizer(input, dictionary, offset).skipWhitespace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// SQL 注释</span></span><br><span class="line">    <span class="keyword">while</span> (isCommentBegin()) &#123;</span><br><span class="line">        offset = <span class="keyword">new</span> Tokenizer(input, dictionary, offset).skipComment();</span><br><span class="line">        offset = <span class="keyword">new</span> Tokenizer(input, dictionary, offset).skipWhitespace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Tokenizer负责<strong>分词</strong>。</p>
<p><code>*Lexer#nextToken()</code> 方法里，使用 <code>#skipIgnoredToken()</code> 方法跳过忽略的 Token，通过 <code>#isXXXX()</code>方法判断好下一个 Token 的类型后</p>
<p><strong>交给 Tokenizer 进行分词返回 Token</strong>。‼️</p>
<p><img src="/2017/10/08/sharding-jdbc/image-02.png" width="500px"></p>
<h4 id="Token-词法标记"><a href="#Token-词法标记" class="headerlink" title="Token 词法标记"></a>Token 词法标记</h4><p> Token 的例子，一共有 3 个属性：</p>
<ul>
<li>TokenType type ：词法标记类型</li>
<li>String literals ：词法字面量标记</li>
<li>int endPosition ：<code>literals</code> 在 SQL 里的结束位置</li>
</ul>
<p>TokenType 词法标记类型，一共分成 4 个大类：</p>
<ul>
<li>DefaultKeyword ：词法关键词</li>
<li>Literals ：词法字面量标记</li>
<li>Symbol ：词法符号标记</li>
<li>Assist ：词法辅助标记</li>
</ul>
<p><img src="/2017/10/08/sharding-jdbc/image-03.png" width="500px"></p>
<p><img src="/2017/10/08/sharding-jdbc/image-04.png" width="500px"></p>
<h3 id="Sql解析"><a href="#Sql解析" class="headerlink" title="Sql解析"></a>Sql解析</h3><p><img src="/2017/10/08/sharding-jdbc/image-05.png" width="500px"></p>
<p>Parser 有三个组件：</p>
<ul>
<li>SQLParsingEngine ：SQL 解析引擎</li>
<li>StatementParser ：SQL语句解析器</li>
<li>SQLParser ：SQL 解析器</li>
</ul>
<p>SQLParsingEngine 实例化合适的SqlParse</p>
<p>StatementParser 调用SQLParser 解析 SQL 表达式(SqlExpression)。</p>
<p>实例化最终的Select/Update/Delete/InsertStatement,并且SqlParse为最终的Statement组装最后执行语句</p>
<blockquote>
<p> SQLParsingEngine</p>
</blockquote>
<p>SQL 解析引擎。其 <code>#parse()</code> 方法作为 SQL 解析入口，本身不带复杂逻辑，通过调用 SQL 对应的 StatementParser 进行 SQL 解析。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SQLParsingEngine.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> SQLStatement <span class="title">parse</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="comment">// 获取 SQL解析器</span></span><br><span class="line">   SQLParser sqlParser = getSQLParser();</span><br><span class="line">   <span class="comment">//</span></span><br><span class="line">   sqlParser.skipIfEqual(Symbol.SEMI); <span class="comment">// 跳过 ";"</span></span><br><span class="line">   <span class="keyword">if</span> (sqlParser.equalAny(DefaultKeyword.WITH)) &#123; <span class="comment">// WITH Syntax</span></span><br><span class="line">       skipWith(sqlParser);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// 获取对应 SQL语句解析器 解析SQL</span></span><br><span class="line">   <span class="keyword">if</span> (sqlParser.equalAny(DefaultKeyword.SELECT)) &#123;</span><br><span class="line">       <span class="keyword">return</span> SelectParserFactory.newInstance(sqlParser).parse();</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (sqlParser.equalAny(DefaultKeyword.INSERT)) &#123;</span><br><span class="line">       <span class="keyword">return</span> InsertParserFactory.newInstance(shardingRule, sqlParser).parse();</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (sqlParser.equalAny(DefaultKeyword.UPDATE)) &#123;</span><br><span class="line">       <span class="keyword">return</span> UpdateParserFactory.newInstance(sqlParser).parse();</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (sqlParser.equalAny(DefaultKeyword.DELETE)) &#123;</span><br><span class="line">       <span class="keyword">return</span> DeleteParserFactory.newInstance(sqlParser).parse();</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">throw</span> <span class="keyword">new</span> SQLParsingUnsupportedException(sqlParser.getLexer().getCurrentToken().getType());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2017/10/08/sharding-jdbc/image-06.png" width="1000px"></p>
<h4 id="SQLParser"><a href="#SQLParser" class="headerlink" title="SQLParser"></a>SQLParser</h4><p>SQLParser 看起来方法特别多，合并下一共 5 种：</p>
<table>
<thead>
<tr>
<th>方法</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>#parseExpression()</td>
<td>解析表达式</td>
</tr>
<tr>
<td>#parseAlias()</td>
<td>解析别名</td>
</tr>
<tr>
<td>#parseSingleTable()</td>
<td>解析单表</td>
</tr>
<tr>
<td>#skipJoin()</td>
<td>跳过表关联词法</td>
</tr>
<tr>
<td>#parseWhere()</td>
<td>解析查询条件</td>
</tr>
</tbody>
</table>
<p>SQLParser 不考虑 SQL 是 SELECT / INSERT / UPDATE / DELETE ，它考虑的是，<strong>给我的是 WHERE 处解析查询条件，或是 INSERT INTO 解析单表 等</strong>，提供 SELECT / INSERT / UPDATE / DELETE 需要的 SQL 块公用解析。</p>
<p><img src="/2017/10/08/sharding-jdbc/image-07.png" width="500px"></p>
<ul>
<li><p>parseAlias()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 解析别名.不仅仅是字段的别名，也可以是表的别名。</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span> 别名</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Optional&lt;String&gt; <span class="title">parseAlias</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="comment">// 解析带 AS 情况</span></span><br><span class="line">   <span class="keyword">if</span> (skipIfEqual(DefaultKeyword.AS)) &#123;</span><br><span class="line">       <span class="keyword">if</span> (equalAny(Symbol.values())) &#123;</span><br><span class="line">           <span class="keyword">return</span> Optional.absent();</span><br><span class="line">       &#125;</span><br><span class="line">       String result = SQLUtil.getExactlyValue(getLexer().getCurrentToken().getLiterals());</span><br><span class="line">       getLexer().nextToken();</span><br><span class="line">       <span class="keyword">return</span> Optional.of(result);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// 解析别名</span></span><br><span class="line">   <span class="comment">// TODO 增加哪些数据库识别哪些关键字作为别名的配置</span></span><br><span class="line">   <span class="keyword">if</span> (equalAny(Literals.IDENTIFIER, Literals.CHARS, DefaultKeyword.USER, DefaultKeyword.END, DefaultKeyword.CASE, DefaultKeyword.KEY, DefaultKeyword.INTERVAL, DefaultKeyword.CONSTRAINT)) &#123;</span><br><span class="line">       String result = SQLUtil.getExactlyValue(getLexer().getCurrentToken().getLiterals());</span><br><span class="line">       getLexer().nextToken();</span><br><span class="line">       <span class="keyword">return</span> Optional.of(result);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> Optional.absent();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>parseSingleTable()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 解析单表.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> sqlStatement SQL语句对象</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">parseSingleTable</span><span class="params">(<span class="keyword">final</span> SQLStatement sqlStatement)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">boolean</span> hasParentheses = <span class="keyword">false</span>;</span><br><span class="line">   <span class="keyword">if</span> (skipIfEqual(Symbol.LEFT_PAREN)) &#123;</span><br><span class="line">       <span class="keyword">if</span> (equalAny(DefaultKeyword.SELECT)) &#123; <span class="comment">// multiple-update 或者 multiple-delete</span></span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"Cannot support subquery"</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       hasParentheses = <span class="keyword">true</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   Table table;</span><br><span class="line">   <span class="keyword">final</span> <span class="keyword">int</span> beginPosition = getLexer().getCurrentToken().getEndPosition() - getLexer().getCurrentToken().getLiterals().length();</span><br><span class="line">   String literals = getLexer().getCurrentToken().getLiterals();</span><br><span class="line">   getLexer().nextToken();</span><br><span class="line">   <span class="keyword">if</span> (skipIfEqual(Symbol.DOT)) &#123;</span><br><span class="line">       getLexer().nextToken();</span><br><span class="line">       <span class="keyword">if</span> (hasParentheses) &#123;</span><br><span class="line">           accept(Symbol.RIGHT_PAREN);</span><br><span class="line">       &#125;</span><br><span class="line">       table = <span class="keyword">new</span> Table(SQLUtil.getExactlyValue(literals), parseAlias());</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       <span class="keyword">if</span> (hasParentheses) &#123;</span><br><span class="line">           accept(Symbol.RIGHT_PAREN);</span><br><span class="line">       &#125;</span><br><span class="line">       table = <span class="keyword">new</span> Table(SQLUtil.getExactlyValue(literals), parseAlias());</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (skipJoin()) &#123; <span class="comment">// multiple-update 或者 multiple-delete</span></span><br><span class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"Cannot support Multiple-Table."</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   sqlStatement.getSqlTokens().add(<span class="keyword">new</span> TableToken(beginPosition, literals));</span><br><span class="line">   sqlStatement.getTables().add(table);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>skipJoin()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SQLParser.java</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 跳过表关联词法.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span> 是否表关联.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">skipJoin</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (skipIfEqual(DefaultKeyword.LEFT, DefaultKeyword.RIGHT, DefaultKeyword.FULL)) &#123;</span><br><span class="line">       skipIfEqual(DefaultKeyword.OUTER);</span><br><span class="line">       accept(DefaultKeyword.JOIN);</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (skipIfEqual(DefaultKeyword.INNER)) &#123;</span><br><span class="line">       accept(DefaultKeyword.JOIN);</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (skipIfEqual(DefaultKeyword.JOIN, Symbol.COMMA, DefaultKeyword.STRAIGHT_JOIN)) &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (skipIfEqual(DefaultKeyword.CROSS)) &#123;</span><br><span class="line">       <span class="keyword">if</span> (skipIfEqual(DefaultKeyword.JOIN, DefaultKeyword.APPLY)) &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (skipIfEqual(DefaultKeyword.OUTER)) &#123;</span><br><span class="line">       <span class="keyword">if</span> (skipIfEqual(DefaultKeyword.APPLY)) &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>parseWhere()</p>
<p>解析 WHERE 查询条件。目前支持 AND 条件，不支持 OR 条件。近期 OR 条件支持的可能性比较低。另外条件这块对括号解析需要继续优化，实际使用请勿写冗余的括号。例如：<code>SELECT * FROM tbl_name1 WHERE ((val1=?) AND (val2=?)) AND val3 =?</code>。</p>
</li>
</ul>
<h4 id="SQL表达式"><a href="#SQL表达式" class="headerlink" title="SQL表达式"></a>SQL表达式</h4><p>SQLExpression。目前 6 种实现：</p>
<table>
<thead>
<tr>
<th style="text-align:center">类</th>
<th>说明</th>
<th>对应Token</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">SQLIdentifierExpression</td>
<td>标识表达式</td>
<td>Literals.IDENTIFIER</td>
</tr>
<tr>
<td style="text-align:center">SQLPropertyExpression</td>
<td>属性表达式</td>
<td>无</td>
</tr>
<tr>
<td style="text-align:center">SQLNumberExpression</td>
<td>数字表达式</td>
<td>Literals.INT, Literals.HEX</td>
</tr>
<tr>
<td style="text-align:center">SQLPlaceholderExpression</td>
<td>占位符表达式</td>
<td>Symbol.QUESTION</td>
</tr>
<tr>
<td style="text-align:center">SQLTextExpression</td>
<td>字符表达式</td>
<td>Literals.CHARS</td>
</tr>
<tr>
<td style="text-align:center">SQLIgnoreExpression</td>
<td>分片中无需关注的SQL表达式</td>
<td>无</td>
</tr>
</tbody>
</table>
<p>通过SqlParse解析成SqlExpression<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SQLParser.java</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 解析表达式.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span> 表达式</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">// TODO 完善Expression解析的各种场景</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> SQLExpression <span class="title">parseExpression</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="comment">// 解析表达式</span></span><br><span class="line">   String literals = getLexer().getCurrentToken().getLiterals();</span><br><span class="line">   <span class="keyword">final</span> SQLExpression expression = getExpression(literals);</span><br><span class="line">   <span class="comment">// SQLIdentifierExpression 需要特殊处理。考虑自定义函数，表名.属性情况。</span></span><br><span class="line">   <span class="keyword">if</span> (skipIfEqual(Literals.IDENTIFIER)) &#123;</span><br><span class="line">       <span class="keyword">if</span> (skipIfEqual(Symbol.DOT)) &#123; <span class="comment">// 例如，ORDER BY o.uid 中的 "o.uid"</span></span><br><span class="line">           String property = getLexer().getCurrentToken().getLiterals();</span><br><span class="line">           getLexer().nextToken();</span><br><span class="line">           <span class="keyword">return</span> skipIfCompositeExpression() ? <span class="keyword">new</span> SQLIgnoreExpression() : <span class="keyword">new</span> SQLPropertyExpression(<span class="keyword">new</span> SQLIdentifierExpression(literals), property);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (equalAny(Symbol.LEFT_PAREN)) &#123; <span class="comment">// 例如，GROUP BY DATE(create_time) 中的 "DATE(create_time)"</span></span><br><span class="line">           skipParentheses();</span><br><span class="line">           skipRestCompositeExpression();</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">new</span> SQLIgnoreExpression();</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> skipIfCompositeExpression() ? <span class="keyword">new</span> SQLIgnoreExpression() : expression;</span><br><span class="line">   &#125;</span><br><span class="line">   getLexer().nextToken();</span><br><span class="line">   <span class="keyword">return</span> skipIfCompositeExpression() ? <span class="keyword">new</span> SQLIgnoreExpression() : expression;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 获得 词法Token 对应的 SQLExpression</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> literals 词法字面量标记</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span> SQLExpression</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> SQLExpression <span class="title">getExpression</span><span class="params">(<span class="keyword">final</span> String literals)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (equalAny(Symbol.QUESTION)) &#123;</span><br><span class="line">       increaseParametersIndex();</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> SQLPlaceholderExpression(getParametersIndex() - <span class="number">1</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (equalAny(Literals.CHARS)) &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> SQLTextExpression(literals);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// TODO 考虑long的情况</span></span><br><span class="line">   <span class="keyword">if</span> (equalAny(Literals.INT)) &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> SQLNumberExpression(Integer.parseInt(literals));</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (equalAny(Literals.FLOAT)) &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> SQLNumberExpression(Double.parseDouble(literals));</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// TODO 考虑long的情况</span></span><br><span class="line">   <span class="keyword">if</span> (equalAny(Literals.HEX)) &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> SQLNumberExpression(Integer.parseInt(literals, <span class="number">16</span>));</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (equalAny(Literals.IDENTIFIER)) &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> SQLIdentifierExpression(SQLUtil.getExactlyValue(literals));</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">new</span> SQLIgnoreExpression();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 如果是 复合表达式，跳过。</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span> 是否跳过</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">skipIfCompositeExpression</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (equalAny(Symbol.PLUS, Symbol.SUB, Symbol.STAR, Symbol.SLASH, Symbol.PERCENT, Symbol.AMP, Symbol.BAR, Symbol.DOUBLE_AMP, Symbol.DOUBLE_BAR, Symbol.CARET, Symbol.DOT, Symbol.LEFT_PAREN)) &#123;</span><br><span class="line">       skipParentheses();</span><br><span class="line">       skipRestCompositeExpression();</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 跳过剩余复合表达式</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">skipRestCompositeExpression</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">while</span> (skipIfEqual(Symbol.PLUS, Symbol.SUB, Symbol.STAR, Symbol.SLASH, Symbol.PERCENT, Symbol.AMP, Symbol.BAR, Symbol.DOUBLE_AMP, Symbol.DOUBLE_BAR, Symbol.CARET, Symbol.DOT)) &#123;</span><br><span class="line">       <span class="keyword">if</span> (equalAny(Symbol.QUESTION)) &#123;</span><br><span class="line">           increaseParametersIndex();</span><br><span class="line">       &#125;</span><br><span class="line">       getLexer().nextToken();</span><br><span class="line">       skipParentheses();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="StatementParser"><a href="#StatementParser" class="headerlink" title="StatementParser"></a>StatementParser</h4><p>StatementParser，SQL语句解析器。每种 SQL，都有相应的 SQL语句解析器实现。不同数据库，继承这些 SQL语句解析器，实现各自 SQL 上的差异</p>
<p><img src="/2017/10/08/sharding-jdbc/image-08.png" width="500px"></p>
<h5 id="SelectStatementParser"><a href="#SelectStatementParser" class="headerlink" title="SelectStatementParser"></a>SelectStatementParser</h5><p>由于每个数据库在遵守 SQL 语法规范的同时，又有各自独特的语法。</p>
<p>因此，在 Sharding-JDBC 里每个数据库都有自己的 SELECT 语句的解析器实现方式，当然绝大部分逻辑是相同的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SelectStatement.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SelectStatement</span> <span class="keyword">extends</span> <span class="title">AbstractSQLStatement</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否行 DISTINCT / DISTINCTROW / UNION</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> distinct;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否查询所有字段，即 SELECT *</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> containStar;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 最后一个查询项下一个 Token 的开始位置</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> #items</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> selectListLastPosition;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 最后一个分组项下一个 Token 的开始位置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> groupByLastPosition;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询项</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;SelectItem&gt; items = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 分组项</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;OrderItem&gt; groupByItems = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 排序项</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;OrderItem&gt; orderByItems = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 分页</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Limit limit;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractSQLStatement</span> <span class="keyword">implements</span> <span class="title">SQLStatement</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * SQL 类型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SQLType type;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 表</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Tables tables = <span class="keyword">new</span> Tables();</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 过滤条件。</span></span><br><span class="line"><span class="comment">     * 只有对路由结果有影响的条件，才添加进数组</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Conditions conditions = <span class="keyword">new</span> Conditions();</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * SQL标记对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;SQLToken&gt; sqlTokens = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2017/10/08/sharding-jdbc/image-09.png" width="500px"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MySQLSelectParser.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">query</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (getSqlParser().equalAny(DefaultKeyword.SELECT)) &#123;</span><br><span class="line">       getSqlParser().getLexer().nextToken();</span><br><span class="line">       parseDistinct();</span><br><span class="line">       getSqlParser().skipAll(MySQLKeyword.HIGH_PRIORITY, DefaultKeyword.STRAIGHT_JOIN, MySQLKeyword.SQL_SMALL_RESULT, MySQLKeyword.SQL_BIG_RESULT, MySQLKeyword.SQL_BUFFER_RESULT,</span><br><span class="line">               MySQLKeyword.SQL_CACHE, MySQLKeyword.SQL_NO_CACHE, MySQLKeyword.SQL_CALC_FOUND_ROWS);</span><br><span class="line">       parseSelectList(); <span class="comment">// 解析 查询字段</span></span><br><span class="line">       skipToFrom(); <span class="comment">// 跳到 FROM 处</span></span><br><span class="line">   &#125;</span><br><span class="line">   parseFrom();<span class="comment">// 解析 表（JOIN ON / FROM 单&amp;多表）</span></span><br><span class="line">   parseWhere(); <span class="comment">// 解析 WHERE 条件</span></span><br><span class="line">   parseGroupBy(); <span class="comment">// 解析 Group By 和 Having（目前不支持）条件</span></span><br><span class="line">   parseOrderBy(); <span class="comment">// 解析 Order By 条件</span></span><br><span class="line">   parseLimit(); <span class="comment">// 解析 分页 Limit 条件</span></span><br><span class="line">   <span class="comment">// [PROCEDURE] 暂不支持</span></span><br><span class="line">   <span class="keyword">if</span> (getSqlParser().equalAny(DefaultKeyword.PROCEDURE)) &#123;</span><br><span class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> SQLParsingUnsupportedException(getSqlParser().getLexer().getCurrentToken().getType());</span><br><span class="line">   &#125;</span><br><span class="line">   queryRest();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">// https://dev.mysql.com/doc/refman/5.7/en/select.html</span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    [ALL | <span class="keyword">DISTINCT</span> | <span class="keyword">DISTINCTROW</span> ]</span><br><span class="line">      [<span class="keyword">HIGH_PRIORITY</span>]</span><br><span class="line">      [<span class="keyword">STRAIGHT_JOIN</span>]</span><br><span class="line">      [<span class="keyword">SQL_SMALL_RESULT</span>] [<span class="keyword">SQL_BIG_RESULT</span>] [<span class="keyword">SQL_BUFFER_RESULT</span>]</span><br><span class="line">      [<span class="keyword">SQL_CACHE</span> | SQL_NO_CACHE] [<span class="keyword">SQL_CALC_FOUND_ROWS</span>]</span><br><span class="line">    select_expr [, select_expr ...]</span><br><span class="line">    [<span class="keyword">FROM</span> table_references</span><br><span class="line">      [<span class="keyword">PARTITION</span> partition_list]</span><br><span class="line">    [<span class="keyword">WHERE</span> where_condition]</span><br><span class="line">    [<span class="keyword">GROUP</span> <span class="keyword">BY</span> &#123;col_name | expr | <span class="keyword">position</span>&#125;</span><br><span class="line">      [<span class="keyword">ASC</span> | <span class="keyword">DESC</span>], ... [<span class="keyword">WITH</span> <span class="keyword">ROLLUP</span>]]</span><br><span class="line">    [<span class="keyword">HAVING</span> where_condition]</span><br><span class="line">    [<span class="keyword">ORDER</span> <span class="keyword">BY</span> &#123;col_name | expr | <span class="keyword">position</span>&#125;</span><br><span class="line">      [<span class="keyword">ASC</span> | <span class="keyword">DESC</span>], ...]</span><br><span class="line">    [<span class="keyword">LIMIT</span> &#123;[<span class="keyword">offset</span>,] <span class="keyword">row_count</span> | <span class="keyword">row_count</span> <span class="keyword">OFFSET</span> <span class="keyword">offset</span>&#125;]</span><br><span class="line">    [<span class="keyword">PROCEDURE</span> procedure_name(argument_list)]</span><br><span class="line">    [<span class="keyword">INTO</span> <span class="keyword">OUTFILE</span> <span class="string">'file_name'</span></span><br><span class="line">        [<span class="built_in">CHARACTER</span> <span class="keyword">SET</span> charset_name]</span><br><span class="line">        export_options</span><br><span class="line">      | <span class="keyword">INTO</span> <span class="keyword">DUMPFILE</span> <span class="string">'file_name'</span></span><br><span class="line">      | <span class="keyword">INTO</span> var_name [, var_name]]</span><br><span class="line">    [<span class="keyword">FOR</span> <span class="keyword">UPDATE</span> | <span class="keyword">LOCK</span> <span class="keyword">IN</span> <span class="keyword">SHARE</span> <span class="keyword">MODE</span>]]</span><br></pre></td></tr></table></figure>
<h5 id="InsertStatementParser"><a href="#InsertStatementParser" class="headerlink" title="InsertStatementParser"></a>InsertStatementParser</h5><p>MySQL INSERT 语法一共有 3 种 ：</p>
<ul>
<li>第一种：<code>INSERT {VALUES | VALUES}</code></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> [<span class="keyword">LOW_PRIORITY</span> | <span class="keyword">DELAYED</span> | <span class="keyword">HIGH_PRIORITY</span>] [<span class="keyword">IGNORE</span>]</span><br><span class="line">    [<span class="keyword">INTO</span>] tbl_name</span><br><span class="line">    [<span class="keyword">PARTITION</span> (partition_name,...)]</span><br><span class="line">    [(col_name,...)]</span><br><span class="line">    &#123;<span class="keyword">VALUES</span> | <span class="keyword">VALUE</span>&#125; (&#123;expr | <span class="keyword">DEFAULT</span>&#125;,...),(...),...</span><br><span class="line">    [ <span class="keyword">ON</span> <span class="keyword">DUPLICATE</span> <span class="keyword">KEY</span> <span class="keyword">UPDATE</span></span><br><span class="line">      col_name=expr</span><br><span class="line">        [, col_name=expr] ... ]</span><br></pre></td></tr></table></figure>
<ul>
<li>第二种：<code>INSERT SET</code></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> [<span class="keyword">LOW_PRIORITY</span> | <span class="keyword">DELAYED</span> | <span class="keyword">HIGH_PRIORITY</span>] [<span class="keyword">IGNORE</span>]</span><br><span class="line">    [<span class="keyword">INTO</span>] tbl_name</span><br><span class="line">    [<span class="keyword">PARTITION</span> (partition_name,...)]</span><br><span class="line">    <span class="keyword">SET</span> col_name=&#123;expr | <span class="keyword">DEFAULT</span>&#125;, ...</span><br><span class="line">    [ <span class="keyword">ON</span> <span class="keyword">DUPLICATE</span> <span class="keyword">KEY</span> <span class="keyword">UPDATE</span></span><br><span class="line">      col_name=expr</span><br><span class="line">        [, col_name=expr] ... ]</span><br></pre></td></tr></table></figure>
<ul>
<li>第三种：<code>INSERT SELECT</code></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> [<span class="keyword">LOW_PRIORITY</span> | <span class="keyword">HIGH_PRIORITY</span>] [<span class="keyword">IGNORE</span>]</span><br><span class="line">    [<span class="keyword">INTO</span>] tbl_name</span><br><span class="line">    [<span class="keyword">PARTITION</span> (partition_name,...)]</span><br><span class="line">    [(col_name,...)]</span><br><span class="line">    <span class="keyword">SELECT</span> ...</span><br><span class="line">    [ <span class="keyword">ON</span> <span class="keyword">DUPLICATE</span> <span class="keyword">KEY</span> <span class="keyword">UPDATE</span></span><br><span class="line">      col_name=expr</span><br><span class="line">        [, col_name=expr] ... ]</span><br></pre></td></tr></table></figure>
<p>Sharding-JDBC 目前支持：</p>
<ul>
<li>第一种：<code>INSERT {VALUES | VALUES}</code> <strong>单条记录</strong></li>
<li>第二种：<code>INSERT SET</code></li>
</ul>
<p>Sharding-JDBC 插入SQL解析主流程如下：</p>
<p><img src="/2017/10/08/sharding-jdbc/image-10.png" width="500px"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AbstractInsertParser.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> InsertStatement <span class="title">parse</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   sqlParser.getLexer().nextToken(); <span class="comment">// 跳过 INSERT 关键字</span></span><br><span class="line">   parseInto(); <span class="comment">// 解析INTO</span></span><br><span class="line">   parseColumns(); <span class="comment">// 解析表</span></span><br><span class="line">   <span class="keyword">if</span> (sqlParser.equalAny(DefaultKeyword.SELECT, Symbol.LEFT_PAREN)) &#123;</span><br><span class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"Cannot support subquery"</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (getValuesKeywords().contains(sqlParser.getLexer().getCurrentToken().getType())) &#123; <span class="comment">// 第一种插入SQL情况</span></span><br><span class="line">       parseValues();</span><br><span class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (getCustomizedInsertKeywords().contains(sqlParser.getLexer().getCurrentToken().getType())) &#123; <span class="comment">// 第二种插入SQL情况</span></span><br><span class="line">       parseCustomizedInsert();</span><br><span class="line">   &#125;</span><br><span class="line">   appendGenerateKey(); <span class="comment">// 自增主键</span></span><br><span class="line">   <span class="keyword">return</span> insertStatement;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="UpdateStatementParser"><a href="#UpdateStatementParser" class="headerlink" title="UpdateStatementParser"></a>UpdateStatementParser</h5><p>MySQL UPDATE 语法一共有 2 种 ：</p>
<ul>
<li>第一种：<strong>Single-table syntax</strong></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> [<span class="keyword">LOW_PRIORITY</span>] [<span class="keyword">IGNORE</span>] table_reference</span><br><span class="line">    <span class="keyword">SET</span> col_name1=&#123;expr1|<span class="keyword">DEFAULT</span>&#125; [, col_name2=&#123;expr2|<span class="keyword">DEFAULT</span>&#125;] ...</span><br><span class="line">    [<span class="keyword">WHERE</span> where_condition]</span><br><span class="line">    [<span class="keyword">ORDER</span> <span class="keyword">BY</span> ...]</span><br><span class="line">    [<span class="keyword">LIMIT</span> <span class="keyword">row_count</span>]</span><br></pre></td></tr></table></figure>
<ul>
<li>第二种：<strong>Multiple-table syntax</strong></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> [<span class="keyword">LOW_PRIORITY</span>] [<span class="keyword">IGNORE</span>] table_references</span><br><span class="line">    <span class="keyword">SET</span> col_name1=&#123;expr1|<span class="keyword">DEFAULT</span>&#125; [, col_name2=&#123;expr2|<span class="keyword">DEFAULT</span>&#125;] ...</span><br><span class="line">    [<span class="keyword">WHERE</span> where_condition]</span><br></pre></td></tr></table></figure>
<p><img src="/2017/10/08/sharding-jdbc/image-11.png" width="500px"></p>
<p>Sharding-JDBC 目前仅支持第一种。业务场景上使用第二种的很少很少。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AbstractUpdateParser.java</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> UpdateStatement <span class="title">parse</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   sqlParser.getLexer().nextToken(); <span class="comment">// 跳过 UPDATE</span></span><br><span class="line">   skipBetweenUpdateAndTable(); <span class="comment">// 跳过关键字，例如：MYSQL 里的 LOW_PRIORITY、IGNORE</span></span><br><span class="line">   sqlParser.parseSingleTable(updateStatement); <span class="comment">// 解析表</span></span><br><span class="line">   parseSetItems(); <span class="comment">// 解析 SET</span></span><br><span class="line">   sqlParser.skipUntil(DefaultKeyword.WHERE);</span><br><span class="line">   sqlParser.setParametersIndex(parametersIndex);</span><br><span class="line">   sqlParser.parseWhere(updateStatement);</span><br><span class="line">   <span class="keyword">return</span> updateStatement; <span class="comment">// 解析 WHERE</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="DeleteStatementParser"><a href="#DeleteStatementParser" class="headerlink" title="DeleteStatementParser"></a>DeleteStatementParser</h5><p>MySQL DELETE 语法一共有 2 种 ：</p>
<ul>
<li>第一种：<strong>Single-table syntax</strong></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DELETE</span> [<span class="keyword">LOW_PRIORITY</span>] [<span class="keyword">QUICK</span>] [<span class="keyword">IGNORE</span>] <span class="keyword">FROM</span> tbl_name</span><br><span class="line">    [<span class="keyword">PARTITION</span> (partition_name,...)]</span><br><span class="line">    [<span class="keyword">WHERE</span> where_condition]</span><br><span class="line">    [<span class="keyword">ORDER</span> <span class="keyword">BY</span> ...]</span><br><span class="line">    [<span class="keyword">LIMIT</span> <span class="keyword">row_count</span>]</span><br></pre></td></tr></table></figure>
<ul>
<li>第二种：<strong>Multiple-table syntax</strong></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DELETE</span> [<span class="keyword">LOW_PRIORITY</span>] [<span class="keyword">QUICK</span>] [<span class="keyword">IGNORE</span>]</span><br><span class="line">    tbl_name[.*] [, tbl_name[.*]] ...</span><br><span class="line">    <span class="keyword">FROM</span> table_references</span><br><span class="line">    [<span class="keyword">WHERE</span> where_condition]</span><br><span class="line">    </span><br><span class="line">【<span class="keyword">OR</span>】</span><br><span class="line"></span><br><span class="line"><span class="keyword">DELETE</span> [<span class="keyword">LOW_PRIORITY</span>] [<span class="keyword">QUICK</span>] [<span class="keyword">IGNORE</span>]</span><br><span class="line">    <span class="keyword">FROM</span> tbl_name[.*] [, tbl_name[.*]] ...</span><br><span class="line">    <span class="keyword">USING</span> table_references</span><br><span class="line">    [<span class="keyword">WHERE</span> where_condition]</span><br></pre></td></tr></table></figure>
<p>Sharding-JDBC 目前仅支持第一种。业务场景上使用第二种的很少很少。</p>
<p><img src="/2017/10/08/sharding-jdbc/image-12.png" width="500px"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AbstractDeleteParser.java</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> DeleteStatement <span class="title">parse</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   sqlParser.getLexer().nextToken(); <span class="comment">// 跳过 DELETE</span></span><br><span class="line">   skipBetweenDeleteAndTable(); <span class="comment">// // 跳过关键字，例如：MYSQL 里的 LOW_PRIORITY、IGNORE 和 FROM</span></span><br><span class="line">   sqlParser.parseSingleTable(deleteStatement); <span class="comment">// 解析表</span></span><br><span class="line">   sqlParser.skipUntil(DefaultKeyword.WHERE); <span class="comment">// 跳到 WHERE</span></span><br><span class="line">   sqlParser.parseWhere(deleteStatement); <span class="comment">// 解析 WHERE</span></span><br><span class="line">   <span class="keyword">return</span> deleteStatement;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h2><p><code>StandardRoutingEngine</code>由此路由引擎决定语句的路由情况</p>
<h2 id="改写"><a href="#改写" class="headerlink" title="改写"></a>改写</h2><p><code>SQLRewriteEngine</code>由此重写引擎决定语句的重写情况</p>
<h2 id="归并"><a href="#归并" class="headerlink" title="归并"></a>归并</h2><p><code>MergeEngine</code>分片结果集归并引擎。</p>
<h2 id="分布式主键"><a href="#分布式主键" class="headerlink" title="分布式主键"></a>分布式主键</h2><p><img src="/2017/10/08/sharding-jdbc/image-13.png" width="500px"></p>
<p><code>DefaultKeyGenerator</code>该生成器采用 Twitter Snowflake 算法实现，生成 <strong>64 Bits</strong> 的 <strong>Long</strong> 型编号。国内另外一款数据库中间件 MyCAT 分布式主键也是基于该算法实现。</p>
<h3 id="DefaultKeyGenerator"><a href="#DefaultKeyGenerator" class="headerlink" title="DefaultKeyGenerator"></a>DefaultKeyGenerator</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultKeyGenerator</span> <span class="keyword">implements</span> <span class="title">KeyGenerator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 时间偏移量，从2016年11月1日零点开始</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> EPOCH;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自增量占用比特</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> SEQUENCE_BITS = <span class="number">12L</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 工作进程ID比特</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> WORKER_ID_BITS = <span class="number">10L</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自增量掩码（最大值）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> SEQUENCE_MASK = (<span class="number">1</span> &lt;&lt; SEQUENCE_BITS) - <span class="number">1</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 工作进程ID左移比特数（位数）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> WORKER_ID_LEFT_SHIFT_BITS = SEQUENCE_BITS;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 时间戳左移比特数（位数）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> TIMESTAMP_LEFT_SHIFT_BITS = WORKER_ID_LEFT_SHIFT_BITS + WORKER_ID_BITS;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 工作进程ID最大值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> WORKER_ID_MAX_VALUE = <span class="number">1L</span> &lt;&lt; WORKER_ID_BITS;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Setter</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> TimeService timeService = <span class="keyword">new</span> TimeService();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 工作进程ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">long</span> workerId;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        Calendar calendar = Calendar.getInstance();</span><br><span class="line">        calendar.set(<span class="number">2016</span>, Calendar.NOVEMBER, <span class="number">1</span>);</span><br><span class="line">        calendar.set(Calendar.HOUR_OF_DAY, <span class="number">0</span>);</span><br><span class="line">        calendar.set(Calendar.MINUTE, <span class="number">0</span>);</span><br><span class="line">        calendar.set(Calendar.SECOND, <span class="number">0</span>);</span><br><span class="line">        calendar.set(Calendar.MILLISECOND, <span class="number">0</span>);</span><br><span class="line">        EPOCH = calendar.getTimeInMillis();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 最后自增量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> sequence;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 最后生成编号时间戳，单位：毫秒</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> lastTime;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置工作进程Id.</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> workerId 工作进程Id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setWorkerId</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> workerId)</span> </span>&#123;</span><br><span class="line">        Preconditions.checkArgument(workerId &gt;= <span class="number">0L</span> &amp;&amp; workerId &lt; WORKER_ID_MAX_VALUE);</span><br><span class="line">        DefaultKeyGenerator.workerId = workerId;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成Id.</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 返回@&#123;<span class="doctag">@link</span> Long&#125;类型的Id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> Number <span class="title">generateKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 保证当前时间大于最后时间。时间回退会导致产生重复id</span></span><br><span class="line">        <span class="keyword">long</span> currentMillis = timeService.getCurrentMillis();</span><br><span class="line">        Preconditions.checkState(lastTime &lt;= currentMillis, <span class="string">"Clock is moving backwards, last time is %d milliseconds, current time is %d milliseconds"</span>, lastTime, currentMillis);</span><br><span class="line">        <span class="comment">// 获取序列号</span></span><br><span class="line">        <span class="keyword">if</span> (lastTime == currentMillis) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="number">0L</span> == (sequence = ++sequence &amp; SEQUENCE_MASK)) &#123; <span class="comment">// 当获得序号超过最大值时，归0，并去获得新的时间</span></span><br><span class="line">                currentMillis = waitUntilNextTime(currentMillis);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            sequence = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 设置最后时间戳</span></span><br><span class="line">        lastTime = currentMillis;</span><br><span class="line">        <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">            log.debug(<span class="string">"&#123;&#125;-&#123;&#125;-&#123;&#125;"</span>, <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss.SSS"</span>).format(<span class="keyword">new</span> Date(lastTime)), workerId, sequence);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 生成编号</span></span><br><span class="line">        <span class="keyword">return</span> ((currentMillis - EPOCH) &lt;&lt; TIMESTAMP_LEFT_SHIFT_BITS) | (workerId &lt;&lt; WORKER_ID_LEFT_SHIFT_BITS) | sequence;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 不停获得时间，直到大于最后时间</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> lastTime 最后时间</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">long</span> <span class="title">waitUntilNextTime</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> lastTime)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> time = timeService.getCurrentMillis();</span><br><span class="line">        <span class="keyword">while</span> (time &lt;= lastTime) &#123;</span><br><span class="line">            time = timeService.getCurrentMillis();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> time;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="HostNameKeyGenerator"><a href="#HostNameKeyGenerator" class="headerlink" title="HostNameKeyGenerator"></a>HostNameKeyGenerator</h3><blockquote>
<p>根据<strong>机器名最后的数字编号</strong>获取工作进程编号。<br>如果线上机器命名有统一规范,建议使用此种方式。<br>例如，机器的 HostName 为: <code>dangdang-db-sharding-dev-01</code>(公司名-部门名-服务名-环境名-编号)，会截取 HostName 最后的编号 01 作为工作进程编号( workId )。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// HostNameKeyGenerator.java</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">initWorkerId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   InetAddress address;</span><br><span class="line">   Long workerId;</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">       address = InetAddress.getLocalHost();</span><br><span class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> UnknownHostException e) &#123;</span><br><span class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Cannot get LocalHost InetAddress, please check your network!"</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   String hostName = address.getHostName();</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">       workerId = Long.valueOf(hostName.replace(hostName.replaceAll(<span class="string">"\\d+$"</span>, <span class="string">""</span>), <span class="string">""</span>));</span><br><span class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> NumberFormatException e) &#123;</span><br><span class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(String.format(<span class="string">"Wrong hostname:%s, hostname must be end with number!"</span>, hostName));</span><br><span class="line">   &#125;</span><br><span class="line">   DefaultKeyGenerator.setWorkerId(workerId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="IPKeyGenerator"><a href="#IPKeyGenerator" class="headerlink" title="IPKeyGenerator"></a>IPKeyGenerator</h3><blockquote>
<p>根据<strong>机器IP</strong>获取工作进程编号。<br>如果线上机器的IP二进制表示的最后10位不重复,建议使用此种方式。<br>例如，机器的IP为192.168.1.108，二进制表示:<code>11000000 10101000 00000001 01101100</code>，截取最后 10 位 <code>01 01101100</code>，转为十进制 364，设置工作进程编号为 364。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// IPKeyGenerator.java</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">initWorkerId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   InetAddress address;</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">       address = InetAddress.getLocalHost();</span><br><span class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> UnknownHostException e) &#123;</span><br><span class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Cannot get LocalHost InetAddress, please check your network!"</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">byte</span>[] ipAddressByteArray = address.getAddress();</span><br><span class="line">   DefaultKeyGenerator.setWorkerId((<span class="keyword">long</span>) (((ipAddressByteArray[ipAddressByteArray.length - <span class="number">2</span>] &amp; <span class="number">0B11</span>) &lt;&lt; Byte.SIZE)</span><br><span class="line">           + (ipAddressByteArray[ipAddressByteArray.length - <span class="number">1</span>] &amp; <span class="number">0xFF</span>)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="IPSectionKeyGenerator"><a href="#IPSectionKeyGenerator" class="headerlink" title="IPSectionKeyGenerator"></a>IPSectionKeyGenerator</h3><p>来自 <strong>DogFc</strong> 贡献，对 IPKeyGenerator 进行改造。</p>
<blockquote>
<p>浏览 IPKeyGenerator 工作进程编号生成的规则后，感觉对服务器IP后10位（特别是IPV6）数值比较约束。<br>有以下优化思路：<br>因为工作进程编号最大限制是 2^10，我们生成的工程进程编号只要满足小于 1024 即可。<br>1.针对IPV4:<br>….IP最大 255.255.255.255。而（255+255+255+255) &lt; 1024。<br>….因此采用IP段数值相加即可生成唯一的workerId，不受IP位限制。</p>
<ol>
<li>针对IPV6:<br>….IP最大 ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff<br>….为了保证相加生成出的工程进程编号 &lt; 1024,思路是将每个 Bit 位的后6位相加。这样在一定程度上也可以满足workerId不重复的问题。<br>使用这种 IP 生成工作进程编号的方法,必须保证IP段相加不能重复</li>
</ol>
</blockquote>
<p>对于 IPV6 ：2^ 6 = 64。64 * 8 = 512 &lt; 1024。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// IPSectionKeyGenerator.java</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">initWorkerId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   InetAddress address;</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">       address = InetAddress.getLocalHost();</span><br><span class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> UnknownHostException e) &#123;</span><br><span class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Cannot get LocalHost InetAddress, please check your network!"</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">byte</span>[] ipAddressByteArray = address.getAddress();</span><br><span class="line">   <span class="keyword">long</span> workerId = <span class="number">0L</span>;</span><br><span class="line">   <span class="comment">// IPV4</span></span><br><span class="line">   <span class="keyword">if</span> (ipAddressByteArray.length == <span class="number">4</span>) &#123;</span><br><span class="line">       <span class="keyword">for</span> (<span class="keyword">byte</span> byteNum : ipAddressByteArray) &#123;</span><br><span class="line">           workerId += byteNum &amp; <span class="number">0xFF</span>;</span><br><span class="line">       &#125;</span><br><span class="line">   <span class="comment">// IPV6</span></span><br><span class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ipAddressByteArray.length == <span class="number">16</span>) &#123;</span><br><span class="line">       <span class="keyword">for</span> (<span class="keyword">byte</span> byteNum : ipAddressByteArray) &#123;</span><br><span class="line">           workerId += byteNum &amp; <span class="number">0B111111</span>;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Bad LocalHost InetAddress, please check your network!"</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   DefaultKeyGenerator.setWorkerId(workerId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h1><h2 id="SQL"><a href="#SQL" class="headerlink" title="SQL"></a>SQL</h2><p>由于SQL语法灵活复杂，分布式数据库和单机数据库的查询场景又不完全相同，难免有和单机数据库不兼容的SQL出现。</p>
<p>本文详细罗列出已明确可支持的SQL种类以及已明确不支持的SQL种类，尽量让使用者避免踩坑。</p>
<p>其中必然有未涉及到的SQL欢迎补充，未支持的SQL也尽量会在未来的版本中支持。</p>
<h2 id="支持项"><a href="#支持项" class="headerlink" title="支持项"></a>支持项</h2><p>全面支持DQL、DML和DDL。支持分页、排序、分组、聚合、关联查询（不支持跨库关联）。以下用最为复杂的DQL举例：</p>
<ul>
<li>SELECT主语句</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> select_expr [, select_expr ...] <span class="keyword">FROM</span> table_reference [, table_reference ...]</span><br><span class="line">[<span class="keyword">WHERE</span> where_condition] </span><br><span class="line">[<span class="keyword">GROUP</span> <span class="keyword">BY</span> &#123;col_name | <span class="keyword">position</span>&#125; [<span class="keyword">ASC</span> | <span class="keyword">DESC</span>]] </span><br><span class="line">[<span class="keyword">ORDER</span> <span class="keyword">BY</span> &#123;col_name | <span class="keyword">position</span>&#125; [<span class="keyword">ASC</span> | <span class="keyword">DESC</span>], ...] </span><br><span class="line">[<span class="keyword">LIMIT</span> &#123;[<span class="keyword">offset</span>,] <span class="keyword">row_count</span> | <span class="keyword">row_count</span> <span class="keyword">OFFSET</span> <span class="keyword">offset</span>&#125;]</span><br></pre></td></tr></table></figure>
<ul>
<li>select_expr</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">* | </span><br><span class="line">COLUMN_NAME [AS] [alias] | </span><br><span class="line">(MAX | MIN | SUM | AVG)(COLUMN_NAME | alias) [AS] [alias] | </span><br><span class="line">COUNT(* | COLUMN_NAME | alias) [AS] [alias]</span><br></pre></td></tr></table></figure>
<ul>
<li>table_reference</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tbl_name [AS] alias] [index_hint_list] | </span><br><span class="line">table_reference ([INNER] | &#123;LEFT|RIGHT&#125; [OUTER]) JOIN table_factor [JOIN ON conditional_expr | USING (column_list)] |</span><br></pre></td></tr></table></figure>
<h2 id="不支持项"><a href="#不支持项" class="headerlink" title="不支持项"></a>不支持项</h2><p>不支持冗余括号、CASE WHEN、DISTINCT、HAVING、UNION (ALL)，有限支持子查询。</p>
<p>除了分页子查询的支持之外(详情请参考<a href="http://shardingsphere.io/document/current/cn/features/sharding/usage-standard/pagination" target="_blank" rel="noopener">分页</a>)，也支持同等模式的子查询。无论嵌套多少层，Sharding-Sphere都可以解析至第一个包含数据表的子查询，一旦在下层嵌套中再次找到包含数据表的子查询将直接抛出解析异常。</p>
<p>例如，以下子查询可以支持：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(*) <span class="keyword">FROM</span> (<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_order o)</span><br></pre></td></tr></table></figure>
<p>以下子查询不支持：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(*) <span class="keyword">FROM</span> (<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_order o <span class="keyword">WHERE</span> o.id <span class="keyword">IN</span> (<span class="keyword">SELECT</span> <span class="keyword">id</span> <span class="keyword">FROM</span> t_order <span class="keyword">WHERE</span> <span class="keyword">status</span> = ?))</span><br></pre></td></tr></table></figure>
<p>简单来说，通过子查询进行非功能需求，在大部分情况下是可以支持的。比如分页、统计总数等；而通过子查询实现业务查询当前并不能支持。</p>
<p>由于归并的限制，子查询中包含聚合函数目前无法支持。</p>
<p>不支持包含schema的SQL。因为Sharding-Sphere的理念是像使用一个数据源一样使用多数据源，因此对SQL的访问都是在同一个逻辑schema之上。</p>
<h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><h3 id="支持的SQL"><a href="#支持的SQL" class="headerlink" title="支持的SQL"></a>支持的SQL</h3><table>
<thead>
<tr>
<th>SQL</th>
<th>必要条件</th>
</tr>
</thead>
<tbody>
<tr>
<td>SELECT * FROM tbl_name</td>
<td></td>
</tr>
<tr>
<td>SELECT * FROM tbl_name WHERE (col1 = ? or col2 = ?) and col3 = ?</td>
<td></td>
</tr>
<tr>
<td>SELECT * FROM tbl_name WHERE col1 = ? ORDER BY col2 DESC LIMIT ?</td>
<td></td>
</tr>
<tr>
<td>SELECT COUNT(*), SUM(col1), MIN(col1), MAX(col1), AVG(col1) FROM tbl_name WHERE col1 = ?</td>
<td></td>
</tr>
<tr>
<td>SELECT COUNT(col1) FROM tbl_name WHERE col2 = ? GROUP BY col1 ORDER BY col3 DESC LIMIT ?, ?</td>
<td></td>
</tr>
<tr>
<td>INSERT INTO tbl_name (col1, col2,…) VALUES (?, ?, ….)</td>
<td></td>
</tr>
<tr>
<td>INSERT INTO tbl_name VALUES (?, ?,….)</td>
<td></td>
</tr>
<tr>
<td>INSERT INTO tbl_name (col1, col2, …) VALUES (?, ?, ….), (?, ?, ….)</td>
<td></td>
</tr>
<tr>
<td>UPDATE tbl_name SET col1 = ? WHERE col2 = ?</td>
<td></td>
</tr>
<tr>
<td>DELETE FROM tbl_name WHERE col1 = ?</td>
<td></td>
</tr>
<tr>
<td>CREATE TABLE tbl_name (col1 int, …)</td>
<td></td>
</tr>
<tr>
<td>ALTER TABLE tbl_name ADD col1 varchar(10)</td>
<td></td>
</tr>
<tr>
<td>DROP TABLE tbl_name</td>
<td></td>
</tr>
<tr>
<td>TRUNCATE TABLE tbl_name</td>
<td></td>
</tr>
<tr>
<td>CREATE INDEX idx_name ON tbl_name</td>
<td></td>
</tr>
<tr>
<td>DROP INDEX idx_name ON tbl_name</td>
<td></td>
</tr>
<tr>
<td>DROP INDEX idx_name</td>
<td>TableRule中配置logic-index</td>
</tr>
</tbody>
</table>
<h3 id="不支持的SQL"><a href="#不支持的SQL" class="headerlink" title="不支持的SQL"></a>不支持的SQL</h3><table>
<thead>
<tr>
<th>SQL</th>
<th>不支持原因</th>
</tr>
</thead>
<tbody>
<tr>
<td>INSERT INTO tbl_name (col1, col2, …) SELECT col1, col2, … FROM tbl_name WHERE col3 = ?</td>
<td>INSERT .. SELECT</td>
</tr>
<tr>
<td>INSERT INTO tbl_name SET col1 = ?</td>
<td>INSERT .. SET</td>
</tr>
<tr>
<td>SELECT DISTINCT * FROM tbl_name WHERE column1 = ?</td>
<td>DISTINCT</td>
</tr>
<tr>
<td>SELECT COUNT(col1) as count_alias FROM tbl_name GROUP BY col1 HAVING count_alias &gt; ?</td>
<td>HAVING</td>
</tr>
<tr>
<td>SELECT <em> FROM tbl_name1 UNION SELECT </em> FROM tbl_name2</td>
<td>UNION</td>
</tr>
<tr>
<td>SELECT <em> FROM tbl_name1 UNION ALL SELECT </em> FROM tbl_name2</td>
<td>UNION ALL</td>
</tr>
<tr>
<td>SELECT * FROM tbl_name1 WHERE (val1=?) AND (val1=?)</td>
<td>冗余括号</td>
</tr>
<tr>
<td>SELECT * FROM ds.tbl_name1</td>
<td>包含schema</td>
</tr>
</tbody>
</table>
<h1 id="性能测试"><a href="#性能测试" class="headerlink" title="性能测试"></a>性能测试</h1><h2 id="单线程25w"><a href="#单线程25w" class="headerlink" title="单线程25w"></a>单线程25w</h2><p>单线程批量插入25w数据</p>
<blockquote>
<p>测试代码</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//读取并添加</span></span><br><span class="line">        <span class="comment">//读取并添加</span></span><br><span class="line">Connection connection = dataSource.getConnection();</span><br><span class="line"><span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">    <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">    PreparedStatement ps = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ps = connection.prepareStatement(</span><br><span class="line">                <span class="string">"SELECT * FROM iks_user_amount_record_shengyuancoin_tab;"</span></span><br><span class="line">                ,ResultSet.TYPE_FORWARD_ONLY, ResultSet.CONCUR_READ_ONLY);</span><br><span class="line">        ps.setFetchSize(Integer.MIN_VALUE);</span><br><span class="line">        ResultSet rs = ps.executeQuery();</span><br><span class="line">        <span class="keyword">while</span> (rs.next()) &#123;</span><br><span class="line">            recordDOList.add(RecordDO.builder()</span><br><span class="line">                    .recordNo(rs.getString(<span class="string">"recordNo"</span>))</span><br><span class="line">                    .userId(rs.getInt(<span class="string">"userId"</span>))</span><br><span class="line">                    .shengyuanCoin(rs.getBigDecimal(<span class="string">"shengyuanCoin"</span>))</span><br><span class="line">                    .paymentType(rs.getInt(<span class="string">"paymentType"</span>))</span><br><span class="line">                    .remarks(rs.getString(<span class="string">"remarks"</span>))</span><br><span class="line">                    .fromType(rs.getString(<span class="string">"fromType"</span>))</span><br><span class="line">                    .addTime(rs.getTimestamp(<span class="string">"addTime"</span>))</span><br><span class="line">                    .build());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">long</span> diff = System.currentTimeMillis() - start;</span><br><span class="line">    System.out.println(<span class="string">"diff:"</span> + diff + <span class="string">",listSize:"</span> + recordDOList.size());</span><br><span class="line"></span><br><span class="line">    start = System.currentTimeMillis();</span><br><span class="line">    <span class="comment">//执行批量插入操作</span></span><br><span class="line">    SqlSession sqlSession = sqlSessionFactory.openSession(ExecutorType.BATCH, <span class="keyword">false</span>);</span><br><span class="line">    RecordDao recordDao = sqlSession.getMapper(RecordDao.class);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt; recordDOList.size(); i++)&#123;</span><br><span class="line">        RecordDO recordDO = recordDOList.get(i);</span><br><span class="line">        recordDao.insertData(recordDO);</span><br><span class="line">        i++;</span><br><span class="line">        <span class="keyword">if</span>(i % <span class="number">10000</span>==<span class="number">9999</span>)&#123;<span class="comment">//每10000条提交一次防止内存溢出</span></span><br><span class="line">            System.out.println(<span class="string">"插入成功 i:"</span> + i);</span><br><span class="line">            sqlSession.commit();</span><br><span class="line">            sqlSession.clearCache();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    sqlSession.commit();</span><br><span class="line">    sqlSession.clearCache();</span><br><span class="line"></span><br><span class="line">    diff = System.currentTimeMillis() - start;</span><br><span class="line">    System.out.println(<span class="string">"diff:"</span> + diff);</span><br><span class="line">&#125;).start();</span><br></pre></td></tr></table></figure>
<blockquote>
<p> 内存变化曲线</p>
</blockquote>
<p><img src="/2017/10/08/sharding-jdbc/image-14.png" alt="image-20181023104717903"></p>
<h2 id="多线程42w"><a href="#多线程42w" class="headerlink" title="多线程42w"></a>多线程42w</h2><blockquote>
<p>代码信息</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> core = <span class="number">20</span>;</span><br><span class="line">threadPoolExecutor = Executors.newFixedThreadPool(core);</span><br><span class="line"><span class="comment">//读取并添加</span></span><br><span class="line">Connection connection = dataSource.getConnection();</span><br><span class="line"><span class="comment">//获取当前的总数量值</span></span><br><span class="line">PreparedStatement ps = connection.prepareStatement(</span><br><span class="line">        <span class="string">"SELECT count(*) as `count` FROM iks_user_amount_record_shengyuancoin_tab;"</span>);</span><br><span class="line">ps.executeQuery();</span><br><span class="line">ResultSet rs = ps.getResultSet();</span><br><span class="line"><span class="keyword">long</span> count = rs.getLong(<span class="string">"count"</span>);</span><br><span class="line"><span class="keyword">long</span> length = count / core;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 提交任务</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> j=<span class="number">0</span>; j&lt;core; j++)&#123;</span><br><span class="line">    threadPoolExecutor.submit(()-&gt;&#123;</span><br><span class="line">        <span class="keyword">int</span> current = atomicInteger.getAndIncrement();</span><br><span class="line">        log.info(<span class="string">"current:&#123;&#125;"</span>, current);</span><br><span class="line">        <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">        PreparedStatement innerPs = <span class="keyword">null</span>;</span><br><span class="line">        List&lt;RecordDO&gt; recordDOList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String sql = <span class="string">"SELECT * FROM iks_user_amount_record_shengyuancoin_tab limit "</span> + length*current +<span class="string">","</span> + length;</span><br><span class="line">            log.info(<span class="string">"Sql:&#123;&#125;"</span>, sql);</span><br><span class="line">            innerPs = connection.prepareStatement(sql,ResultSet.TYPE_FORWARD_ONLY, ResultSet.CONCUR_READ_ONLY);</span><br><span class="line">            innerPs.setFetchSize(Integer.MIN_VALUE);</span><br><span class="line">            ResultSet innerRs = innerPs.executeQuery();</span><br><span class="line">            <span class="keyword">while</span> (innerRs.next()) &#123;</span><br><span class="line">                recordDOList.add(RecordDO.builder()</span><br><span class="line">                        .recordNo(innerRs.getString(<span class="string">"recordNo"</span>))</span><br><span class="line">                        .userId(innerRs.getInt(<span class="string">"userId"</span>))</span><br><span class="line">                        .shengyuanCoin(innerRs.getBigDecimal(<span class="string">"shengyuanCoin"</span>))</span><br><span class="line">                        .paymentType(innerRs.getInt(<span class="string">"paymentType"</span>))</span><br><span class="line">                        .remarks(innerRs.getString(<span class="string">"remarks"</span>))</span><br><span class="line">                        .fromType(innerRs.getString(<span class="string">"fromType"</span>))</span><br><span class="line">                        .addTime(innerRs.getTimestamp(<span class="string">"addTime"</span>))</span><br><span class="line">                        .build());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">long</span> diff = System.currentTimeMillis() - start;</span><br><span class="line">        log.info(<span class="string">"current:&#123;&#125;,diff:&#123;&#125;,listSize:&#123;&#125;"</span>, current, diff, recordDOList.size());</span><br><span class="line"></span><br><span class="line">        start = System.currentTimeMillis();</span><br><span class="line">        <span class="comment">//执行批量插入操作</span></span><br><span class="line">        SqlSession sqlSession = sqlSessionFactory.openSession(ExecutorType.BATCH, <span class="keyword">false</span>);</span><br><span class="line">        RecordDao recordDao = sqlSession.getMapper(RecordDao.class);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt; recordDOList.size(); i++)&#123;</span><br><span class="line">            RecordDO recordDO = recordDOList.get(i);</span><br><span class="line">            recordDao.insertData(recordDO);</span><br><span class="line">            i++;</span><br><span class="line">            <span class="keyword">if</span>(i % <span class="number">10000</span>==<span class="number">9999</span>)&#123;<span class="comment">//每10000条提交一次防止内存溢出</span></span><br><span class="line">                log.info(<span class="string">"插入成功 i:&#123;&#125;"</span>, i);</span><br><span class="line">                sqlSession.commit();</span><br><span class="line">                sqlSession.clearCache();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        sqlSession.commit();</span><br><span class="line">        sqlSession.clearCache();</span><br><span class="line"></span><br><span class="line">        diff = System.currentTimeMillis() - start;</span><br><span class="line">        log.info(<span class="string">"diff:&#123;&#125;"</span>, diff);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>CPU: 2 GHz Intel Core i7</li>
<li>内存: 8 GB 1600 MHz DDR3</li>
<li>环境: JDK 1.8 SpringBoot1.5.8.RELEASE Mybatis+Druid+Sharding-Jdbc</li>
</ul>
<p>线程数: 20,所花时间12分钟</p>
<p>内存曲线图</p>
<p><img src="/2017/10/08/sharding-jdbc/image-16.png" alt="image-20181023144941430"></p>

        
    </section>
</article>



<div class="comments">
    <div id="disqus_thread">
        <p class="comment-tips">国内查看评论需要代理~</p>
    </div>
    <script>
    window.disqus_config = function () {
        this.language = 'zh';
        this.page.url = 'http://www.coderss.cn/2017/10/08/sharding-jdbc/';
        this.page.title = '数据库分表分片工具-sharding-jdbc';
        this.page.identifier = '2017/10/08/sharding-jdbc/';
    };
    (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        s.src = 'https://name.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>

</div>
        <footer class="footer">
    Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, Theme by <a href="https://github.com/sanonz/hexo-theme-concise" target="_blank">Concise</a>
</footer>

<script type="text/javascript" src="//s13.cnzz.com/z_stat.php?id=1234567890&amp;web_id=1234567890"></script>


    </div>

    <script type="text/javascript" src="https://cdn.bootcss.com/jquery/1.9.0/jquery.min.js"></script>
    
    <script type="text/javascript" src="/js/scrollspy.min.js"></script>
    
    <script type="text/javascript">
        $(function() {
            var nodes = {
                nav: $('#nav'),
                aside: $('#aside'),
                navTags: $('#nav-tags')
            };

            $('#open-panel, #aside-mask').on('click', function() {
                nodes.aside.toggleClass('panel-show');
            });
            $('#nav-tag').on('click', function(event) {
                event.preventDefault();console.log(nodes.navTags.attr('class'))
                nodes.navTags.toggleClass('tag-show');console.log(nodes.navTags.attr('class'))
            })/*.hover(function() {
                nodes.navTags.addClass('tag-show');
            }, function() {
                nodes.navTags.removeClass('tag-show');
            });*/

            
            $(document.body).scrollspy({target: '#aside-inner'});
            
        });
    </script>

</body>
</html>
