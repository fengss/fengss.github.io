<!DOCTYPE html>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="UTF-8">

    

    

    <title>Dubbo解析 | Coderss</title>
    <meta name="author" content="coder">
    <meta name="version" content="1.0.0">
    <meta name="keywords" content="">
    <meta name="description" content="Dubbo 源码解析
集群容错

Invoker: Provider 的一个可调用 Service 的抽象，Invoker 封装了 Provider 地址及 Service 接口信息  
Directory: 代表多个 Invoker,可以把它看成 List,但与 List 不同的是，它的值可能是动态变化的，比如注册中心推送变更  
Cluster: 将 Directory 中的多个 Invoker 伪装成一个 Invoker，对上层透明，伪装过程包含了容错逻辑，调用失败后，重试另一个  
Ro">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <meta name="baidu-site-verification" content="F0CXvmUgA9">

    
    
    <link rel="icon" href="/favicon.png">
    

    <link rel="stylesheet" href="/css/style.css">
</head>
<body>

    <div class="app">
        <header class="header clearfix">
    <div id="nav" class="nav">
    <button id="open-panel" class="open-panel"><i class="icon-library"></i></button>

    <nav class="nav-inner">

        
        
        <li class="nav-item">
            <a class="nav-link" href="/">首页</a>
        </li>
        
        
        
        <li class="nav-item">
            <a class="nav-link" href="/categories/back-end">Java前后端</a>
        </li>
        
        
        
        <li class="nav-item">
            <a class="nav-link" href="/categories/cpp">Cpp嵌入式</a>
        </li>
        
        
        
        <li class="nav-item">
            <a class="nav-link" href="/categories/go">Go云原生</a>
        </li>
        
        
        
        <li class="nav-item">
            <a class="nav-link" href="/categories/cloud">Linux安全</a>
        </li>
        
        
        
        <li class="nav-item">
            <a class="nav-link" href="/categories/reverse">Win安全</a>
        </li>
        
        
        
        <li class="nav-item">
            <a class="nav-link" href="/categories/data">数据与算法</a>
        </li>
        
        
        
        <li class="nav-item">
            <a class="nav-link" href="/categories/work">工作相关</a>
        </li>
        
        
        
        <li class="nav-item nav-item-tag">
            <a id="nav-tag" class="nav-link" href="#">文章标签</a>
            <div id="nav-tags" class="nav-tag-wrap">
                <i class="nav-tag-arrow"></i>
                
  <div class="widget-wrap">
    <h3 class="widget-title">
        <i class="icon-tag vm"></i>
        <span class="vm">Tags</span>
    </h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/AI/">AI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Boost库/">Boost库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Collection/">Collection</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cpp编程/">Cpp编程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Fescar/">Fescar</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Gc/">Gc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/K8s/">K8s</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MapReduce/">MapReduce</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Math/">Math</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Net/">Net</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nosql/">Nosql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python计算库/">Python计算库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Rust/">Rust</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Sharding-jdbc/">Sharding-jdbc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SkyWalking/">SkyWalking</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spark/">Spark</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TensorFlow/">TensorFlow</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Turi/">Turi</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Windows系统/">Windows系统</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Windows驱动/">Windows驱动</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Yarn/">Yarn</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/assembly/">assembly</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/c-cpp语言/">c/cpp语言</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/debug/">debug</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/design/">design</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dubbo/">dubbo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/eth/">eth</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/flume/">flume</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go/">go</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go-kernel/">go-kernel</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/io/">io</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/">java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/juc/">juc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kubernetes/">kubernetes</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/map/">map</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mfc/">mfc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/microservice/">microservice</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mybatis/">mybatis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/netty/">netty</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python-book/">python-book</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/qt/">qt</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sentinel/">sentinel</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/skycoin/">skycoin</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spring/">spring</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spring-cloud/">spring-cloud</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/stl/">stl</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tomcat/">tomcat</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/x86-Windows系统总结/">x86 Windows系统总结</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/中台/">中台</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/分布式文件系统/">分布式文件系统</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/多线程编程/">多线程编程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/嵌入式/">嵌入式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/架构/">架构</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/消息队列/">消息队列</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/网络编程/">网络编程</a></li></ul>
    </div>
  </div>


            </div>
        </li>
        
        
        
        <li class="nav-item">
            <a class="nav-link" href="/archives">历史归档</a>
        </li>
        
        
        

    </nav>
</div>

    <aside id="aside" class="aside">
    <div id="aside-mask" class="aside-mask"></div>
    <div id="aside-inner" class="aside-inner">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit"><i class="icon-search-stroke"></i></button><input type="hidden" name="sitesearch" value="http://www.coderss.cn"></form>

        
        
        
        
        

        
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#集群容错"><span class="toc-number">1.</span> <span class="toc-text">集群容错</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Mock机制"><span class="toc-number">1.1.</span> <span class="toc-text">Mock机制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#本地伪装"><span class="toc-number">1.1.1.</span> <span class="toc-text">本地伪装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Cluster-gt-MockClusterWrapper"><span class="toc-number">1.1.2.</span> <span class="toc-text">Cluster-&gt;MockClusterWrapper</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Router-gt-MockInvokersRouter"><span class="toc-number">1.1.3.</span> <span class="toc-text">Router-&gt;MockInvokersRouter</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#setRouters"><span class="toc-number">1.1.3.1.</span> <span class="toc-text">setRouters</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#AbstractDirectory-list"><span class="toc-number">1.1.3.1.1.</span> <span class="toc-text">AbstractDirectory#list</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#getMockInvokers"><span class="toc-number">1.1.3.1.2.</span> <span class="toc-text">getMockInvokers</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Directory"><span class="toc-number">1.2.</span> <span class="toc-text">Directory</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#RegistryDirectory"><span class="toc-number">1.2.1.</span> <span class="toc-text">RegistryDirectory</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#doList-服务读操作"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">doList 服务读操作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#notify-服务写操作"><span class="toc-number">1.2.1.2.</span> <span class="toc-text">notify 服务写操作</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#StaticDirectory"><span class="toc-number">1.2.2.</span> <span class="toc-text">StaticDirectory</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Cluster"><span class="toc-number">1.3.</span> <span class="toc-text">Cluster</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#MockClusterWrapper"><span class="toc-number">1.3.1.</span> <span class="toc-text">MockClusterWrapper</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Mergeable-Cluster"><span class="toc-number">1.3.2.</span> <span class="toc-text">Mergeable Cluster</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Failover-Cluster"><span class="toc-number">1.3.3.</span> <span class="toc-text">Failover Cluster</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Failfast-Cluster"><span class="toc-number">1.3.4.</span> <span class="toc-text">Failfast Cluster</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Failsafe-Cluster"><span class="toc-number">1.3.5.</span> <span class="toc-text">Failsafe Cluster</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Failback-Cluster"><span class="toc-number">1.3.6.</span> <span class="toc-text">Failback Cluster</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Forking-Cluster"><span class="toc-number">1.3.7.</span> <span class="toc-text">Forking Cluster</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Broadcast-Cluster"><span class="toc-number">1.3.8.</span> <span class="toc-text">Broadcast Cluster</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Route"><span class="toc-number">1.4.</span> <span class="toc-text">Route</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#MockInvokersSelector"><span class="toc-number">1.4.1.</span> <span class="toc-text">MockInvokersSelector</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ConditionRouter-条件路由"><span class="toc-number">1.4.2.</span> <span class="toc-text">ConditionRouter(条件路由)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Loadbalance"><span class="toc-number">1.5.</span> <span class="toc-text">Loadbalance</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#RoundRobin-LoadBalance"><span class="toc-number">1.5.1.</span> <span class="toc-text">RoundRobin LoadBalance</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#不同权重值"><span class="toc-number">1.5.1.1.</span> <span class="toc-text">不同权重值</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#相同权重值"><span class="toc-number">1.5.1.2.</span> <span class="toc-text">相同权重值</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Random-LoadBalance"><span class="toc-number">1.5.2.</span> <span class="toc-text">Random LoadBalance</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#不同权重值-1"><span class="toc-number">1.5.2.1.</span> <span class="toc-text">不同权重值</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#相同权重值-1"><span class="toc-number">1.5.2.2.</span> <span class="toc-text">相同权重值</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LeastActive-LoadBalance"><span class="toc-number">1.5.3.</span> <span class="toc-text">LeastActive LoadBalance</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ConsistentHash-LoadBalance"><span class="toc-number">1.5.4.</span> <span class="toc-text">ConsistentHash LoadBalance</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#SPI扩展-ExtensionLoader"><span class="toc-number">2.</span> <span class="toc-text">SPI扩展-ExtensionLoader</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#变量说明"><span class="toc-number">2.1.</span> <span class="toc-text">变量说明</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#功能说明"><span class="toc-number">2.2.</span> <span class="toc-text">功能说明</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#获取实例-操作流程"><span class="toc-number">2.2.1.</span> <span class="toc-text">获取实例-操作流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Adaptive"><span class="toc-number">2.2.2.</span> <span class="toc-text">Adaptive</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#面向用户操作"><span class="toc-number">2.2.2.1.</span> <span class="toc-text">面向用户操作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#示例"><span class="toc-number">2.2.2.2.</span> <span class="toc-text">示例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Activate"><span class="toc-number">2.2.3.</span> <span class="toc-text">Activate</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#面向用户操作-1"><span class="toc-number">2.2.3.1.</span> <span class="toc-text">面向用户操作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#示例-1"><span class="toc-number">2.2.3.2.</span> <span class="toc-text">示例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Extension"><span class="toc-number">2.2.4.</span> <span class="toc-text">Extension</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#示例-2"><span class="toc-number">2.2.4.1.</span> <span class="toc-text">示例</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#加载流程"><span class="toc-number">2.3.</span> <span class="toc-text">加载流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#取相关实现类"><span class="toc-number">2.3.1.</span> <span class="toc-text">取相关实现类</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Extension-1"><span class="toc-number">2.3.1.1.</span> <span class="toc-text">Extension</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#getExtension"><span class="toc-number">2.3.1.1.1.</span> <span class="toc-text">getExtension</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#createExtension"><span class="toc-number">2.3.1.1.2.</span> <span class="toc-text">createExtension</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#injectExtension"><span class="toc-number">2.3.1.1.3.</span> <span class="toc-text">injectExtension</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AdaptiveExtension"><span class="toc-number">2.3.1.2.</span> <span class="toc-text">AdaptiveExtension</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#getAdaptiveExtension"><span class="toc-number">2.3.1.2.1.</span> <span class="toc-text">getAdaptiveExtension</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#createAdaptiveExtension"><span class="toc-number">2.3.1.2.2.</span> <span class="toc-text">createAdaptiveExtension</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#getAdaptiveExtensionClass"><span class="toc-number">2.3.1.2.3.</span> <span class="toc-text">getAdaptiveExtensionClass</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#createAdaptiveExtensionClass"><span class="toc-number">2.3.1.2.4.</span> <span class="toc-text">createAdaptiveExtensionClass</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#createAdaptiveExtensionClassCode"><span class="toc-number">2.3.1.2.5.</span> <span class="toc-text">createAdaptiveExtensionClassCode</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ActivateExtension"><span class="toc-number">2.3.1.3.</span> <span class="toc-text">ActivateExtension</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#getActivateExtension"><span class="toc-number">2.3.1.3.1.</span> <span class="toc-text">getActivateExtension</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#加载META-INF接口相关实现类"><span class="toc-number">2.3.2.</span> <span class="toc-text">加载META-INF接口相关实现类</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#getExtensionClasses"><span class="toc-number">2.3.2.1.</span> <span class="toc-text">getExtensionClasses</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#loadExtensionClasses"><span class="toc-number">2.3.2.2.</span> <span class="toc-text">loadExtensionClasses</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#loadFile"><span class="toc-number">2.3.2.3.</span> <span class="toc-text">loadFile</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#从主要三个目录加载文件"><span class="toc-number">2.3.2.3.1.</span> <span class="toc-text">从主要三个目录加载文件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#分解name-line两部分"><span class="toc-number">2.3.2.3.2.</span> <span class="toc-text">分解name,line两部分</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#设定加cachedAdaptiveClass"><span class="toc-number">2.3.2.3.3.</span> <span class="toc-text">设定加cachedAdaptiveClass</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#添加cachedActivates"><span class="toc-number">2.3.2.3.4.</span> <span class="toc-text">添加cachedActivates</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#添加cachedNames-extensionClasses"><span class="toc-number">2.3.2.3.5.</span> <span class="toc-text">添加cachedNames,extensionClasses</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#服务-Consumer-Producer"><span class="toc-number">3.</span> <span class="toc-text">服务-Consumer,Producer</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#消费者"><span class="toc-number">3.1.</span> <span class="toc-text">消费者</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#消费者-服务引用"><span class="toc-number">3.1.1.</span> <span class="toc-text">消费者-服务引用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#流程序列图"><span class="toc-number">3.1.1.1.</span> <span class="toc-text">流程序列图</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#大致流程"><span class="toc-number">3.1.1.2.</span> <span class="toc-text">大致流程</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#消费者-调用"><span class="toc-number">3.1.2.</span> <span class="toc-text">消费者-调用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#流程序列图-1"><span class="toc-number">3.1.2.1.</span> <span class="toc-text">流程序列图</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#大致流程-1"><span class="toc-number">3.1.2.2.</span> <span class="toc-text">大致流程</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#生产者"><span class="toc-number">3.2.</span> <span class="toc-text">生产者</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#生产者-服务暴露"><span class="toc-number">3.2.1.</span> <span class="toc-text">生产者-服务暴露</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#流程序列图-2"><span class="toc-number">3.2.1.1.</span> <span class="toc-text">流程序列图</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#大致流程-2"><span class="toc-number">3.2.1.2.</span> <span class="toc-text">大致流程</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#本地暴露"><span class="toc-number">3.2.1.2.1.</span> <span class="toc-text">本地暴露</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#远程暴露"><span class="toc-number">3.2.1.2.2.</span> <span class="toc-text">远程暴露</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#注册中心-Zookeeper"><span class="toc-number">4.</span> <span class="toc-text">注册中心-Zookeeper</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#FailbackRegistry"><span class="toc-number">4.1.</span> <span class="toc-text">FailbackRegistry</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#网络模型-Netty"><span class="toc-number">5.</span> <span class="toc-text">网络模型-Netty</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#消费者-网络模型"><span class="toc-number">5.1.</span> <span class="toc-text">消费者-网络模型</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#参数功能点-URL"><span class="toc-number">6.</span> <span class="toc-text">参数功能点-URL</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#屏蔽功能"><span class="toc-number">6.1.</span> <span class="toc-text">屏蔽功能</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#dubbo管控台调控"><span class="toc-number">6.1.1.</span> <span class="toc-text">dubbo管控台调控</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Mock服务降级-amp-amp-容错机制"><span class="toc-number">6.2.</span> <span class="toc-text">Mock服务降级&amp;&amp;容错机制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#dubbo管控台调控-1"><span class="toc-number">6.2.1.</span> <span class="toc-text">dubbo管控台调控</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#初始化服务调控"><span class="toc-number">6.2.2.</span> <span class="toc-text">初始化服务调控</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#线程模型"><span class="toc-number">7.</span> <span class="toc-text">线程模型</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#业务线程模型"><span class="toc-number">7.1.</span> <span class="toc-text">业务线程模型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DubboRegistryFailedRetryTimer"><span class="toc-number">7.2.</span> <span class="toc-text">DubboRegistryFailedRetryTimer</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#forking-cluster-timer"><span class="toc-number">7.3.</span> <span class="toc-text">forking-cluster-timer</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#failback-cluster-timer"><span class="toc-number">7.4.</span> <span class="toc-text">failback-cluster-timer</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DubboClientHandler"><span class="toc-number">7.5.</span> <span class="toc-text">DubboClientHandler</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#dubbo-remoting-client-heartbeat"><span class="toc-number">7.6.</span> <span class="toc-text">dubbo-remoting-client-heartbeat</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DubboClientReconnectTimer"><span class="toc-number">7.7.</span> <span class="toc-text">DubboClientReconnectTimer</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DubboSaveRegistryCache"><span class="toc-number">7.8.</span> <span class="toc-text">DubboSaveRegistryCache</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DubboServerHandler"><span class="toc-number">7.9.</span> <span class="toc-text">DubboServerHandler</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#dubbo-remoting-server-heartbeat"><span class="toc-number">7.10.</span> <span class="toc-text">dubbo-remoting-server-heartbeat</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#handler包裹"><span class="toc-number">8.</span> <span class="toc-text">handler包裹</span></a></li></ol>
        
    </div>
</aside>

</header>

        <div id="content" class="content"><article class="article" itemscope="" itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
           Dubbo解析
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="/2017/08/25/dubbo/">
    
    <i class="icon-calendar"></i>
    
    <time datetime="2017-08-25T08:48:55.000Z" itemprop="datePublished">2017-08-25</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag"></i>
    <a class="article-tag-link" href="/tags/dubbo/">dubbo</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <p>Dubbo 源码解析<br><a id="more"></a></p>
<h1 id="集群容错"><a href="#集群容错" class="headerlink" title="集群容错"></a>集群容错</h1><p><img src="/2017/08/25/dubbo/image-01.png" alt="image-20180803143006952"></p>
<ul>
<li>Invoker: Provider 的一个可调用 Service 的抽象，Invoker 封装了 Provider 地址及 Service 接口信息  </li>
<li>Directory: 代表多个 Invoker,可以把它看成 List<invoker>,但与 List 不同的是，它的值可能是动态变化的，比如注册中心推送变更  </invoker></li>
<li>Cluster: 将 Directory 中的多个 Invoker 伪装成一个 Invoker，对上层透明，伪装过程包含了容错逻辑，调用失败后，重试另一个  </li>
<li>Router:负责从多个 Invoker 中按路由规则选出子集，比如读写分离，应用隔离等  </li>
<li>LoadBalance:负责从多个 Invoker 中选出具体的一个用于本次调用，选的过程包含了负载均衡算法，调用失败后，需要重选</li>
</ul>
<h2 id="Mock机制"><a href="#Mock机制" class="headerlink" title="Mock机制"></a>Mock机制</h2><p>可以通过服务降级功能临时屏蔽某个出错的非关键服务,并定义降级后的返回策略。<br>向注册中心写入动态配置覆盖规则：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">RegistryFactory registryFactory = ExtensionLoader.getExtensionLoader(RegistryFactory.class).getAdaptiveExtension();</span><br><span class="line">Registry registry = registryFactory.getRegistry(URL.valueOf(<span class="string">"zookeeper://10.20.153.10:2181"</span>));</span><br><span class="line">registry.register(URL.valueOf(<span class="string">"override://0.0.0.0/com.foo.BarService?category=configurators&amp;dynamic=false&amp;application=foo&amp;mock=force:return+null"</span>));</span><br></pre></td></tr></table></figure>
<ul>
<li>mock=force:return+null 表示消费方对该服务的方法调用都直接返回 null 值，不发起远程调用。用来屏蔽不重要服务不可用时对调用方的影响。</li>
<li>mock=fail:return+null 表示消费方对该服务的方法调用在失败后，再返回 null 值，不抛异常。用来容忍不重要服务不稳定时对调用方的影响。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;dubbo:service <span class="class"><span class="keyword">interface</span></span>=<span class="string">"com.foo.BarService"</span> mock=<span class="string">"true"</span> /&gt;</span><br><span class="line">&lt;dubbo:service <span class="class"><span class="keyword">interface</span></span>=<span class="string">"com.foo.BarService"</span> mock=<span class="string">"return null"</span> /&gt;</span><br></pre></td></tr></table></figure>
<h3 id="本地伪装"><a href="#本地伪装" class="headerlink" title="本地伪装"></a>本地伪装</h3><p>通常用于服务降级,比如某验权服务,当服务提供方全部挂掉后,客户端不抛出异常,而是通过 Mock 数据返回授权失败  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;dubbo:service <span class="class"><span class="keyword">interface</span></span>=<span class="string">"com.foo.BarService"</span> mock=<span class="string">"com.foo.BarServiceMock"</span> /&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.foo;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BarServiceMock</span> <span class="keyword">implements</span> <span class="title">BarService</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHello</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 你可以伪造容错数据，此方法只在出现RpcException时被执行</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"容错数据"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">MockClusterInvoker-&gt;doMockInvoke-&gt;selectMockInvoker  </span><br><span class="line">一般情况下selectMockInvoker都为<span class="keyword">null</span></span><br><span class="line">所以由MockInvoker包裹最终由MockInvoker#invoker  </span><br><span class="line"></span><br><span class="line"><span class="comment">//impl mock</span></span><br><span class="line"><span class="comment">//如果是一个本地伪装实现类则调用这个类实现的对象</span></span><br><span class="line"> <span class="keyword">try</span> &#123;</span><br><span class="line">     Invoker&lt;T&gt; invoker = getInvoker(mock);</span><br><span class="line">     <span class="keyword">return</span> invoker.invoke(invocation);</span><br><span class="line"> &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">     <span class="keyword">throw</span> <span class="keyword">new</span> RpcException(<span class="string">"Failed to create mock implemention class "</span> + mock , t);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h3 id="Cluster-gt-MockClusterWrapper"><a href="#Cluster-gt-MockClusterWrapper" class="headerlink" title="Cluster-&gt;MockClusterWrapper"></a>Cluster-&gt;MockClusterWrapper</h3><p>调用端mock的执行主要由MockClusterInvoker完成,MockClusterInvoker的invoke方法的执行逻辑如下     </p>
<ul>
<li>(1):如果在没有配置之中没有设置mock，那么直接把方法调用转发给实际的Invoker(也就是FailoverClusterInvoker)</li>
<li>(2):如果配置了强制执行Mock，比如发生服务降级，那么直接按照配置执行mock之后返回</li>
<li><p>(3):如果是其它的情况，比如只是配置的是mock=fail:return null,那么就是在正常的调用出现异常的时候按照配置执行mock      </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">String value = directory.getUrl().getMethodParameter(invocation.getMethodName(), Constants.MOCK_KEY, Boolean.FALSE.toString()).trim(); </span><br><span class="line"><span class="keyword">if</span> (value.length() == <span class="number">0</span> || value.equalsIgnoreCase(<span class="string">"false"</span>))&#123;</span><br><span class="line">    <span class="comment">//no mock</span></span><br><span class="line">    result = <span class="keyword">this</span>.invoker.invoke(invocation);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (value.startsWith(<span class="string">"force"</span>)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (logger.isWarnEnabled()) &#123;</span><br><span class="line">        logger.info(<span class="string">"force-mock: "</span> + invocation.getMethodName() + <span class="string">" force-mock enabled , url : "</span> +  directory.getUrl());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//force:direct mock</span></span><br><span class="line">    result = doMockInvoke(invocation, <span class="keyword">null</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">//fail-mock</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        result = <span class="keyword">this</span>.invoker.invoke(invocation);</span><br><span class="line">    &#125;<span class="keyword">catch</span> (RpcException e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (e.isBiz()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (logger.isWarnEnabled()) &#123;</span><br><span class="line">                logger.info(<span class="string">"fail-mock: "</span> + invocation.getMethodName() + <span class="string">" fail-mock enabled , url : "</span> +  directory.getUrl(), e);</span><br><span class="line">            &#125;</span><br><span class="line">            result = doMockInvoke(invocation, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>(4):通过(2)和(3)最终都会通过调用doMockInvoke来完成mock调用<br>  doMockInvoke方法会首先尝试调用selectMockInvoker方法来看看用户有没有配置过MockInvoker  </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Result <span class="title">doMockInvoke</span><span class="params">(Invocation invocation,RpcException e)</span></span>&#123;</span><br><span class="line">    Result result = <span class="keyword">null</span>;</span><br><span class="line">    Invoker&lt;T&gt; minvoker ;</span><br><span class="line">    </span><br><span class="line">    List&lt;Invoker&lt;T&gt;&gt; mockInvokers = selectMockInvoker(invocation);</span><br><span class="line">    <span class="keyword">if</span> (mockInvokers == <span class="keyword">null</span> || mockInvokers.size() == <span class="number">0</span>)&#123;</span><br><span class="line">        minvoker = (Invoker&lt;T&gt;) <span class="keyword">new</span> MockInvoker(directory.getUrl());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        minvoker = mockInvokers.get(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        result = minvoker.invoke(invocation);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RpcException me) &#123;</span><br><span class="line">        <span class="keyword">if</span> (me.isBiz()) &#123;</span><br><span class="line">            result = <span class="keyword">new</span> RpcResult(me.getCause());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RpcException(me.getCode(), getMockExceptionMessage(e, me), me.getCause());</span><br><span class="line">        &#125;       </span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable me) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RpcException(getMockExceptionMessage(e, me), me.getCause());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>selectMockInvoker的代码如下依靠在Invocation的attachment里面做个标记来告诉directory的list方法应该返回MockInvoker  </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> List&lt;Invoker&lt;T&gt;&gt; selectMockInvoker(Invocation invocation)&#123;</span><br><span class="line">    <span class="keyword">if</span> (invocation <span class="keyword">instanceof</span> RpcInvocation)&#123;</span><br><span class="line">        <span class="comment">//存在隐含契约(虽然在接口声明中增加描述，但扩展性会存在问题.同时放在attachement中的做法需要改进</span></span><br><span class="line">        ((RpcInvocation)invocation).setAttachment(Constants.INVOCATION_NEED_MOCK, Boolean.TRUE.toString());</span><br><span class="line">        <span class="comment">//directory根据invocation中attachment是否有Constants.INVOCATION_NEED_MOCK，来判断获取的是normal invokers or mock invokers</span></span><br><span class="line">        List&lt;Invoker&lt;T&gt;&gt; invokers = directory.list(invocation);</span><br><span class="line">        <span class="keyword">return</span> invokers;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span> ;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  directory是RegistryDirectory,RegistryDirectory的list方法里面与mock有关的部分主要是router  </p>
</li>
<li><p>selectMockInvoker一般返回的都是空,所以要用MockInvoker构造的进行invoke调用      </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Result <span class="title">invoke</span><span class="params">(Invocation invocation)</span> <span class="keyword">throws</span> RpcException </span>&#123;</span><br><span class="line">    String mock = getUrl().getParameter(invocation.getMethodName()+<span class="string">"."</span>+Constants.MOCK_KEY);</span><br><span class="line">    <span class="keyword">if</span> (invocation <span class="keyword">instanceof</span> RpcInvocation) &#123;</span><br><span class="line">        ((RpcInvocation) invocation).setInvoker(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(mock))&#123;</span><br><span class="line">        mock = getUrl().getParameter(Constants.MOCK_KEY);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(mock))&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RpcException(<span class="keyword">new</span> IllegalAccessException(<span class="string">"mock can not be null. url :"</span> + url));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    mock = normallizeMock(URL.decode(mock));</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (Constants.RETURN_PREFIX.trim().equalsIgnoreCase(mock.trim()))&#123;</span><br><span class="line">        <span class="comment">//如果没有mock=return关键字</span></span><br><span class="line">        RpcResult result = <span class="keyword">new</span> RpcResult();</span><br><span class="line">        result.setValue(<span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mock.startsWith(Constants.RETURN_PREFIX)) &#123;</span><br><span class="line">        <span class="comment">//mock关键字中有return则返回具体的return value</span></span><br><span class="line">        mock = mock.substring(Constants.RETURN_PREFIX.length()).trim();</span><br><span class="line">        mock = mock.replace(<span class="string">'`'</span>, <span class="string">'"'</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Type[] returnTypes = RpcUtils.getReturnTypes(invocation);</span><br><span class="line">            Object value = parseMockValue(mock, returnTypes);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> RpcResult(value);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ew) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RpcException(<span class="string">"mock return invoke error. method :"</span> + invocation.getMethodName() + <span class="string">", mock:"</span> + mock + <span class="string">", url: "</span>+ url , ew);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mock.startsWith(Constants.THROW_PREFIX)) &#123;</span><br><span class="line">        <span class="comment">//mock关键字中有throw则抛异常</span></span><br><span class="line">        mock = mock.substring(Constants.THROW_PREFIX.length()).trim();</span><br><span class="line">        mock = mock.replace(<span class="string">'`'</span>, <span class="string">'"'</span>);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(mock))&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RpcException(<span class="string">" mocked exception for Service degradation. "</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">//用户自定义类</span></span><br><span class="line">            Throwable t = getThrowable(mock);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RpcException(RpcException.BIZ_EXCEPTION, t);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">//impl mock</span></span><br><span class="line">        <span class="comment">//如果是一个本地伪装实现类则调用这个类实现的对象</span></span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">             Invoker&lt;T&gt; invoker = getInvoker(mock);</span><br><span class="line">             <span class="keyword">return</span> invoker.invoke(invocation);</span><br><span class="line">         &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">             <span class="keyword">throw</span> <span class="keyword">new</span> RpcException(<span class="string">"Failed to create mock implemention class "</span> + mock , t);</span><br><span class="line">         &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="Router-gt-MockInvokersRouter"><a href="#Router-gt-MockInvokersRouter" class="headerlink" title="Router-&gt;MockInvokersRouter"></a>Router-&gt;MockInvokersRouter</h3><p>由上面的<code>directory#list</code>函数过来route方法<br>RegistryDirectory在初始化内部的routers的时候,会人为的加上一个MockInvokerRouter  </p>
<h4 id="setRouters"><a href="#setRouters" class="headerlink" title="setRouters"></a>setRouters</h4><blockquote>
<p>增加MockInvokersRouter  </p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">AbstractDirectory#setRouters</span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setRouters</span><span class="params">(List&lt;Router&gt; routers)</span></span>&#123;  </span><br><span class="line">    <span class="comment">// copy list  </span></span><br><span class="line">    routers = routers == <span class="keyword">null</span> ? <span class="keyword">new</span>  ArrayList&lt;Router&gt;() : <span class="keyword">new</span> ArrayList&lt;Router&gt;(routers);  </span><br><span class="line">    <span class="comment">// append url router  </span></span><br><span class="line">    String routerValue = url.getParameter(Constants.ROUTER_KEY);  </span><br><span class="line">    <span class="keyword">if</span> (routerValue != <span class="keyword">null</span> &amp;&amp; routerValue.length() &gt; <span class="number">0</span>)&#123;  </span><br><span class="line">      RouterFactory routerFactory =   </span><br><span class="line">        ExtensionLoader.getExtensionLoader(RouterFactory.class).getExtension(routerValue);  </span><br><span class="line">      routers.add(routerFactory.getRouter(url));  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment">// append mock invoker selector  </span></span><br><span class="line">    routers.add(<span class="keyword">new</span> MockInvokersRouter());  </span><br><span class="line">    Collections.sort(routers);  </span><br><span class="line">    <span class="keyword">this</span>.routers = routers;  </span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h5 id="AbstractDirectory-list"><a href="#AbstractDirectory-list" class="headerlink" title="AbstractDirectory#list"></a>AbstractDirectory#list</h5><blockquote>
<p>RegistryDirectory的list方法最后由router来对invokers进行处理    </p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; List&lt;Invoker&lt;T&gt;&gt; route(<span class="keyword">final</span> List&lt;Invoker&lt;T&gt;&gt; invokers,URL url, <span class="keyword">final</span> Invocation invocation) <span class="keyword">throws</span> RpcException&#123;  </span><br><span class="line">    <span class="keyword">if</span> (invocation.getAttachments() == <span class="keyword">null</span>)&#123;  </span><br><span class="line">        <span class="keyword">return</span> getNormalInvokers(invokers);  </span><br><span class="line">    &#125;   </span><br><span class="line">    <span class="keyword">else</span>&#123;  </span><br><span class="line">        String value = invocation.getAttachments().get(Constants.INVOCATION_NEED_MOCK);  </span><br><span class="line">        <span class="keyword">if</span> (value == <span class="keyword">null</span>)&#123;  </span><br><span class="line">            <span class="keyword">return</span> getNormalInvokers(invokers);  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (Boolean.TRUE.toString().equalsIgnoreCase(value))&#123;  </span><br><span class="line">            <span class="keyword">return</span> getMockInvokers(invokers);  </span><br><span class="line">        &#125;   </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> invokers;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="getMockInvokers"><a href="#getMockInvokers" class="headerlink" title="getMockInvokers"></a>getMockInvokers</h5><blockquote>
<p>一般的情况下，是不会配置mock协议的，所以这个方法返回null  </p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> &lt;T&gt; List&lt;Invoker&lt;T&gt;&gt; getMockInvokers(<span class="keyword">final</span> List&lt;Invoker&lt;T&gt;&gt; invokers)  &#123;  </span><br><span class="line">    <span class="keyword">if</span> (! hasMockProviders(invokers))&#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">    List&lt;Invoker&lt;T&gt;&gt; resultInvokers = <span class="keyword">new</span> ArrayList&lt;Invoker&lt;T&gt;&gt;(<span class="number">1</span>);  </span><br><span class="line">    <span class="keyword">for</span> (Invoker&lt;T&gt; invoker : invokers)&#123;  </span><br><span class="line">        <span class="keyword">if</span> (invoker.getUrl().getProtocol().equals(Constants.MOCK_PROTOCOL))&#123;  </span><br><span class="line">            resultInvokers.add(invoker);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> resultInvokers;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Directory"><a href="#Directory" class="headerlink" title="Directory"></a>Directory</h2><p>Directory分<code>RegistryDirectory</code>和<code>StaticDirectory</code>  </p>
<h3 id="RegistryDirectory"><a href="#RegistryDirectory" class="headerlink" title="RegistryDirectory"></a>RegistryDirectory</h3><p><code>notify方法</code>为<code>NotifyListener</code>中的注册中心的回调能根据注册中心动态变化的根源所在  </p>
<h4 id="doList-服务读操作"><a href="#doList-服务读操作" class="headerlink" title="doList 服务读操作"></a>doList 服务读操作</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;Invoker&lt;T&gt;&gt; doList(Invocation invocation) &#123;</span><br><span class="line">    <span class="keyword">if</span> (forbidden) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RpcException(RpcException.FORBIDDEN_EXCEPTION, <span class="string">"Forbid consumer "</span> +  NetUtils.getLocalHost() + <span class="string">" access service "</span> + getInterface().getName() + <span class="string">" from registry "</span> + getUrl().getAddress() + <span class="string">" use dubbo version "</span> + Version.getVersion() + <span class="string">", Please check registry access list (whitelist/blacklist)."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    List&lt;Invoker&lt;T&gt;&gt; invokers = <span class="keyword">null</span>;</span><br><span class="line">    Map&lt;String, List&lt;Invoker&lt;T&gt;&gt;&gt; localMethodInvokerMap = <span class="keyword">this</span>.methodInvokerMap; <span class="comment">// local reference</span></span><br><span class="line">    <span class="keyword">if</span> (localMethodInvokerMap != <span class="keyword">null</span> &amp;&amp; localMethodInvokerMap.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        String methodName = RpcUtils.getMethodName(invocation);</span><br><span class="line">        Object[] args = RpcUtils.getArguments(invocation);</span><br><span class="line">        <span class="keyword">if</span>(args != <span class="keyword">null</span> &amp;&amp; args.length &gt; <span class="number">0</span> &amp;&amp; args[<span class="number">0</span>] != <span class="keyword">null</span></span><br><span class="line">                &amp;&amp; (args[<span class="number">0</span>] <span class="keyword">instanceof</span> String || args[<span class="number">0</span>].getClass().isEnum())) &#123;</span><br><span class="line">            invokers = localMethodInvokerMap.get(methodName + <span class="string">"."</span> + args[<span class="number">0</span>]); <span class="comment">// 可根据第一个参数枚举路由</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(invokers == <span class="keyword">null</span>) &#123;</span><br><span class="line">            invokers = localMethodInvokerMap.get(methodName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(invokers == <span class="keyword">null</span>) &#123;</span><br><span class="line">            invokers = localMethodInvokerMap.get(Constants.ANY_VALUE);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(invokers == <span class="keyword">null</span>) &#123;</span><br><span class="line">            Iterator&lt;List&lt;Invoker&lt;T&gt;&gt;&gt; iterator = localMethodInvokerMap.values().iterator();</span><br><span class="line">            <span class="keyword">if</span> (iterator.hasNext()) &#123;</span><br><span class="line">                invokers = iterator.next();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> invokers == <span class="keyword">null</span> ? <span class="keyword">new</span> ArrayList&lt;Invoker&lt;T&gt;&gt;(<span class="number">0</span>) : invokers;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>引入来源<code>this.methodInvokerMap</code>  </p>
<h4 id="notify-服务写操作"><a href="#notify-服务写操作" class="headerlink" title="notify 服务写操作"></a>notify 服务写操作</h4><p>注册中心有变化,则notify监听被执行      </p>
<p>更新methodInvokerMap和urlInvokerMap的值<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">notify</span><br><span class="line">|</span><br><span class="line">|</span><br><span class="line">|</span><br><span class="line">refreshInvoker</span><br><span class="line">|</span><br><span class="line">|</span><br><span class="line">|</span><br><span class="line">toInvokers拿newUrlInvokerMap</span><br><span class="line">|</span><br><span class="line">|</span><br><span class="line">|</span><br><span class="line">toMethodInvokers拿newMethodInvokerMap</span><br><span class="line">|</span><br><span class="line">|</span><br><span class="line">|</span><br><span class="line">变更成员变量</span><br><span class="line"><span class="keyword">this</span>.methodInvokerMap = multiGroup ? toMergeMethodInvokerMap(newMethodInvokerMap) : newMethodInvokerMap;</span><br><span class="line"><span class="keyword">this</span>.urlInvokerMap = newUrlInvokerMap;</span><br></pre></td></tr></table></figure></p>
<h3 id="StaticDirectory"><a href="#StaticDirectory" class="headerlink" title="StaticDirectory"></a>StaticDirectory</h3><p>StaticDirectory的Invoker是通过构造函数传入不支持对注册中心的服务引用  </p>
<h2 id="Cluster"><a href="#Cluster" class="headerlink" title="Cluster"></a>Cluster</h2><p>集群模式配置,按照以下示例在服务提供方和消费方配置集群模式</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dubbo:service</span> <span class="attr">cluster</span>=<span class="string">"failsafe"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dubbo:reference</span> <span class="attr">cluster</span>=<span class="string">"failsafe"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="MockClusterWrapper"><a href="#MockClusterWrapper" class="headerlink" title="MockClusterWrapper"></a>MockClusterWrapper</h3><blockquote>
<p>本地伪装通常用于服务降级<br>比如某验权服务,当服务提供方全部挂掉后,客户端不抛出异常,而是通过 Mock 数据返回授权失败  </p>
</blockquote>
<p>由于是Wrapper每次产生的Cluster后都会由这个类包裹  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;dubbo:service <span class="class"><span class="keyword">interface</span></span>=<span class="string">"com.foo.BarService"</span> mock=<span class="string">"true"</span> /&gt;</span><br><span class="line">&lt;dubbo:service <span class="class"><span class="keyword">interface</span></span>=<span class="string">"com.foo.BarService"</span> mock=<span class="string">"com.foo.BarServiceMock"</span> /&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.foo;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BarServiceMock</span> <span class="keyword">implements</span> <span class="title">BarService</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHello</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"容错数据"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;dubbo:service interface=&quot;com.foo.BarService&quot; mock=&quot;return null&quot; /&gt;</span><br><span class="line">//直接返回null</span><br></pre></td></tr></table></figure>
<h3 id="Mergeable-Cluster"><a href="#Mergeable-Cluster" class="headerlink" title="Mergeable Cluster"></a>Mergeable Cluster</h3><blockquote>
<p>分组聚合:按组合并返回结果<br>比如菜单服务接口一样，但有多种实现用group区分,现在消费方需从每种group中调用一次返回结果,合并结果返回,这样就可以实现聚合菜单项。  </p>
</blockquote>
<p><code>RegistryProtocol#refer</code>中有group的判断,如果有<code>Cluster</code>则为<code>MergeableCluster</code>  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">Invoker&lt;T&gt; <span class="title">refer</span><span class="params">(Class&lt;T&gt; type, URL url)</span> <span class="keyword">throws</span> RpcException </span>&#123;</span><br><span class="line">    url = url.setProtocol(url.getParameter(Constants.REGISTRY_KEY, Constants.DEFAULT_REGISTRY)).removeParameter(Constants.REGISTRY_KEY);</span><br><span class="line">    Registry registry = registryFactory.getRegistry(url);</span><br><span class="line">    <span class="keyword">if</span> (RegistryService.class.equals(type)) &#123;</span><br><span class="line">        <span class="keyword">return</span> proxyFactory.getInvoker((T) registry, type, url);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// group="a,b" or group="*"</span></span><br><span class="line">    Map&lt;String, String&gt; qs = StringUtils.parseQueryString(url.getParameterAndDecoded(Constants.REFER_KEY));</span><br><span class="line">    String group = qs.get(Constants.GROUP_KEY);</span><br><span class="line">    <span class="keyword">if</span> (group != <span class="keyword">null</span> &amp;&amp; group.length() &gt; <span class="number">0</span> ) &#123;</span><br><span class="line">        <span class="keyword">if</span> ( ( Constants.COMMA_SPLIT_PATTERN.split( group ) ).length &gt; <span class="number">1</span></span><br><span class="line">                || <span class="string">"*"</span>.equals( group ) ) &#123;</span><br><span class="line">            <span class="keyword">return</span> doRefer( getMergeableCluster(), registry, type, url );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> doRefer(cluster, registry, type, url);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Failover-Cluster"><a href="#Failover-Cluster" class="headerlink" title="Failover Cluster"></a>Failover Cluster</h3><p>失败自动切换，当出现失败，重试其它服务器 1。通常用于读操作，但重试会带来更长延迟。可通过 retries=”2” 来设置重试次数(不含第一次)。</p>
<p>重试次数配置如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;dubbo:service retries=&quot;2&quot; /&gt;</span><br><span class="line">&lt;dubbo:reference retries=&quot;2&quot; /&gt;</span><br><span class="line"></span><br><span class="line">&lt;dubbo:reference&gt;</span><br><span class="line">    &lt;dubbo:method name=&quot;findFoo&quot; retries=&quot;2&quot; /&gt;</span><br><span class="line">&lt;/dubbo:reference&gt;</span><br></pre></td></tr></table></figure></p>
<h3 id="Failfast-Cluster"><a href="#Failfast-Cluster" class="headerlink" title="Failfast Cluster"></a>Failfast Cluster</h3><p>快速失败，只发起一次调用，失败立即报错。通常用于非幂等性的写操作，比如新增记录。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Invoker&lt;T&gt; invoker = select(loadbalance, invocation, invokers, <span class="keyword">null</span>);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> invoker.invoke(invocation);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">    <span class="keyword">if</span> (e <span class="keyword">instanceof</span> RpcException &amp;&amp; ((RpcException)e).isBiz()) &#123; <span class="comment">// biz exception.</span></span><br><span class="line">        <span class="keyword">throw</span> (RpcException) e;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RpcException(.....);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码如上,遇到调用失败进入catch直接快速失败</p>
<h3 id="Failsafe-Cluster"><a href="#Failsafe-Cluster" class="headerlink" title="Failsafe Cluster"></a>Failsafe Cluster</h3><p>失败安全，出现异常时，直接忽略。通常用于写入审计日志等操作。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    checkInvokers(invokers, invocation);</span><br><span class="line">    Invoker&lt;T&gt; invoker = select(loadbalance, invocation, invokers, <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">return</span> invoker.invoke(invocation);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">    logger.error(<span class="string">"Failsafe ignore exception: "</span> + e.getMessage(), e);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> RpcResult(); <span class="comment">// ignore</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Failback-Cluster"><a href="#Failback-Cluster" class="headerlink" title="Failback Cluster"></a>Failback Cluster</h3><p>失败自动恢复，后台记录失败请求，定时重发。通常用于消息通知操作。</p>
<p><code>failback-cluster-timer</code>线程池用于定时重发  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//启动一个failback-cluster-timer线程池  </span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ScheduledExecutorService scheduledExecutorService = Executors.newScheduledThreadPool(<span class="number">2</span>, <span class="keyword">new</span> NamedThreadFactory(<span class="string">"failback-cluster-timer"</span>, <span class="keyword">true</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    checkInvokers(invokers, invocation);</span><br><span class="line">    Invoker&lt;T&gt; invoker = select(loadbalance, invocation, invokers, <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">return</span> invoker.invoke(invocation);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">    logger.error(<span class="string">"Failback to invoke method "</span> + invocation.getMethodName() + <span class="string">", wait for retry in background. Ignored exception: "</span></span><br><span class="line">                         + e.getMessage() + <span class="string">", "</span>, e);</span><br><span class="line">    addFailed(invocation, <span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> RpcResult(); <span class="comment">// ignore</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addFailed</span><span class="params">(Invocation invocation, AbstractClusterInvoker&lt;?&gt; router)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (retryFuture == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (retryFuture == <span class="keyword">null</span>) &#123;</span><br><span class="line">                retryFuture = scheduledExecutorService.scheduleWithFixedDelay(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        <span class="comment">// 收集统计信息</span></span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            retryFailed();</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (Throwable t) &#123; <span class="comment">// 防御性容错</span></span><br><span class="line">                            logger.error(<span class="string">"Unexpected error occur at collect statistic"</span>, t);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;, RETRY_FAILED_PERIOD, RETRY_FAILED_PERIOD, TimeUnit.MILLISECONDS);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    failed.put(invocation, router);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">retryFailed</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (failed.size() == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;Invocation, AbstractClusterInvoker&lt;?&gt;&gt; entry : <span class="keyword">new</span> HashMap&lt;Invocation, AbstractClusterInvoker&lt;?&gt;&gt;(failed).entrySet()) &#123;</span><br><span class="line">        Invocation invocation = entry.getKey();</span><br><span class="line">        Invoker&lt;?&gt; invoker = entry.getValue();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            invoker.invoke(invocation);</span><br><span class="line">            failed.remove(invocation);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            logger.error(<span class="string">"Failed retry to invoke method "</span> + invocation.getMethodName() + <span class="string">", waiting again."</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Forking-Cluster"><a href="#Forking-Cluster" class="headerlink" title="Forking Cluster"></a>Forking Cluster</h3><p>并行调用多个服务器，只要一个成功即返回。<br>通常用于实时性要求较高的读操作，但需要浪费更多服务资源。可通过 forks=”2” 来设置最大并行数。</p>
<p><code>forking-cluster-timer</code>线程池用于并发,<code>forks</code>调用默认为2(invokers的length长度为2)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ExecutorService executor = Executors.newCachedThreadPool(<span class="keyword">new</span> NamedThreadFactory(<span class="string">"forking-cluster-timer"</span>, <span class="keyword">true</span>));</span><br><span class="line"></span><br><span class="line">selected = <span class="keyword">new</span> ArrayList&lt;Invoker&lt;T&gt;&gt;();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; forks; i++) &#123;</span><br><span class="line">    <span class="comment">//在invoker列表(排除selected)后,如果没有选够,则存在重复循环问题.见select实现.</span></span><br><span class="line">    Invoker&lt;T&gt; invoker = select(loadbalance, invocation, invokers, selected);</span><br><span class="line">    <span class="keyword">if</span>(!selected.contains(invoker))&#123;<span class="comment">//防止重复添加invoker</span></span><br><span class="line">        selected.add(invoker);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">final</span> Invoker&lt;T&gt; invoker : selected) &#123;</span><br><span class="line">    executor.execute(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Result result = invoker.invoke(invocation);</span><br><span class="line">                ref.offer(result);</span><br><span class="line">            &#125; <span class="keyword">catch</span>(Throwable e) &#123;</span><br><span class="line">                <span class="keyword">int</span> value = count.incrementAndGet();</span><br><span class="line">                <span class="keyword">if</span> (value &gt;= selected.size()) &#123;</span><br><span class="line">                    ref.offer(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Broadcast-Cluster"><a href="#Broadcast-Cluster" class="headerlink" title="Broadcast Cluster"></a>Broadcast Cluster</h3><p>广播调用所有提供者，逐个调用，任意一台报错则报错。<br>通常用于通知所有提供者更新缓存或日志等本地资源信息。    </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (Invoker&lt;T&gt; invoker: invokers) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        result = invoker.invoke(invocation);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RpcException e) &#123;</span><br><span class="line">        exception = e;</span><br><span class="line">        logger.warn(e.getMessage(), e);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">        exception = <span class="keyword">new</span> RpcException(e.getMessage(), e);</span><br><span class="line">        logger.warn(e.getMessage(), e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (exception != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> exception;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Route"><a href="#Route" class="headerlink" title="Route"></a>Route</h2><p>有三个实现类,分别是ConditionRouter,MockInvokersSelector,ScriptRouter    </p>
<p>route两处使用</p>
<ul>
<li>第一处为notify写入invoker的时候利用了ConditionRoute进行一个条件筛选</li>
<li>第二处为invoker.invoke()执行调用的时候，list读取invoker的时候利用MockInvokersSelector进行一个mock包装</li>
</ul>
<h3 id="MockInvokersSelector"><a href="#MockInvokersSelector" class="headerlink" title="MockInvokersSelector"></a>MockInvokersSelector</h3><blockquote>
<p>list:调用的时候读取invoker  </p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">router.getUrl() == <span class="keyword">null</span> 选定MockInvokersSelector  </span><br><span class="line">参数值`invocation.need.mock`有</span><br><span class="line">并且`invocation.getAttachments`不为空则返回`MockedInvokers`否则返回`NormalInvokers`</span><br></pre></td></tr></table></figure>
<ul>
<li>MockedInvokers:url中带有mock的提供者</li>
<li>NormalInvokers:url中带没有mock的提供者</li>
</ul>
<h3 id="ConditionRouter-条件路由"><a href="#ConditionRouter-条件路由" class="headerlink" title="ConditionRouter(条件路由)"></a>ConditionRouter(条件路由)</h3><p>条件路由主要就是根据dubbo管理控制台配置的路由规则来过滤相关的invoker<br>当我们对路由规则点击启用的时候,就会触发RegistryDirectory类的<code>notify</code>方法中  </p>
<blockquote>
<p>notify:写入invoker的时候会引入ConditionRouter进行</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">router.getUrl() != null判断过滤掉MockInvokersSelector</span><br><span class="line">ConditionRouter的matchThen进行主要的invoker过滤</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//----&gt;notify</span></span><br><span class="line"><span class="keyword">if</span> (routerUrls != <span class="keyword">null</span> &amp;&amp; routerUrls.size() &gt;<span class="number">0</span> )&#123;</span><br><span class="line">    List&lt;Router&gt; routers = toRouters(routerUrls);</span><br><span class="line">    <span class="keyword">if</span>(routers != <span class="keyword">null</span>)&#123; <span class="comment">// null - do nothing</span></span><br><span class="line">        setRouters(routers);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//----&gt;refreshInvoker----&gt;toMethodInvokers  </span></span><br><span class="line">newMethodInvokerMap.put(method, route(methodInvokers, method));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> List&lt;Invoker&lt;T&gt;&gt; route(List&lt;Invoker&lt;T&gt;&gt; invokers, String method) &#123;</span><br><span class="line">    Invocation invocation = <span class="keyword">new</span> RpcInvocation(method, <span class="keyword">new</span> Class&lt;?&gt;[<span class="number">0</span>], <span class="keyword">new</span> Object[<span class="number">0</span>]);</span><br><span class="line">    List&lt;Router&gt; routers = getRouters(); </span><br><span class="line">    <span class="keyword">if</span> (routers != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Router router : routers) &#123;</span><br><span class="line">            <span class="keyword">if</span> (router.getUrl() != <span class="keyword">null</span> &amp;&amp; ! router.getUrl().getParameter(Constants.RUNTIME_KEY, <span class="keyword">true</span>)) &#123;</span><br><span class="line">                invokers = router.route(invokers, getConsumerUrl(), invocation);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> invokers;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//主要做条件路由的入口</span></span><br><span class="line">router.route(invokers, getConsumerUrl(), invocation);</span><br></pre></td></tr></table></figure>
<h2 id="Loadbalance"><a href="#Loadbalance" class="headerlink" title="Loadbalance"></a>Loadbalance</h2><h3 id="RoundRobin-LoadBalance"><a href="#RoundRobin-LoadBalance" class="headerlink" title="RoundRobin LoadBalance"></a>RoundRobin LoadBalance</h3><p>随机，按权重设置随机概率。<br>在一个截面上碰撞的概率高，但调用量越大分布越均匀，而且按概率使用权重后也比较均匀，有利于动态调整提供者权重。  </p>
<h4 id="不同权重值"><a href="#不同权重值" class="headerlink" title="不同权重值"></a>不同权重值</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">服务A,B,C各个权重值: 1, 2, 3</span><br><span class="line">1:维护调用次数自增值</span><br><span class="line">2:调用次数取模计算 (i % maxWeight) 最大的权重值  </span><br><span class="line">3:选择取模数为列表下标作为选中invoker</span><br></pre></td></tr></table></figure>
<h4 id="相同权重值"><a href="#相同权重值" class="headerlink" title="相同权重值"></a>相同权重值</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">服务A,B,C各个权重值: 1, 3, 3</span><br><span class="line">1:维护调用次数自增值</span><br><span class="line">2:调用次数取模计算 (i % maxWeight) 最大的权重值  </span><br><span class="line">3:如遇到相同权重, 再次取模运算( i % length) length为相同权重值的长度</span><br></pre></td></tr></table></figure>
<h3 id="Random-LoadBalance"><a href="#Random-LoadBalance" class="headerlink" title="Random LoadBalance"></a>Random LoadBalance</h3><p>轮循，按公约后的权重设置轮循比率。<br>存在慢的提供者累积请求的问题，比如：第二台机器很慢，但没挂，当请求调到第二台时就卡在那，久而久之，所有请求都卡在调到第二台上。 </p>
<h4 id="不同权重值-1"><a href="#不同权重值-1" class="headerlink" title="不同权重值"></a>不同权重值</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">服务A,B,C各个权重值为 1, 2, 3</span><br><span class="line">1:取出总权重值(1+2+3)</span><br><span class="line">2:random.next(总权重值)</span><br><span class="line">3:随机出来的数字 -= 将服务权重从小到大排序 如果小于 0 即可调用</span><br><span class="line"></span><br><span class="line">int offset = random.nextInt(totalWeight);</span><br><span class="line">for (int i = 0; i &lt; length; i++) &#123;</span><br><span class="line">    offset -= getWeight(invokers.get(i), invocation);</span><br><span class="line">    if (offset &lt; 0) &#123;</span><br><span class="line">        return invokers.get(i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="相同权重值-1"><a href="#相同权重值-1" class="headerlink" title="相同权重值"></a>相同权重值</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">服务A,B,C各个权重值为1, 3 ,3</span><br><span class="line">1:首先会去判断sameWeight 相等权重会不会出现</span><br><span class="line">2:如遇出现直接random.next(length) length为所有invoker的数量</span><br><span class="line">3:随机出来的直接调用</span><br></pre></td></tr></table></figure>
<h3 id="LeastActive-LoadBalance"><a href="#LeastActive-LoadBalance" class="headerlink" title="LeastActive LoadBalance"></a>LeastActive LoadBalance</h3><p>最少活跃调用数，相同活跃数的随机，活跃数指调用前后计数差。<br>使慢的提供者收到更少请求，因为越慢的提供者的调用前后计数差会越大。  </p>
<blockquote>
<p>每个服务维护一个活跃数计数器。当A机器开始处理请求，该计数器加1，此时A还未处理完成。若处理完毕则计数器减1。而B机器接受到请求后很快处理完毕。那么A,B的活跃数分别是1，0。当又产生了一个新的请求，则选择B机器去执行(B活跃数最小)，这样使慢的机器A收到少的请求。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">服务A,B,C各个权重值为 1, 2, 3</span><br><span class="line">1:遍历invoker从RpcStatus获取active活跃数以及当前invoker的权重weight  </span><br><span class="line"></span><br><span class="line">2:遍历判断,如遇到active比之前记录的leastActive(最小活跃数)还小</span><br><span class="line">则刷新leastActive的值还有leastCount最小活跃数invoker的数量以及leastIndexs相关的invokers里面的下标  </span><br><span class="line">以及把当前的权重成为totalWeight  </span><br><span class="line"></span><br><span class="line">3:遍历判断,如遇到跟之前leastActive一致的则直接添加leastIndexs和leastActive递增</span><br><span class="line">并且叠加totalWeight,以及表示是否还有相同权重的情况sameWeight</span><br><span class="line"></span><br><span class="line">4:如果没有遇到相同活跃数的直接调用</span><br><span class="line"></span><br><span class="line">5:如果遇到相同活跃数但是权重不等的</span><br><span class="line">random.nextInt(totalWeight) 随机值,然后以随机轮询的方法处理</span><br><span class="line">即随机值 -= 每个invoker的权重weight 如果小于 0 即刻调用</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">6:如果遇到相同活跃数与相同权重值</span><br><span class="line">invokers.get(leastIndexs[random.nextInt(leastCount)])</span><br><span class="line">在活跃数列表中长度随机调用</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h3 id="ConsistentHash-LoadBalance"><a href="#ConsistentHash-LoadBalance" class="headerlink" title="ConsistentHash LoadBalance"></a>ConsistentHash LoadBalance</h3><p>一致性 Hash，相同参数的请求总是发到同一提供者。<br>当某一台提供者挂时，原本发往该提供者的请求，基于虚拟节点，平摊到其它提供者，不会引起剧烈变动。<br>算法参见：<a href="http://en.wikipedia.org/wiki/Consistent_hashing" target="_blank" rel="noopener">http://en.wikipedia.org/wiki/Consistent_hashing</a><br>缺省只对第一个参数 Hash，如果要修改，请配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;dubbo:parameter key=&quot;hash.arguments&quot; value=&quot;0,1&quot; /&gt;</span><br></pre></td></tr></table></figure></p>
<p>缺省用 160 份虚拟节点，如果要修改，请配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;dubbo:parameter key=&quot;hash.nodes&quot; value=&quot;320&quot; /&gt;</span><br></pre></td></tr></table></figure></p>
<p><br><br><br><br><br></p>
<h1 id="SPI扩展-ExtensionLoader"><a href="#SPI扩展-ExtensionLoader" class="headerlink" title="SPI扩展-ExtensionLoader"></a>SPI扩展-ExtensionLoader</h1><h2 id="变量说明"><a href="#变量说明" class="headerlink" title="变量说明"></a>变量说明</h2><p>实例变量根据你的服务接口变化<br>类变量整个JVM共享  </p>
<table>
<thead>
<tr>
<th>变量名</th>
<th>类型</th>
<th>功能</th>
<th>示例</th>
</tr>
</thead>
<tbody>
<tr>
<td>EXTENSION_LOADERS</td>
<td>类变量</td>
<td>各个接口下对象加载器实例</td>
<td>key为接口Class,value为ExtensionLoader</td>
</tr>
<tr>
<td>EXTENSION_INSTANCES</td>
<td>类变量</td>
<td>各个接口实现类</td>
<td>key为实现类的Class,value为Object实现对象</td>
</tr>
<tr>
<td>cachedClasses</td>
<td>实例变量</td>
<td>缓存从META-INF拿到的所有实现类</td>
<td>一个hodler,value为Map,Map[“name”-&gt;Class]</td>
</tr>
<tr>
<td>cachedNames</td>
<td>实例变量</td>
<td>缓存从META-INF拿到的所有实现类</td>
<td>一个ConcurrentMap,key为Class,value为name</td>
</tr>
<tr>
<td>cachedInstances</td>
<td>实例变量</td>
<td>holder缓存,holder的value</td>
<td>key为name,value为hodler,hodler的value为目标对象</td>
</tr>
<tr>
<td>cachedAdaptiveInstance</td>
<td>实例变量</td>
<td>holder value缓存<code>XX@Adaptive</code>相关对象实例</td>
<td>Holder[value=Xxx@Adaptive]</td>
</tr>
<tr>
<td>cachedActivates</td>
<td>实例变量</td>
<td>缓存activate相关的信息</td>
<td>一个Map,key为META-INF的name,value为<code>@Activate</code>注解到Class上的注解信息</td>
</tr>
</tbody>
</table>
<p><br><br><br><br><br></p>
<h2 id="功能说明"><a href="#功能说明" class="headerlink" title="功能说明"></a>功能说明</h2><ul>
<li>getActivateExtension:根据注解条件结合Key获取当前扩展可自动激活的实现<br>  例如@Activate(group = Constants.PROVIDER),只给生产者端<br>  URL中又指定key,@Activate(value=”限定key的value值”)</li>
<li>getExtension:直接根据名称获取当前扩展的指定实现</li>
<li>getAdaptiveExtension : 所有类都会变成XX@Adaptive,根据获取URL的参数自适应拿对象,未指定取@SPI的name</li>
</ul>
<h3 id="获取实例-操作流程"><a href="#获取实例-操作流程" class="headerlink" title="获取实例-操作流程"></a>获取实例-操作流程</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Adaptive</span></span><br><span class="line">Xxx接口 对象 = ExtensionLoader.getExtensionLoader(Xxx.class).getAdaptiveExtension();</span><br><span class="line"> </span><br><span class="line"><span class="comment">//Activate</span></span><br><span class="line">List&lt;Xxx接口&gt; animals = ExtensionLoader.getExtensionLoader(Xxx接口.class).getActivateExtension(</span><br><span class="line">                <span class="keyword">new</span> URL(<span class="string">"protocol"</span>, <span class="string">"host"</span>,</span><br><span class="line">                        <span class="number">80</span>,<span class="comment">//port</span></span><br><span class="line">                        ImmutableMap.of(<span class="string">"key"</span>,<span class="string">"指定你的value"</span>))</span><br><span class="line">                , <span class="string">"key"</span> <span class="comment">//指定你的key</span></span><br><span class="line">                , Constants.PROVIDER);  <span class="comment">//指定你的group</span></span><br><span class="line">                </span><br><span class="line"><span class="comment">//Extension                </span></span><br><span class="line">Xxx接口 对象 = ExtensionLoader.getExtensionLoader(Xxx接口.class).getExtension(<span class="string">"META-INF的name"</span>);</span><br></pre></td></tr></table></figure>
<p>每个接口都会实例化一个<code>ExtensionLoader</code>,为这个接口提供附属的关联对象类<br>如果之前有实例化过会缓存到<code>EXTENSION_LOADERS</code>,后期直接从这个变量拿<br>首次实例化某个接口的<code>ExtensionLoader</code>,附带会实例化<code>ExtensionFactory</code>的加载器<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">ExtensionLoader</span><span class="params">(Class&lt;?&gt; type)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.type = type;</span><br><span class="line">    objectFactory = (type == ExtensionFactory.class ? <span class="keyword">null</span> :</span><br><span class="line">                    ExtensionLoader.getExtensionLoader(ExtensionFactory.class).getAdaptiveExtension());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>当实例化<code>ExtensionFactory</code>的时候,代码<code>type == ExtensionFactory.class</code>会生效直接返回null<br>接下来会先走<code>ExtensionFactory</code>的<code>getAdaptiveExtension</code>生成<code>AdaptiveExtensionFactory</code><br>然后走你相关的类加载器的<code>getAdaptiveExtension</code>生成<code>Xxxx接口@Adaptive</code><br>具体的<code>getAdaptiveExtension</code> 代码会有解释  </p>
<p><br><br><br></p>
<h3 id="Adaptive"><a href="#Adaptive" class="headerlink" title="Adaptive"></a>Adaptive</h3><h4 id="面向用户操作"><a href="#面向用户操作" class="headerlink" title="面向用户操作"></a>面向用户操作</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ExtensionLoader.getExtensionLoader(你的接口.class).getAdaptiveExtension();</span><br></pre></td></tr></table></figure>
<p>根据你的<code>@Adaptive({&quot;key&quot;})</code>,在构建URL中的map参数中你注解指定的<code>key</code>的<code>value</code>,来寻找<code>META-INF</code>对应的<code>name</code>的实现类  </p>
<h4 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SPI</span>(<span class="string">"man"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">People</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Adaptive</span>(&#123;<span class="string">"key"</span>&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">say</span><span class="params">(URL url,String msg)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Adaptive</span>(&#123;<span class="string">"key"</span>&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">eat</span><span class="params">(URL url, String msg)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Man</span> <span class="keyword">implements</span> <span class="title">People</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">say</span><span class="params">(URL url, String msg)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"man say "</span> + msg);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">eat</span><span class="params">(URL url, String msg)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"man eat "</span> + msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Woman</span> <span class="keyword">implements</span> <span class="title">People</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">say</span><span class="params">(URL url, String msg)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"woman say "</span> + msg);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">eat</span><span class="params">(URL url, String msg)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"woman eat "</span> + msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//man=cn.coderss.service.impl.Man</span></span><br><span class="line"><span class="comment">//women=cn.coderss.service.impl.Woman</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        People people = ExtensionLoader.getExtensionLoader(People.class).getAdaptiveExtension();</span><br><span class="line">        <span class="comment">//参数</span></span><br><span class="line">        HashMap&lt;String,String&gt; map = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line">        URL url = <span class="keyword">new</span> URL(<span class="string">"p1"</span>, <span class="string">"1.2.3.4"</span>, <span class="number">1010</span>, <span class="string">"path"</span>, map);</span><br><span class="line">        people.say(url, <span class="string">"test"</span>);</span><br><span class="line">        <span class="comment">//重新构建URL</span></span><br><span class="line">        map.put(<span class="string">"key"</span>, <span class="string">"women"</span>);</span><br><span class="line">        URL url2 = <span class="keyword">new</span> URL(<span class="string">"p1"</span>, <span class="string">"1.2.3.4"</span>, <span class="number">1010</span>, <span class="string">"path"</span>, map);</span><br><span class="line">        people.say(url2, <span class="string">"test"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//man say test</span></span><br><span class="line"><span class="comment">//woman say test</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="Activate"><a href="#Activate" class="headerlink" title="Activate"></a>Activate</h3><h4 id="面向用户操作-1"><a href="#面向用户操作-1" class="headerlink" title="面向用户操作"></a>面向用户操作</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Animal&gt; animals = ExtensionLoader.getExtensionLoader(Animal.class).getActivateExtension(</span><br><span class="line">                <span class="keyword">new</span> URL(<span class="string">"p1"</span>, <span class="string">"1.2.3.4."</span>,</span><br><span class="line">                        <span class="number">1010</span>,</span><br><span class="line">                        ImmutableMap.of(<span class="string">"key"</span>,<span class="string">"cat"</span>))</span><br><span class="line">                , <span class="string">"key"</span>, Constants.PROVIDER);</span><br></pre></td></tr></table></figure>
<p><code>key</code>指定key后map中用你指定的key添加value,这个value后期用作<code>@Activate(value=&quot;你之前map中指定的value&quot;)</code><br><code>group</code>可消费者可生产者  </p>
<h4 id="示例-1"><a href="#示例-1" class="headerlink" title="示例"></a>示例</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SPI</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Animal</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">say</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Activate</span>(group = Constants.PROVIDER,value = <span class="string">"cat"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Cat</span> <span class="keyword">implements</span> <span class="title">Animal</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">say</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"cat say"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Activate</span>(group = Constants.PROVIDER,value = <span class="string">"dog"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Dog</span> <span class="keyword">implements</span> <span class="title">Animal</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">say</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"dog say"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//dog=cn.coderss.service.impl.Dog</span></span><br><span class="line"><span class="comment">//cat=cn.coderss.service.impl.Cat</span></span><br><span class="line"></span><br><span class="line">List&lt;Animal&gt; animals = ExtensionLoader.getExtensionLoader(Animal.class).getActivateExtension(</span><br><span class="line">        <span class="keyword">new</span> URL(<span class="string">"p1"</span>, <span class="string">"1.2.3.4."</span>,</span><br><span class="line">                <span class="number">1010</span>,</span><br><span class="line">                ImmutableMap.of(<span class="string">"key"</span>,<span class="string">"cat"</span>)) </span><br><span class="line">        , <span class="string">"key"</span>, Constants.PROVIDER);</span><br><span class="line">        <span class="comment">//dog的实现类会被忽略</span></span><br><span class="line"><span class="keyword">for</span> (Animal animal:animals)&#123;</span><br><span class="line">    animal.say();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="Extension"><a href="#Extension" class="headerlink" title="Extension"></a>Extension</h3><p>直接指定META-INF中的name对应实现类,进行关联和获取扩展实现类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ExtensionLoader.getExtensionLoader(你的接口.class).getExtension(<span class="string">"你的name"</span>);</span><br></pre></td></tr></table></figure></p>
<h4 id="示例-2"><a href="#示例-2" class="headerlink" title="示例"></a>示例</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Cat</span> <span class="keyword">implements</span> <span class="title">Animal</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">say</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"cat say"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SPI</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Animal</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">say</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//cat=cn.coderss.service.impl.Cat</span></span><br><span class="line"></span><br><span class="line">Animal cat = ExtensionLoader.getExtensionLoader(Animal.class).getExtension(<span class="string">"cat"</span>);</span><br><span class="line">cat.say();</span><br></pre></td></tr></table></figure>
<p><br><br><br><br><br></p>
<h2 id="加载流程"><a href="#加载流程" class="headerlink" title="加载流程"></a>加载流程</h2><h3 id="取相关实现类"><a href="#取相关实现类" class="headerlink" title="取相关实现类"></a>取相关实现类</h3><h4 id="Extension-1"><a href="#Extension-1" class="headerlink" title="Extension"></a>Extension</h4><h5 id="getExtension"><a href="#getExtension" class="headerlink" title="getExtension"></a>getExtension</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">getExtension</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (name == <span class="keyword">null</span> || name.length() == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Extension name == null"</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">"true"</span>.equals(name)) &#123;</span><br><span class="line">        <span class="keyword">return</span> getDefaultExtension();</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//前方为参数检查</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//检查cachedInstances是否有holder缓存  </span></span><br><span class="line">    Holder&lt;Object&gt; holder = cachedInstances.get(name);</span><br><span class="line">    <span class="keyword">if</span> (holder == <span class="keyword">null</span>) &#123;</span><br><span class="line">        cachedInstances.putIfAbsent(name, <span class="keyword">new</span> Holder&lt;Object&gt;());</span><br><span class="line">        holder = cachedInstances.get(name);</span><br><span class="line">    &#125;</span><br><span class="line">    Object instance = holder.get();</span><br><span class="line">    <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (holder) &#123;</span><br><span class="line">            instance = holder.get();</span><br><span class="line">            <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">                instance = createExtension(name);</span><br><span class="line">                holder.set(instance);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (T) instance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="createExtension"><a href="#createExtension" class="headerlink" title="createExtension"></a>createExtension</h5><p>从<code>getExtensionClasses</code>中的<code>cachedClasses</code>拿取相关的缓存实现类<br>拿到Class后去<code>EXTENSION_INSTANCES</code>取这个全局变量内是否有此Class的对象<br>有则返回,无则<code>clazz.newInstance()</code>实例化<br>查询此接口是否有<code>wrapperClasses</code></p>
<blockquote>
<p><code>wrapperClasses</code>:即构造函数是否为本接口的Class,有则为wrapperClasses  </p>
</blockquote>
<p>如果有<code>wrapperClasses</code>相关的类,则将上一轮实例化后的对象再放入此构造器被<code>wrapperClass</code>包裹<br>最后进行一次<code>injectExtension</code>进行处理    </p>
<blockquote>
<p><code>injectExtension</code>:查是否有set函数,有且只有一个参数,且public修饰符则进行自动注入</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> T <span class="title">createExtension</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    Class&lt;?&gt; clazz = getExtensionClasses().get(name);</span><br><span class="line">    <span class="keyword">if</span> (clazz == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> findException(name);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        T instance = (T) EXTENSION_INSTANCES.get(clazz);</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            EXTENSION_INSTANCES.putIfAbsent(clazz, (T) clazz.newInstance());</span><br><span class="line">            instance = (T) EXTENSION_INSTANCES.get(clazz);</span><br><span class="line">        &#125;</span><br><span class="line">        injectExtension(instance);</span><br><span class="line">        Set&lt;Class&lt;?&gt;&gt; wrapperClasses = cachedWrapperClasses;</span><br><span class="line">        <span class="keyword">if</span> (wrapperClasses != <span class="keyword">null</span> &amp;&amp; wrapperClasses.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Class&lt;?&gt; wrapperClass : wrapperClasses) &#123;</span><br><span class="line">                instance = injectExtension((T) wrapperClass.getConstructor(type).newInstance(instance));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Extension instance(name: "</span> + name + <span class="string">", class: "</span> +</span><br><span class="line">                type + <span class="string">")  could not be instantiated: "</span> + t.getMessage(), t);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="injectExtension"><a href="#injectExtension" class="headerlink" title="injectExtension"></a>injectExtension</h5><p>判断是否有set函数且参数为1个且为public<br>如果有则进行自动注入  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> T <span class="title">injectExtension</span><span class="params">(T instance)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (objectFactory != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Method method : instance.getClass().getMethods()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (method.getName().startsWith(<span class="string">"set"</span>)</span><br><span class="line">                        &amp;&amp; method.getParameterTypes().length == <span class="number">1</span></span><br><span class="line">                        &amp;&amp; Modifier.isPublic(method.getModifiers())) &#123;</span><br><span class="line">                    Class&lt;?&gt; pt = method.getParameterTypes()[<span class="number">0</span>];</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        String property = method.getName().length() &gt; <span class="number">3</span> ? method.getName().substring(<span class="number">3</span>, <span class="number">4</span>).toLowerCase() + method.getName().substring(<span class="number">4</span>) : <span class="string">""</span>;</span><br><span class="line">                        Object object = objectFactory.getExtension(pt, property);</span><br><span class="line">                        <span class="keyword">if</span> (object != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            method.invoke(instance, object);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                        logger.error(<span class="string">"fail to inject via method "</span> + method.getName()</span><br><span class="line">                                + <span class="string">" of interface "</span> + type.getName() + <span class="string">": "</span> + e.getMessage(), e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        logger.error(e.getMessage(), e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> instance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h4 id="AdaptiveExtension"><a href="#AdaptiveExtension" class="headerlink" title="AdaptiveExtension"></a>AdaptiveExtension</h4><h5 id="getAdaptiveExtension"><a href="#getAdaptiveExtension" class="headerlink" title="getAdaptiveExtension"></a>getAdaptiveExtension</h5><p>从<code>cachedAdaptiveInstance</code>拿,如不存在则创建,<code>cachedAdaptiveInstance</code>为实例变量不共享,根据你的接口而变  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> T <span class="title">getAdaptiveExtension</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Object instance = cachedAdaptiveInstance.get();</span><br><span class="line">    <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(createAdaptiveInstanceError == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (cachedAdaptiveInstance) &#123;</span><br><span class="line">                instance = cachedAdaptiveInstance.get();</span><br><span class="line">                <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        instance = createAdaptiveExtension();</span><br><span class="line">                        cachedAdaptiveInstance.set(instance);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                        createAdaptiveInstanceError = t;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"fail to create adaptive instance: "</span> + t.toString(), t);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"fail to create adaptive instance: "</span> + createAdaptiveInstanceError.toString(), createAdaptiveInstanceError);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (T) instance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="createAdaptiveExtension"><a href="#createAdaptiveExtension" class="headerlink" title="createAdaptiveExtension"></a>createAdaptiveExtension</h5><p>进行创建工作,获取相关类,执行实例化    </p>
<ul>
<li>getAdaptiveExtensionClass()<blockquote>
<p>获取相关的<code>Xxx@Adaptive</code>对象的类</p>
</blockquote>
</li>
<li>newInstance()  <blockquote>
<p>进行实例化操作  </p>
</blockquote>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> T <span class="title">createAdaptiveExtension</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> injectExtension((T) getAdaptiveExtensionClass().newInstance());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Can not create adaptive extenstion "</span> + type + <span class="string">", cause: "</span> + e.getMessage(), e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="getAdaptiveExtensionClass"><a href="#getAdaptiveExtensionClass" class="headerlink" title="getAdaptiveExtensionClass"></a>getAdaptiveExtensionClass</h5><blockquote>
<p>获取相关Adaptive类信息,如果不存在则由此去创建<br>不存在判断:META-INF关联的类Class级别注解没有<code>@Adaptive</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Class&lt;?&gt; getAdaptiveExtensionClass() &#123;</span><br><span class="line">    getExtensionClasses();</span><br><span class="line">    <span class="keyword">if</span> (cachedAdaptiveClass != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> cachedAdaptiveClass;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cachedAdaptiveClass = createAdaptiveExtensionClass();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h5 id="createAdaptiveExtensionClass"><a href="#createAdaptiveExtensionClass" class="headerlink" title="createAdaptiveExtensionClass"></a>createAdaptiveExtensionClass</h5><blockquote>
<p>由此将创建<code>Xxx@Adaptive</code>对象信息<br>寻找合适的ClassLoader<br>利用compiler为JavassistCompiler去执行编译加载内存<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Class&lt;?&gt; createAdaptiveExtensionClass() &#123;</span><br><span class="line">    String code = createAdaptiveExtensionClassCode();</span><br><span class="line">    ClassLoader classLoader = findClassLoader();</span><br><span class="line">    com.alibaba.dubbo.common.compiler.Compiler compiler = ExtensionLoader.getExtensionLoader(com.alibaba.dubbo.common.compiler.Compiler.class).getAdaptiveExtension();</span><br><span class="line">    <span class="keyword">return</span> compiler.compile(code, classLoader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h5 id="createAdaptiveExtensionClassCode"><a href="#createAdaptiveExtensionClassCode" class="headerlink" title="createAdaptiveExtensionClassCode"></a>createAdaptiveExtensionClassCode</h5><blockquote>
<p>主要去拼装相关的Class字节信息<br>它主要找有没有<code>@Adaptive</code>注解修饰的方法,如果有将会修饰成如下的方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> 返回类型 方法名(com.alibaba.dubbo.common.URL arg0) &#123;</span><br><span class="line">    <span class="keyword">if</span> (arg0 == <span class="keyword">null</span>) </span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"url == null"</span>);</span><br><span class="line">    com.alibaba.dubbo.common.URL url = arg0;</span><br><span class="line">    String extName = ( url.getProtocol() == <span class="keyword">null</span> ? <span class="string">"你设定的@SPI默认值"</span> : url.getProtocol() );</span><br><span class="line">    <span class="keyword">if</span>(extName == <span class="keyword">null</span>) </span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Fail to get extension(你的接口) name from url("</span> + url.toString() + <span class="string">") use keys([protocol])"</span>);</span><br><span class="line">    你的接口 extension = (你的接口)ExtensionLoader.getExtensionLoader(你的接口).getExtension(extName);</span><br><span class="line">    <span class="keyword">return</span> extension.方法名(arg0);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//以下是源代码</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">createAdaptiveExtensionClassCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    StringBuilder codeBuidler = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">    Method[] methods = type.getMethods();</span><br><span class="line">    <span class="keyword">boolean</span> hasAdaptiveAnnotation = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">for</span>(Method m : methods) &#123;</span><br><span class="line">        <span class="keyword">if</span>(m.isAnnotationPresent(Adaptive.class)) &#123;</span><br><span class="line">            hasAdaptiveAnnotation = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 完全没有Adaptive方法，则不需要生成Adaptive类</span></span><br><span class="line">    <span class="keyword">if</span>(! hasAdaptiveAnnotation)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"No adaptive method on extension "</span> + type.getName() + <span class="string">", refuse to create the adaptive class!"</span>);</span><br><span class="line">    </span><br><span class="line">    codeBuidler.append(<span class="string">"package "</span> + type.getPackage().getName() + <span class="string">";"</span>);</span><br><span class="line">    codeBuidler.append(<span class="string">"\nimport "</span> + ExtensionLoader.class.getName() + <span class="string">";"</span>);</span><br><span class="line">    codeBuidler.append(<span class="string">"\npublic class "</span> + type.getSimpleName() + <span class="string">"$Adpative"</span> + <span class="string">" implements "</span> + type.getCanonicalName() + <span class="string">" &#123;"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (Method method : methods) &#123;</span><br><span class="line">        Class&lt;?&gt; rt = method.getReturnType();</span><br><span class="line">        Class&lt;?&gt;[] pts = method.getParameterTypes();</span><br><span class="line">        Class&lt;?&gt;[] ets = method.getExceptionTypes();</span><br><span class="line"></span><br><span class="line">        Adaptive adaptiveAnnotation = method.getAnnotation(Adaptive.class);</span><br><span class="line">        StringBuilder code = <span class="keyword">new</span> StringBuilder(<span class="number">512</span>);</span><br><span class="line">        <span class="keyword">if</span> (adaptiveAnnotation == <span class="keyword">null</span>) &#123;</span><br><span class="line">            code.append(<span class="string">"throw new UnsupportedOperationException(\"method "</span>)</span><br><span class="line">                    .append(method.toString()).append(<span class="string">" of interface "</span>)</span><br><span class="line">                    .append(type.getName()).append(<span class="string">" is not adaptive method!\");"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">int</span> urlTypeIndex = -<span class="number">1</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pts.length; ++i) &#123;</span><br><span class="line">                <span class="keyword">if</span> (pts[i].equals(URL.class)) &#123;</span><br><span class="line">                    urlTypeIndex = i;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 有类型为URL的参数</span></span><br><span class="line">            <span class="keyword">if</span> (urlTypeIndex != -<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="comment">// Null Point check</span></span><br><span class="line">                String s = String.format(<span class="string">"\nif (arg%d == null) throw new IllegalArgumentException(\"url == null\");"</span>,</span><br><span class="line">                                urlTypeIndex);</span><br><span class="line">                code.append(s);</span><br><span class="line">                </span><br><span class="line">                s = String.format(<span class="string">"\n%s url = arg%d;"</span>, URL.class.getName(), urlTypeIndex); </span><br><span class="line">                code.append(s);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 参数没有URL类型</span></span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                String attribMethod = <span class="keyword">null</span>;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 找到参数的URL属性</span></span><br><span class="line">                LBL_PTS:</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pts.length; ++i) &#123;</span><br><span class="line">                    Method[] ms = pts[i].getMethods();</span><br><span class="line">                    <span class="keyword">for</span> (Method m : ms) &#123;</span><br><span class="line">                        String name = m.getName();</span><br><span class="line">                        <span class="keyword">if</span> ((name.startsWith(<span class="string">"get"</span>) || name.length() &gt; <span class="number">3</span>)</span><br><span class="line">                                &amp;&amp; Modifier.isPublic(m.getModifiers())</span><br><span class="line">                                &amp;&amp; !Modifier.isStatic(m.getModifiers())</span><br><span class="line">                                &amp;&amp; m.getParameterTypes().length == <span class="number">0</span></span><br><span class="line">                                &amp;&amp; m.getReturnType() == URL.class) &#123;</span><br><span class="line">                            urlTypeIndex = i;</span><br><span class="line">                            attribMethod = name;</span><br><span class="line">                            <span class="keyword">break</span> LBL_PTS;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span>(attribMethod == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"fail to create adative class for interface "</span> + type.getName()</span><br><span class="line">                            + <span class="string">": not found url parameter or url attribute in parameters of method "</span> + method.getName());</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// Null point check</span></span><br><span class="line">                String s = String.format(<span class="string">"\nif (arg%d == null) throw new IllegalArgumentException(\"%s argument == null\");"</span>,</span><br><span class="line">                                urlTypeIndex, pts[urlTypeIndex].getName());</span><br><span class="line">                code.append(s);</span><br><span class="line">                s = String.format(<span class="string">"\nif (arg%d.%s() == null) throw new IllegalArgumentException(\"%s argument %s() == null\");"</span>,</span><br><span class="line">                                urlTypeIndex, attribMethod, pts[urlTypeIndex].getName(), attribMethod);</span><br><span class="line">                code.append(s);</span><br><span class="line"></span><br><span class="line">                s = String.format(<span class="string">"%s url = arg%d.%s();"</span>,URL.class.getName(), urlTypeIndex, attribMethod); </span><br><span class="line">                code.append(s);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            String[] value = adaptiveAnnotation.value();</span><br><span class="line">            <span class="comment">// 没有设置Key，则使用“扩展点接口名的点分隔 作为Key</span></span><br><span class="line">            <span class="keyword">if</span>(value.length == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">char</span>[] charArray = type.getSimpleName().toCharArray();</span><br><span class="line">                StringBuilder sb = <span class="keyword">new</span> StringBuilder(<span class="number">128</span>);</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; charArray.length; i++) &#123;</span><br><span class="line">                    <span class="keyword">if</span>(Character.isUpperCase(charArray[i])) &#123;</span><br><span class="line">                        <span class="keyword">if</span>(i != <span class="number">0</span>) &#123;</span><br><span class="line">                            sb.append(<span class="string">"."</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        sb.append(Character.toLowerCase(charArray[i]));</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> &#123;</span><br><span class="line">                        sb.append(charArray[i]);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                value = <span class="keyword">new</span> String[] &#123;sb.toString()&#125;;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">boolean</span> hasInvocation = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pts.length; ++i) &#123;</span><br><span class="line">                <span class="keyword">if</span> (pts[i].getName().equals(<span class="string">"com.alibaba.dubbo.rpc.Invocation"</span>)) &#123;</span><br><span class="line">                    <span class="comment">// Null Point check</span></span><br><span class="line">                    String s = String.format(<span class="string">"\nif (arg%d == null) throw new IllegalArgumentException(\"invocation == null\");"</span>, i);</span><br><span class="line">                    code.append(s);</span><br><span class="line">                    s = String.format(<span class="string">"\nString methodName = arg%d.getMethodName();"</span>, i); </span><br><span class="line">                    code.append(s);</span><br><span class="line">                    hasInvocation = <span class="keyword">true</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            String defaultExtName = cachedDefaultName;</span><br><span class="line">            String getNameCode = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = value.length - <span class="number">1</span>; i &gt;= <span class="number">0</span>; --i) &#123;</span><br><span class="line">                <span class="keyword">if</span>(i == value.length - <span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span>(<span class="keyword">null</span> != defaultExtName) &#123;</span><br><span class="line">                        <span class="keyword">if</span>(!<span class="string">"protocol"</span>.equals(value[i]))</span><br><span class="line">                            <span class="keyword">if</span> (hasInvocation) </span><br><span class="line">                                getNameCode = String.format(<span class="string">"url.getMethodParameter(methodName, \"%s\", \"%s\")"</span>, value[i], defaultExtName);</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                                getNameCode = String.format(<span class="string">"url.getParameter(\"%s\", \"%s\")"</span>, value[i], defaultExtName);</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                            getNameCode = String.format(<span class="string">"( url.getProtocol() == null ? \"%s\" : url.getProtocol() )"</span>, defaultExtName);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span>(!<span class="string">"protocol"</span>.equals(value[i]))</span><br><span class="line">                            <span class="keyword">if</span> (hasInvocation) </span><br><span class="line">                                getNameCode = String.format(<span class="string">"url.getMethodParameter(methodName, \"%s\", \"%s\")"</span>, value[i], defaultExtName);</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                                getNameCode = String.format(<span class="string">"url.getParameter(\"%s\")"</span>, value[i]);</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                            getNameCode = <span class="string">"url.getProtocol()"</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span>(!<span class="string">"protocol"</span>.equals(value[i]))</span><br><span class="line">                        <span class="keyword">if</span> (hasInvocation) </span><br><span class="line">                            getNameCode = String.format(<span class="string">"url.getMethodParameter(methodName, \"%s\", \"%s\")"</span>, value[i], defaultExtName);</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                            getNameCode = String.format(<span class="string">"url.getParameter(\"%s\", %s)"</span>, value[i], getNameCode);</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        getNameCode = String.format(<span class="string">"url.getProtocol() == null ? (%s) : url.getProtocol()"</span>, getNameCode);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            code.append(<span class="string">"\nString extName = "</span>).append(getNameCode).append(<span class="string">";"</span>);</span><br><span class="line">            <span class="comment">// check extName == null?</span></span><br><span class="line">            String s = String.format(<span class="string">"\nif(extName == null) "</span> +</span><br><span class="line">                    <span class="string">"throw new IllegalStateException(\"Fail to get extension(%s) name from url(\" + url.toString() + \") use keys(%s)\");"</span>,</span><br><span class="line">                    type.getName(), Arrays.toString(value));</span><br><span class="line">            code.append(s);</span><br><span class="line">            </span><br><span class="line">            s = String.format(<span class="string">"\n%s extension = (%&lt;s)%s.getExtensionLoader(%s.class).getExtension(extName);"</span>,</span><br><span class="line">                    type.getName(), ExtensionLoader.class.getSimpleName(), type.getName());</span><br><span class="line">            code.append(s);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// return statement</span></span><br><span class="line">            <span class="keyword">if</span> (!rt.equals(<span class="keyword">void</span>.class)) &#123;</span><br><span class="line">                code.append(<span class="string">"\nreturn "</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            s = String.format(<span class="string">"extension.%s("</span>, method.getName());</span><br><span class="line">            code.append(s);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pts.length; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (i != <span class="number">0</span>)</span><br><span class="line">                    code.append(<span class="string">", "</span>);</span><br><span class="line">                code.append(<span class="string">"arg"</span>).append(i);</span><br><span class="line">            &#125;</span><br><span class="line">            code.append(<span class="string">");"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        codeBuidler.append(<span class="string">"\npublic "</span> + rt.getCanonicalName() + <span class="string">" "</span> + method.getName() + <span class="string">"("</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pts.length; i ++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                codeBuidler.append(<span class="string">", "</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            codeBuidler.append(pts[i].getCanonicalName());</span><br><span class="line">            codeBuidler.append(<span class="string">" "</span>);</span><br><span class="line">            codeBuidler.append(<span class="string">"arg"</span> + i);</span><br><span class="line">        &#125;</span><br><span class="line">        codeBuidler.append(<span class="string">")"</span>);</span><br><span class="line">        <span class="keyword">if</span> (ets.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            codeBuidler.append(<span class="string">" throws "</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; ets.length; i ++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (i &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    codeBuidler.append(<span class="string">", "</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                codeBuidler.append(pts[i].getCanonicalName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        codeBuidler.append(<span class="string">" &#123;"</span>);</span><br><span class="line">        codeBuidler.append(code.toString());</span><br><span class="line">        codeBuidler.append(<span class="string">"\n&#125;"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    codeBuidler.append(<span class="string">"\n&#125;"</span>);</span><br><span class="line">    <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">        logger.debug(codeBuidler.toString());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> codeBuidler.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<p><br></p>
<h4 id="ActivateExtension"><a href="#ActivateExtension" class="headerlink" title="ActivateExtension"></a>ActivateExtension</h4><h5 id="getActivateExtension"><a href="#getActivateExtension" class="headerlink" title="getActivateExtension"></a>getActivateExtension</h5><p>根据传进来的参数,拿取<code>url</code>中指定的<code>key</code>对应的<code>value</code>,如果<code>value</code>为空直接返回null<br>所以使用<code>ActivateExtension</code>必须要指定<code>key</code>和<code>value</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;T&gt; <span class="title">getActivateExtension</span><span class="params">(URL url, String key, String group)</span> </span>&#123;</span><br><span class="line">    String value = url.getParameter(key);</span><br><span class="line">    <span class="keyword">return</span> getActivateExtension(url, value == <span class="keyword">null</span> || value.length() == <span class="number">0</span> ? <span class="keyword">null</span> : Constants.COMMA_SPLIT_PATTERN.split(value), group);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<p>拿到<code>value</code>后进入以下方法,并附带了<code>url</code>与<code>group</code><br>主要做了以下步骤  </p>
<ul>
<li><p>getExtensionClasses:获取当前加载器相关的Class信息,并且领出<code>cachedActivates</code>信息,<code>cachedActivates</code>为当前加载器下的满足以下条件就会加入</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Activate activate = clazz.getAnnotation(Activate.class);</span><br><span class="line"><span class="keyword">if</span> (activate != <span class="keyword">null</span>) &#123;</span><br><span class="line">    cachedActivates.put(names[<span class="number">0</span>], activate);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>isMatchGroup:匹配group组是否符合,即consumer或provider,符合组即<code>getExtension(name);</code>取出对象信息  </p>
</li>
<li><p>!names.contains(name) &amp;&amp; isActive(….): 判断key是否相符,相符则加入到<code>exts</code>,如果未指定注解<code>value</code>也被加入进去</p>
<blockquote>
<p>META-INF中的name如果带有”-“标识则表现出为移除状态<br><code>! names.contains(name)</code>先排除掉让没有key指定的对象先添加到list再排序list<br>后期再加<code>T ext = getExtension(name);</code>对ext对象直接添加到<code>exts</code>列表,保证了调用的先后顺序    </p>
</blockquote>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;T&gt; <span class="title">getActivateExtension</span><span class="params">(URL url, String[] values, String group)</span> </span>&#123;</span><br><span class="line">    List&lt;T&gt; exts = <span class="keyword">new</span> ArrayList&lt;T&gt;();</span><br><span class="line">    List&lt;String&gt; names = values == <span class="keyword">null</span> ? <span class="keyword">new</span> ArrayList&lt;String&gt;(<span class="number">0</span>) : Arrays.asList(values);</span><br><span class="line">    <span class="keyword">if</span> (! names.contains(Constants.REMOVE_VALUE_PREFIX + Constants.DEFAULT_KEY)) &#123;</span><br><span class="line">        getExtensionClasses();</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, Activate&gt; entry : cachedActivates.entrySet()) &#123;</span><br><span class="line">            String name = entry.getKey();</span><br><span class="line">            Activate activate = entry.getValue();</span><br><span class="line">            <span class="keyword">if</span> (isMatchGroup(group, activate.group())) &#123;</span><br><span class="line">                T ext = getExtension(name);</span><br><span class="line">                <span class="keyword">if</span> (! names.contains(name)</span><br><span class="line">                        &amp;&amp; ! names.contains(Constants.REMOVE_VALUE_PREFIX + name) </span><br><span class="line">                        &amp;&amp; isActive(activate, url)) &#123;</span><br><span class="line">                    exts.add(ext);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        Collections.sort(exts, ActivateComparator.COMPARATOR);</span><br><span class="line">    &#125;</span><br><span class="line">    List&lt;T&gt; usrs = <span class="keyword">new</span> ArrayList&lt;T&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; names.size(); i ++) &#123;</span><br><span class="line">        String name = names.get(i);</span><br><span class="line">        <span class="keyword">if</span> (! name.startsWith(Constants.REMOVE_VALUE_PREFIX)</span><br><span class="line">                &amp;&amp; ! names.contains(Constants.REMOVE_VALUE_PREFIX + name)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (Constants.DEFAULT_KEY.equals(name)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (usrs.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    exts.addAll(<span class="number">0</span>, usrs);</span><br><span class="line">                    usrs.clear();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                T ext = getExtension(name);</span><br><span class="line">                usrs.add(ext);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (usrs.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        exts.addAll(usrs);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> exts;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br><br><br><br><br></p>
<h3 id="加载META-INF接口相关实现类"><a href="#加载META-INF接口相关实现类" class="headerlink" title="加载META-INF接口相关实现类"></a>加载META-INF接口相关实现类</h3><h4 id="getExtensionClasses"><a href="#getExtensionClasses" class="headerlink" title="getExtensionClasses"></a>getExtensionClasses</h4><p>如果当前缓存类持有容器不存在相关的Map(name-&gt;实现类),则进行加载流程</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Map&lt;String, Class&lt;?&gt;&gt; getExtensionClasses() &#123;</span><br><span class="line">    Map&lt;String, Class&lt;?&gt;&gt; classes = cachedClasses.get();</span><br><span class="line">    <span class="keyword">if</span> (classes == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (cachedClasses) &#123;</span><br><span class="line">            classes = cachedClasses.get();</span><br><span class="line">            <span class="keyword">if</span> (classes == <span class="keyword">null</span>) &#123;</span><br><span class="line">                classes = loadExtensionClasses();</span><br><span class="line">                cachedClasses.set(classes);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> classes;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="loadExtensionClasses"><a href="#loadExtensionClasses" class="headerlink" title="loadExtensionClasses"></a>loadExtensionClasses</h4><p>组织加载流程三个目录  </p>
<blockquote>
<p>从<code>dir</code>目标目录中加载接口-实现类配置文件    </p>
</blockquote>
<p><code>dir</code>目录有这三类:</p>
<ul>
<li>SERVICES_DIRECTORY = “META-INF/services/“</li>
<li>DUBBO_DIRECTORY = “META-INF/dubbo/“</li>
<li>DUBBO_INTERNAL_DIRECTORY = DUBBO_DIRECTORY + “internal/“  </li>
</ul>
<p>这些目录的文件样式如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">monitor=com.alibaba.dubbo.monitor.support.MonitorFilter</span><br></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Map&lt;String, Class&lt;?&gt;&gt; loadExtensionClasses() &#123;</span><br><span class="line">    <span class="keyword">final</span> SPI defaultAnnotation = type.getAnnotation(SPI.class);</span><br><span class="line">    <span class="keyword">if</span>(defaultAnnotation != <span class="keyword">null</span>) &#123;</span><br><span class="line">        String value = defaultAnnotation.value();</span><br><span class="line">        <span class="keyword">if</span>(value != <span class="keyword">null</span> &amp;&amp; (value = value.trim()).length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            String[] names = NAME_SEPARATOR.split(value);</span><br><span class="line">            <span class="keyword">if</span>(names.length &gt; <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"more than 1 default extension name on extension "</span> + type.getName()</span><br><span class="line">                        + <span class="string">": "</span> + Arrays.toString(names));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(names.length == <span class="number">1</span>) cachedDefaultName = names[<span class="number">0</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    Map&lt;String, Class&lt;?&gt;&gt; extensionClasses = <span class="keyword">new</span> HashMap&lt;String, Class&lt;?&gt;&gt;();</span><br><span class="line">    loadFile(extensionClasses, DUBBO_INTERNAL_DIRECTORY);</span><br><span class="line">    loadFile(extensionClasses, DUBBO_DIRECTORY);</span><br><span class="line">    loadFile(extensionClasses, SERVICES_DIRECTORY);</span><br><span class="line">    <span class="keyword">return</span> extensionClasses;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="loadFile"><a href="#loadFile" class="headerlink" title="loadFile"></a>loadFile</h4><p><code>extensionClasses</code>为成员变量<code>cachedClasses</code>  </p>
<p>以下是主要加载文件的源代码  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadFile</span><span class="params">(Map&lt;String, Class&lt;?&gt;&gt; extensionClasses, String dir)</span> </span>&#123;</span><br><span class="line">    String fileName = dir + type.getName();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Enumeration&lt;java.net.URL&gt; urls;</span><br><span class="line">        ClassLoader classLoader = findClassLoader();</span><br><span class="line">        <span class="keyword">if</span> (classLoader != <span class="keyword">null</span>) &#123;</span><br><span class="line">            urls = classLoader.getResources(fileName);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            urls = ClassLoader.getSystemResources(fileName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (urls != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">while</span> (urls.hasMoreElements()) &#123;</span><br><span class="line">                java.net.URL url = urls.nextElement();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    BufferedReader reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(url.openStream(), <span class="string">"utf-8"</span>));</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        String line = <span class="keyword">null</span>;</span><br><span class="line">                        <span class="keyword">while</span> ((line = reader.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">final</span> <span class="keyword">int</span> ci = line.indexOf(<span class="string">'#'</span>);</span><br><span class="line">                            <span class="keyword">if</span> (ci &gt;= <span class="number">0</span>) line = line.substring(<span class="number">0</span>, ci);</span><br><span class="line">                            line = line.trim();</span><br><span class="line">                            <span class="keyword">if</span> (line.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                                <span class="keyword">try</span> &#123;</span><br><span class="line">                                    String name = <span class="keyword">null</span>;</span><br><span class="line">                                    <span class="keyword">int</span> i = line.indexOf(<span class="string">'='</span>);</span><br><span class="line">                                    <span class="keyword">if</span> (i &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                                        name = line.substring(<span class="number">0</span>, i).trim();</span><br><span class="line">                                        line = line.substring(i + <span class="number">1</span>).trim();</span><br><span class="line">                                    &#125;</span><br><span class="line">                                    <span class="comment">//例如monitor=com.alibaba.dubbo.monitor.support.MonitorFilter</span></span><br><span class="line">                                    <span class="comment">//被分解成name=monitor,line=com.alibaba.dubbo.monitor.support.MonitorFilter</span></span><br><span class="line">                                    </span><br><span class="line">                                    <span class="keyword">if</span> (line.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                                        Class&lt;?&gt; clazz = Class.forName(line, <span class="keyword">true</span>, classLoader);</span><br><span class="line">                                        <span class="keyword">if</span> (! type.isAssignableFrom(clazz)) &#123;</span><br><span class="line">                                            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Error when load extension class(interface: "</span> +</span><br><span class="line">                                                    type + <span class="string">", class line: "</span> + clazz.getName() + <span class="string">"), class "</span> </span><br><span class="line">                                                    + clazz.getName() + <span class="string">"is not subtype of interface."</span>);</span><br><span class="line">                                        &#125;</span><br><span class="line">                                        <span class="keyword">if</span> (clazz.isAnnotationPresent(Adaptive.class)) &#123;</span><br><span class="line">                                            </span><br><span class="line">                                            <span class="comment">//如果有Adaptive.class注解,就将现在的cachedAdaptiveClass成员变量设定这个类</span></span><br><span class="line">                                        </span><br><span class="line">                                            <span class="keyword">if</span>(cachedAdaptiveClass == <span class="keyword">null</span>) &#123;</span><br><span class="line">                                                cachedAdaptiveClass = clazz;</span><br><span class="line">                                            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (! cachedAdaptiveClass.equals(clazz)) &#123;</span><br><span class="line">                                                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"More than 1 adaptive class found: "</span></span><br><span class="line">                                                        + cachedAdaptiveClass.getClass().getName()</span><br><span class="line">                                                        + <span class="string">", "</span> + clazz.getClass().getName());</span><br><span class="line">                                            &#125;</span><br><span class="line">                                            </span><br><span class="line">                                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                                <span class="comment">//查看这个类是否有此类的构造器,如果有判定为Wrapper包裹类</span></span><br><span class="line">                                                <span class="comment">//并且加入到wrappers列表</span></span><br><span class="line">                                                </span><br><span class="line">                                                clazz.getConstructor(type);</span><br><span class="line">                                                Set&lt;Class&lt;?&gt;&gt; wrappers = cachedWrapperClasses;</span><br><span class="line">                                                <span class="keyword">if</span> (wrappers == <span class="keyword">null</span>) &#123;</span><br><span class="line">                                                    cachedWrapperClasses = <span class="keyword">new</span> ConcurrentHashSet&lt;Class&lt;?&gt;&gt;();</span><br><span class="line">                                                    wrappers = cachedWrapperClasses;</span><br><span class="line">                                                &#125;</span><br><span class="line">                                                wrappers.add(clazz);</span><br><span class="line">                                            &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">                                            </span><br><span class="line">                                                <span class="comment">//再查是否有注解</span></span><br><span class="line">                                                clazz.getConstructor();</span><br><span class="line">                                                <span class="keyword">if</span> (name == <span class="keyword">null</span> || name.length() == <span class="number">0</span>) &#123;</span><br><span class="line">                                                    name = findAnnotationName(clazz);</span><br><span class="line">                                                    <span class="keyword">if</span> (name == <span class="keyword">null</span> || name.length() == <span class="number">0</span>) &#123;</span><br><span class="line">                                                        <span class="keyword">if</span> (clazz.getSimpleName().length() &gt; type.getSimpleName().length()</span><br><span class="line">                                                                &amp;&amp; clazz.getSimpleName().endsWith(type.getSimpleName())) &#123;</span><br><span class="line">                                                            name = clazz.getSimpleName().substring(<span class="number">0</span>, clazz.getSimpleName().length() - type.getSimpleName().length()).toLowerCase();</span><br><span class="line">                                                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                                            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"No such extension name for the class "</span> + clazz.getName() + <span class="string">" in the config "</span> + url);</span><br><span class="line">                                                        &#125;</span><br><span class="line">                                                    &#125;</span><br><span class="line">                                                &#125;</span><br><span class="line">                                                </span><br><span class="line">                                                <span class="comment">//查询name中是否存在Activate注解</span></span><br><span class="line">                                                <span class="comment">//如果有Activate注解,则put到cachedActivates</span></span><br><span class="line">                                                <span class="comment">//最后将类放入cachedNames,extensionClasses</span></span><br><span class="line">                                                </span><br><span class="line">                                                String[] names = NAME_SEPARATOR.split(name);</span><br><span class="line">                                                <span class="keyword">if</span> (names != <span class="keyword">null</span> &amp;&amp; names.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                                                    Activate activate = clazz.getAnnotation(Activate.class);</span><br><span class="line">                                                    <span class="keyword">if</span> (activate != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                                        cachedActivates.put(names[<span class="number">0</span>], activate);</span><br><span class="line">                                                    &#125;</span><br><span class="line">                                                    <span class="keyword">for</span> (String n : names) &#123;</span><br><span class="line">                                                        <span class="keyword">if</span> (! cachedNames.containsKey(clazz)) &#123;</span><br><span class="line">                                                            cachedNames.put(clazz, n);</span><br><span class="line">                                                        &#125;</span><br><span class="line">                                                        Class&lt;?&gt; c = extensionClasses.get(n);</span><br><span class="line">                                                        <span class="keyword">if</span> (c == <span class="keyword">null</span>) &#123;</span><br><span class="line">                                                            extensionClasses.put(n, clazz);</span><br><span class="line">                                                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c != clazz) &#123;</span><br><span class="line">                                                            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Duplicate extension "</span> + type.getName() + <span class="string">" name "</span> + n + <span class="string">" on "</span> + c.getName() + <span class="string">" and "</span> + clazz.getName());</span><br><span class="line">                                                        &#125;</span><br><span class="line">                                                    &#125;</span><br><span class="line">                                                &#125;</span><br><span class="line">                                            &#125;</span><br><span class="line">                                        &#125;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                                    IllegalStateException e = <span class="keyword">new</span> IllegalStateException(<span class="string">"Failed to load extension class(interface: "</span> + type + <span class="string">", class line: "</span> + line + <span class="string">") in "</span> + url + <span class="string">", cause: "</span> + t.getMessage(), t);</span><br><span class="line">                                    exceptions.put(line, e);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="comment">// end of while read lines</span></span><br><span class="line">                    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                        reader.close();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                    logger.error(<span class="string">"Exception when load extension class(interface: "</span> +</span><br><span class="line">                                        type + <span class="string">", class file: "</span> + url + <span class="string">") in "</span> + url, t);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="comment">// end of while urls</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        logger.error(<span class="string">"Exception when load extension class(interface: "</span> +</span><br><span class="line">                type + <span class="string">", description file: "</span> + fileName + <span class="string">")."</span>, t);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上代码经历了以下主要步骤  </p>
<h5 id="从主要三个目录加载文件"><a href="#从主要三个目录加载文件" class="headerlink" title="从主要三个目录加载文件"></a>从主要三个目录加载文件</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SERVICES_DIRECTORY = &quot;META-INF/services/&quot;</span><br><span class="line">DUBBO_DIRECTORY = &quot;META-INF/dubbo/&quot;</span><br><span class="line">DUBBO_INTERNAL_DIRECTORY = DUBBO_DIRECTORY + &quot;internal/&quot;  </span><br><span class="line"></span><br><span class="line">//文件内容如下</span><br><span class="line">monitor=com.alibaba.dubbo.monitor.support.MonitorFilter</span><br></pre></td></tr></table></figure>
<h5 id="分解name-line两部分"><a href="#分解name-line两部分" class="headerlink" title="分解name,line两部分"></a>分解name,line两部分</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">while 循环每一行</span><br><span class="line">name = line.substring(0, i).trim();</span><br><span class="line">line = line.substring(i + 1).trim();</span><br><span class="line">取出name和line两部分</span><br></pre></td></tr></table></figure>
<h5 id="设定加cachedAdaptiveClass"><a href="#设定加cachedAdaptiveClass" class="headerlink" title="设定加cachedAdaptiveClass"></a>设定加cachedAdaptiveClass</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">clazz.isAnnotationPresent(Adaptive.class)</span><br><span class="line"><span class="comment">//如果有Adaptive.class注解,就将现在的cachedAdaptiveClass成员变量设定这个类</span></span><br></pre></td></tr></table></figure>
<h5 id="添加cachedActivates"><a href="#添加cachedActivates" class="headerlink" title="添加cachedActivates"></a>添加cachedActivates</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Activate activate = clazz.getAnnotation(Activate.class);</span><br><span class="line"><span class="keyword">if</span> (activate != <span class="keyword">null</span>) &#123;</span><br><span class="line">    cachedActivates.put(names[<span class="number">0</span>], activate);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//查询name中是否存在Activate注解</span></span><br><span class="line"><span class="comment">//如果有Activate注解,则put到cachedActivates</span></span><br></pre></td></tr></table></figure>
<h5 id="添加cachedNames-extensionClasses"><a href="#添加cachedNames-extensionClasses" class="headerlink" title="添加cachedNames,extensionClasses"></a>添加cachedNames,extensionClasses</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//最后将类放入cachedNames,extensionClasses</span></span><br><span class="line"><span class="keyword">for</span> (String n : names) &#123;</span><br><span class="line">    <span class="keyword">if</span> (! cachedNames.containsKey(clazz)) &#123;</span><br><span class="line">        cachedNames.put(clazz, n);</span><br><span class="line">    &#125;</span><br><span class="line">    Class&lt;?&gt; c = extensionClasses.get(n);</span><br><span class="line">    <span class="keyword">if</span> (c == <span class="keyword">null</span>) &#123;</span><br><span class="line">        extensionClasses.put(n, clazz);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c != clazz) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Duplicate extension "</span> + type.getName() + <span class="string">" name "</span> + n + <span class="string">" on "</span> + c.getName() + <span class="string">" and "</span> + clazz.getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br><br><br><br><br></p>
<h1 id="服务-Consumer-Producer"><a href="#服务-Consumer-Producer" class="headerlink" title="服务-Consumer,Producer"></a>服务-Consumer,Producer</h1><h2 id="消费者"><a href="#消费者" class="headerlink" title="消费者"></a>消费者</h2><h3 id="消费者-服务引用"><a href="#消费者-服务引用" class="headerlink" title="消费者-服务引用"></a>消费者-服务引用</h3><h4 id="流程序列图"><a href="#流程序列图" class="headerlink" title="流程序列图"></a>流程序列图</h4><p><img src="/2017/08/25/dubbo/image-02.png" alt="01"></p>
<p><br><br><br></p>
<h4 id="大致流程"><a href="#大致流程" class="headerlink" title="大致流程"></a>大致流程</h4><ul>
<li><code>ReferenceBean</code>实现<code>FactoryBean</code>的<code>getObject</code>方法进入  <blockquote>
<p>由<code>DubboNamespaceHandler</code>解析<code>registerBeanDefinitionParser</code>,从而带入<code>ReferenceBean</code>到Spring环境中<br>所有的消费者都将会在身为<code>FactoryBean</code>的<code>ReferenceBean</code>的<code>getObject</code>方法拿取引用服务的Bean  </p>
</blockquote>
</li>
<li><code>refprotocol[Protocol$Adaptive].refer</code>通过url为<code>registry</code>关键字找<code>RegistryProtocol#refer</code></li>
<li><code>RegistryProtocol#refer</code>首先做注册<code>registry.register</code>  </li>
<li><code>RegistryProtocol#refer</code>接着做注册中心订阅<code>directory.subscribe</code>  </li>
<li><code>RegistryDirectory</code>往zk进行操作<code>zookeeperRegistry.subscribe</code>,并注册自身的<code>NotifyListener#notify</code>方法  </li>
<li><code>RegistryDirectory</code>在zk得到响应<code>notify</code>方法被调用接着引出<code>refreshInvoker</code>整理从注册中心得到的服务Invoker列表  </li>
<li><p><code>refreshInvoker</code>主要操作<code>toInvokers</code>与<code>toMethodInvokers</code>两个相关的方法来换取相关的Invokers  </p>
<ul>
<li><p><code>toInvokers</code>:</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">invoker = <span class="keyword">new</span> InvokerDelegete&lt;T&gt;(protocol.refer(serviceType, url), url, providerUrl);</span><br></pre></td></tr></table></figure>
<p>  由上方代码引出<code>DubboProtocol</code></p>
</li>
<li><p><code>toMethodInvokers</code>:</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">newMethodInvokerMap.put(method, route(methodInvokers, method));</span><br></pre></td></tr></table></figure>
<p>  由上方代码引出<code>route</code>机制  </p>
</li>
</ul>
</li>
<li><p><code>DubboProtocol#refer</code>主要构件DubboInvoker并且建立客户端链接<code>getClients(url)</code>,并添加<code>invokers</code></p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DubboInvoker&lt;T&gt; invoker = <span class="keyword">new</span> DubboInvoker&lt;T&gt;(serviceType, url, getClients(url), invokers);</span><br><span class="line">invokers.add(invoker);</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>FailoverCluster</code>在<code>RegistryDirectory</code>结束<code>notify</code>之后会得到根据<code>route</code>规则通过<code>directory.list</code>拿到的Invokers列表,然后用<code>FailoverClusterInvoker</code>包裹  </p>
</li>
<li><code>JavassistProxyFactory</code>将上一步得到的<code>ClusterInvoker</code>到这里来进行<code>getProxy</code>代理操作  </li>
</ul>
<h3 id="消费者-调用"><a href="#消费者-调用" class="headerlink" title="消费者-调用"></a>消费者-调用</h3><h4 id="流程序列图-1"><a href="#流程序列图-1" class="headerlink" title="流程序列图"></a>流程序列图</h4><p><img src="/2017/08/25/dubbo/image-03.png" alt="doInvoke"></p>
<h4 id="大致流程-1"><a href="#大致流程-1" class="headerlink" title="大致流程"></a>大致流程</h4><ul>
<li><code>InvokerInvocationHandler</code>由于所有的引用服务都被<code>JavassistProxyFactory.getProxy</code>所以的<code>Invoker</code>调用都被这个<code>InvokerInvocationHandler</code>包裹  </li>
<li><code>MockClusterInvoker</code>因为有<code>MockClusterWrapper</code>所以最后在<code>FailoverCluster</code>上包裹了一层<blockquote>
<p>主要用于判断:有无mock,强制mock,失败后mock三种失败mock策略</p>
</blockquote>
</li>
<li><code>FailoverClusterInvoker</code>在父级<code>AbstractClusterInvoker</code>选定好后<code>loadbalance</code>策略,到了本对象的<code>doInvoke</code>直接激活负载策略,如遇失败重试,具体重试次数根据设定来    <blockquote>
<p>主要用于各类容错机制  </p>
</blockquote>
</li>
<li><code>InvokerWrapper</code>因为在<code>InvokerDelegete</code>的初始化,作为父级类包裹了invoker</li>
<li><code>ProtocolFilterWrapper</code>由于<code>DubboProtocol</code>要经过<code>Filter</code>责任链的洗礼,所以这里的<code>Invoker</code>全部是<code>Consumer</code>端的<code>Filter</code><blockquote>
<p>通过责任链可以添加各类扩展</p>
</blockquote>
</li>
<li><code>ListenerExporterWrapper</code>由于<code>ProtocolListenerWrapper</code>也是<code>DubboProtocol</code>包裹类,在<code>refer</code>操作中被强制包上了<code>ListenerInvokerWrapper</code>  <blockquote>
<p>实现<code>InvokerListener</code>进行invoker监听动作  </p>
</blockquote>
</li>
<li><code>DubboInvoker</code>最终来到了这里拿取<code>client</code>进行远程调用  </li>
</ul>
<blockquote>
<p>invoker 调用细节  </p>
</blockquote>
<p><code>route.route</code>会用在两个地方  </p>
<ul>
<li><p>notify:写入invoker的时候会引入ConditionRouter进行</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">router.getUrl() != null判断过滤掉MockInvokersSelector</span><br><span class="line">ConditionRouter的matchThen进行主要的invoker过滤</span><br></pre></td></tr></table></figure>
</li>
<li><p>list:调用的时候读取invoker</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">router.getUrl() == null 选定MockInvokersSelector  </span><br><span class="line">参数值`invocation.need.mock`有并且`invocation.getAttachments`不为空则返回`MockedInvokers`否则返回`NormalInvokers`</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br><br><br><br><br></p>
<h2 id="生产者"><a href="#生产者" class="headerlink" title="生产者"></a>生产者</h2><h3 id="生产者-服务暴露"><a href="#生产者-服务暴露" class="headerlink" title="生产者-服务暴露"></a>生产者-服务暴露</h3><h4 id="流程序列图-2"><a href="#流程序列图-2" class="headerlink" title="流程序列图"></a>流程序列图</h4><p><img src="/2017/08/25/dubbo/image-05.png" alt="05"></p>
<h4 id="大致流程-2"><a href="#大致流程-2" class="headerlink" title="大致流程"></a>大致流程</h4><ul>
<li>配置为none不暴露</li>
<li>配置不是remote的情况下做本地暴露 (配置为remote，则表示只暴露远程服务)</li>
<li>如果配置不是local则暴露为远程服务.(配置为local，则表示只暴露远程服务)  </li>
</ul>
<h5 id="本地暴露"><a href="#本地暴露" class="headerlink" title="本地暴露"></a>本地暴露</h5><ul>
<li>proxyFactory.getInvoker:</li>
<li><p>protocol.export  </p>
<blockquote>
<p><code>Protocol$Adaptive(InJvmProtocol)</code><br>两个Wrapper:<code>ProtocolFilterWrapper</code>(官方9个Filter),<code>ProtocolListenerWrapper</code>(包裹<code>ListenerExportWrapper</code>)<br>在Filter包裹后,Listener包裹之前构建<code>InJvmExport</code>  </p>
</blockquote>
</li>
<li><p>exporters.add(exporter);</p>
</li>
</ul>
<h5 id="远程暴露"><a href="#远程暴露" class="headerlink" title="远程暴露"></a>远程暴露</h5><ul>
<li>proxyFactory.getInvoker</li>
<li><p>protocol.export</p>
<blockquote>
<p><code>Protocol$Adaptive(RegistryProtocol)</code>    </p>
</blockquote>
<ul>
<li>构建<code>InvokeDelegate</code></li>
<li><code>protocol.export(invokeDelegate)</code>暴露服务</li>
<li><p><code>registry.register</code>将<code>OverrideListener</code>注册      </p>
<blockquote>
<p><code>Protocol$Adaptive(DubboProtocol)</code>      </p>
</blockquote>
</li>
<li><p><code>ProtocolFilterWrapper</code>嵌套责任链</p>
</li>
<li><code>DubboExport</code>将Invoke转<code>DubboExport</code></li>
<li><p><code>openServer</code>开启Netty网络服务       </p>
<blockquote>
<p><code>return New Export(....)</code>返回<code>Export</code>出去</p>
</blockquote>
</li>
</ul>
</li>
<li>exporters.add(exporter);</li>
</ul>
<p><br><br><br><br><br></p>
<h1 id="注册中心-Zookeeper"><a href="#注册中心-Zookeeper" class="headerlink" title="注册中心-Zookeeper"></a>注册中心-Zookeeper</h1><p>zookeeperRegistry  </p>
<h2 id="FailbackRegistry"><a href="#FailbackRegistry" class="headerlink" title="FailbackRegistry"></a>FailbackRegistry</h2><blockquote>
<p>作为<code>ZookeeperRegistry</code>的父类:专注用于失败后的重试机制<br>起<code>DubboRegistryFailedRetryTimer</code>线程池用来做定时任务  </p>
</blockquote>
<ul>
<li><p>doRegister : 注册中心失败  </p>
</li>
<li><p>doSubscribe : 监听注册中心失败重试  </p>
</li>
<li><p>doUnsubscribe : 向服务器端发送取消订阅请求失败重试  </p>
</li>
<li><p>doNotify : 将失败的通知请求记录到失败列表，定时重试</p>
</li>
</ul>
<p><br><br><br><br><br></p>
<h1 id="网络模型-Netty"><a href="#网络模型-Netty" class="headerlink" title="网络模型-Netty"></a>网络模型-Netty</h1><blockquote>
<p>HeaderExchangeClient/HeaderExchangeServer-&gt;NettyServer/NettyClient<br>NettyServer/NettyClient—&gt;MultiMessageHandler–&gt;HeartbeatHandler—&gt; AllChannelHandler<br>[HeaderExchanger构建] DecodeHandler-&gt; HeaderExchangeHandler-&gt;NettyHandler      </p>
</blockquote>
<h2 id="消费者-网络模型"><a href="#消费者-网络模型" class="headerlink" title="消费者-网络模型"></a>消费者-网络模型</h2><p><img src="/2017/08/25/dubbo/image-04.png" alt="03"></p>
<ul>
<li><code>DubboInvoke</code>获取Client判读是否是共享client还是非共享client  </li>
<li><code>Exchangers</code>工具类,获得合适的Exchanger进行connect链接,默认为<code>HeaderExchanger</code>  </li>
<li><code>HeaderExchanger</code>进行<code>RequestHandler</code>参数包裹<blockquote>
<p><code>HeaderExchangeHandler</code>包裹第一层<br><code>DecodeHandler</code>包裹第二层<br><code>Transporters.connect</code>起客户端链接<br><code>HeaderExchangeClient</code>包裹第三层,并且在初始化防范中起<code>dubbo-remoting-client-heartbeat</code>心跳</p>
</blockquote>
</li>
<li><p><code>Transporters</code>工具类,根据上一轮步骤<code>Transporters.connect</code>起客户端链接衍生      </p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getTransporter() //默认获取NettyTransporter</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>NettyTransporter</code>初始化新的<code>NettyClient</code>返回回去  </p>
</li>
<li><p><code>NettyClient</code>  </p>
<blockquote>
<p><code>wrapChannelHandler</code>进行包裹</p>
</blockquote>
<ul>
<li><p>寻找<code>Dispatch</code>,默认<code>AllDispatcher</code>实现类</p>
<ul>
<li><p><code>AllChannelHandler</code>包裹Url以及handler(被<code>DecodeHandler</code>,<code>HeaderExchangeHandler</code>包裹)</p>
</li>
<li><p>在<code>WrappedChannelHandler</code>初始化中起executor(<code>DubboClientHandler</code>)</p>
</li>
<li><p>再初始化一个dataStore存储url-&gt;executor</p>
</li>
</ul>
</li>
<li><code>HeartbeatHandler</code>包裹</li>
<li><code>MultiMessageHandler</code>包裹</li>
</ul>
</li>
</ul>
<p><br><br><br></p>
<h1 id="参数功能点-URL"><a href="#参数功能点-URL" class="headerlink" title="参数功能点-URL"></a>参数功能点-URL</h1><h2 id="屏蔽功能"><a href="#屏蔽功能" class="headerlink" title="屏蔽功能"></a>屏蔽功能</h2><h3 id="dubbo管控台调控"><a href="#dubbo管控台调控" class="headerlink" title="dubbo管控台调控"></a>dubbo管控台调控</h3><blockquote>
<p>消费者 禁止 被禁止的客户端将收到禁止访问异常。<br>notify的时候会带上<code>route</code>的url     </p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">route://0.0.0.0/cn.coderss.service.user.api.UserService?category=routers&amp;dynamic=false&amp;enabled=true&amp;force=true&amp;name=cn.coderss.service.user.api.UserService blackwhitelist&amp;priority=0&amp;router=condition&amp;rule=consumer.host+%3D+192.168.3.149+%3D%3E+false&amp;runtime=false</span><br></pre></td></tr></table></figure>
<blockquote>
<p>“rule” -&gt; “consumer.host+=+192.168.3.149+=&gt;+false”</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">RegistryDirectory#notify-&gt;refreshInvoker-&gt;toMethodInvokers-&gt;newMethodInvokerMap.put(method, route(methodInvokers, method));</span><br><span class="line"></span><br><span class="line">invokers = router.route(invokers, getConsumerUrl(), invocation); </span><br><span class="line">//路由得到无Invokers结果</span><br></pre></td></tr></table></figure>
<h2 id="Mock服务降级-amp-amp-容错机制"><a href="#Mock服务降级-amp-amp-容错机制" class="headerlink" title="Mock服务降级&amp;&amp;容错机制"></a>Mock服务降级&amp;&amp;容错机制</h2><blockquote>
<p>注意点:初始化的时候如果<code>mock=force:return+null</code>或者<code>mock=fail:return+null</code>都会失效,只有<code>mock=retur null</code>才能行<br>因为<code>AbstractMethodConfig#setMock</code>有相关的mock参数检测,只允许<code>.数字字母</code>  </p>
</blockquote>
<h3 id="dubbo管控台调控-1"><a href="#dubbo管控台调控-1" class="headerlink" title="dubbo管控台调控"></a>dubbo管控台调控</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zookeeper注册中心变更</span><br><span class="line">RegistryDirectory#notify-&gt;refreshInvoker-&gt;toInvokers-&gt;mergeUrl</span><br></pre></td></tr></table></figure>
<p>导致变更以下代码  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//directoryUrl 与 override 合并是在notify的最后，这里不能够处理</span></span><br><span class="line"><span class="keyword">this</span>.overrideDirectoryUrl = <span class="keyword">this</span>.overrideDirectoryUrl.addParametersIfAbsent(providerUrl.getParameters()); <span class="comment">// 合并提供者参数</span></span><br></pre></td></tr></table></figure>
<p>调用的时候<code>MockClusterInvoker#invoke</code>  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取`overrideDirectoryUrl`相关的mock参数  </span></span><br><span class="line">String value = directory.getUrl().getMethodParameter(invocation.getMethodName(), Constants.MOCK_KEY, Boolean.FALSE.toString()).trim();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//no mock</span></span><br><span class="line">result = <span class="keyword">this</span>.invoker.invoke(invocation);</span><br><span class="line"></span><br><span class="line"><span class="comment">//force:direct mock</span></span><br><span class="line">result = doMockInvoke(invocation, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//fail-mock</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    result = <span class="keyword">this</span>.invoker.invoke(invocation);</span><br><span class="line">&#125;<span class="keyword">catch</span> (RpcException e) &#123;</span><br><span class="line">    <span class="keyword">if</span> (e.isBiz()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (logger.isWarnEnabled()) &#123;</span><br><span class="line">            logger.info(<span class="string">"fail-mock: "</span> + invocation.getMethodName() + <span class="string">" fail-mock enabled , url : "</span> +  directory.getUrl(), e);</span><br><span class="line">        &#125;</span><br><span class="line">        result = doMockInvoke(invocation, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>mock=force:return+null</code>当强制返回的时候或者<code>fail:return+null</code>的情况下<br>首先都会去<code>RegistryDirectory#list</code>找是否提供相关的<code>mock协议而不是dubbo协议的服务提供者</code><br>如果有则调用这些<code>invokers</code>否则自己去组装一个<code>mockInvoker</code>  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">MockInvoker#invoke</span><br><span class="line"></span><br><span class="line">mock = normallizeMock(URL.decode(mock));</span><br><span class="line"><span class="keyword">if</span> (Constants.RETURN_PREFIX.trim().equalsIgnoreCase(mock.trim()))&#123;</span><br><span class="line">    RpcResult result = <span class="keyword">new</span> RpcResult();</span><br><span class="line">    result.setValue(<span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (mock.startsWith(Constants.RETURN_PREFIX)) &#123;</span><br><span class="line">    mock = mock.substring(Constants.RETURN_PREFIX.length()).trim();</span><br><span class="line">    mock = mock.replace(<span class="string">'`'</span>, <span class="string">'"'</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Type[] returnTypes = RpcUtils.getReturnTypes(invocation);</span><br><span class="line">        Object value = parseMockValue(mock, returnTypes);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RpcResult(value);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception ew) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RpcException(<span class="string">"mock return invoke error. method :"</span> + invocation.getMethodName() + <span class="string">", mock:"</span> + mock + <span class="string">", url: "</span>+ url , ew);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (mock.startsWith(Constants.THROW_PREFIX)) &#123;</span><br><span class="line">    mock = mock.substring(Constants.THROW_PREFIX.length()).trim();</span><br><span class="line">    mock = mock.replace(<span class="string">'`'</span>, <span class="string">'"'</span>);</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(mock))&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RpcException(<span class="string">" mocked exception for Service degradation. "</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">//用户自定义类</span></span><br><span class="line">        Throwable t = getThrowable(mock);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RpcException(RpcException.BIZ_EXCEPTION, t);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123; <span class="comment">//impl mock</span></span><br><span class="line">     <span class="keyword">try</span> &#123;</span><br><span class="line">         Invoker&lt;T&gt; invoker = getInvoker(mock);</span><br><span class="line">         <span class="keyword">return</span> invoker.invoke(invocation);</span><br><span class="line">     &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> RpcException(<span class="string">"Failed to create mock implemention class "</span> + mock , t);</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="初始化服务调控"><a href="#初始化服务调控" class="headerlink" title="初始化服务调控"></a>初始化服务调控</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Reference</span>(timeout = <span class="number">600000</span>, mock = <span class="string">"return null"</span>)</span><br><span class="line"><span class="comment">//在容错的时候不允许mock= "force:return+null"或者mock = "fail:return+null" 这是容错不是服务降级  </span></span><br><span class="line"><span class="comment">//否则在setMock属性会去检测  checkName-&gt;`Pattern.compile("[\\-._0-9a-zA-Z]+")` 这些范围才允许mock容错生效  </span></span><br><span class="line">UserService service;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/user"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> User <span class="title">getUser</span><span class="params">(String name)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> service.getUserByName(name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="线程模型"><a href="#线程模型" class="headerlink" title="线程模型"></a>线程模型</h1><p><img src="/2017/08/25/dubbo/image-06.png" alt="image-20180803143759053"></p>
<h2 id="业务线程模型"><a href="#业务线程模型" class="headerlink" title="业务线程模型"></a>业务线程模型</h2><blockquote>
<p>Dispatcher</p>
</blockquote>
<ul>
<li><p>all 除发送消息之外,其他全部使用线程池处理;包括请求，响应，连接事件，断开事件，心跳等。</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">connected</span><span class="params">(Channel channel)</span> <span class="keyword">throws</span> RemotingException </span>&#123;</span><br><span class="line">    ExecutorService cexecutor = getExecutorService(); </span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        cexecutor.execute(<span class="keyword">new</span> ChannelEventRunnable(channel, handler ,ChannelState.CONNECTED));</span><br><span class="line">    &#125;<span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ExecutionException(<span class="string">"connect event"</span>, channel, getClass()+<span class="string">" error when process connected event ."</span> , t);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">disconnected</span><span class="params">(Channel channel)</span> <span class="keyword">throws</span> RemotingException </span>&#123;</span><br><span class="line">    ExecutorService cexecutor = getExecutorService(); </span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        cexecutor.execute(<span class="keyword">new</span> ChannelEventRunnable(channel, handler ,ChannelState.DISCONNECTED));</span><br><span class="line">    &#125;<span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ExecutionException(<span class="string">"disconnect event"</span>, channel, getClass()+<span class="string">" error when process disconnected event ."</span> , t);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">received</span><span class="params">(Channel channel, Object message)</span> <span class="keyword">throws</span> RemotingException </span>&#123;</span><br><span class="line">    ExecutorService cexecutor = getExecutorService();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        cexecutor.execute(<span class="keyword">new</span> ChannelEventRunnable(channel, handler, ChannelState.RECEIVED, message));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ExecutionException(message, channel, getClass() + <span class="string">" error when process received event ."</span>, t);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">caught</span><span class="params">(Channel channel, Throwable exception)</span> <span class="keyword">throws</span> RemotingException </span>&#123;</span><br><span class="line">    ExecutorService cexecutor = getExecutorService(); </span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        cexecutor.execute(<span class="keyword">new</span> ChannelEventRunnable(channel, handler ,ChannelState.CAUGHT, exception));</span><br><span class="line">    &#125;<span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ExecutionException(<span class="string">"caught event"</span>, channel, getClass()+<span class="string">" error when process caught event ."</span> , t);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> ExecutorService <span class="title">getExecutorService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ExecutorService cexecutor = executor;</span><br><span class="line">    <span class="keyword">if</span> (cexecutor == <span class="keyword">null</span> || cexecutor.isShutdown()) &#123; </span><br><span class="line">        cexecutor = SHARED_EXECUTOR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cexecutor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>execution 除发送消息之外,其他全部使用线程池处理;</p>
<blockquote>
<p>与AllChannelHandler不同之处在于若创建的线程池ExecutorService不可用，AllChannelHandler将使用共享线程池，而ExecutionChannelHandler只有报错了。</p>
</blockquote>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">connected</span><span class="params">(Channel channel)</span> <span class="keyword">throws</span> RemotingException </span>&#123;</span><br><span class="line">    executor.execute(<span class="keyword">new</span> ChannelEventRunnable(channel, handler ,ChannelState.CONNECTED));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">disconnected</span><span class="params">(Channel channel)</span> <span class="keyword">throws</span> RemotingException </span>&#123;</span><br><span class="line">    executor.execute(<span class="keyword">new</span> ChannelEventRunnable(channel, handler ,ChannelState.DISCONNECTED));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">received</span><span class="params">(Channel channel, Object message)</span> <span class="keyword">throws</span> RemotingException </span>&#123;</span><br><span class="line">    executor.execute(<span class="keyword">new</span> ChannelEventRunnable(channel, handler, ChannelState.RECEIVED, message));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">caught</span><span class="params">(Channel channel, Throwable exception)</span> <span class="keyword">throws</span> RemotingException </span>&#123;</span><br><span class="line">    executor.execute(<span class="keyword">new</span> ChannelEventRunnable(channel, handler ,ChannelState.CAUGHT, exception));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>direct 所有消息都不派发到线程池，全部在 IO 线程上直接执行。</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ChannelHandler <span class="title">dispatch</span><span class="params">(ChannelHandler handler, URL url)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> handler;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>message 只有请求响应消息派发到线程池，其它连接断开事件，心跳等消息，直接在 IO 线程上执行。</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ChannelHandler <span class="title">dispatch</span><span class="params">(ChannelHandler handler, URL url)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> MessageOnlyChannelHandler(handler, url);</span><br><span class="line">&#125;</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">received</span><span class="params">(Channel channel, Object message)</span> <span class="keyword">throws</span> RemotingException </span>&#123;</span><br><span class="line">    ExecutorService cexecutor = executor;</span><br><span class="line">    <span class="keyword">if</span> (cexecutor == <span class="keyword">null</span> || cexecutor.isShutdown()) &#123;</span><br><span class="line">        cexecutor = SHARED_EXECUTOR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        cexecutor.execute(<span class="keyword">new</span> ChannelEventRunnable(channel, handler, ChannelState.RECEIVED, message));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ExecutionException(message, channel, getClass() + <span class="string">" error when process received event ."</span>, t);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>connection 在 IO 线程上，将连接断开事件放入队列，有序逐个执行，其它消息派发到线程池。</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ConnectionOrderedChannelHandler</span><span class="params">(ChannelHandler handler, URL url)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(handler, url);</span><br><span class="line">    String threadName = url.getParameter(Constants.THREAD_NAME_KEY,Constants.DEFAULT_THREAD_NAME);</span><br><span class="line">    connectionExecutor = <span class="keyword">new</span> ThreadPoolExecutor(<span class="number">1</span>, <span class="number">1</span>,</span><br><span class="line">                                 <span class="number">0L</span>, TimeUnit.MILLISECONDS,</span><br><span class="line">                                 <span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;(url.getPositiveParameter(Constants.CONNECT_QUEUE_CAPACITY, Integer.MAX_VALUE)),</span><br><span class="line">                                 <span class="keyword">new</span> NamedThreadFactory(threadName, <span class="keyword">true</span>),</span><br><span class="line">                                 <span class="keyword">new</span> AbortPolicyWithReport(threadName, url)</span><br><span class="line">        );  <span class="comment">// FIXME 没有地方释放connectionExecutor！</span></span><br><span class="line">    queuewarninglimit = url.getParameter(Constants.CONNECT_QUEUE_WARNING_SIZE, Constants.DEFAULT_CONNECT_QUEUE_WARNING_SIZE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">connected</span><span class="params">(Channel channel)</span> <span class="keyword">throws</span> RemotingException </span>&#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        checkQueueLength();</span><br><span class="line">        connectionExecutor.execute(<span class="keyword">new</span> ChannelEventRunnable(channel, handler ,ChannelState.CONNECTED));</span><br><span class="line">    &#125;<span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ExecutionException(<span class="string">"connect event"</span>, channel, getClass()+<span class="string">" error when process connected event ."</span> , t);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">disconnected</span><span class="params">(Channel channel)</span> <span class="keyword">throws</span> RemotingException </span>&#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        checkQueueLength();</span><br><span class="line">        connectionExecutor.execute(<span class="keyword">new</span> ChannelEventRunnable(channel, handler ,ChannelState.DISCONNECTED));</span><br><span class="line">    &#125;<span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ExecutionException(<span class="string">"disconnected event"</span>, channel, getClass()+<span class="string">" error when process disconnected event ."</span> , t);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">received</span><span class="params">(Channel channel, Object message)</span> <span class="keyword">throws</span> RemotingException </span>&#123;</span><br><span class="line">    ExecutorService cexecutor = executor;</span><br><span class="line">    <span class="keyword">if</span> (cexecutor == <span class="keyword">null</span> || cexecutor.isShutdown()) &#123;</span><br><span class="line">        cexecutor = SHARED_EXECUTOR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        cexecutor.execute(<span class="keyword">new</span> ChannelEventRunnable(channel, handler, ChannelState.RECEIVED, message));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ExecutionException(message, channel, getClass() + <span class="string">" error when process received event ."</span>, t);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">caught</span><span class="params">(Channel channel, Throwable exception)</span> <span class="keyword">throws</span> RemotingException </span>&#123;</span><br><span class="line">    ExecutorService cexecutor = executor;</span><br><span class="line">    <span class="keyword">if</span> (cexecutor == <span class="keyword">null</span> || cexecutor.isShutdown()) &#123; </span><br><span class="line">        cexecutor = SHARED_EXECUTOR;</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        cexecutor.execute(<span class="keyword">new</span> ChannelEventRunnable(channel, handler ,ChannelState.CAUGHT, exception));</span><br><span class="line">    &#125;<span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ExecutionException(<span class="string">"caught event"</span>, channel, getClass()+<span class="string">" error when process caught event ."</span> , t);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkQueueLength</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (connectionExecutor.getQueue().size() &gt; queuewarninglimit)&#123;</span><br><span class="line">        logger.warn(<span class="keyword">new</span> IllegalThreadStateException(<span class="string">"connectionordered channel handler `queue size: "</span>+connectionExecutor.getQueue().size()+<span class="string">" exceed the warning limit number :"</span>+queuewarninglimit));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<blockquote>
<p>ThreadPool</p>
</blockquote>
<ul>
<li>fixed 固定大小线程池，启动时建立线程，不关闭，一直持有。(缺省)</li>
<li>cached 缓存线程池，空闲一分钟自动删除，需要时重建。</li>
<li>limited 可伸缩线程池，但池中的线程数只会增长不会收缩。只增长不收缩的目的是为了避免收缩时突然来了大流量引起的性能问题。</li>
</ul>
<h2 id="DubboRegistryFailedRetryTimer"><a href="#DubboRegistryFailedRetryTimer" class="headerlink" title="DubboRegistryFailedRetryTimer"></a>DubboRegistryFailedRetryTimer</h2><blockquote>
<p>注册中心相关 失败执行后 - 定时循环重新执行任务 - 执行器  </p>
</blockquote>
<p>参数<code>retry.period</code>  : 注册中心失败事件重试事件,即此线程的定时数,单位默认<code>MILLISECONDS</code>  </p>
<blockquote>
<p><code>FailbackRegistry</code> 作为<code>ZookeeperRegistry</code>的父类:专注用于失败后的重试机制  </p>
</blockquote>
<ul>
<li><p>doRegister : 注册中心失败  </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//failedRegistered 数值的由来</span></span><br><span class="line"><span class="comment">//failedRegistered.remove(url);</span></span><br><span class="line"><span class="comment">//failedUnregistered.remove(url);</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 向服务器端发送注册请求</span></span><br><span class="line">    doRegister(url);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">     <span class="comment">// 将失败的注册请求记录到失败列表，定时重试</span></span><br><span class="line">    failedRegistered.add(url);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//只要成功了就移除failedRegistered.remove(url);</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doRegister</span><span class="params">(URL url)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        zkClient.create(toUrlPath(url), url.getParameter(Constants.DYNAMIC_KEY, <span class="keyword">true</span>));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RpcException(<span class="string">"Failed to register "</span> + url + <span class="string">" to zookeeper "</span> + getUrl() + <span class="string">", cause: "</span> + e.getMessage(), e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>doSubscribe : 监听注册中心失败重试  </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">failedSubscribed</span><br><span class="line"></span><br><span class="line"><span class="comment">//removeFailedSubscribed(url, listener);</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 向服务器端发送订阅请求</span></span><br><span class="line">    doSubscribe(url, listener);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    <span class="comment">// 将失败的订阅请求记录到失败列表，定时重试</span></span><br><span class="line">    addFailedSubscribed(url, listener);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>doUnsubscribe : 向服务器端发送取消订阅请求失败重试  </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">removeFailedSubscribed(url, listener);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 向服务器端发送取消订阅请求</span></span><br><span class="line">    doUnsubscribe(url, listener);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    <span class="comment">// 将失败的取消订阅请求记录到失败列表，定时重试</span></span><br><span class="line">    Set&lt;NotifyListener&gt; listeners = failedUnsubscribed.get(url);</span><br><span class="line">    <span class="keyword">if</span> (listeners == <span class="keyword">null</span>) &#123;</span><br><span class="line">        failedUnsubscribed.putIfAbsent(url, <span class="keyword">new</span> ConcurrentHashSet&lt;NotifyListener&gt;());</span><br><span class="line">        listeners = failedUnsubscribed.get(url);</span><br><span class="line">    &#125;</span><br><span class="line">    listeners.add(listener);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>doNotify : 将失败的通知请求记录到失败列表，定时重试</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">try</span> &#123;</span><br><span class="line">    doNotify(url, listener, urls);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception t) &#123;</span><br><span class="line">    <span class="comment">// 将失败的通知请求记录到失败列表，定时重试</span></span><br><span class="line">    Map&lt;NotifyListener, List&lt;URL&gt;&gt; listeners = failedNotified.get(url);</span><br><span class="line">    <span class="keyword">if</span> (listeners == <span class="keyword">null</span>) &#123;</span><br><span class="line">        failedNotified.putIfAbsent(url, <span class="keyword">new</span> ConcurrentHashMap&lt;NotifyListener, List&lt;URL&gt;&gt;());</span><br><span class="line">        listeners = failedNotified.get(url);</span><br><span class="line">    &#125;</span><br><span class="line">    listeners.put(listener, urls);</span><br><span class="line">    logger.error(<span class="string">"Failed to notify for subscribe "</span> + url + <span class="string">", waiting for retry, cause: "</span> + t.getMessage(), t);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="forking-cluster-timer"><a href="#forking-cluster-timer" class="headerlink" title="forking-cluster-timer"></a>forking-cluster-timer</h2><blockquote>
<p><code>Cluster</code>选用<code>Forking Cluster</code><br>并行调用多个服务器，只要一个成功即返回  </p>
</blockquote>
<h2 id="failback-cluster-timer"><a href="#failback-cluster-timer" class="headerlink" title="failback-cluster-timer"></a>failback-cluster-timer</h2><blockquote>
<p><code>Cluster</code>选用<code>Failback Cluster</code><br><code>failback-cluster-timer</code>线程池用于定时重发失败的调用  </p>
</blockquote>
<h2 id="DubboClientHandler"><a href="#DubboClientHandler" class="headerlink" title="DubboClientHandler"></a>DubboClientHandler</h2><blockquote>
<p><code>NettyClient</code>产生线程池<br><code>ChannelHandlers#wrap</code>将<code>NettyClient</code>相关处理业务的<code>handler</code>包裹在<code>Dispatcher</code>   </p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;dubbo:protocol name=&quot;dubbo&quot; dispatcher=&quot;all&quot; threadpool=&quot;fixed&quot; threads=&quot;100&quot; /&gt;</span><br></pre></td></tr></table></figure>
<h2 id="dubbo-remoting-client-heartbeat"><a href="#dubbo-remoting-client-heartbeat" class="headerlink" title="dubbo-remoting-client-heartbeat"></a>dubbo-remoting-client-heartbeat</h2><blockquote>
<p><code>HeaderExchangeClient</code>产生此线程池,执行<code>HeartBeatTask</code></p>
</blockquote>
<p>heartbeat:性能调优心跳间隔,对于长连接,当物理层断开时;比如拔网线,TCP的FIN消息来不及发送,对方收不到断开事件,此时需要心跳来帮助检查连接是否已断开  </p>
<h2 id="DubboClientReconnectTimer"><a href="#DubboClientReconnectTimer" class="headerlink" title="DubboClientReconnectTimer"></a>DubboClientReconnectTimer</h2><blockquote>
<p>Dubbo客户端断线重连<br>心跳和断线重连线程池工作职责不一样  </p>
</blockquote>
<ul>
<li>心跳 : 只管发send信息到各个channelProvider,如果遇到超时则进行重连,期间正常发的时候不去管是否有断开连接    </li>
<li>断线重连 : 定时判断是否连接,如遇没有连接则进行重连    </li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Runnable connectStatusCheckCommand =  <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (! isConnected()) &#123;</span><br><span class="line">                connect();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                lastConnectedTime = System.currentTimeMillis();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123; </span><br><span class="line">            String errorMsg = <span class="string">"client reconnect to "</span>+getUrl().getAddress()+<span class="string">" find error . url: "</span>+ getUrl();</span><br><span class="line">            <span class="comment">// wait registry sync provider list</span></span><br><span class="line">            <span class="keyword">if</span> (System.currentTimeMillis() - lastConnectedTime &gt; shutdown_timeout)&#123;</span><br><span class="line">                <span class="keyword">if</span> (!reconnect_error_log_flag.get())&#123;</span><br><span class="line">                    reconnect_error_log_flag.set(<span class="keyword">true</span>);</span><br><span class="line">                    logger.error(errorMsg, t);</span><br><span class="line">                    <span class="keyword">return</span> ;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ( reconnect_count.getAndIncrement() % reconnect_warning_period == <span class="number">0</span>)&#123;</span><br><span class="line">                logger.warn(errorMsg, t);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">reconnectExecutorFuture = reconnectExecutorService.scheduleWithFixedDelay(connectStatusCheckCommand, reconnect, reconnect, TimeUnit.MILLISECONDS);</span><br></pre></td></tr></table></figure>
<h2 id="DubboSaveRegistryCache"><a href="#DubboSaveRegistryCache" class="headerlink" title="DubboSaveRegistryCache"></a>DubboSaveRegistryCache</h2><blockquote>
<p><code>AbstractRegistry</code>产生,主要用于配置文件缓存定时写入<br>每次注册中心<code>notify</code>的时候会激发<code>saveProperties(url);</code>-&gt;<code>registryCacheExecutor.execute(new SaveProperties(version));</code>函数<br>用于写入invoker的时候写入本地缓存</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">registryCacheExecutor.execute(<span class="keyword">new</span> SaveProperties(lastCacheChanged.incrementAndGet()));</span><br></pre></td></tr></table></figure>
<h2 id="DubboServerHandler"><a href="#DubboServerHandler" class="headerlink" title="DubboServerHandler"></a>DubboServerHandler</h2><blockquote>
<p><code>NettyServer</code>产生线程池<br><code>ChannelHandlers#wrap</code>将<code>NettyClient</code>相关处理业务的<code>handler</code>包裹在<code>Dispatcher</code>   </p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;dubbo:protocol name=&quot;dubbo&quot; dispatcher=&quot;all&quot; threadpool=&quot;fixed&quot; threads=&quot;100&quot; /&gt;</span><br></pre></td></tr></table></figure>
<h2 id="dubbo-remoting-server-heartbeat"><a href="#dubbo-remoting-server-heartbeat" class="headerlink" title="dubbo-remoting-server-heartbeat"></a>dubbo-remoting-server-heartbeat</h2><blockquote>
<p><code>HeaderExchangeServer</code>产生线程池,执行<code>HeartBeatTask</code>  </p>
</blockquote>
<h1 id="handler包裹"><a href="#handler包裹" class="headerlink" title="handler包裹"></a>handler包裹</h1><blockquote>
<p>ExchangerChannelHandler与ExchangeChannelHandler不一样<br>一个用来处理响应并回复,一个用来作为NettyClient包裹发送      </p>
</blockquote>
<blockquote>
<p>服务端       </p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">HeaderExchangeServer(Transporters.bind(url, <span class="keyword">new</span> DecodeHandler(<span class="keyword">new</span> HeaderExchangeHandler(handler))));</span><br><span class="line">MultiMessageHandler(<span class="keyword">new</span> HeartbeatHandler(</span><br><span class="line">    ExtensionLoader.getExtensionLoader(Dispatcher.class).getAdaptiveExtension().dispatch(handler, url))</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">响应:</span><br><span class="line">MultiMessageHandler------&gt;HeartbeatHandler------&gt;Dispatcher线程池------&gt;</span><br><span class="line">DecodeHandler------&gt;HeaderExchangerHandler------&gt;DubboProtocol#requestHandler</span><br><span class="line">------&gt;DubboExporter------&gt;proxyFactory#invoker</span><br><span class="line"></span><br><span class="line">发送:</span><br><span class="line">HeaderExchangeHandler#received</span><br><span class="line">Response response = handleRequest(exchangeChannel, request);<span class="comment">//给DubboProtocol#requestHandler执行</span></span><br><span class="line">channel.send(response);<span class="comment">//再发出去</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>客户端  </p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">HeaderExchangeClient(Transporters.connect(url, <span class="keyword">new</span> DecodeHandler(<span class="keyword">new</span> HeaderExchangeHandler(handler))));</span><br><span class="line">整体的结构:</span><br><span class="line">MultiMessageHandler------&gt;HeartbeatHandler------&gt;Dispatcher线程池------&gt;</span><br><span class="line">DecodeHandler------&gt;HeaderExchangerHandler------&gt;DubboProtocol#requestHandler</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">发送:</span><br><span class="line">HeaderExchangeClient内部把NettyTransport返回的NettyClient作为client后</span><br><span class="line"><span class="keyword">this</span>.channel = <span class="keyword">new</span> HeaderExchangeChannel(client);</span><br><span class="line">还包了一层HeaderExchangeChannel与所以request方法实际简介运营nettyClient如下:</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> ResponseFuture <span class="title">request</span><span class="params">(Object request, <span class="keyword">int</span> timeout)</span> <span class="keyword">throws</span> RemotingException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (closed) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RemotingException(<span class="keyword">this</span>.getLocalAddress(), <span class="keyword">null</span>, <span class="string">"Failed to send request "</span> + request + <span class="string">", cause: The channel "</span> + <span class="keyword">this</span> + <span class="string">" is closed!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// create request.</span></span><br><span class="line">    Request req = <span class="keyword">new</span> Request();</span><br><span class="line">    req.setVersion(<span class="string">"2.0.0"</span>);</span><br><span class="line">    req.setTwoWay(<span class="keyword">true</span>);</span><br><span class="line">    req.setData(request);</span><br><span class="line">    DefaultFuture future = <span class="keyword">new</span> DefaultFuture(channel, req, timeout);</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        channel.send(req);</span><br><span class="line">    &#125;<span class="keyword">catch</span> (RemotingException e) &#123;</span><br><span class="line">        future.cancel();</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> future;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">响应:</span><br><span class="line">HeaderExchangerHandler会拦截</span><br><span class="line"><span class="keyword">if</span> (message <span class="keyword">instanceof</span> Response) &#123;</span><br><span class="line">    handleResponse(channel, (Response) message);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">handleResponse</span><span class="params">(Channel channel, Response response)</span> <span class="keyword">throws</span> RemotingException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (response != <span class="keyword">null</span> &amp;&amp; !response.isHeartbeat()) &#123;</span><br><span class="line">        DefaultFuture.received(channel, response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
        
    </section>
</article>



<div class="comments">
    <div id="disqus_thread">
        <p class="comment-tips">国内查看评论需要代理~</p>
    </div>
    <script>
    window.disqus_config = function () {
        this.language = 'zh';
        this.page.url = 'http://www.coderss.cn/2017/08/25/dubbo/';
        this.page.title = 'Dubbo解析';
        this.page.identifier = '2017/08/25/dubbo/';
    };
    (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        s.src = 'https://name.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>

</div>
        <footer class="footer">
    Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, Theme by <a href="https://github.com/sanonz/hexo-theme-concise" target="_blank">Concise</a>
</footer>

<script type="text/javascript" src="//s13.cnzz.com/z_stat.php?id=1234567890&amp;web_id=1234567890"></script>


    </div>

    <script type="text/javascript" src="https://cdn.bootcss.com/jquery/1.9.0/jquery.min.js"></script>
    
    <script type="text/javascript" src="/js/scrollspy.min.js"></script>
    
    <script type="text/javascript">
        $(function() {
            var nodes = {
                nav: $('#nav'),
                aside: $('#aside'),
                navTags: $('#nav-tags')
            };

            $('#open-panel, #aside-mask').on('click', function() {
                nodes.aside.toggleClass('panel-show');
            });
            $('#nav-tag').on('click', function(event) {
                event.preventDefault();console.log(nodes.navTags.attr('class'))
                nodes.navTags.toggleClass('tag-show');console.log(nodes.navTags.attr('class'))
            })/*.hover(function() {
                nodes.navTags.addClass('tag-show');
            }, function() {
                nodes.navTags.removeClass('tag-show');
            });*/

            
            $(document.body).scrollspy({target: '#aside-inner'});
            
        });
    </script>

</body>
</html>
