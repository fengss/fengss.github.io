<!DOCTYPE html>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="UTF-8">

    

    

    <title>SpringCloud源码详解 | Coderss</title>
    <meta name="author" content="coder">
    <meta name="version" content="1.0.0">
    <meta name="keywords" content="">
    <meta name="description" content="SpringCloud技术栈-相关的源码详解笔记 
Auto Configuration@Enable* 注解@SpringBootApplication注解带入了@EnableAutoConfiguration@EnableAutoConfiguration又带有@Import(EnableAutoConfigurationImportSelector.class)  
使用了Spring Core包的SpringFactoriesLoader类的loadFactoryNamesof()方法。">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <meta name="baidu-site-verification" content="F0CXvmUgA9">

    
    
    <link rel="icon" href="/favicon.png">
    

    <link rel="stylesheet" href="/css/style.css">
</head>
<body>

    <div class="app">
        <header class="header clearfix">
    <div id="nav" class="nav">
    <button id="open-panel" class="open-panel"><i class="icon-library"></i></button>

    <nav class="nav-inner">

        
        
        <li class="nav-item">
            <a class="nav-link" href="/">首页</a>
        </li>
        
        
        
        <li class="nav-item">
            <a class="nav-link" href="/categories/back-end">Java栈</a>
        </li>
        
        
        
        <li class="nav-item">
            <a class="nav-link" href="/categories/cpp">C/C++</a>
        </li>
        
        
        
        <li class="nav-item">
            <a class="nav-link" href="/categories/go">Golang</a>
        </li>
        
        
        
        <li class="nav-item">
            <a class="nav-link" href="/categories/cloud">System</a>
        </li>
        
        
        
        <li class="nav-item">
            <a class="nav-link" href="/categories/reverse">Reverse</a>
        </li>
        
        
        
        <li class="nav-item">
            <a class="nav-link" href="/categories/data">BigData</a>
        </li>
        
        
        
        <li class="nav-item">
            <a class="nav-link" href="/categories/ai">Math/AI</a>
        </li>
        
        
        
        <li class="nav-item nav-item-tag">
            <a id="nav-tag" class="nav-link" href="#">标签</a>
            <div id="nav-tags" class="nav-tag-wrap">
                <i class="nav-tag-arrow"></i>
                
  <div class="widget-wrap">
    <h3 class="widget-title">
        <i class="icon-tag vm"></i>
        <span class="vm">Tags</span>
    </h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/AI/">AI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Boost库/">Boost库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Collection/">Collection</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cpp编程/">Cpp编程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Fescar/">Fescar</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Gc/">Gc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/K8s/">K8s</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MapReduce/">MapReduce</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Math/">Math</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python计算库/">Python计算库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Sharding-jdbc/">Sharding-jdbc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SkyWalking/">SkyWalking</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spark/">Spark</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TensorFlow/">TensorFlow</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Turi/">Turi</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Windows系统/">Windows系统</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Windows驱动/">Windows驱动</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Yarn/">Yarn</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/assembly/">assembly</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/c-cpp语言/">c/cpp语言</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/debug/">debug</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/design/">design</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dubbo/">dubbo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/eth/">eth</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/flume/">flume</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go/">go</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go-kernel/">go-kernel</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/io/">io</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/">java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/juc/">juc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kubernetes/">kubernetes</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/map/">map</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mfc/">mfc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/microservice/">microservice</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mybatis/">mybatis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/netty/">netty</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python-book/">python-book</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/qt/">qt</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sentinel/">sentinel</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/skycoin/">skycoin</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spring/">spring</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spring-cloud/">spring-cloud</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/stl/">stl</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tomcat/">tomcat</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/x86-Windows系统总结/">x86 Windows系统总结</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/中台/">中台</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/内网穿透/">内网穿透</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/分布式文件系统/">分布式文件系统</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/多线程编程/">多线程编程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/架构/">架构</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/消息队列/">消息队列</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/网络编程/">网络编程</a></li></ul>
    </div>
  </div>


            </div>
        </li>
        
        
        
        <li class="nav-item">
            <a class="nav-link" href="/archives">归档</a>
        </li>
        
        
        

    </nav>
</div>

    <aside id="aside" class="aside">
    <div id="aside-mask" class="aside-mask"></div>
    <div id="aside-inner" class="aside-inner">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit"><i class="icon-search-stroke"></i></button><input type="hidden" name="sitesearch" value="http://www.coderss.cn"></form>

        
        
        
        
        

        
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Auto-Configuration"><span class="toc-number">1.</span> <span class="toc-text">Auto Configuration</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Enable-注解"><span class="toc-number">1.1.</span> <span class="toc-text">@Enable* 注解</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#DeferredImportSelector-接口"><span class="toc-number">1.1.1.</span> <span class="toc-text">DeferredImportSelector 接口</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#属性映射"><span class="toc-number">1.2.</span> <span class="toc-text">属性映射</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Conditional-注解"><span class="toc-number">1.3.</span> <span class="toc-text">@Conditional 注解</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Eureka"><span class="toc-number">2.</span> <span class="toc-text">Eureka</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#概述"><span class="toc-number">2.1.</span> <span class="toc-text">概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Eureka-Server的集群同步操作"><span class="toc-number">2.1.1.</span> <span class="toc-text">Eureka Server的集群同步操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PeerAwareInstanceRegistryImpl"><span class="toc-number">2.1.2.</span> <span class="toc-text">PeerAwareInstanceRegistryImpl</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#新的Eureka-Server节点加入集群后的影响"><span class="toc-number">2.1.3.</span> <span class="toc-text">新的Eureka Server节点加入集群后的影响</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#新服务注册-Register-注册时的影响"><span class="toc-number">2.1.4.</span> <span class="toc-text">新服务注册(Register)注册时的影响</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#服务心跳-renew"><span class="toc-number">2.1.5.</span> <span class="toc-text">服务心跳(renew)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#服务下线和剔除"><span class="toc-number">2.1.6.</span> <span class="toc-text">服务下线和剔除</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#自我保护模式"><span class="toc-number">2.1.7.</span> <span class="toc-text">自我保护模式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Eureka-Client"><span class="toc-number">2.2.</span> <span class="toc-text">Eureka-Client</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#初始化线程池"><span class="toc-number">2.2.1.</span> <span class="toc-text">初始化线程池</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#初始化定时任务"><span class="toc-number">2.2.2.</span> <span class="toc-text">初始化定时任务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#初始化-Eureka-网络通信相关"><span class="toc-number">2.2.3.</span> <span class="toc-text">初始化 Eureka 网络通信相关</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Eureka-Server"><span class="toc-number">2.3.</span> <span class="toc-text">Eureka Server</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#EurekaServerBootstrap"><span class="toc-number">2.4.</span> <span class="toc-text">EurekaServerBootstrap</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Eureka-Server-配置环境"><span class="toc-number">2.4.1.</span> <span class="toc-text">Eureka-Server 配置环境</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#EurekaBootStrap"><span class="toc-number">2.5.</span> <span class="toc-text">EurekaBootStrap</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Eureka-Client-1"><span class="toc-number">2.5.1.</span> <span class="toc-text">Eureka Client</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#注册"><span class="toc-number">2.6.</span> <span class="toc-text">注册</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Eureka-Client-2"><span class="toc-number">2.6.1.</span> <span class="toc-text">Eureka-Client</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#发起注册-应用实例信息复制器"><span class="toc-number">2.6.1.1.</span> <span class="toc-text">发起注册 | 应用实例信息复制器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#刷新应用实例信息"><span class="toc-number">2.6.1.2.</span> <span class="toc-text">刷新应用实例信息</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Eureka-Server-1"><span class="toc-number">2.6.2.</span> <span class="toc-text">Eureka-Server</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#接收注册请求"><span class="toc-number">2.6.2.1.</span> <span class="toc-text">接收注册请求</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#续租"><span class="toc-number">2.7.</span> <span class="toc-text">续租</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Eureka-Client-3"><span class="toc-number">2.7.1.</span> <span class="toc-text">Eureka-Client</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#初始化定时任务-1"><span class="toc-number">2.7.1.1.</span> <span class="toc-text">初始化定时任务</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Eureka-Server-2"><span class="toc-number">2.7.2.</span> <span class="toc-text">Eureka-Server</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#接收续租请求"><span class="toc-number">2.7.2.1.</span> <span class="toc-text">接收续租请求</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Feign"><span class="toc-number">3.</span> <span class="toc-text">Feign</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#注解说明"><span class="toc-number">3.1.</span> <span class="toc-text">注解说明</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#EnableFeignClients-注解"><span class="toc-number">3.1.1.</span> <span class="toc-text">EnableFeignClients 注解</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Feign-是怎么工作的？"><span class="toc-number">3.2.</span> <span class="toc-text">Feign 是怎么工作的？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#工作流程"><span class="toc-number">3.3.</span> <span class="toc-text">工作流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#FeignAutoConfiguration"><span class="toc-number">3.3.1.</span> <span class="toc-text">FeignAutoConfiguration</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FeignClientFactoryBean"><span class="toc-number">3.3.2.</span> <span class="toc-text">FeignClientFactoryBean</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Configuration-与-FeignBuilder-关联"><span class="toc-number">3.3.2.1.</span> <span class="toc-text">Configuration 与 FeignBuilder 关联</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Client-Bean"><span class="toc-number">3.3.2.2.</span> <span class="toc-text">Client Bean</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Targeter-生产代理类"><span class="toc-number">3.3.2.3.</span> <span class="toc-text">Targeter 生产代理类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#生成代理"><span class="toc-number">3.3.2.4.</span> <span class="toc-text">生成代理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SynchronousMethodHandler-invoke方法"><span class="toc-number">3.3.2.5.</span> <span class="toc-text">SynchronousMethodHandler#invoke方法</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Feign调用流程"><span class="toc-number">3.4.</span> <span class="toc-text">Feign调用流程</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Ribbon"><span class="toc-number">4.</span> <span class="toc-text">Ribbon</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#功能说明"><span class="toc-number">4.1.</span> <span class="toc-text">功能说明</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Ribbon主要组件"><span class="toc-number">4.2.</span> <span class="toc-text">Ribbon主要组件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#IRule"><span class="toc-number">4.2.1.</span> <span class="toc-text">IRule</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IPing"><span class="toc-number">4.2.2.</span> <span class="toc-text">IPing</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ServerList"><span class="toc-number">4.2.3.</span> <span class="toc-text">ServerList</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ServerListFilter"><span class="toc-number">4.2.4.</span> <span class="toc-text">ServerListFilter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ServerListUpdater"><span class="toc-number">4.2.5.</span> <span class="toc-text">ServerListUpdater</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IClientConfig"><span class="toc-number">4.2.6.</span> <span class="toc-text">IClientConfig</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ILoadBalancer"><span class="toc-number">4.2.7.</span> <span class="toc-text">ILoadBalancer</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#默认的ribbon实现类"><span class="toc-number">4.3.</span> <span class="toc-text">默认的ribbon实现类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#通过配置文件配置Ribbon的主要组件"><span class="toc-number">4.4.</span> <span class="toc-text">通过配置文件配置Ribbon的主要组件</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Hystrix"><span class="toc-number">5.</span> <span class="toc-text">Hystrix</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#简介"><span class="toc-number">5.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#应用"><span class="toc-number">5.2.</span> <span class="toc-text">应用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#线程池隔离"><span class="toc-number">5.2.1.</span> <span class="toc-text">线程池隔离</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#运用至项目-线程隔离"><span class="toc-number">5.2.1.1.</span> <span class="toc-text">运用至项目-线程隔离</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#线程池隔离-优缺点"><span class="toc-number">5.2.1.2.</span> <span class="toc-text">线程池隔离 - 优缺点</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#信号量隔离"><span class="toc-number">5.2.2.</span> <span class="toc-text">信号量隔离</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#运用至项目-信号量隔离"><span class="toc-number">5.2.2.1.</span> <span class="toc-text">运用至项目-信号量隔离</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#信号量隔离-优缺点"><span class="toc-number">5.2.2.2.</span> <span class="toc-text">信号量隔离 - 优缺点</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#熔断器"><span class="toc-number">5.2.3.</span> <span class="toc-text">熔断器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#熔断器-参数"><span class="toc-number">5.2.3.1.</span> <span class="toc-text">熔断器 - 参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#熔断模拟示例"><span class="toc-number">5.2.3.2.</span> <span class="toc-text">熔断模拟示例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#回退降级"><span class="toc-number">5.2.4.</span> <span class="toc-text">回退降级</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#注解使用"><span class="toc-number">5.2.5.</span> <span class="toc-text">注解使用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Properties属性介绍"><span class="toc-number">5.2.5.1.</span> <span class="toc-text">Properties属性介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#fallback回退"><span class="toc-number">5.2.5.2.</span> <span class="toc-text">fallback回退</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#缓存功能"><span class="toc-number">5.2.5.3.</span> <span class="toc-text">缓存功能</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HystrixCollapser-合并命令"><span class="toc-number">5.2.6.</span> <span class="toc-text">HystrixCollapser 合并命令</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#流程"><span class="toc-number">5.3.</span> <span class="toc-text">流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#toObservable"><span class="toc-number">5.3.1.</span> <span class="toc-text">toObservable</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#applyHystrixSemantics"><span class="toc-number">5.3.2.</span> <span class="toc-text">applyHystrixSemantics</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#executeCommandAndObserve"><span class="toc-number">5.3.3.</span> <span class="toc-text">executeCommandAndObserve</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#executeCommandWithSpecifiedIsolation"><span class="toc-number">5.3.4.</span> <span class="toc-text">executeCommandWithSpecifiedIsolation</span></a></li></ol></li></ol></li></ol>
        
    </div>
</aside>

</header>

        <div id="content" class="content"><article class="article" itemscope="" itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            SpringCloud源码详解
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="/2017/05/16/springcloud/">
    
    <i class="icon-calendar"></i>
    
    <time datetime="2017-05-15T16:01:22.000Z" itemprop="datePublished">2017-05-16</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag"></i>
    <a class="article-tag-link" href="/tags/spring-cloud/">spring-cloud</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <p>SpringCloud技术栈-相关的源码详解笔记<br><a id="more"></a> </p>
<h1 id="Auto-Configuration"><a href="#Auto-Configuration" class="headerlink" title="Auto Configuration"></a>Auto Configuration</h1><h2 id="Enable-注解"><a href="#Enable-注解" class="headerlink" title="@Enable* 注解"></a>@Enable* 注解</h2><p><code>@SpringBootApplication</code>注解带入了<code>@EnableAutoConfiguration</code><br><code>@EnableAutoConfiguration</code>又带有<code>@Import(EnableAutoConfigurationImportSelector.class)</code>  </p>
<p>使用了Spring Core包的SpringFactoriesLoader类的loadFactoryNamesof()方法。<br>SpringFactoriesLoader会查询META-INF/spring.factories文件中包含的JAR文件。   </p>
<h3 id="DeferredImportSelector-接口"><a href="#DeferredImportSelector-接口" class="headerlink" title="DeferredImportSelector 接口"></a>DeferredImportSelector 接口</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sequenceDiagram</span><br><span class="line"></span><br><span class="line">SpringApplication-&gt;&gt;SpringApplication:run(args);</span><br><span class="line">SpringApplication-&gt;&gt;SpringApplication:refreshContext</span><br><span class="line">SpringApplication-&gt;&gt;AbstractApplicationContext:refresh</span><br><span class="line">AbstractApplicationContext-&gt;&gt;AbstractApplicationContext:invokeBeanFactoryPostProcessors</span><br><span class="line">AbstractApplicationContext-&gt;&gt;PostProcessorRegistrationDelegate:invokeBeanFactoryPostProcessors</span><br><span class="line">PostProcessorRegistrationDelegate-&gt;&gt;postProcessor:postProcessBeanDefinitionRegistry</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sequenceDiagram</span><br><span class="line"></span><br><span class="line">ConfigurationClassPostProcessor-&gt;&gt;ConfigurationClassPostProcessor:processConfigBeanDefinitions;</span><br><span class="line">ConfigurationClassPostProcessor-&gt;&gt;ConfigurationClassParser:parse</span><br><span class="line">ConfigurationClassParser-&gt;&gt;ConfigurationClassParser:processDeferredImportSelectors</span><br><span class="line">ConfigurationClassParser-&gt;&gt;DeferredImportSelector:selectImports</span><br></pre></td></tr></table></figure>
<blockquote>
<p>以上逻辑就实现了DeferredImportSelector,才得以重写的selectImports起生效</p>
<blockquote>
<p>getCandidateConfigurations利用了SpringFactoriesLoader.loadFactoryNames寻找相关的”META-INF/spring.factories”</p>
</blockquote>
</blockquote>
<p><br></p>
<h2 id="属性映射"><a href="#属性映射" class="headerlink" title="属性映射"></a>属性映射</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"spring.data.mongodb"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MongoProperties</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String host;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> port = DBPort.PORT;</span><br><span class="line">    <span class="keyword">private</span> String uri = <span class="string">"mongodb://localhost/test"</span>;</span><br><span class="line">    <span class="keyword">private</span> String database;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ... getters/ setters omitted</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>@ConfigurationProperties注释将POJO关联到指定前缀的每一个属性。<br>例如:spring.data.mongodb.port属性将映射到这个类的端口属性。 </p>
<p><br></p>
<h2 id="Conditional-注解"><a href="#Conditional-注解" class="headerlink" title="@Conditional 注解"></a>@Conditional 注解</h2><p>以下各个注解有很大帮助实现自动配置功能</p>
<ul>
<li>@ConditionalOnBean</li>
<li>@ConditionalOnClass</li>
<li>@ConditionalOnExpression</li>
<li>@ConditionalOnMissingBean</li>
<li>@ConditionalOnMissingClass</li>
<li>@ConditionalOnNotWebApplication</li>
<li>@ConditionalOnResource</li>
<li>@ConditionalOnWebApplication</li>
</ul>
<p><br><br><br></p>
<h1 id="Eureka"><a href="#Eureka" class="headerlink" title="Eureka"></a>Eureka</h1><p><br></p>
<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><ul>
<li>集群重要类:PeerAwareInstanceRegistryImpl</li>
<li>新的Eureka Server节点加入集群后的影响</li>
<li>新服务注册(Register)注册时的影响</li>
<li>服务心跳(renew)</li>
<li>服务下线和剔除</li>
<li>自我保护模式</li>
</ul>
<h3 id="Eureka-Server的集群同步操作"><a href="#Eureka-Server的集群同步操作" class="headerlink" title="Eureka Server的集群同步操作"></a>Eureka Server的集群同步操作</h3><p>Eureka官网的架构图,下方的操作需要结合下图理解:   </p>
<p><img src="/2017/05/16/springcloud/image-07.png" width="500px"></p>
<h3 id="PeerAwareInstanceRegistryImpl"><a href="#PeerAwareInstanceRegistryImpl" class="headerlink" title="PeerAwareInstanceRegistryImpl"></a>PeerAwareInstanceRegistryImpl</h3><p>集群相关重要的类<code>com.netflix.eureka.registry.PeerAwareInstanceRegistryImpl</code>:为了保证集群里所有Eureka Server节点的状态同步<br>所有以下操作都会同步到集群的所有服务上:服务注册(Registers)、服务更新(Renewals)、服务取消(Cancels),服务超时(Expirations)和服务状态变更(Status Changes)。</p>
<p>以下是一些部分方法：</p>
<ul>
<li>syncUp:在Eureka Server重启或新的Eureka Server节点加进来的,会执行初始化,从集群其他节点中获取所有的实例注册信息,从而能够正常提供服务。当Eureka - Server启动时,它会从其它节点获取所有的注册信息,如果获取同步失败,它在一定时间(此值由决定)内拒绝服务。</li>
<li>replicateToPeers: 同步以下操作到所有的集群节点：服务注册(Registers)、服务更新(Renewals)、服务取消(Cancels),服务超时(Expirations)和服务状态变更(Status Changes)</li>
<li>register:注册实例,并且复印此实例的信息到所有的eureka server的节点。如果其它Eureka Server调用此节点,只在本节点更新实例信息,避免通知其他节点执行更新</li>
<li>renew:心跳,同步集群</li>
<li>cancel</li>
<li>其他</li>
</ul>
<p>Eureka Server集群之间的状态是采用异步方式同步的,所以不保证节点间的状态一定是一致的,不过基本能保证最终状态是一致的。</p>
<h3 id="新的Eureka-Server节点加入集群后的影响"><a href="#新的Eureka-Server节点加入集群后的影响" class="headerlink" title="新的Eureka Server节点加入集群后的影响"></a>新的Eureka Server节点加入集群后的影响</h3><p>当有新的节点加入到集群中,会对现在Eureka Server和Eureka Client有什么影响以及他们如何发现新增的Eureka Server节点：</p>
<ul>
<li>新增的Eureka Server：在Eureka Server重启或新的Eureka Server节点加进来的,它会从集群里其它节点获取所有的实例注册信息。如果获取同步失败,它会在一定时间(此值由决定eureka.server.peer-eureka-nodes-update-interval-ms决定)内拒绝服务。</li>
<li><p>已有Eureka Server和Service Consumer如何发现新的Eureka Server</p>
<ul>
<li>已有的Eureka Server：在运行过程中,Eureka Server之间会定时同步实例的注册信息。这样即使新的Application Service只向集群中一台注册服务,则经过一段时间会集群中所有的Eureka Server都会有这个实例的信息。那么Eureka Server节点之间如何相互发现,各个节点之间定时(时间由eureka.server.peer-eureka-nodes-update-interval-ms决定)更新节点信息,进行相互发现。</li>
<li>Service Consumer：Service Consumer刚启动时,它会从配置文件读取Eureka Server的地址信息。当集群中新增一个Eureka Server中时,那么Service Provider如何发现这个Eureka Server？Service Consumer会定时(此值由eureka.client.eureka-service-url-poll-interval-seconds决定)调用Eureka Server集群接口,获取所有的Eureka Server信息的并更新本地配置。</li>
</ul>
</li>
</ul>
<h3 id="新服务注册-Register-注册时的影响"><a href="#新服务注册-Register-注册时的影响" class="headerlink" title="新服务注册(Register)注册时的影响"></a>新服务注册(Register)注册时的影响</h3><p>Service Provider要对外提供服务,把自己注册到Eureka Server上。如果配置参数eureka.client.registerWithEureka=true(默认值true)时,会向Eureka Server注册进行注册,Eureka Server会保存注册信息到内存中。</p>
<p>Service Consumer为了避免每次调用服务请求都需要向Eureka Server获取服务实例的注册信息,此时需要设置eureka.client.fetchRegistry=true,它会在本地缓存所有实例注册信息。为了保证缓存数据的有效性,它会定时(值由eureka.client.registry-fetch-interval-seconds定义,默认值为30s)向注册中心更新实例。</p>
<h3 id="服务心跳-renew"><a href="#服务心跳-renew" class="headerlink" title="服务心跳(renew)"></a>服务心跳(renew)</h3><p>服务实例会通过心跳(eureka.instance.lease-renewal-interval-in-seconds定义心跳的频率,默认值为30s)续约的方式向Eureka Server定时更新自己的状态。Eureka Server收到心跳后,会通知集群里的其它Eureka Server更新此实例的状态。Service Provider/Service Consumer也会定时更新缓存的实例信息。</p>
<h3 id="服务下线和剔除"><a href="#服务下线和剔除" class="headerlink" title="服务下线和剔除"></a>服务下线和剔除</h3><p>服务的下线有两种情况：</p>
<ul>
<li>在Service Provider服务shutdown的时候,主动通知Eureka Server把自己剔除,从而避免客户端调用已经下线的服务。</li>
<li>Eureka Server会定时(间隔值是eureka.server.eviction-interval-timer-in-ms,默认值为0,默认情况不删除实例)进行检查,如果发现实例在在一定时间(此值由eureka.instance.lease-expiration-duration-in-seconds定义,默认值为90s)内没有收到心跳,则会注销此实例。</li>
</ul>
<p>这种情况下,Eureka Client的最多需要[eureka.instance.lease-renewal-interval-in-seconds + eureka.client.registry-fetch-interval-seconds]时间才发现服务已经下线。同理,一个新的服务上线后,Eureka Client的服务消费方最多需要相同的时间才发现服务已经上线</p>
<p>服务下线,同时会更新到Eureka Server其他节点和Eureka client的缓存,流程类似同以上的register过程</p>
<h3 id="自我保护模式"><a href="#自我保护模式" class="headerlink" title="自我保护模式"></a>自我保护模式</h3><p>如果Eureka Server最近1分钟收到renew的次数小于阈值(即预期的最小值),则会触发自我保护模式,此时Eureka Server此时会认为这是网络问题,它不会注销任何过期的实例。等到最近收到renew的次数大于阈值后,则Eureka Server退出自我保护模式。</p>
<p>自我保护模式阈值计算：</p>
<ul>
<li>每个instance的预期心跳数目 = 60/每个instance的心跳间隔秒数</li>
<li>阈值 = 所有注册到服务的instance的数量的预期心跳之和 *自我保护系数</li>
</ul>
<p>以上的参数都可配置的：</p>
<ul>
<li>instance的心跳间隔秒数：eureka.instance.lease-renewal-interval-in-seconds</li>
<li>自我保护系数：eureka.server.renewal-percent-threshold</li>
</ul>
<p>如果我们的实例比较少且是内部网络时,推荐关掉此选项。我们也可以通过eureka.server.enable-self-preservation = false来禁用自我保护系数</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">10761</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">cloud-registration-center</span></span><br><span class="line"><span class="comment">## eureka ： 主要配置属性在EurekaInstanceConfigBean和EurekaClientConfigBean中</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">  instance:</span></span><br><span class="line">    <span class="comment"># hostname: 127.0.0.1</span></span><br><span class="line">    <span class="comment"># 使用IP注册</span></span><br><span class="line"><span class="attr">    preferIpAddress:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># 心跳间隔</span></span><br><span class="line"><span class="attr">    lease-renewal-interval-in-seconds:</span> <span class="number">3</span></span><br><span class="line">    <span class="comment"># 服务失效时间： 如果多久没有收到请求,则可以删除服务</span></span><br><span class="line"><span class="attr">    lease-expiration-duration-in-seconds:</span> <span class="number">7</span></span><br><span class="line"><span class="attr">  client:</span></span><br><span class="line">    <span class="comment"># 关闭eureka client</span></span><br><span class="line">    <span class="comment"># enabled: false</span></span><br><span class="line">    <span class="comment"># 注册自身到eureka服务器</span></span><br><span class="line"><span class="attr">    registerWithEureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># 表示是否从eureka服务器获取注册信息</span></span><br><span class="line"><span class="attr">    fetchRegistry:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># 客户端从Eureka Server集群里更新Eureka Server信息的频率</span></span><br><span class="line"><span class="attr">    eureka-service-url-poll-interval-seconds:</span> <span class="number">60</span></span><br><span class="line">    <span class="comment"># 定义从注册中心获取注册服务的信息</span></span><br><span class="line"><span class="attr">    registry-fetch-interval-seconds:</span> <span class="number">5</span></span><br><span class="line">    <span class="comment"># 设置eureka服务器所在的地址,查询服务和注册服务都需要依赖这个地址</span></span><br><span class="line"><span class="attr">    serviceUrl:</span></span><br><span class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://127.0.0.1:10761/eureka/</span></span><br><span class="line">       <span class="comment"># 设置eureka服务器所在的地址,可以同时向多个服务注册服务</span></span><br><span class="line">       <span class="comment"># defaultZone: http://192.168.21.3:10761/eureka/,http://192.168.21.4:10761/eureka/</span></span><br><span class="line"><span class="attr">  server:</span></span><br><span class="line">     <span class="comment"># renewal-percent-threshold: 0.1</span></span><br><span class="line">     <span class="comment"># 关闭自我保护模式</span></span><br><span class="line"><span class="attr">     enable-self-preservation:</span> <span class="literal">false</span></span><br><span class="line">     <span class="comment"># Eureka Server 自我保护系数,当enable-self-preservation=true时,启作用</span></span><br><span class="line">     <span class="comment"># renewal-percent-threshold:</span></span><br><span class="line">     <span class="comment"># 设置清理间隔,单位为毫秒,默认为0</span></span><br><span class="line"><span class="attr">     eviction-interval-timer-in-ms:</span> <span class="number">3000</span></span><br><span class="line">     <span class="comment"># 设置如果Eureka Server启动时无法从临近Eureka Server节点获取注册信息,它多久不对外提供注册服务</span></span><br><span class="line"><span class="attr">     wait-time-in-ms-when-sync-empty:</span> <span class="number">6000000</span></span><br><span class="line">     <span class="comment"># 集群之间相互更新节点信息的时间频率</span></span><br><span class="line"><span class="attr">     peer-eureka-nodes-update-interval-ms:</span> <span class="number">60000</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h2 id="Eureka-Client"><a href="#Eureka-Client" class="headerlink" title="Eureka-Client"></a>Eureka-Client</h2><p><code>EurekaClientAutoConfiguration</code>被<code>spring.factories</code>纳入,自动被加载实例bean<br><code>EurekaClientAutoConfiguration</code>里面有<code>eurekaClient</code>存在</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sequenceDiagram</span><br><span class="line"></span><br><span class="line">EmbeddedWebApplicationContext-&gt;&gt;AbstractApplicationContext:super.refresh();</span><br><span class="line">AbstractApplicationContext-&gt;&gt;AbstractApplicationContext:finishBeanFactoryInitialization();</span><br><span class="line">AbstractApplicationContext-&gt;&gt;AbstractApplicationContext:beanFactory.preInstantiateSingletons();</span><br></pre></td></tr></table></figure>
<p>在<code>eurekaClient</code>的实例化Bean中<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">new CloudEurekaClient(manager, config, this.optionalArgs,this.context);</span><br></pre></td></tr></table></figure></p>
<p>而<code>CloudEurekaClient</code>又继承于<code>DiscoveryClient</code><br>至此会实例化相关的<code>DiscoveryClient</code>  </p>
<p><br></p>
<blockquote>
<p>CloudEurekaClient继承与DiscoveryClient</p>
</blockquote>
<p><img src="/2017/05/16/springcloud/image-01.png" alt="img"></p>
<ol>
<li>创建 EurekaInstanceConfig对象  </li>
<li>使用 EurekaInstanceConfig对象 创建 InstanceInfo对象</li>
<li>使用 EurekaInstanceConfig对象 + InstanceInfo对象 创建   </li>
<li>ApplicationInfoManager对象  </li>
<li>创建 EurekaClientConfig对象  </li>
</ol>
<p>使用 ApplicationInfoManager对象 + EurekaClientConfig对象 创建 EurekaClient对象</p>
<blockquote>
<p>其中ApplicationInfoManager包括</p>
<blockquote>
<ul>
<li>EurekaInstanceConfig  </li>
<li>InstanceInfo</li>
</ul>
</blockquote>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationInfoManager</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 单例</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ApplicationInfoManager instance = <span class="keyword">new</span> ApplicationInfoManager(<span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 状态变更监听器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> Map&lt;String, StatusChangeListener&gt; listeners;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 应用实例状态匹配</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> InstanceStatusMapper instanceStatusMapper;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 应用实例信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> InstanceInfo instanceInfo;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 应用实例配置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> EurekaInstanceConfig config;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ... 省略其它构造方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ApplicationInfoManager</span><span class="params">(EurekaInstanceConfig config, InstanceInfo instanceInfo, OptionalArgs optionalArgs)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.config = config;</span><br><span class="line">        <span class="keyword">this</span>.instanceInfo = instanceInfo;</span><br><span class="line">        <span class="keyword">this</span>.listeners = <span class="keyword">new</span> ConcurrentHashMap&lt;String, StatusChangeListener&gt;();</span><br><span class="line">        <span class="keyword">if</span> (optionalArgs != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.instanceStatusMapper = optionalArgs.getInstanceStatusMapper();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.instanceStatusMapper = NO_OP_MAPPER;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Hack to allow for getInstance() to use the DI'd ApplicationInfoManager</span></span><br><span class="line">        instance = <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ... 省略其它方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>EurekaInstanceConfig,重在应用实例,例如,应用名、应用的端口等等。此处应用指的是,Application Consumer 和 Application Provider。</p>
</li>
<li><p>EurekaClientConfig,重在 Eureka-Client,例如, 连接的 Eureka-Server 的地址、获取服务提供者列表的频率、注册自身为服务提供者的频率等等。</p>
</li>
</ul>
<h3 id="初始化线程池"><a href="#初始化线程池" class="headerlink" title="初始化线程池"></a>初始化线程池</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DiscoveryClient.java 变量</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 线程池</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* A scheduler to be used for the following 3 tasks: 【目前只有两个】</span></span><br><span class="line"><span class="comment">* - updating service urls</span></span><br><span class="line"><span class="comment">* - scheduling a TimedSuperVisorTask</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ScheduledExecutorService scheduler;</span><br><span class="line"><span class="comment">// additional executors for supervised subtasks</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 心跳执行器</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ThreadPoolExecutor heartbeatExecutor;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* &#123;<span class="doctag">@link</span> #localRegionApps&#125; 刷新执行器</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ThreadPoolExecutor cacheRefreshExecutor;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// DiscoveryClient.java 构造方法</span></span><br><span class="line"><span class="comment">// default size of 2 - 1 each for heartbeat and cacheRefresh</span></span><br><span class="line">scheduler = Executors.newScheduledThreadPool(<span class="number">2</span>,</span><br><span class="line">     <span class="keyword">new</span> ThreadFactoryBuilder()</span><br><span class="line">             .setNameFormat(<span class="string">"DiscoveryClient-%d"</span>)</span><br><span class="line">             .setDaemon(<span class="keyword">true</span>)</span><br><span class="line">             .build());</span><br><span class="line">heartbeatExecutor = <span class="keyword">new</span> ThreadPoolExecutor(</span><br><span class="line">     <span class="number">1</span>, clientConfig.getHeartbeatExecutorThreadPoolSize(), <span class="number">0</span>, TimeUnit.SECONDS,</span><br><span class="line">     <span class="keyword">new</span> SynchronousQueue&lt;Runnable&gt;(),</span><br><span class="line">     <span class="keyword">new</span> ThreadFactoryBuilder()</span><br><span class="line">             .setNameFormat(<span class="string">"DiscoveryClient-HeartbeatExecutor-%d"</span>)</span><br><span class="line">             .setDaemon(<span class="keyword">true</span>)</span><br><span class="line">             .build()</span><br><span class="line">);  <span class="comment">// use direct handoff</span></span><br><span class="line">cacheRefreshExecutor = <span class="keyword">new</span> ThreadPoolExecutor(</span><br><span class="line">     <span class="number">1</span>, clientConfig.getCacheRefreshExecutorThreadPoolSize(), <span class="number">0</span>, TimeUnit.SECONDS,</span><br><span class="line">     <span class="keyword">new</span> SynchronousQueue&lt;Runnable&gt;(),</span><br><span class="line">     <span class="keyword">new</span> ThreadFactoryBuilder()</span><br><span class="line">             .setNameFormat(<span class="string">"DiscoveryClient-CacheRefreshExecutor-%d"</span>)</span><br><span class="line">             .setDaemon(<span class="keyword">true</span>)</span><br><span class="line">             .build()</span><br><span class="line">);  <span class="comment">// use direct handoff</span></span><br></pre></td></tr></table></figure>
<p>scheduler:定时任务线程池,初始化大小为 2,定时给任务,一个给 heartbeatExecutor,一个给 cacheRefreshExecutor  </p>
<p>heartbeatExecutor,cacheRefreshExecutor:在提交给scheduler 才声明具体的任务。  </p>
<h3 id="初始化定时任务"><a href="#初始化定时任务" class="headerlink" title="初始化定时任务"></a>初始化定时任务</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DiscoveryClient.java 构造方法</span></span><br><span class="line">initScheduledTasks();</span><br><span class="line"><span class="comment">// DiscoveryClient.java</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initScheduledTasks</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="comment">// 从 Eureka-Server 拉取注册信息执行器</span></span><br><span class="line">   <span class="keyword">if</span> (clientConfig.shouldFetchRegistry()) &#123;</span><br><span class="line">       <span class="comment">// registry cache refresh timer</span></span><br><span class="line">       <span class="keyword">int</span> registryFetchIntervalSeconds = clientConfig.getRegistryFetchIntervalSeconds();</span><br><span class="line">       <span class="keyword">int</span> expBackOffBound = clientConfig.getCacheRefreshExecutorExponentialBackOffBound();</span><br><span class="line">       scheduler.schedule(</span><br><span class="line">               <span class="keyword">new</span> TimedSupervisorTask(</span><br><span class="line">                       <span class="string">"cacheRefresh"</span>,</span><br><span class="line">                       scheduler,</span><br><span class="line">                       cacheRefreshExecutor,</span><br><span class="line">                       registryFetchIntervalSeconds,</span><br><span class="line">                       TimeUnit.SECONDS,</span><br><span class="line">                       expBackOffBound,</span><br><span class="line">                       <span class="keyword">new</span> CacheRefreshThread()</span><br><span class="line">               ),</span><br><span class="line">               registryFetchIntervalSeconds, TimeUnit.SECONDS);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// 向 Eureka-Server 心跳(续租)执行器</span></span><br><span class="line">   <span class="keyword">if</span> (clientConfig.shouldRegisterWithEureka()) &#123;</span><br><span class="line">       <span class="keyword">int</span> renewalIntervalInSecs = instanceInfo.getLeaseInfo().getRenewalIntervalInSecs();</span><br><span class="line">       <span class="keyword">int</span> expBackOffBound = clientConfig.getHeartbeatExecutorExponentialBackOffBound();</span><br><span class="line">       logger.info(<span class="string">"Starting heartbeat executor: "</span> + <span class="string">"renew interval is: "</span> + renewalIntervalInSecs);</span><br><span class="line">       <span class="comment">// Heartbeat timer</span></span><br><span class="line">       scheduler.schedule(</span><br><span class="line">               <span class="keyword">new</span> TimedSupervisorTask(</span><br><span class="line">                       <span class="string">"heartbeat"</span>,</span><br><span class="line">                       scheduler,</span><br><span class="line">                       heartbeatExecutor,</span><br><span class="line">                       renewalIntervalInSecs,</span><br><span class="line">                       TimeUnit.SECONDS,</span><br><span class="line">                       expBackOffBound,</span><br><span class="line">                       <span class="keyword">new</span> HeartbeatThread()</span><br><span class="line">               ),</span><br><span class="line">               renewalIntervalInSecs, TimeUnit.SECONDS);</span><br><span class="line">       <span class="comment">// InstanceInfo replicator</span></span><br><span class="line">       instanceInfoReplicator = <span class="keyword">new</span> InstanceInfoReplicator(</span><br><span class="line">               <span class="keyword">this</span>,</span><br><span class="line">               instanceInfo,</span><br><span class="line">               clientConfig.getInstanceInfoReplicationIntervalSeconds(),</span><br><span class="line">               <span class="number">2</span>); <span class="comment">// burstSize</span></span><br><span class="line">       statusChangeListener = <span class="keyword">new</span> ApplicationInfoManager.StatusChangeListener() &#123;</span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> String <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">               <span class="keyword">return</span> <span class="string">"statusChangeListener"</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notify</span><span class="params">(StatusChangeEvent statusChangeEvent)</span> </span>&#123;</span><br><span class="line">               <span class="keyword">if</span> (InstanceStatus.DOWN == statusChangeEvent.getStatus() ||</span><br><span class="line">                       InstanceStatus.DOWN == statusChangeEvent.getPreviousStatus()) &#123;</span><br><span class="line">                   <span class="comment">// log at warn level if DOWN was involved</span></span><br><span class="line">                   logger.warn(<span class="string">"Saw local status change event &#123;&#125;"</span>, statusChangeEvent);</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   logger.info(<span class="string">"Saw local status change event &#123;&#125;"</span>, statusChangeEvent);</span><br><span class="line">               &#125;</span><br><span class="line">               instanceInfoReplicator.onDemandUpdate();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;;</span><br><span class="line">       <span class="keyword">if</span> (clientConfig.shouldOnDemandUpdateStatusChange()) &#123;</span><br><span class="line">           applicationInfoManager.registerStatusChangeListener(statusChangeListener);</span><br><span class="line">       &#125;</span><br><span class="line">       instanceInfoReplicator.start(clientConfig.getInitialInstanceInfoReplicationIntervalSeconds());</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       logger.info(<span class="string">"Not registering with Eureka server per configuration"</span>);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>定时提交任务到Heartbeat线程池,另一个任务到cacheRefresh线程池</p>
<h3 id="初始化-Eureka-网络通信相关"><a href="#初始化-Eureka-网络通信相关" class="headerlink" title="初始化 Eureka 网络通信相关"></a>初始化 Eureka 网络通信相关</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DiscoveryClient.java 构造方法</span></span><br><span class="line">eurekaTransport = <span class="keyword">new</span> EurekaTransport();</span><br><span class="line">scheduleServerEndpointTask(eurekaTransport, args);</span><br></pre></td></tr></table></figure>
<p><br><br><br><br><br></p>
<h2 id="Eureka-Server"><a href="#Eureka-Server" class="headerlink" title="Eureka Server"></a>Eureka Server</h2><p>Spring Cloud Eureka Server<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.boot.autoconfigure.EnableAutoConfiguration=\</span><br><span class="line">  org.springframework.cloud.netflix.eureka.server.EurekaServerAutoConfiguration</span><br></pre></td></tr></table></figure></p>
<p>自动摄取了<code>EurekaServerAutoConfiguration</code>配置类<br>里面包含了<code>EurekaServerBootstrap</code>这个Bean</p>
<p><br><br><br></p>
<h2 id="EurekaServerBootstrap"><a href="#EurekaServerBootstrap" class="headerlink" title="EurekaServerBootstrap"></a>EurekaServerBootstrap</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaBootStrap</span> <span class="keyword">implements</span> <span class="title">ServletContextListener</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 省略无关变量和方法</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">contextInitialized</span><span class="params">(ServletContextEvent event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 初始化 Eureka-Server 配置环境</span></span><br><span class="line">            initEurekaEnvironment();</span><br><span class="line">            <span class="comment">// 初始化 Eureka-Server 上下文</span></span><br><span class="line">            initEurekaServerContext();</span><br><span class="line">            ServletContext sc = event.getServletContext();</span><br><span class="line">            sc.setAttribute(EurekaServerContext.class.getName(), serverContext);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            logger.error(<span class="string">"Cannot bootstrap eureka server :"</span>, e);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Cannot bootstrap eureka server :"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Eureka-Server-配置环境"><a href="#Eureka-Server-配置环境" class="headerlink" title="Eureka-Server 配置环境"></a>Eureka-Server 配置环境</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// EurekaBootStrap.java</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 部署环境 - 测服</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TEST = <span class="string">"test"</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ARCHAIUS_DEPLOYMENT_ENVIRONMENT = <span class="string">"archaius.deployment.environment"</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String EUREKA_ENVIRONMENT = <span class="string">"eureka.environment"</span>;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 部署数据中心 - CLOUD</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String CLOUD = <span class="string">"cloud"</span>;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 部署数据中心 - 默认</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT = <span class="string">"default"</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ARCHAIUS_DEPLOYMENT_DATACENTER = <span class="string">"archaius.deployment.datacenter"</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String EUREKA_DATACENTER = <span class="string">"eureka.datacenter"</span>;</span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initEurekaEnvironment</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    logger.info(<span class="string">"Setting the eureka configuration.."</span>);</span><br><span class="line">   <span class="comment">// 设置配置文件的数据中心</span></span><br><span class="line">   String dataCenter = ConfigurationManager.getConfigInstance().getString(EUREKA_DATACENTER);</span><br><span class="line">   <span class="keyword">if</span> (dataCenter == <span class="keyword">null</span>) &#123;</span><br><span class="line">       logger.info(<span class="string">"Eureka data center value eureka.datacenter is not set, defaulting to default"</span>);</span><br><span class="line">       ConfigurationManager.getConfigInstance().setProperty(ARCHAIUS_DEPLOYMENT_DATACENTER, DEFAULT);</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       ConfigurationManager.getConfigInstance().setProperty(ARCHAIUS_DEPLOYMENT_DATACENTER, dataCenter);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// 设置配置文件的环境</span></span><br><span class="line">   String environment = ConfigurationManager.getConfigInstance().getString(EUREKA_ENVIRONMENT);</span><br><span class="line">   <span class="keyword">if</span> (environment == <span class="keyword">null</span>) &#123;</span><br><span class="line">       ConfigurationManager.getConfigInstance().setProperty(ARCHAIUS_DEPLOYMENT_ENVIRONMENT, TEST);</span><br><span class="line">       logger.info(<span class="string">"Eureka environment value eureka.environment is not set, defaulting to test"</span>);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h2 id="EurekaBootStrap"><a href="#EurekaBootStrap" class="headerlink" title="EurekaBootStrap"></a>EurekaBootStrap</h2><h3 id="Eureka-Client-1"><a href="#Eureka-Client-1" class="headerlink" title="Eureka Client"></a>Eureka Client</h3><p>Eureka-Server 内嵌 Eureka-Client,用于和 Eureka-Server 集群里其他节点通信交互。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">ApplicationInfoManager applicationInfoManager;</span><br><span class="line"><span class="keyword">if</span> (eurekaClient == <span class="keyword">null</span>) &#123;</span><br><span class="line">  EurekaInstanceConfig instanceConfig = isCloud(ConfigurationManager.getDeploymentContext())</span><br><span class="line">          ? <span class="keyword">new</span> CloudInstanceConfig()</span><br><span class="line">          : <span class="keyword">new</span> MyDataCenterInstanceConfig();</span><br><span class="line">  </span><br><span class="line">  applicationInfoManager = <span class="keyword">new</span> ApplicationInfoManager(</span><br><span class="line">          instanceConfig, <span class="keyword">new</span> EurekaConfigBasedInstanceInfoProvider(instanceConfig).get());</span><br><span class="line">  </span><br><span class="line">  EurekaClientConfig eurekaClientConfig = <span class="keyword">new</span> DefaultEurekaClientConfig();</span><br><span class="line">  eurekaClient = <span class="keyword">new</span> DiscoveryClient(applicationInfoManager, eurekaClientConfig);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  applicationInfoManager = eurekaClient.getApplicationInfoManager();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="注册"><a href="#注册" class="headerlink" title="注册"></a>注册</h2><p><img src="/2017/05/16/springcloud/image-02.png" alt="img"></p>
<h3 id="Eureka-Client-2"><a href="#Eureka-Client-2" class="headerlink" title="Eureka-Client"></a>Eureka-Client</h3><h4 id="发起注册-应用实例信息复制器"><a href="#发起注册-应用实例信息复制器" class="headerlink" title="发起注册 | 应用实例信息复制器"></a>发起注册 | 应用实例信息复制器</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DiscoveryClient.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DiscoveryClient</span> <span class="keyword">implements</span> <span class="title">EurekaClient</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 应用实例状态变更监听器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> ApplicationInfoManager.StatusChangeListener statusChangeListener;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 应用实例信息复制器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> InstanceInfoReplicator instanceInfoReplicator;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initScheduledTasks</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ... 省略无关代码</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (clientConfig.shouldRegisterWithEureka()) &#123;</span><br><span class="line">        </span><br><span class="line">            <span class="comment">// ... 省略无关代码</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 创建 应用实例信息复制器</span></span><br><span class="line">            <span class="comment">// InstanceInfo replicator</span></span><br><span class="line">            instanceInfoReplicator = <span class="keyword">new</span> InstanceInfoReplicator(</span><br><span class="line">                    <span class="keyword">this</span>,</span><br><span class="line">                    instanceInfo,</span><br><span class="line">                    clientConfig.getInstanceInfoReplicationIntervalSeconds(),</span><br><span class="line">                    <span class="number">2</span>); <span class="comment">// burstSize</span></span><br><span class="line">            <span class="comment">// 创建 应用实例状态变更监听器</span></span><br><span class="line">            statusChangeListener = <span class="keyword">new</span> ApplicationInfoManager.StatusChangeListener() &#123;</span><br><span class="line">                <span class="comment">// ... 省略无关代码</span></span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="comment">// 注册 应用实例状态变更监听器</span></span><br><span class="line">            <span class="keyword">if</span> (clientConfig.shouldOnDemandUpdateStatusChange()) &#123;</span><br><span class="line">                applicationInfoManager.registerStatusChangeListener(statusChangeListener);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 开启 应用实例信息复制器</span></span><br><span class="line">            instanceInfoReplicator.start(clientConfig.getInitialInstanceInfoReplicationIntervalSeconds());</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="刷新应用实例信息"><a href="#刷新应用实例信息" class="headerlink" title="刷新应用实例信息"></a>刷新应用实例信息</h4><p><code>InstanceInfoReplicator#run</code>函数里面调用  </p>
<p><code>DiscoveryClient#refreshInstanceInfo()</code>方法,刷新应用实例信息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">refreshInstanceInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="comment">// 刷新 数据中心信息</span></span><br><span class="line">   applicationInfoManager.refreshDataCenterInfoIfRequired();</span><br><span class="line">   <span class="comment">// 刷新 租约信息</span></span><br><span class="line">   applicationInfoManager.refreshLeaseInfoIfRequired();</span><br><span class="line">   <span class="comment">// 健康检查</span></span><br><span class="line">   InstanceStatus status;</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">       status = getHealthCheckHandler().getStatus(instanceInfo.getStatus());</span><br><span class="line">   &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">       logger.warn(<span class="string">"Exception from healthcheckHandler.getStatus, setting status to DOWN"</span>, e);</span><br><span class="line">       status = InstanceStatus.DOWN;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (<span class="keyword">null</span> != status) &#123;</span><br><span class="line">       applicationInfoManager.setInstanceStatus(status);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Eureka-Server-1"><a href="#Eureka-Server-1" class="headerlink" title="Eureka-Server"></a>Eureka-Server</h3><h4 id="接收注册请求"><a href="#接收注册请求" class="headerlink" title="接收注册请求"></a>接收注册请求</h4><p>注册应用实例信息的请求,映射 <code>ApplicationResource#addInstance()</code> 方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Produces</span>(&#123;<span class="string">"application/xml"</span>, <span class="string">"application/json"</span>&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationResource</span> </span>&#123;</span><br><span class="line">    <span class="meta">@POST</span></span><br><span class="line">    <span class="meta">@Consumes</span>(&#123;<span class="string">"application/json"</span>, <span class="string">"application/xml"</span>&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Response <span class="title">addInstance</span><span class="params">(InstanceInfo info,</span></span></span><br><span class="line"><span class="function"><span class="params">                                @HeaderParam(PeerEurekaNode.HEADER_REPLICATION)</span> String isReplication) </span>&#123;</span><br><span class="line">        <span class="comment">// 校验参数是否合法</span></span><br><span class="line">        logger.debug(<span class="string">"Registering instance &#123;&#125; (replication=&#123;&#125;)"</span>, info.getId(), isReplication);</span><br><span class="line">        <span class="comment">// validate that the instanceinfo contains all the necessary required fields</span></span><br><span class="line">        <span class="keyword">if</span> (isBlank(info.getId())) &#123;</span><br><span class="line">            <span class="keyword">return</span> Response.status(<span class="number">400</span>).entity(<span class="string">"Missing instanceId"</span>).build();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isBlank(info.getHostName())) &#123;</span><br><span class="line">            <span class="keyword">return</span> Response.status(<span class="number">400</span>).entity(<span class="string">"Missing hostname"</span>).build();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isBlank(info.getIPAddr())) &#123;</span><br><span class="line">            <span class="keyword">return</span> Response.status(<span class="number">400</span>).entity(<span class="string">"Missing ip address"</span>).build();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isBlank(info.getAppName())) &#123;</span><br><span class="line">            <span class="keyword">return</span> Response.status(<span class="number">400</span>).entity(<span class="string">"Missing appName"</span>).build();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!appName.equals(info.getAppName())) &#123;</span><br><span class="line">            <span class="keyword">return</span> Response.status(<span class="number">400</span>).entity(<span class="string">"Mismatched appName, expecting "</span> + appName + <span class="string">" but was "</span> + info.getAppName()).build();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (info.getDataCenterInfo() == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> Response.status(<span class="number">400</span>).entity(<span class="string">"Missing dataCenterInfo"</span>).build();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (info.getDataCenterInfo().getName() == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> Response.status(<span class="number">400</span>).entity(<span class="string">"Missing dataCenterInfo Name"</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// AWS 相关,跳过</span></span><br><span class="line">        <span class="comment">// handle cases where clients may be registering with bad DataCenterInfo with missing data</span></span><br><span class="line">        DataCenterInfo dataCenterInfo = info.getDataCenterInfo();</span><br><span class="line">        <span class="keyword">if</span> (dataCenterInfo <span class="keyword">instanceof</span> UniqueIdentifier) &#123;</span><br><span class="line">            String dataCenterInfoId = ((UniqueIdentifier) dataCenterInfo).getId();</span><br><span class="line">            <span class="keyword">if</span> (isBlank(dataCenterInfoId)) &#123;</span><br><span class="line">                <span class="keyword">boolean</span> experimental = <span class="string">"true"</span>.equalsIgnoreCase(serverConfig.getExperimental(<span class="string">"registration.validation.dataCenterInfoId"</span>));</span><br><span class="line">                <span class="keyword">if</span> (experimental) &#123;</span><br><span class="line">                    String entity = <span class="string">"DataCenterInfo of type "</span> + dataCenterInfo.getClass() + <span class="string">" must contain a valid id"</span>;</span><br><span class="line">                    <span class="keyword">return</span> Response.status(<span class="number">400</span>).entity(entity).build();</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (dataCenterInfo <span class="keyword">instanceof</span> AmazonInfo) &#123;</span><br><span class="line">                    AmazonInfo amazonInfo = (AmazonInfo) dataCenterInfo;</span><br><span class="line">                    String effectiveId = amazonInfo.get(AmazonInfo.MetaDataKey.instanceId);</span><br><span class="line">                    <span class="keyword">if</span> (effectiveId == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        amazonInfo.getMetadata().put(AmazonInfo.MetaDataKey.instanceId.getName(), info.getId());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    logger.warn(<span class="string">"Registering DataCenterInfo of type &#123;&#125; without an appropriate id"</span>, dataCenterInfo.getClass());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 注册应用实例信息</span></span><br><span class="line">        registry.register(info, <span class="string">"true"</span>.equals(isReplication));</span><br><span class="line">        <span class="comment">// 返回 204 成功</span></span><br><span class="line">        <span class="keyword">return</span> Response.status(<span class="number">204</span>).build();  <span class="comment">// 204 to be backwards compatible</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>调用 <code>AbstractInstanceRegistry#register(...)</code> 方法,注册应用实例信息,实现代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(InstanceInfo registrant, <span class="keyword">int</span> leaseDuration, <span class="keyword">boolean</span> isReplication)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            read.lock();</span><br><span class="line">            Map&lt;String, Lease&lt;InstanceInfo&gt;&gt; gMap = registry.get(registrant.getAppName());</span><br><span class="line">            REGISTER.increment(isReplication);</span><br><span class="line">            <span class="keyword">if</span> (gMap == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> ConcurrentHashMap&lt;String, Lease&lt;InstanceInfo&gt;&gt; gNewMap = <span class="keyword">new</span> ConcurrentHashMap&lt;String, Lease&lt;InstanceInfo&gt;&gt;();</span><br><span class="line">                gMap = registry.putIfAbsent(registrant.getAppName(), gNewMap);</span><br><span class="line">                <span class="keyword">if</span> (gMap == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    gMap = gNewMap;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            Lease&lt;InstanceInfo&gt; existingLease = gMap.get(registrant.getId());</span><br><span class="line">            <span class="comment">// Retain the last dirty timestamp without overwriting it, if there is already a lease</span></span><br><span class="line">            <span class="keyword">if</span> (existingLease != <span class="keyword">null</span> &amp;&amp; (existingLease.getHolder() != <span class="keyword">null</span>)) &#123;</span><br><span class="line">                Long existingLastDirtyTimestamp = existingLease.getHolder().getLastDirtyTimestamp();</span><br><span class="line">                Long registrationLastDirtyTimestamp = registrant.getLastDirtyTimestamp();</span><br><span class="line">                logger.debug(<span class="string">"Existing lease found (existing=&#123;&#125;, provided=&#123;&#125;"</span>, existingLastDirtyTimestamp, registrationLastDirtyTimestamp);</span><br><span class="line">                <span class="keyword">if</span> (existingLastDirtyTimestamp &gt; registrationLastDirtyTimestamp) &#123;</span><br><span class="line">                    logger.warn(<span class="string">"There is an existing lease and the existing lease's dirty timestamp &#123;&#125; is greater"</span> +</span><br><span class="line">                            <span class="string">" than the one that is being registered &#123;&#125;"</span>, existingLastDirtyTimestamp, registrationLastDirtyTimestamp);</span><br><span class="line">                    logger.warn(<span class="string">"Using the existing instanceInfo instead of the new instanceInfo as the registrant"</span>);</span><br><span class="line">                    registrant = existingLease.getHolder();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// The lease does not exist and hence it is a new registration</span></span><br><span class="line">                <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">this</span>.expectedNumberOfRenewsPerMin &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="comment">// Since the client wants to cancel it, reduce the threshold</span></span><br><span class="line">                        <span class="comment">// (1</span></span><br><span class="line">                        <span class="comment">// for 30 seconds, 2 for a minute)</span></span><br><span class="line">                        <span class="keyword">this</span>.expectedNumberOfRenewsPerMin = <span class="keyword">this</span>.expectedNumberOfRenewsPerMin + <span class="number">2</span>;</span><br><span class="line">                        <span class="keyword">this</span>.numberOfRenewsPerMinThreshold =</span><br><span class="line">                                (<span class="keyword">int</span>) (<span class="keyword">this</span>.expectedNumberOfRenewsPerMin * serverConfig.getRenewalPercentThreshold());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                logger.debug(<span class="string">"No previous lease information found; it is new registration"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            Lease&lt;InstanceInfo&gt; lease = <span class="keyword">new</span> Lease&lt;InstanceInfo&gt;(registrant, leaseDuration);</span><br><span class="line">            <span class="keyword">if</span> (existingLease != <span class="keyword">null</span>) &#123;</span><br><span class="line">                lease.setServiceUpTimestamp(existingLease.getServiceUpTimestamp());</span><br><span class="line">            &#125;</span><br><span class="line">            gMap.put(registrant.getId(), lease);</span><br><span class="line">            <span class="keyword">synchronized</span> (recentRegisteredQueue) &#123;</span><br><span class="line">                recentRegisteredQueue.add(<span class="keyword">new</span> Pair&lt;Long, String&gt;(</span><br><span class="line">                        System.currentTimeMillis(),</span><br><span class="line">                        registrant.getAppName() + <span class="string">"("</span> + registrant.getId() + <span class="string">")"</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// This is where the initial state transfer of overridden status happens</span></span><br><span class="line">            <span class="keyword">if</span> (!InstanceStatus.UNKNOWN.equals(registrant.getOverriddenStatus())) &#123;</span><br><span class="line">                logger.debug(<span class="string">"Found overridden status &#123;&#125; for instance &#123;&#125;. Checking to see if needs to be add to the "</span></span><br><span class="line">                                + <span class="string">"overrides"</span>, registrant.getOverriddenStatus(), registrant.getId());</span><br><span class="line">                <span class="keyword">if</span> (!overriddenInstanceStatusMap.containsKey(registrant.getId())) &#123;</span><br><span class="line">                    logger.info(<span class="string">"Not found overridden id &#123;&#125; and hence adding it"</span>, registrant.getId());</span><br><span class="line">                    overriddenInstanceStatusMap.put(registrant.getId(), registrant.getOverriddenStatus());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            InstanceStatus overriddenStatusFromMap = overriddenInstanceStatusMap.get(registrant.getId());</span><br><span class="line">            <span class="keyword">if</span> (overriddenStatusFromMap != <span class="keyword">null</span>) &#123;</span><br><span class="line">                logger.info(<span class="string">"Storing overridden status &#123;&#125; from map"</span>, overriddenStatusFromMap);</span><br><span class="line">                registrant.setOverriddenStatus(overriddenStatusFromMap);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Set the status based on the overridden status rules</span></span><br><span class="line">            InstanceStatus overriddenInstanceStatus = getOverriddenInstanceStatus(registrant, existingLease, isReplication);</span><br><span class="line">            registrant.setStatusWithoutDirty(overriddenInstanceStatus);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If the lease is registered with UP status, set lease service up timestamp</span></span><br><span class="line">            <span class="keyword">if</span> (InstanceStatus.UP.equals(registrant.getStatus())) &#123;</span><br><span class="line">                lease.serviceUp();</span><br><span class="line">            &#125;</span><br><span class="line">            registrant.setActionType(ActionType.ADDED);</span><br><span class="line">            recentlyChangedQueue.add(<span class="keyword">new</span> RecentlyChangedItem(lease));</span><br><span class="line">            registrant.setLastUpdatedTimestamp();</span><br><span class="line">            invalidateCache(registrant.getAppName(), registrant.getVIPAddress(), registrant.getSecureVipAddress());</span><br><span class="line">            logger.info(<span class="string">"Registered instance &#123;&#125;/&#123;&#125; with status &#123;&#125; (replication=&#123;&#125;)"</span>,</span><br><span class="line">                    registrant.getAppName(), registrant.getId(), registrant.getStatus(), isReplication);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            read.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="续租"><a href="#续租" class="headerlink" title="续租"></a>续租</h2><p><img src="/2017/05/16/springcloud/image-03.png" alt="img"></p>
<h3 id="Eureka-Client-3"><a href="#Eureka-Client-3" class="headerlink" title="Eureka-Client"></a>Eureka-Client</h3><blockquote>
<p>Eureka-Client 向 Eureka-Server 发起注册应用实例成功后获得租约 ( Lease )。<br>Eureka-Client 固定间隔向 Eureka-Server 发起续租( renew ),避免租约过期。<br>默认情况下,租约有效期为 90 秒,续租频率为 30 秒。两者比例为 1 : 3 ,保证在网络异常等情况下,有三次重试的机会。</p>
</blockquote>
<h4 id="初始化定时任务-1"><a href="#初始化定时任务-1" class="headerlink" title="初始化定时任务"></a>初始化定时任务</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initScheduledTasks</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 向 Eureka-Server 心跳(续租)执行器</span></span><br><span class="line">    <span class="keyword">if</span> (clientConfig.shouldRegisterWithEureka()) &#123;</span><br><span class="line">        <span class="keyword">int</span> renewalIntervalInSecs = instanceInfo.getLeaseInfo().getRenewalIntervalInSecs(); <span class="comment">// 续租频率</span></span><br><span class="line">        <span class="keyword">int</span> expBackOffBound = clientConfig.getHeartbeatExecutorExponentialBackOffBound(); <span class="comment">//</span></span><br><span class="line">        logger.info(<span class="string">"Starting heartbeat executor: "</span> + <span class="string">"renew interval is: "</span> + renewalIntervalInSecs);</span><br><span class="line">        <span class="comment">// Heartbeat timer</span></span><br><span class="line">        scheduler.schedule(</span><br><span class="line">               <span class="keyword">new</span> TimedSupervisorTask(</span><br><span class="line">                       <span class="string">"heartbeat"</span>,</span><br><span class="line">                       scheduler,</span><br><span class="line">                       heartbeatExecutor,</span><br><span class="line">                       renewalIntervalInSecs,</span><br><span class="line">                       TimeUnit.SECONDS,</span><br><span class="line">                       expBackOffBound,</span><br><span class="line">                       <span class="keyword">new</span> HeartbeatThread()</span><br><span class="line">               ),</span><br><span class="line">               renewalIntervalInSecs, TimeUnit.SECONDS);</span><br><span class="line">               </span><br><span class="line">          <span class="comment">// ... 省略无关代码</span></span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">// ... 省略无关代码</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// DiscoveryClient.java</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 最后成功向 Eureka-Server 心跳时间戳</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> lastSuccessfulHeartbeatTimestamp = -<span class="number">1</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">HeartbeatThread</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (renew()) &#123;</span><br><span class="line">           lastSuccessfulHeartbeatTimestamp = System.currentTimeMillis();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// DiscoveryClient.java</span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">renew</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   EurekaHttpResponse&lt;InstanceInfo&gt; httpResponse;</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">       httpResponse = eurekaTransport.registrationClient.sendHeartBeat(instanceInfo.getAppName(), instanceInfo.getId(), instanceInfo, <span class="keyword">null</span>);</span><br><span class="line">       logger.debug(<span class="string">"&#123;&#125; - Heartbeat status: &#123;&#125;"</span>, PREFIX + appPathIdentifier, httpResponse.getStatusCode());</span><br><span class="line">       <span class="keyword">if</span> (httpResponse.getStatusCode() == <span class="number">404</span>) &#123;</span><br><span class="line">           REREGISTER_COUNTER.increment();</span><br><span class="line">           logger.info(<span class="string">"&#123;&#125; - Re-registering apps/&#123;&#125;"</span>, PREFIX + appPathIdentifier, instanceInfo.getAppName());</span><br><span class="line">           <span class="keyword">long</span> timestamp = instanceInfo.setIsDirtyWithTime();</span><br><span class="line">           <span class="comment">// 发起注册</span></span><br><span class="line">           <span class="keyword">boolean</span> success = register();</span><br><span class="line">           <span class="keyword">if</span> (success) &#123;</span><br><span class="line">               instanceInfo.unsetIsDirty(timestamp);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">return</span> success;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> httpResponse.getStatusCode() == <span class="number">200</span>;</span><br><span class="line">   &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">       logger.error(<span class="string">"&#123;&#125; - was unable to send heartbeat!"</span>, PREFIX + appPathIdentifier, e);</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Eureka-Server-2"><a href="#Eureka-Server-2" class="headerlink" title="Eureka-Server"></a>Eureka-Server</h3><h4 id="接收续租请求"><a href="#接收续租请求" class="headerlink" title="接收续租请求"></a>接收续租请求</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PUT</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Response <span class="title">renewLease</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        @HeaderParam(PeerEurekaNode.HEADER_REPLICATION)</span> String isReplication,</span></span><br><span class="line"><span class="function">        @<span class="title">QueryParam</span><span class="params">(<span class="string">"overriddenstatus"</span>)</span> String overriddenStatus,</span></span><br><span class="line"><span class="function">        @<span class="title">QueryParam</span><span class="params">(<span class="string">"status"</span>)</span> String status,</span></span><br><span class="line"><span class="function">        @<span class="title">QueryParam</span><span class="params">(<span class="string">"lastDirtyTimestamp"</span>)</span> String lastDirtyTimestamp) </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> isFromReplicaNode = <span class="string">"true"</span>.equals(isReplication);</span><br><span class="line">    <span class="keyword">boolean</span> isSuccess = registry.renew(app.getName(), id, isFromReplicaNode);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 省略代码</span></span><br><span class="line">    <span class="keyword">return</span> response;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//boolean isSuccess = registry.renew(app.getName(), id, isFromReplicaNode);</span></span><br><span class="line"><span class="comment">// PeerAwareInstanceRegistryImpl.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">renew</span><span class="params">(<span class="keyword">final</span> String appName, <span class="keyword">final</span> String id, <span class="keyword">final</span> <span class="keyword">boolean</span> isReplication)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (<span class="keyword">super</span>.renew(appName, id, isReplication)) &#123; <span class="comment">// 续租</span></span><br><span class="line">       <span class="comment">// Eureka-Server 复制</span></span><br><span class="line">       replicateToPeers(Action.Heartbeat, appName, id, <span class="keyword">null</span>, <span class="keyword">null</span>, isReplication);</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">renew</span><span class="params">(String appName, String id, <span class="keyword">boolean</span> isReplication)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 增加 续租次数 到 监控</span></span><br><span class="line">    RENEW.increment(isReplication);</span><br><span class="line">    <span class="comment">// 获得 租约</span></span><br><span class="line">    Map&lt;String, Lease&lt;InstanceInfo&gt;&gt; gMap = registry.get(appName);</span><br><span class="line">    Lease&lt;InstanceInfo&gt; leaseToRenew = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (gMap != <span class="keyword">null</span>) &#123;</span><br><span class="line">        leaseToRenew = gMap.get(id);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 租约不存在</span></span><br><span class="line">    <span class="keyword">if</span> (leaseToRenew == <span class="keyword">null</span>) &#123;</span><br><span class="line">        RENEW_NOT_FOUND.increment(isReplication);</span><br><span class="line">        logger.warn(<span class="string">"DS: Registry: lease doesn't exist, registering resource: &#123;&#125; - &#123;&#125;"</span>, appName, id);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        InstanceInfo instanceInfo = leaseToRenew.getHolder();</span><br><span class="line">        <span class="keyword">if</span> (instanceInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">            InstanceStatus overriddenInstanceStatus = <span class="keyword">this</span>.getOverriddenInstanceStatus(</span><br><span class="line">                    instanceInfo, leaseToRenew, isReplication);</span><br><span class="line">            <span class="keyword">if</span> (overriddenInstanceStatus == InstanceStatus.UNKNOWN) &#123;</span><br><span class="line">                logger.info(<span class="string">"Instance status UNKNOWN possibly due to deleted override for instance &#123;&#125;"</span></span><br><span class="line">                        + <span class="string">"; re-register required"</span>, instanceInfo.getId());</span><br><span class="line">                RENEW_NOT_FOUND.increment(isReplication);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!instanceInfo.getStatus().equals(overriddenInstanceStatus)) &#123;</span><br><span class="line">                Object[] args = &#123;</span><br><span class="line">                        instanceInfo.getStatus().name(),</span><br><span class="line">                        instanceInfo.getOverriddenStatus().name(),</span><br><span class="line">                        instanceInfo.getId()</span><br><span class="line">                &#125;;</span><br><span class="line">                logger.info(</span><br><span class="line">                        <span class="string">"The instance status &#123;&#125; is different from overridden instance status &#123;&#125; for instance &#123;&#125;. "</span></span><br><span class="line">                                + <span class="string">"Hence setting the status to overridden status"</span>, args);</span><br><span class="line">                instanceInfo.setStatus(overriddenInstanceStatus);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 新增 续租每分钟次数</span></span><br><span class="line">        renewsLastMin.increment();</span><br><span class="line">        <span class="comment">// 设置 租约最后更新时间(续租)</span></span><br><span class="line">        leaseToRenew.renew();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br><br><br><br><br></p>
<h1 id="Feign"><a href="#Feign" class="headerlink" title="Feign"></a>Feign</h1><p>Feign 涉及到了两个注解,一个是@EnableFeignClients,用来开启 Feign<br>另一个是@FeignClient,用来标记要用 Feign 来拦截的请求接口。  </p>
<h2 id="注解说明"><a href="#注解说明" class="headerlink" title="注解说明"></a>注解说明</h2><h3 id="EnableFeignClients-注解"><a href="#EnableFeignClients-注解" class="headerlink" title="EnableFeignClients 注解"></a>EnableFeignClients 注解</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Target</span>(ElementType.TYPE)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Import</span>(FeignClientsRegistrar.class)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableFeignClients &#123;</span><br><span class="line">    String[] value() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">    String[] basePackages() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">    Class&lt;?&gt;[] basePackageClasses() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">    Class&lt;?&gt;[] defaultConfiguration() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">    Class&lt;?&gt;[] clients() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Target</span>(ElementType.TYPE)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> FeignClient &#123;</span><br><span class="line">    <span class="meta">@AliasFor</span>(<span class="string">"name"</span>)</span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line">    <span class="meta">@Deprecated</span></span><br><span class="line">    <span class="function">String <span class="title">serviceId</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line">    <span class="meta">@AliasFor</span>(<span class="string">"value"</span>)</span><br><span class="line">    <span class="function">String <span class="title">name</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line">    <span class="function">String <span class="title">qualifier</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line">    <span class="function">String <span class="title">url</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">decode404</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">false</span></span>;</span><br><span class="line">    Class&lt;?&gt;[] configuration() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">    Class&lt;?&gt; fallback() <span class="keyword">default</span> <span class="keyword">void</span>.class;</span><br><span class="line">    Class&lt;?&gt; fallbackFactory() <span class="keyword">default</span> <span class="keyword">void</span>.class;</span><br><span class="line">    <span class="function">String <span class="title">path</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">primary</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">true</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用了<code>@Import(FeignClientsRegistrar.class)</code><br>Spring会包含此<code>FeignClientsRegistrar</code>类信息</p>
<blockquote>
<p>因实现了ImportBeanDefinitionRegistrar<br>所以在后期会执行ImportBeanDefinitionRegistrar#registerBeanDefinitions</p>
</blockquote>
<p><br><br><br><br><br></p>
<h2 id="Feign-是怎么工作的？"><a href="#Feign-是怎么工作的？" class="headerlink" title="Feign 是怎么工作的？"></a>Feign 是怎么工作的？</h2><ul>
<li>第一是为接口定义的每个接口都生成一个实现方法,结果就是 <code>SynchronousMethodHandler</code> 对象。  </li>
<li>第二是为该服务接口生成了动态代理。动态代理的实现是 <code>ReflectiveFeign.FeignInvocationHanlder</code>,代理被调用的时候,会根据当前调用的方法,转到对应的<code>SynchronousMethodHandler</code>。</li>
</ul>
<p><br><br><br></p>
<p>当对接口的实例进行请求时(Autowire 的对象是某个ReflectiveFeign.FeignInvocationHanlder 的实例)</p>
<p>根据方法名进入了某个 SynchronousMethodHandler 对象的 invoke 方法。</p>
<blockquote>
<p>SynchronousMethodHandler 其实也并不处理具体的 HTTP 请求,它关心的更多的是请求结果的处理。<br>HTTP 请求的过程,包括服务发现,都交给了当前 context 注册中的 Client 实现类比如: <code>LoadBalancerFeignClient</code>。  </p>
</blockquote>
<p>Retry 的逻辑实际上已经提出来了<br>但是 fallback 并没有在上面体现,因为我们上面分析动态代理的过程中,用的是 Feign.Builder<br>而如果有 fallback 的情况下,会使用 <code>HystrixFeign.Builder</code><br>这是 Feign.Builder的一个子类。</p>
<p>它在创建动态代理的时候,主要改了一个东西就是 <code>invocationFactory</code> 从默认的 <code>InvocationHandlerFactory.Default</code>变成了一个内部匿名工厂,这个工厂的create 方法返回的不是 <code>ReflectiveFeign.FeignInvocationHandler</code>,而是<code>HystrixInvocationHandler</code>。</p>
<p>所以动态代理类换掉了,invoke 的逻辑就变了,每次Invoke都会带HystrixCommand。<br><code>HystrixCommand</code>由<code>SynchronousMethodHandler</code>和<code>fallback</code>一起封装       </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HystrixInvocationHandler.<span class="keyword">this</span>.dispatch.get(method).invoke(args);</span><br></pre></td></tr></table></figure>
<p>在新的逻辑里简单的将方法转到对应的<code>SynchronousMethodHandler</code>上面并且执行该对象。</p>
<p><br><br><br><br><br></p>
<h2 id="工作流程"><a href="#工作流程" class="headerlink" title="工作流程"></a>工作流程</h2><p>Spring 通过调用其 <code>FeignClientsRegistrar#registerBeanDefinitions</code> 方法来获取其提供的 bean definition。  </p>
<p>这里会往 Registry 里面添加两种 <code>BeanDefinition</code>,</p>
<ul>
<li><p>一个是 <code>FeignClientSpecification</code><br>  主要可调整项是通过 EnableFeignClients 注解的 defaultConfiguration 参数传入。  </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">registerClientConfiguration(registry, name,defaultAttrs.get(<span class="string">"defaultConfiguration"</span>));</span><br></pre></td></tr></table></figure>
</li>
<li><p>一个是负责注册 <code>FeignClient</code>,分为以下几步</p>
<ol>
<li>找到 basePackage 下面所有包含了 FeignClient 注解的类</li>
<li>读取类上面的 FeignClient 注解参数</li>
<li><p>如果该注解包括了 configuration 参数则先注册 configuration 所指定的类。<br>这个类也是包装在 FeignClientSpecification 里面的,在 FeignClient 上指定的 configuration 类是它的一个属性。  </p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">registerClientConfiguration(registry, name,attributes.get(<span class="string">"configuration"</span>));</span><br></pre></td></tr></table></figure>
</li>
<li><p>注册该注解了 FeignClient 的接口,生成 BeanDefinition 时是以 FeignClientFactoryBean 作为对象创建的,而使用了 FeignClient 注解的接口是作为该 Bean 的一个属性,同时,对于 FeignClient 注解配置的参数,比如 fallback 等都一并作为参数放入 BeanDefinition 中。</p>
</li>
</ol>
</li>
</ul>
<p>总结一下,这些 BeanDefinition 分为两类：</p>
<ul>
<li><p>FeignClientSpecification,包括了所有 FeignClient 上指定 configuration 以及在 EnableFeignClients 上指定的 defaultConfiguration。  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">前者的名字为注解的 URL 或者 value 组成  </span><br><span class="line">比如TEST-SERVICE  </span><br><span class="line">后者的名字为 default.$CLASSNAME  </span><br><span class="line">比如 default.name.org.xiang.SpringBootApp。</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li>FeignClientFactoryBean,它包含了所有使用了 FeignClient 注解的接口信息以及注解上面的参数。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">它的名字为注解的 URL 或者 value,比如 TEST-SERVICE</span><br><span class="line">跟它上面的 configuration 创建出来的 bean 定义是同一个名字。</span><br></pre></td></tr></table></figure>
<h3 id="FeignAutoConfiguration"><a href="#FeignAutoConfiguration" class="headerlink" title="FeignAutoConfiguration"></a>FeignAutoConfiguration</h3><blockquote>
<p>给当前环境装配<code>Targeter</code>以及<code>Client</code>  </p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span>(required = <span class="keyword">false</span>) <span class="comment">//自动注入FeignClientSpecification</span></span><br><span class="line"><span class="keyword">private</span> List&lt;FeignClientSpecification&gt; configurations = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br></pre></td></tr></table></figure>
<blockquote>
<p>后期各种<code>AutoConfiguration</code>来实现自动装配  </p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">例如:FeignRibbonClientAutoConfiguration  </span><br><span class="line">装配Client为LoadBalancerFeignClient</span><br></pre></td></tr></table></figure>
<h3 id="FeignClientFactoryBean"><a href="#FeignClientFactoryBean" class="headerlink" title="FeignClientFactoryBean"></a>FeignClientFactoryBean</h3><p>它是一个工厂类,Spring Context 创建 Bean 实例时会调用它的 getObject 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    FeignContext context = applicationContext.getBean(FeignContext.class);</span><br><span class="line">    Feign.Builder builder = feign(context);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.hasText(<span class="keyword">this</span>.url)) &#123;</span><br><span class="line">        String url;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.name.startsWith(<span class="string">"http"</span>)) &#123;</span><br><span class="line">            url = <span class="string">"http://"</span> + <span class="keyword">this</span>.name;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            url = <span class="keyword">this</span>.name;</span><br><span class="line">        &#125;</span><br><span class="line">        url += cleanPath();</span><br><span class="line">        <span class="keyword">return</span> loadBalance(builder, context, <span class="keyword">new</span> HardCodedTarget&lt;&gt;(<span class="keyword">this</span>.type,</span><br><span class="line">                <span class="keyword">this</span>.name, url));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.hasText(<span class="keyword">this</span>.url) &amp;&amp; !<span class="keyword">this</span>.url.startsWith(<span class="string">"http"</span>)) &#123;</span><br><span class="line">        <span class="keyword">this</span>.url = <span class="string">"http://"</span> + <span class="keyword">this</span>.url;</span><br><span class="line">    &#125;</span><br><span class="line">    String url = <span class="keyword">this</span>.url + cleanPath();</span><br><span class="line">    Client client = getOptional(context, Client.class);</span><br><span class="line">    <span class="keyword">if</span> (client != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (client <span class="keyword">instanceof</span> LoadBalancerFeignClient) &#123;</span><br><span class="line">            <span class="comment">// not lod balancing because we have a url,</span></span><br><span class="line">            <span class="comment">// but ribbon is on the classpath, so unwrap</span></span><br><span class="line">            client = ((LoadBalancerFeignClient)client).getDelegate();</span><br><span class="line">        &#125;</span><br><span class="line">        builder.client(client);</span><br><span class="line">    &#125;</span><br><span class="line">    Targeter targeter = get(context, Targeter.class);</span><br><span class="line">    <span class="keyword">return</span> targeter.target(<span class="keyword">this</span>, builder, context, <span class="keyword">new</span> HardCodedTarget&lt;&gt;(</span><br><span class="line">            <span class="keyword">this</span>.type, <span class="keyword">this</span>.name, url));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Configuration-与-FeignBuilder-关联"><a href="#Configuration-与-FeignBuilder-关联" class="headerlink" title="Configuration 与 FeignBuilder 关联"></a>Configuration 与 FeignBuilder 关联</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">FeignContext context = applicationContext.getBean(FeignContext.class);</span><br><span class="line">Feign.Builder builder = feign(context);</span><br></pre></td></tr></table></figure>
<p>spring-cloud 也提供了一个 Feign 的初始化配置类:FeignAutoConfiguration。<br>它初始化了一个新的 FeignContext bean,并且把所有的 configuration 都放在 FeignContext 里面。  </p>
<p>FeignContext 继承了 NamedContextFactory,它会管理一批 Context<br>外部调用的时候会指定用哪个 context 来寻找对应的 bean<br>而 context 如果不存在,则会创建一个新的 AnnotationConfigApplicationContext。<br>创建 context 的时候,会用 name 去匹配已有的 configurations(加载该 FeignClient 注解里面提供的 configuration 属性类)<br>如果有同名的,则就将该 configuration 注册进 context<br>另外如果有 default 开头的 configuration,也会将其注册到 context 里面<br>最后调用 refresh 方法对 context 进行初始化。<br>初始化以后,相当于 configuration 里面提供的encoder,decoder 这些就逗号了。  </p>
<p>在 FeignClientFactoryBean 创建 Bean 的时候它先从 applicationContext 里面找到已经构建好的 feignContext  </p>
<p>初始化一个 FeignBuilder,FeignBuilder 会利用 context 里面包含的对应的 configuration 指定的 bean<br>获取指定的类,比如 decoder,encoder,retryer,errorDecoder。<br>然后再去寻找 context 中的 Client bean。  </p>
<p><br></p>
<h4 id="Client-Bean"><a href="#Client-Bean" class="headerlink" title="Client Bean"></a>Client Bean</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Client client = getOptional(context, Client.class);</span><br></pre></td></tr></table></figure>
<p>如果当前路径里面有<code>Ribbon</code>,那么 Spring Boot 启动时就会创建一个<code>LoadBalancerFeignClient</code>。<br>如果没有,<code>FeignAutoConfiguration</code> 里面也会自己去创建 <code>ApacheHttpClient</code> 或者 <code>OKHttpClient</code>。<br>FeignBuilder 会拿这个 <code>client</code> 配到自己里面。  </p>
<blockquote>
<p>Ribbon的负载均衡  </p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">LoadBalancerFeignClient 做为FeignRibbonClientAutoConfiguration#feignClient引入</span><br><span class="line">LoadBalancerFeignClient#lbClient利用内部成员变量CachingSpringLoadBalancerFactory创建合适的Client  </span><br><span class="line">主要看是否有重试?RetryableFeignLoadBalancer:FeignLoadBalancer,这两个类都继承AbstractLoadBalancerAwareClient  </span><br><span class="line">executeWithLoadBalancer就是执行父抽象类AbstractLoadBalancerAwareClient#executeWithLoadBalancer</span><br><span class="line">由LoadBalancerCommand以RxJava方式去submit一个请求执行</span><br><span class="line">LoadBalancerCommand#selectServer选择服务器间接引出LoadBalancerContext再引出ILoadBalancer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">所以具体交给了ILoadBalancer来处理,ILoadBalancer通过配置IRule、IPing等信息</span><br><span class="line">由BaseLoadBalancer引出了IRule.choose(key);默认为RoundRobinRule</span><br><span class="line"></span><br><span class="line">并向EurekaClient获取注册列表的信息,并默认10秒一次向EurekaClient发送&quot;ping&quot;,进而检查是否更新服务列表</span><br><span class="line">最后得到注册列表后,ILoadBalancer根据IRule的策略进行负载均衡。 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">而RestTemplate被@LoadBalance注解后能过用负载均衡;主要是维护了一个被@LoadBalance注解的RestTemplate列表,并给列表中的RestTemplate添加拦截器,进而交给负载均衡器去处理。</span><br></pre></td></tr></table></figure>
<h4 id="Targeter-生产代理类"><a href="#Targeter-生产代理类" class="headerlink" title="Targeter 生产代理类"></a>Targeter 生产代理类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Targeter targeter = get(context, Targeter.class);</span><br><span class="line"><span class="keyword">return</span> targeter.target(<span class="keyword">this</span>, builder, context, <span class="keyword">new</span> HardCodedTarget&lt;&gt;(<span class="keyword">this</span>.type, <span class="keyword">this</span>.name, url));</span><br></pre></td></tr></table></figure>
<p>然后是最关键的一步,获取 Targeter 来生成动态代理类,在 FeignAutoConfiguration 里面,<br>指定了生成 HystrixTargeter。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> loadBalance(builder, context, <span class="keyword">new</span> HardCodedTarget&lt;&gt;(<span class="keyword">this</span>.type,<span class="keyword">this</span>.name, url));</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> &lt;T&gt; <span class="function">T <span class="title">loadBalance</span><span class="params">(Feign.Builder builder, FeignContext context,</span></span></span><br><span class="line"><span class="function"><span class="params">            HardCodedTarget&lt;T&gt; target)</span> </span>&#123;</span><br><span class="line">    Client client = getOptional(context, Client.class);</span><br><span class="line">    <span class="keyword">if</span> (client != <span class="keyword">null</span>) &#123;</span><br><span class="line">        builder.client(client);</span><br><span class="line">        Targeter targeter = get(context, Targeter.class);</span><br><span class="line">        <span class="keyword">return</span> targeter.target(<span class="keyword">this</span>, builder, context, target);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">            <span class="string">"No Feign Client for loadBalancing defined. Did you forget to include spring-cloud-starter-ribbon?"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">target</span><span class="params">(FeignClientFactoryBean factory, Feign.Builder feign, FeignContext context,</span></span></span><br><span class="line"><span class="function"><span class="params">                    Target.HardCodedTarget&lt;T&gt; target)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!(feign <span class="keyword">instanceof</span> feign.hystrix.HystrixFeign.Builder)) &#123;</span><br><span class="line">        <span class="keyword">return</span> feign.target(target);</span><br><span class="line">    &#125;</span><br><span class="line">    feign.hystrix.HystrixFeign.Builder builder = (feign.hystrix.HystrixFeign.Builder) feign;</span><br><span class="line">    SetterFactory setterFactory = getOptional(factory.getName(), context,</span><br><span class="line">        SetterFactory.class);</span><br><span class="line">    <span class="keyword">if</span> (setterFactory != <span class="keyword">null</span>) &#123;</span><br><span class="line">        builder.setterFactory(setterFactory);</span><br><span class="line">    &#125;</span><br><span class="line">    Class&lt;?&gt; fallback = factory.getFallback();</span><br><span class="line">    <span class="keyword">if</span> (fallback != <span class="keyword">void</span>.class) &#123;</span><br><span class="line">        <span class="keyword">return</span> targetWithFallback(factory.getName(), context, target, builder, fallback);</span><br><span class="line">    &#125;</span><br><span class="line">    Class&lt;?&gt; fallbackFactory = factory.getFallbackFactory();</span><br><span class="line">    <span class="keyword">if</span> (fallbackFactory != <span class="keyword">void</span>.class) &#123;</span><br><span class="line">        <span class="keyword">return</span> targetWithFallbackFactory(factory.getName(), context, target, builder, fallbackFactory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> feign.target(target);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果 FeignClient 没有定义 fallback,或者说 Builder 不是 HystrixFeignBuilder,则直接用 FeignBuidler 的 target 方法生成代理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">target</span><span class="params">(Target&lt;T&gt; target)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> build().newInstance(target);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Feign <span class="title">build</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  SynchronousMethodHandler.Factory synchronousMethodHandlerFactory =</span><br><span class="line">      <span class="keyword">new</span> SynchronousMethodHandler.Factory(client, retryer, requestInterceptors, logger,</span><br><span class="line">                                           logLevel, decode404);</span><br><span class="line">  ParseHandlersByName handlersByName =</span><br><span class="line">      <span class="keyword">new</span> ParseHandlersByName(contract, options, encoder, decoder,</span><br><span class="line">                              errorDecoder, synchronousMethodHandlerFactory);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> ReflectiveFeign(handlersByName, invocationHandlerFactory);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="生成代理"><a href="#生成代理" class="headerlink" title="生成代理"></a>生成代理</h4><p>ReflectiveFeign 生成动态代理对象(newInstance)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">newInstance</span><span class="params">(Target&lt;T&gt; target)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//为每个方法创建一个SynchronousMethodHandler对象,并放在 Map 里面。</span></span><br><span class="line">    Map&lt;String, MethodHandler&gt; nameToHandler = targetToHandlersByName.apply(target);</span><br><span class="line">    Map&lt;Method, MethodHandler&gt; methodToHandler = <span class="keyword">new</span> LinkedHashMap&lt;Method, MethodHandler&gt;();</span><br><span class="line">    List&lt;DefaultMethodHandler&gt; defaultMethodHandlers = <span class="keyword">new</span> LinkedList&lt;DefaultMethodHandler&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (Method method : target.type().getMethods()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (method.getDeclaringClass() == Object.class) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(Util.isDefault(method)) &#123;</span><br><span class="line">            <span class="comment">//如果是 default 方法,说明已经有实现了,用 DefaultHandler</span></span><br><span class="line">            DefaultMethodHandler handler = <span class="keyword">new</span> DefaultMethodHandler(method);</span><br><span class="line">            defaultMethodHandlers.add(handler);</span><br><span class="line">            methodToHandler.put(method, handler);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//否则就用上面的 SynchronousMethodHandler</span></span><br><span class="line">            methodToHandler.put(method, nameToHandler.get(Feign.configKey(target.type(), method)));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 创建动态代理,factory 是 InvocationHandlerFactory.Default,创建出来的是 ReflectiveFeign.FeignInvocationHanlder,也就是说后续对方法的调用都会进入到该对象的 inovke 方法。</span></span><br><span class="line">    InvocationHandler handler = factory.create(target, methodToHandler);</span><br><span class="line">    <span class="comment">// 创建动态代理对象</span></span><br><span class="line">    T proxy = (T) Proxy.newProxyInstance(target.type().getClassLoader(), <span class="keyword">new</span> Class&lt;?&gt;[]&#123;target.type()&#125;, handler);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(DefaultMethodHandler defaultMethodHandler : defaultMethodHandlers) &#123;</span><br><span class="line">        defaultMethodHandler.bindTo(proxy);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> proxy;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Map&lt;String, MethodHandler&gt; <span class="title">apply</span><span class="params">(Target key)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//取出要实现的接口的所有方法</span></span><br><span class="line">    List&lt;MethodMetadata&gt; metadata = contract.parseAndValidatateMetadata(key.type());</span><br><span class="line">    Map&lt;String, MethodHandler&gt; result = <span class="keyword">new</span> LinkedHashMap&lt;String, MethodHandler&gt;();</span><br><span class="line">    <span class="keyword">for</span> (MethodMetadata md : metadata) &#123;</span><br><span class="line">        <span class="comment">//根据目标接口类和方法上的注解信息判断该用哪种 buildTemplate</span></span><br><span class="line">        BuildTemplateByResolvingArgs buildTemplate;</span><br><span class="line">        <span class="keyword">if</span> (!md.formParams().isEmpty() &amp;&amp; md.template().bodyTemplate() == <span class="keyword">null</span>) &#123;</span><br><span class="line">          buildTemplate = <span class="keyword">new</span> BuildFormEncodedTemplateFromArgs(md, encoder);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (md.bodyIndex() != <span class="keyword">null</span>) &#123;</span><br><span class="line">          buildTemplate = <span class="keyword">new</span> BuildEncodedTemplateFromArgs(md, encoder);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          buildTemplate = <span class="keyword">new</span> BuildTemplateByResolvingArgs(md);</span><br><span class="line">        &#125;</span><br><span class="line">          <span class="comment">//调用synchronousMethodHandlerFactory来生成SynchronousMethodHandler对象。这个就是对接口某个方法的实现。</span></span><br><span class="line">        result.put(md.configKey(),</span><br><span class="line">                   factory.create(key, md, buildTemplate, options, decoder, errorDecoder));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>synchronousMethodHandlerFactory 的 create 方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> MethodHandler <span class="title">create</span><span class="params">(Target&lt;?&gt; target, MethodMetadata md,</span></span></span><br><span class="line"><span class="function"><span class="params">                                RequestTemplate.Factory buildTemplateFromArgs,</span></span></span><br><span class="line"><span class="function"><span class="params">                                Options options, Decoder decoder, ErrorDecoder errorDecoder)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> SynchronousMethodHandler(target, client, retryer, requestInterceptors, logger,</span><br><span class="line">                                      logLevel, md, buildTemplateFromArgs, options, decoder,</span><br><span class="line">                                      errorDecoder, decode404);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ReflectiveFeign.FeignInvocationHanlder 的 invoke 方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    <span class="comment">//通过动态代理实现了几个通用方法,比如 equals、toString、hasCode</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">"equals"</span>.equals(method.getName())) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Object</span><br><span class="line">              otherHandler =</span><br><span class="line">              args.length &gt; <span class="number">0</span> &amp;&amp; args[<span class="number">0</span>] != <span class="keyword">null</span> ? Proxy.getInvocationHandler(args[<span class="number">0</span>]) : <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">return</span> equals(otherHandler);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"hashCode"</span>.equals(method.getName())) &#123;</span><br><span class="line">        <span class="keyword">return</span> hashCode();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"toString"</span>.equals(method.getName())) &#123;</span><br><span class="line">        <span class="keyword">return</span> toString();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//找到具体的 method 的 Handler,然后调用 invoke 方法。这样就又进入了SynchronousMethodHandler对象的 invoke 方法。</span></span><br><span class="line">    <span class="keyword">return</span> dispatch.get(method).invoke(args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>SynchronousMethodHandler 的 invoke 方法主要是应用 encoder,decoder 以及 retry 等配置并且自身对于调用结果有一定的处理逻辑。  </p>
<p>我们最关心的请求实现,实际上是在组装 SynchronousMethodHandler 的 client 参数上<br>即前面提到的,如果当前路径里面有 Ribbon,就是 LoadBalancerFeignClient<br>如果没有,根据配置生成 ApacheHttpClient 或者 OKHttpClient。<br>在 Ribbon 里面,实现了 Eureka 服务发现以及进行请求等动作,当然 Ribbon 里面还带了负载均衡逻辑。  </p>
<h4 id="SynchronousMethodHandler-invoke方法"><a href="#SynchronousMethodHandler-invoke方法" class="headerlink" title="SynchronousMethodHandler#invoke方法"></a>SynchronousMethodHandler#invoke方法</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object[] argv)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    RequestTemplate template = buildTemplateFromArgs.create(argv);</span><br><span class="line">    Retryer retryer = <span class="keyword">this</span>.retryer.clone();</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> executeAndDecode(template);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (RetryableException e) &#123;</span><br><span class="line">        retryer.continueOrPropagate(e);</span><br><span class="line">        <span class="keyword">if</span> (logLevel != Logger.Level.NONE) &#123;</span><br><span class="line">          logger.logRetry(metadata.configKey(), logLevel);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Object <span class="title">executeAndDecode</span><span class="params">(RequestTemplate template)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    Request request = targetRequest(template);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (logLevel != Logger.Level.NONE) &#123;</span><br><span class="line">      logger.logRequest(metadata.configKey(), logLevel, request);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Response response;</span><br><span class="line">    <span class="keyword">long</span> start = System.nanoTime();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">//通过 client 获得请求的返回值</span></span><br><span class="line">      response = client.execute(request, options);</span><br><span class="line">      <span class="comment">// ensure the request is set. <span class="doctag">TODO:</span> remove in Feign 10</span></span><br><span class="line">      response.toBuilder().request(request).build();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">      <span class="keyword">if</span> (logLevel != Logger.Level.NONE) &#123;</span><br><span class="line">        logger.logIOException(metadata.configKey(), logLevel, e, elapsedTime(start));</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">throw</span> errorExecuting(request, e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">long</span> elapsedTime = TimeUnit.NANOSECONDS.toMillis(System.nanoTime() - start);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> shouldClose = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (logLevel != Logger.Level.NONE) &#123;</span><br><span class="line">        response =</span><br><span class="line">            logger.logAndRebufferResponse(metadata.configKey(), logLevel, response, elapsedTime);</span><br><span class="line">        <span class="comment">// ensure the request is set. <span class="doctag">TODO:</span> remove in Feign 10</span></span><br><span class="line">        response.toBuilder().request(request).build();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (Response.class == metadata.returnType()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (response.body() == <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> response;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (response.body().length() == <span class="keyword">null</span> ||</span><br><span class="line">                response.body().length() &gt; MAX_RESPONSE_BUFFER_SIZE) &#123;</span><br><span class="line">          shouldClose = <span class="keyword">false</span>;</span><br><span class="line">          <span class="keyword">return</span> response;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Ensure the response body is disconnected</span></span><br><span class="line">        <span class="keyword">byte</span>[] bodyData = Util.toByteArray(response.body().asInputStream());</span><br><span class="line">        <span class="keyword">return</span> response.toBuilder().body(bodyData).build();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (response.status() &gt;= <span class="number">200</span> &amp;&amp; response.status() &lt; <span class="number">300</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">void</span>.class == metadata.returnType()) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> decode(response);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (decode404 &amp;&amp; response.status() == <span class="number">404</span> &amp;&amp; <span class="keyword">void</span>.class != metadata.returnType()) &#123;</span><br><span class="line">        <span class="keyword">return</span> decode(response);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> errorDecoder.decode(metadata.configKey(), response);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">      <span class="keyword">if</span> (logLevel != Logger.Level.NONE) &#123;</span><br><span class="line">        logger.logIOException(metadata.configKey(), logLevel, e, elapsedTime);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">throw</span> errorReading(request, response, e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (shouldClose) &#123;</span><br><span class="line">        ensureClosed(response.body());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<h2 id="Feign调用流程"><a href="#Feign调用流程" class="headerlink" title="Feign调用流程"></a>Feign调用流程</h2><p><code>业务FeignClient</code>的调用-&gt;<code>ReflectiveFeign.FeignInvocationHandler#invoker</code></p>
<blockquote>
<p>invoker代码引出如下  </p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> dispatch.get(method).invoke(args);</span><br></pre></td></tr></table></figure>
<p><code>SynchronousMethodHandler#invoke</code>  </p>
<ul>
<li>创建合适的<code>RequestTemplate</code>  </li>
<li>执行<code>executeAndDecode</code>  <ul>
<li>通过<code>targetRequest</code>将<code>RequestTemplate</code>转换为<code>request</code>  </li>
<li><code>client.execute(request, options);</code>(由client引出<code>LoadBalancerFeignClient</code>)  </li>
</ul>
</li>
<li><code>LoadBalancerFeignClient#execute</code>  <ul>
<li>根据<code>request</code>构建<code>ribbonRequest</code></li>
<li><code>lbClient(clientName).executeWithLoadBalancer(ribbonRequest,requestConfig).toResponse();</code></li>
</ul>
</li>
<li><code>lbClient(clientName)</code>(通过lbClientFactory工厂创建合适的client去执行负载请求)  <ul>
<li>获取相关的<code>ILoadBalancer</code>,<code>IClientConfig</code>构建<code>FeignLoadBalancer</code></li>
</ul>
</li>
<li><code>FeignLoadBalancer#executeWithLoadBalancer</code>执行点在基础抽象类<code>AbstractLoadBalancerAwareClient#executeWithLoadBalancer</code>  <ul>
<li>构建命令<code>LoadBalancerCommand</code>  </li>
<li>命令执行<code>command.submit</code>  <ul>
<li><code>selectServer</code>选取合适的服务列表</li>
<li><code>AbstractLoadBalancerAwareClient.this.execute</code>(引出<code>FeignLoadBalancer#execute</code>)</li>
</ul>
</li>
</ul>
</li>
<li><code>FeignLoadBalancer#execute</code><ul>
<li><code>Client.Default#execute</code>(HttpURLConnection请求回复)  </li>
</ul>
</li>
</ul>
<p><br><br><br><br><br></p>
<h1 id="Ribbon"><a href="#Ribbon" class="headerlink" title="Ribbon"></a>Ribbon</h1><p>ribbon的6个主要组件:<code>IRule</code>、<code>IPing</code>、<code>ServerList</code> 、<code>ServerListFilter</code>、<code>ServerListUpdater</code>、<code>ILoadBalancer</code></p>
<h2 id="功能说明"><a href="#功能说明" class="headerlink" title="功能说明"></a>功能说明</h2><p>Ribbon主要包括如下功能</p>
<ul>
<li>1.支持通过DNS和IP和服务端通信</li>
<li>2.可以根据算法从多个服务中选取一个服务进行访问</li>
<li>3.通过将客户端和服务器分成几个区域(zone)来建立客户端和服务器之间的关系。客户端尽量访问和自己在相同区域(zone)的服务，减少服务的延迟</li>
<li>4.保留服务器的统计信息,ribbon可以实现用于避免高延迟或频繁访问故障的服务器</li>
<li>5.保留区域(zone)的统计数据,ribbon可以实现避免可能访问失效的区域(zone)</li>
</ul>
<h2 id="Ribbon主要组件"><a href="#Ribbon主要组件" class="headerlink" title="Ribbon主要组件"></a>Ribbon主要组件</h2><p>Ribbon主要包含如下组件：</p>
<ul>
<li>1.IRule</li>
<li>2.IPing</li>
<li>3.ServerList</li>
<li>4.ServerListFilter</li>
<li>5.ServerListUpdater</li>
<li>6.IClientConfig</li>
<li>7.ILoadBalancer</li>
</ul>
<p><br></p>
<h3 id="IRule"><a href="#IRule" class="headerlink" title="IRule"></a>IRule</h3><blockquote>
<p>功能:根据特定算法中从服务列表中选取一个要访问的服务 </p>
</blockquote>
<p>常用IRule实现有以下几种：</p>
<ul>
<li><p>RoundRobinRule<br>轮询规则，默认规则。同时也是更高级rules的回退策略</p>
</li>
<li><p>AvailabilityFilteringRule<br>这个负载均衡器规则，会先过滤掉以下服务：</p>
</li>
</ul>
<p>a. 由于多次访问故障而处于断路器跳闸状态<br>b. 并发的连接数量超过阈值<br>然后对剩余的服务列表按照RoundRobinRule策略进行访问</p>
<ul>
<li><p>WeightedResponseTimeRule<br>根据平均响应时间计算所有服务的权重，响应时间越快，服务权重越重、被选中的概率越高。刚启动时，如果统计信息不足，则使用RoundRobinRule策略，等统计信息足够，会切换到WeightedResponseTimeRule。</p>
</li>
<li><p>RetryRule<br>先按照RoundRobinRule的策略获取服务，如果获取服务失败，则在指定时间内会进行重试，获取可用的服务</p>
</li>
<li><p>BestAvailableRule<br>此负载均衡器会先过滤掉由于多次访问故障而处于断路器跳闸状态的服务，然后选择一个并发量最小的服务</p>
</li>
<li><p>RandomRule<br>随机获取一个服务</p>
</li>
</ul>
<p><br></p>
<h3 id="IPing"><a href="#IPing" class="headerlink" title="IPing"></a>IPing</h3><blockquote>
<p>功能:在后台运行的一个组件，用于检查服务列表是否都活</p>
</blockquote>
<ul>
<li><p>NIWSDiscoveryPing<br>不执行真正的ping。如果Discovery Client认为是在线，则程序认为本次心跳成功，服务活着</p>
</li>
<li><p>PingUrl<br>此组件会使用HttpClient调用服务的一个URL，如果调用成功，则认为本次心跳成功，表示此服务活着。</p>
</li>
<li><p>NoOpPing<br>永远返回true，即认为服务永远活着</p>
</li>
<li><p>DummyPing<br>默认实现，默认返回true，即认为服务永远活着</p>
</li>
</ul>
<p><br></p>
<h3 id="ServerList"><a href="#ServerList" class="headerlink" title="ServerList"></a>ServerList</h3><blockquote>
<p>功能:存储服务列表。分为静态和动态。如果是动态的后台有个线程会定时刷新和过滤服务列表</p>
</blockquote>
<p>常用ServerList 实现有以下几种：</p>
<ul>
<li>ConfigurationBasedServerList<br>从配置文件中获取所有服务列表</li>
</ul>
<p>配置例子:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sample-client.ribbon.listOfServers=www.microsoft.com:80,www.yahoo.com:80,www.google.com:80</span><br></pre></td></tr></table></figure>
<ul>
<li>DiscoveryEnabledNIWSServerList </li>
</ul>
<p>从Eureka Client中获取服务列表。此值必须通过属性中的VipAddress来标识服务器集群。DynamicServerListLoadBalancer会调用此对象动态获取服务列表</p>
<ul>
<li>DomainExtractingServerList<br>代理类,根据ServerList的值实现具体的逻辑</li>
</ul>
<p><br></p>
<h3 id="ServerListFilter"><a href="#ServerListFilter" class="headerlink" title="ServerListFilter"></a>ServerListFilter</h3><p>该接口允许过滤配置或动态获取的具有所需特性的服务器列表。ServerListFilter是DynamicServerListLoadBalancer用于过滤从ServerList实现返回的服务器的组件。</p>
<p>常用ServerListFilter 实现有以下几种：</p>
<ul>
<li>ZoneAffinityServerListFilter<br>过滤掉所有的不和客户端在相同zone的服务,如果和客户端相同的zone不存在,才不过滤不同zone有服务。</li>
</ul>
<p>启用此配置使用以下配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;clientName&gt;.ribbon.EnableZoneAffinity=true</span><br></pre></td></tr></table></figure>
<ul>
<li>ZonePreferenceServerListFilter </li>
</ul>
<p>ZoneAffinityServerListFilter的子类。和ZoneAffinityServerListFilter相似,但是比较的zone是发布环境里面的zone。<br>过滤掉所有和客户端环境里的配置的zone的不同的服务,如果和客户端相同的zone不存在才不进行过滤。</p>
<ul>
<li>ServerListSubsetFilter </li>
</ul>
<p>ZoneAffinityServerListFilter的子类。此过滤器确保客户端仅看到由ServerList实现返回的整个服务器的固定子集。<br>它还可以定期用新服务器替代可用性差的子集中的服务器。</p>
<p>要启用此过滤器，请指定以下属性：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;clientName&gt;.ribbon.NIWSServerListClassName=com.netflix.niws.loadbalancer.DiscoveryEnabledNIWSServerList </span><br><span class="line"># the server must register itself with Eureka server with VipAddress &quot;myservice&quot;</span><br><span class="line">&lt;clientName&gt;.ribbon.DeploymentContextBasedVipAddresses=myservice</span><br><span class="line">&lt;clientName&gt;.ribbon.NIWSServerListFilterClassName=com.netflix.loadbalancer.ServerListSubsetFilter</span><br><span class="line"># only show client 5 servers. default is 20.</span><br><span class="line">&lt;clientName&gt;.ribbon.ServerListSubsetFilter.size=5</span><br></pre></td></tr></table></figure>
<p><br></p>
<h3 id="ServerListUpdater"><a href="#ServerListUpdater" class="headerlink" title="ServerListUpdater"></a>ServerListUpdater</h3><blockquote>
<p>功能:被DynamicServerListLoadBalancer用于动态的更新服务列表。 </p>
</blockquote>
<p>常用的实现类：</p>
<ul>
<li>PollingServerListUpdater </li>
</ul>
<p>默认的实现策略。此对象会启动一个定时线程池，定时执行更新策略</p>
<ul>
<li>EurekaNotificationServerListUpdater </li>
</ul>
<p>当收到缓存刷新的通知，会更新服务列表。</p>
<p><br></p>
<h3 id="IClientConfig"><a href="#IClientConfig" class="headerlink" title="IClientConfig"></a>IClientConfig</h3><blockquote>
<p>功能:定义各种配置信息,用来初始化ribbon客户端和负载均衡器</p>
</blockquote>
<p>常用IClientConfig实现有以下几种： </p>
<ul>
<li>DefaultClientConfigImpl </li>
</ul>
<p>IClientConfig的默认实现，配置文件里的部分值为ribbon。</p>
<p><br></p>
<h3 id="ILoadBalancer"><a href="#ILoadBalancer" class="headerlink" title="ILoadBalancer"></a>ILoadBalancer</h3><p>定义软件负载平衡器操作的接口。动态更新一组服务列表及根据指定算法从现有服务器列表中选择一个服务</p>
<ul>
<li>DynamicServerListLoadBalancer </li>
</ul>
<p>DynamicServerListLoadBalancer组合Rule、IPing、ServerList、ServerListFilter、ServerListUpdater 实现类,实现动态更新和过滤更新服务列表</p>
<ul>
<li>ZoneAwareLoadBalancer </li>
</ul>
<p>这是DynamicServerListLoadBalancer的子类,主要加入zone的因素。统计每个zone的平均请求的情况,保证从所有zone选取对当前客户端服务最好的服务组列表</p>
<p><br></p>
<h2 id="默认的ribbon实现类"><a href="#默认的ribbon实现类" class="headerlink" title="默认的ribbon实现类"></a>默认的ribbon实现类</h2><ul>
<li>IClientConfig ribbonClientConfig: DefaultClientConfigImpl </li>
<li>IRule ribbonRule: ZoneAvoidanceRule </li>
<li>IPing ribbonPing: DummyPing </li>
<li>ServerList ribbonServerList: ConfigurationBasedServerList </li>
<li>ServerListFilter ribbonServerListFilter: ZonePreferenceServerListFilter </li>
<li>ILoadBalancer ribbonLoadBalancer: ZoneAwareLoadBalancer </li>
<li>ServerListUpdater ribbonServerListUpdater: PollingServerListUpdater</li>
</ul>
<p><br>  </p>
<h2 id="通过配置文件配置Ribbon的主要组件"><a href="#通过配置文件配置Ribbon的主要组件" class="headerlink" title="通过配置文件配置Ribbon的主要组件"></a>通过配置文件配置Ribbon的主要组件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;clientName&gt;.ribbon.NFLoadBalancerClassName=xx</span><br><span class="line">&lt;clientName&gt;.ribbon.NFLoadBalancerRuleClassName=xx</span><br><span class="line">&lt;clientName&gt;.ribbon.NFLoadBalancerPingClassName=xx</span><br><span class="line">&lt;clientName&gt;.ribbon.NIWSServerListClassName=xx</span><br><span class="line">&lt;clientName&gt;.ribbon.NIWSServerListFilterClassName=xx</span><br></pre></td></tr></table></figure>
<p>或者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyDefaultRibbonConfig</span> </span>&#123;</span><br><span class="line"><span class="comment">//    @Bean</span></span><br><span class="line"><span class="comment">//    public IRule ribbonRule() &#123;</span></span><br><span class="line"><span class="comment">//        return new MyRule();</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IPing <span class="title">ribbonPing</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MyPingUrl(<span class="keyword">new</span> NIWSDiscoveryPing());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br><br><br><br><br></p>
<h1 id="Hystrix"><a href="#Hystrix" class="headerlink" title="Hystrix"></a>Hystrix</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><table>
<thead>
<tr>
<th>方法</th>
<th>执行方式</th>
</tr>
</thead>
<tbody>
<tr>
<td>#execute()</td>
<td>同步调用,返回直接结果    </td>
</tr>
<tr>
<td>#queue()</td>
<td>异步调用,返回 java.util.concurrent.Future  </td>
</tr>
<tr>
<td>#observe()</td>
<td>异步调用,返回 rx.Observable 。向 Observable 注册 rx.Subscriber 处理结果  </td>
</tr>
<tr>
<td>#toObservable()</td>
<td>未调用,返回 rx.Observable 。向 Observable 注册 rx.Subscriber 处理结果</td>
</tr>
</tbody>
</table>
<ul>
<li>#toObservable() 方法 ：未做订阅,返回干净的 Observable 。这就是为什么上文说”未调用” 。</li>
<li>#observe() 方法 ：调用 #toObservable() 方法的基础上,向 Observable 注册 rx.subjects.ReplaySubject 发起订阅 。<br>ReplaySubject 会发射所有来自原始 Observable 的数据给观察者,无论它们是何时订阅的。感兴趣的同学可以阅读 《ReactiveX/RxJava文档中文版 —— Subject》 。</li>
<li>#queue() 方法 ：调用 #toObservable() 方法的基础上,调用：<ul>
<li>Observable#toBlocking() 方法 ：将 Observable 转换成阻塞的 rx.observables.BlockingObservable 。</li>
<li>BlockingObservable#toFuture() 方法 ：返回可获得 #run() 抽象方法执行结果的 Future 。<ul>
<li>#run() 方法 ：子类实现该方法,执行正常的业务逻辑。</li>
</ul>
</li>
</ul>
</li>
<li>#execute() 方法 ：调用 #queue() 方法的基础上,调用 Future#get() 方法,同步返回 #run() 的执行结果。</li>
</ul>
<p><img src="/2017/05/16/springcloud/image-04.png" alt="img"></p>
<p><br></p>
<h2 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h2><p><img src="/2017/05/16/springcloud/image-05.png" alt="img"> </p>
<h3 id="线程池隔离"><a href="#线程池隔离" class="headerlink" title="线程池隔离"></a>线程池隔离</h3><p>Hystrix通过命令模式,将每个类型的业务请求封装成对应的命令请求</p>
<ul>
<li>查询订单-&gt;订单Command</li>
<li>查询商品-&gt;商品Command</li>
<li>查询用户-&gt;用户Command。<br>每个类型的Command对应一个线程池。创建好的线程池是被放入到ConcurrentHashMap中  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">static</span> ConcurrentHashMap&lt;String, HystrixThreadPool&gt; threadPools = <span class="keyword">new</span> ConcurrentHashMap&lt;String, HystrixThreadPool&gt;();</span><br><span class="line">threadPools.put(<span class="string">"hystrix-order"</span>, <span class="keyword">new</span> HystrixThreadPoolDefault(threadPoolKey, propertiesBuilder));</span><br></pre></td></tr></table></figure>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ThreadPoolExecutor <span class="title">getThreadPool</span><span class="params">(<span class="keyword">final</span> HystrixThreadPoolKey threadPoolKey, HystrixProperty&lt;Integer&gt; corePoolSize, HystrixProperty&lt;Integer&gt; maximumPoolSize, HystrixProperty&lt;Integer&gt; keepAliveTime, TimeUnit unit, BlockingQueue&lt;Runnable&gt; workQueue)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ThreadFactory threadFactory = getThreadFactory(threadPoolKey);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> dynamicCoreSize = corePoolSize.get();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> dynamicMaximumSize = maximumPoolSize.get();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (dynamicCoreSize &gt; dynamicMaximumSize) &#123;</span><br><span class="line">        logger.error(<span class="string">"Hystrix ThreadPool configuration at startup for : "</span> + threadPoolKey.name() + <span class="string">" is trying to set coreSize = "</span> +</span><br><span class="line">                dynamicCoreSize + <span class="string">" and maximumSize = "</span> + dynamicMaximumSize + <span class="string">".  Maximum size will be set to "</span> +</span><br><span class="line">                dynamicCoreSize + <span class="string">", the coreSize value, since it must be equal to or greater than the coreSize value"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ThreadPoolExecutor(dynamicCoreSize, dynamicCoreSize, keepAliveTime.get(), unit, workQueue, threadFactory);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ThreadPoolExecutor(dynamicCoreSize, dynamicMaximumSize, keepAliveTime.get(), unit, workQueue, threadFactory);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="运用至项目-线程隔离"><a href="#运用至项目-线程隔离" class="headerlink" title="运用至项目-线程隔离"></a>运用至项目-线程隔离</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GetOrderCommand</span> <span class="keyword">extends</span> <span class="title">HystrixCommand</span>&lt;<span class="title">List</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    OrderService orderService;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GetOrderCommand</span><span class="params">(String name)</span></span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(<span class="string">"ThreadPoolTestGroup"</span>))</span><br><span class="line">                .andCommandKey(HystrixCommandKey.Factory.asKey(<span class="string">"testCommandKey"</span>))</span><br><span class="line">                .andThreadPoolKey(HystrixThreadPoolKey.Factory.asKey(name))</span><br><span class="line">                .andCommandPropertiesDefaults(</span><br><span class="line">                        HystrixCommandProperties.Setter()</span><br><span class="line">                                .withExecutionTimeoutInMilliseconds(<span class="number">5000</span>)</span><br><span class="line">                )</span><br><span class="line">                .andThreadPoolPropertiesDefaults(</span><br><span class="line">                        HystrixThreadPoolProperties.Setter()</span><br><span class="line">                                .withMaxQueueSize(<span class="number">10</span>)   <span class="comment">//配置队列大小</span></span><br><span class="line">                                .withCoreSize(<span class="number">2</span>)    <span class="comment">// 配置线程池里的线程数</span></span><br><span class="line">                )</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> List <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> orderService.getOrderList();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">UnitTest</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Test</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testGetOrder</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="comment">//            new GetOrderCommand("hystrix-order").execute();</span></span><br><span class="line">            Future&lt;List&gt; future =<span class="keyword">new</span> GetOrderCommand(<span class="string">"hystrix-order"</span>).queue();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="线程池隔离-优缺点"><a href="#线程池隔离-优缺点" class="headerlink" title="线程池隔离 - 优缺点"></a>线程池隔离 - 优缺点</h4><ul>
<li><p>线程池隔离的优点:</p>
<ul>
<li>应用程序会被完全保护起来,即使依赖的一个服务的线程池满了,也不会影响到应用程序的其他部分。</li>
<li>我们给应用程序引入一个新的风险较低的客户端lib的时候,如果发生问题,也是在本lib中,并不会影响到其他内容,因此我们可以大胆的引入新lib库。</li>
<li>当依赖的一个失败的服务恢复正常时,应用程序会立即恢复正常的性能。</li>
<li>如果我们的应用程序一些参数配置错误了,线程池的运行状况将会很快显示出来,比如延迟、超时、拒绝等。同时可以通过动态属性实时执行来处理纠正错误的参数配置。</li>
<li>如果服务的性能有变化,从而需要调整,比如增加或者减少超时时间,更改重试次数,就可以通过线程池指标动态属性修改,而且不会影响到其他调用请求。</li>
<li>除了隔离优势外,hystrix拥有专门的线程池可提供内置的并发功能,使得可以在同步调用之上构建异步的外观模式,这样就可以很方便的做异步编程(Hystrix引入了Rxjava异步框架)。</li>
</ul>
</li>
<li><p>线程池隔离的缺点:</p>
<ul>
<li>线程池的主要缺点就是它增加了计算的开销,每个业务请求(被包装成命令)在执行的时候,会涉及到请求排队,调度和上下文切换。不过Netflix公司内部认为线程隔离开销足够小,不会产生重大的成本或性能的影响。</li>
</ul>
</li>
</ul>
<h3 id="信号量隔离"><a href="#信号量隔离" class="headerlink" title="信号量隔离"></a>信号量隔离</h3><p>将属性<code>execution.isolation.strategy</code>设置为SEMAPHORE<br>象这样 ExecutionIsolationStrategy.SEMAPHORE,则Hystrix使用信号量而不是默认的线程池来做隔离。  </p>
<p>线程池方式下业务请求线程和执行依赖的服务的线程不是同一个线程;<br>信号量方式下业务请求线程和执行依赖服务的线程是同一个线程  </p>
<h4 id="运用至项目-信号量隔离"><a href="#运用至项目-信号量隔离" class="headerlink" title="运用至项目-信号量隔离"></a>运用至项目-信号量隔离</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommandUsingSemaphoreIsolation</span> <span class="keyword">extends</span> <span class="title">HystrixCommand</span>&lt;<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> id;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CommandUsingSemaphoreIsolation</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(<span class="string">"ExampleGroup"</span>))</span><br><span class="line">                .andCommandPropertiesDefaults(HystrixCommandProperties.Setter()</span><br><span class="line">                        .withExecutionIsolationStrategy(ExecutionIsolationStrategy.SEMAPHORE)));</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"ValueFromHashMap_"</span> + id;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="信号量隔离-优缺点"><a href="#信号量隔离-优缺点" class="headerlink" title="信号量隔离 - 优缺点"></a>信号量隔离 - 优缺点</h4><p>信号量隔离的方式是限制了总的并发数,每一次请求过来,请求线程和调用依赖服务的线程是同一个线程,那么如果不涉及远程RPC调用(没有网络开销)则使用信号量来隔离,更为轻量,开销更小。<br>当我们依赖的服务是极低延迟的,比如访问内存缓存,就没有必要使用线程池的方式,那样的话开销得不偿失  </p>
<h3 id="熔断器"><a href="#熔断器" class="headerlink" title="熔断器"></a>熔断器</h3><p>Hystrix在运行过程中会向每个commandKey对应的熔断器报告成功、失败、超时和拒绝的状态<br>熔断器维护计算统计的数据,根据这些统计的信息来确定熔断器是否打开。  </p>
<p>如果打开,后续的请求都会被截断。然后会隔一段时间默认是5s,尝试半开,放入一部分流量请求进来,相当于对依赖服务进行一次健康检查<br>如果恢复,熔断器关闭,随后完全恢复调用。  </p>
<p><img src="/2017/05/16/springcloud/image-06.png" alt="熔断器"><br>步骤4开始,Hystrix会检查Circuit Breaker的状态。<br>如果Circuit Breaker的状态为开启状态,Hystrix将不会执行对应指令,而是直接进入失败处理状态(图中8 Fallback)。<br>如果Circuit Breaker的状态为关闭状态,Hystrix会继续进行线程池、任务队列、信号量的检查(图中5)  </p>
<h4 id="熔断器-参数"><a href="#熔断器-参数" class="headerlink" title="熔断器 - 参数"></a>熔断器 - 参数</h4><p>1: <code>circuitBreaker.enabled</code><br>是否启用熔断器,默认是TURE。<br>2: <code>circuitBreaker.forceOpen</code><br>熔断器强制打开,始终保持打开状态。默认值FLASE。<br>3: <code>circuitBreaker.forceClosed</code><br>熔断器强制关闭,始终保持关闭状态。默认值FLASE。<br>4: <code>circuitBreaker.errorThresholdPercentage</code><br>设定错误百分比,默认值50%,例如一段时间(10s)内有100个请求,其中有55个超时或者异常返回了,那么这段时间内的错误百分比是55%,大于了默认值50%,这种情况下触发熔断器-打开。<br>5: <code>circuitBreaker.requestVolumeThreshold</code><br>默认值20.意思是至少有20个请求才进行errorThresholdPercentage错误百分比计算。比如一段时间(10s)内有19个请求全部失败了。<br>错误百分比是100%,但熔断器不会打开,因为requestVolumeThreshold的值是20.<br>这个参数非常重要,熔断器是否打开首先要满足这个条件<br>6: <code>circuitBreaker.sleepWindowInMilliseconds</code><br>半开试探休眠时间,默认值5000ms。当熔断器开启一段时间之后比如5000ms,会尝试放过去一部分流量进行试探,确定依赖服务是否恢复。  </p>
<h4 id="熔断模拟示例"><a href="#熔断模拟示例" class="headerlink" title="熔断模拟示例"></a>熔断模拟示例</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GetOrderCircuitBreakerCommand</span> <span class="keyword">extends</span> <span class="title">HystrixCommand</span>&lt;<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GetOrderCircuitBreakerCommand</span><span class="params">(String name)</span></span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(<span class="string">"ThreadPoolTestGroup"</span>))</span><br><span class="line">                .andCommandKey(HystrixCommandKey.Factory.asKey(<span class="string">"testCommandKey"</span>))</span><br><span class="line">                .andThreadPoolKey(HystrixThreadPoolKey.Factory.asKey(name))</span><br><span class="line">                .andCommandPropertiesDefaults(</span><br><span class="line">                        HystrixCommandProperties.Setter()</span><br><span class="line">                                .withCircuitBreakerEnabled(<span class="keyword">true</span>)<span class="comment">//默认是true,本例中为了展现该参数</span></span><br><span class="line">                                .withCircuitBreakerForceOpen(<span class="keyword">false</span>)<span class="comment">//默认是false,本例中为了展现该参数</span></span><br><span class="line">                                .withCircuitBreakerForceClosed(<span class="keyword">false</span>)<span class="comment">//默认是false,本例中为了展现该参数</span></span><br><span class="line">                                .withCircuitBreakerErrorThresholdPercentage(<span class="number">5</span>)<span class="comment">//(1)错误百分比超过5%</span></span><br><span class="line">                                .withCircuitBreakerRequestVolumeThreshold(<span class="number">10</span>)<span class="comment">//(2)10s以内调用次数10次,同时满足(1)(2)熔断器打开</span></span><br><span class="line">                                .withCircuitBreakerSleepWindowInMilliseconds(<span class="number">5000</span>)<span class="comment">//隔5s之后,熔断器会尝试半开(关闭),重新放进来请求</span></span><br><span class="line"><span class="comment">//                                .withExecutionTimeoutInMilliseconds(1000)</span></span><br><span class="line">                )</span><br><span class="line">                .andThreadPoolPropertiesDefaults(</span><br><span class="line">                        HystrixThreadPoolProperties.Setter()</span><br><span class="line">                                .withMaxQueueSize(<span class="number">10</span>)   <span class="comment">//配置队列大小</span></span><br><span class="line">                                .withCoreSize(<span class="number">2</span>)    <span class="comment">// 配置线程池里的线程数</span></span><br><span class="line">                )</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Random rand = <span class="keyword">new</span> Random();</span><br><span class="line">        <span class="comment">//模拟错误百分比(方式比较粗鲁但可以证明问题)</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="number">1</span>==rand.nextInt(<span class="number">2</span>))&#123;</span><br><span class="line"><span class="comment">//            System.out.println("make exception");</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"make exception"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"running:  "</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">getFallback</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">//        System.out.println("FAILBACK");</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"fallback: "</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">UnitTest</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Test</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testCircuitBreaker</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">25</span>;i++)&#123;</span><br><span class="line">                Thread.sleep(<span class="number">500</span>);</span><br><span class="line">                HystrixCommand&lt;String&gt; command = <span class="keyword">new</span> GetOrderCircuitBreakerCommand(<span class="string">"testCircuitBreaker"</span>);</span><br><span class="line">                String result = command.execute();</span><br><span class="line">                <span class="comment">//本例子中从第11次,熔断器开始打开</span></span><br><span class="line">                System.out.println(<span class="string">"call times:"</span>+(i+<span class="number">1</span>)+<span class="string">"   result:"</span>+result +<span class="string">" isCircuitBreakerOpen: "</span>+command.isCircuitBreakerOpen());</span><br><span class="line">                <span class="comment">//本例子中5s以后,熔断器尝试关闭,放开新的请求进来</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>每个熔断器默认维护10个bucket,每秒一个bucket,每个blucket记录成功,失败,超时,拒绝的状态,默认错误超过50%且10秒内超过20个请求进行中断拦截。  </p>
<h3 id="回退降级"><a href="#回退降级" class="headerlink" title="回退降级"></a>回退降级</h3><p><br><br>在Hystrix执行非核心链路功能失败的情况下,如何处理,比如返回默认值等。<br>如果我们要回退或者降级处理,代码上需要实现HystrixCommand.getFallback()方法或者是HystrixObservableCommand. HystrixObservableCommand()。  </p>
<p>降级回退方式  </p>
<ul>
<li><p>Fail Fast 快速失败</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> String <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (throwException) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"failure from CommandThatFailsFast"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//如果实现的是HystrixObservableCommand.java则 重写 resumeWithFallback方法</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Observable&lt;String&gt; <span class="title">resumeWithFallback</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (throwException) &#123;</span><br><span class="line">        <span class="keyword">return</span> Observable.error(<span class="keyword">new</span> Throwable(<span class="string">"failure from CommandThatFailsFast"</span>));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Observable.just(<span class="string">"success"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Fail Silent 无声失败<br>  返回null,空Map,空List  </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> String <span class="title">getFallback</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> List&lt;String&gt; <span class="title">getFallback</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Observable&lt;String&gt; <span class="title">resumeWithFallback</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Observable.empty();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Fallback: Static 返回默认值  </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Boolean <span class="title">getFallback</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Observable&lt;Boolean&gt; <span class="title">resumeWithFallback</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Observable.just( <span class="keyword">true</span> );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Fallback: Stubbed 自己组装一个值返回       </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> UserAccount <span class="title">getFallback</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> UserAccount(customerId, <span class="string">"Unknown Name"</span>,</span><br><span class="line">            countryCodeFromGeoLookup, <span class="keyword">true</span>, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Fallback: Cache via Network 利用远程缓存  </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> String <span class="title">getFallback</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> FallbackViaNetwork(id).execute();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">FallbackViaNetwork</span> <span class="keyword">extends</span> <span class="title">HystrixCommand</span>&lt;<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> id;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FallbackViaNetwork</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(<span class="string">"RemoteServiceX"</span>))</span><br><span class="line">                .andCommandKey(HystrixCommandKey.Factory.asKey(<span class="string">"GetValueFallbackCommand"</span>))</span><br><span class="line">                .andThreadPoolKey(HystrixThreadPoolKey.Factory.asKey(<span class="string">"RemoteServiceXFallback"</span>)));</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        MemCacheClient.getValue(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">getFallback</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>Hystrix为我们提供了一套线上系统容错的技术实践方法,我们通过在系统中引入Hystrix的jar包可以很方便的使用线程隔离、熔断、回退等技术。同时它还提供了监控页面配置,方便我们管理查看每个接口的调用情况。<br>像spring cloud这种微服务构建模式中也引入了Hystrix,我们可以放心使用Hystrix的线程隔离技术,来防止雪崩这种可怕的致命性线上故障。</p>
<h3 id="注解使用"><a href="#注解使用" class="headerlink" title="注解使用"></a>注解使用</h3><ul>
<li><p>同步执行  </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@HystrixCommand</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">getUserById</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userResource.getUserById(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>异步执行  </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@HystrixCommand</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Future&lt;User&gt; <span class="title">getUserByIdAsync</span><span class="params">(<span class="keyword">final</span> String id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> AsyncResult&lt;User&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> User <span class="title">invoke</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> userResource.getUserById(id);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="Properties属性介绍"><a href="#Properties属性介绍" class="headerlink" title="Properties属性介绍"></a>Properties属性介绍</h4><p>每个方法的相关Properties<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@HystrixCommand</span>(groupKey = <span class="string">"hello"</span>,commandKey = <span class="string">"hello-service"</span>,threadPoolKey = <span class="string">"hello-pool"</span>,</span><br><span class="line">    threadPoolProperties = &#123;</span><br><span class="line">            <span class="meta">@HystrixProperty</span>(name = <span class="string">"coreSize"</span>, value = <span class="string">"30"</span>),</span><br><span class="line">            <span class="meta">@HystrixProperty</span>(name = <span class="string">"maxQueueSize"</span>, value = <span class="string">"101"</span>),</span><br><span class="line">            <span class="meta">@HystrixProperty</span>(name = <span class="string">"keepAliveTimeMinutes"</span>, value = <span class="string">"2"</span>),</span><br><span class="line">            <span class="meta">@HystrixProperty</span>(name = <span class="string">"queueSizeRejectionThreshold"</span>, value = <span class="string">"15"</span>),</span><br><span class="line">            <span class="meta">@HystrixProperty</span>(name = <span class="string">"metrics.rollingStats.numBuckets"</span>, value = <span class="string">"12"</span>),</span><br><span class="line">            <span class="meta">@HystrixProperty</span>(name = <span class="string">"metrics.rollingStats.timeInMilliseconds"</span>, value = <span class="string">"1440"</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    commandProperties = &#123;</span><br><span class="line">        <span class="meta">@HystrixProperty</span>(name = <span class="string">"execution.isolation.thread.timeoutInMilliseconds"</span>,value = <span class="string">"5000"</span>),</span><br><span class="line">        <span class="meta">@HystrixProperty</span>(name = <span class="string">"execution.isolation.strategy"</span>,value = <span class="string">"THREAD"</span>)&#125;,</span><br><span class="line">    fallbackMethod = <span class="string">"helloFallBack"</span></span><br><span class="line">    )</span><br></pre></td></tr></table></figure></p>
<p><code>@DefaultProperties</code>Class类上默认的Properties,不需要每个function都定义一次Properties<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@DefaultProperties</span>(groupKey = <span class="string">"DefaultGroupKey"</span>)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Service</span> </span>&#123;</span><br><span class="line">    <span class="meta">@HystrixCommand</span>     <span class="comment">// hystrix command group key is 'DefaultGroupKey'</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">commandInheritsDefaultProperties</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@HystrixCommand</span>(groupKey = <span class="string">"SpecificGroupKey"</span>) <span class="comment">// command overrides default group key</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">commandOverridesGroupKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="fallback回退"><a href="#fallback回退" class="headerlink" title="fallback回退"></a>fallback回退</h4><ul>
<li>fallback方法必须和指定fallback方法的主方法在一个类中</li>
<li>fallback方法的参数必须要和主方法的参数一致<br>否则不生效</li>
<li>使用fallback方法需要根据依赖服务设置合理的超时时间,即<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">commandProperties = &#123;</span><br><span class="line">    <span class="meta">@HystrixProperty</span>(</span><br><span class="line">    name = <span class="string">"execution.isolation.thread.timeoutInMilliseconds"</span>,</span><br><span class="line">    value = <span class="string">"5000"</span>)&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@HystrixCommand</span>(fallbackMethod = <span class="string">"fallback1"</span>)</span><br><span class="line"><span class="function">User <span class="title">getUserById</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"getUserById command failed"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@HystrixCommand</span>(fallbackMethod = <span class="string">"fallback2"</span>)</span><br><span class="line"><span class="function">User <span class="title">fallback1</span><span class="params">(String id, Throwable e)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">assert</span> <span class="string">"getUserById command failed"</span>.equals(e.getMessage());</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"fallback1 failed"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@HystrixCommand</span>(fallbackMethod = <span class="string">"fallback3"</span>)</span><br><span class="line"><span class="function">User <span class="title">fallback2</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"fallback2 failed"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@HystrixCommand</span>(fallbackMethod = <span class="string">"staticFallback"</span>)</span><br><span class="line"><span class="function">User <span class="title">fallback3</span><span class="params">(String id, Throwable e)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">assert</span> <span class="string">"fallback2 failed"</span>.equals(e.getMessage());</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"fallback3 failed"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">User <span class="title">staticFallback</span><span class="params">(String id, Throwable e)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">assert</span> <span class="string">"fallback3 failed"</span>.equals(e.getMessage());</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> User(<span class="string">"def"</span>, <span class="string">"def"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// test</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    assertEquals(<span class="string">"def"</span>, getUserById(<span class="string">"1"</span>).getName());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="缓存功能"><a href="#缓存功能" class="headerlink" title="缓存功能"></a>缓存功能</h4><ul>
<li><p>CacheResult<br>  @CacheResult方法可以用在我们之前的Service方法上,表示给该方法开启缓存,默认情况下方法的所有参数都将作为缓存的key如下:  </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CacheResult</span></span><br><span class="line"><span class="meta">@HystrixCommand</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Book <span class="title">test6</span><span class="params">(Integer id,String aa)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> restTemplate.getForObject(<span class="string">"http://HELLO-SERVICE/getbook5/&#123;1&#125;"</span>, Book.class, id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>CacheKey<br>  当然除了使用默认数据之外,我们也可以使用@CacheKey来指定缓存的key  </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CacheResult</span></span><br><span class="line"><span class="meta">@HystrixCommand</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Book <span class="title">test6</span><span class="params">(@CacheKey Integer id,String aa)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> restTemplate.getForObject(<span class="string">"http://HELLO-SERVICE/getbook5/&#123;1&#125;"</span>, Book.class, id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>CacheRemove<br>  这个当然是用来让缓存失效的注解,用法也很简单  </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CacheRemove</span>(commandKey = <span class="string">"test6"</span>)</span><br><span class="line"><span class="meta">@HystrixCommand</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Book <span class="title">test7</span><span class="params">(@CacheKey Integer id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/test6"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Book <span class="title">test6</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    HystrixRequestContext.initializeContext();</span><br><span class="line">    <span class="comment">//第一次发起请求</span></span><br><span class="line">    Book b1 = bookService.test6(<span class="number">2</span>);</span><br><span class="line">    <span class="comment">//清除缓存</span></span><br><span class="line">    bookService.test7(<span class="number">2</span>);</span><br><span class="line">    <span class="comment">//缓存被清除,重新发起请求</span></span><br><span class="line">    Book b2 = bookService.test6(<span class="number">2</span>);</span><br><span class="line">    <span class="comment">//参数一致,使用缓存数据</span></span><br><span class="line">    Book b3 = bookService.test6(<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">return</span> b1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="HystrixCollapser-合并命令"><a href="#HystrixCollapser-合并命令" class="headerlink" title="HystrixCollapser 合并命令"></a>HystrixCollapser 合并命令</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyService</span> </span>&#123;</span><br><span class="line">    Logger logger = LoggerFactory.getLogger(MyService.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@HystrixCollapser</span>(batchMethod = <span class="string">"getIds"</span>,</span><br><span class="line">            collapserProperties = &#123;<span class="meta">@HystrixProperty</span>(name = <span class="string">"timerDelayInMilliseconds"</span>, value = <span class="string">"200"</span>)&#125;,</span><br><span class="line">            scope = GLOBAL)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Future&lt;String&gt; <span class="title">getId</span><span class="params">(String id)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"getId"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@HystrixCommand</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">getIds</span><span class="params">(List&lt;String&gt; ids)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"executing on thread id: "</span>+ Thread.currentThread().getName() + <span class="string">", id:"</span>+ids.toString());</span><br><span class="line">        <span class="keyword">return</span> ids.stream().map(data-&gt;String.valueOf(Integer.valueOf(data)+<span class="number">1</span>)).collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CollegeController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CollegeService collegeService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MyService service;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/collapser"</span>)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">collapser</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, ExecutionException </span>&#123;</span><br><span class="line">        Future&lt;String&gt; f1 = service.getId(<span class="string">"1"</span>);</span><br><span class="line">        Future&lt;String&gt; f2 = service.getId(<span class="string">"2"</span>);</span><br><span class="line">        String result1 = f1.get();</span><br><span class="line">        String result2 = f2.get();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result1+result2;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h2><p><img src="/2017/05/16/springcloud/image-04.png" alt="img"></p>
<h3 id="toObservable"><a href="#toObservable" class="headerlink" title="toObservable"></a>toObservable</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Observable&lt;R&gt; <span class="title">toObservable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//_cmd 指向当前命令对象,用于下面实现 FuncX ,ActionX 内部类使用。</span></span><br><span class="line">        <span class="keyword">final</span> AbstractCommand&lt;R&gt; _cmd = <span class="keyword">this</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Action0 terminateCommandCleanup = <span class="keyword">new</span> Action0() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (_cmd.commandState.compareAndSet(CommandState.OBSERVABLE_CHAIN_CREATED, CommandState.TERMINAL)) &#123;</span><br><span class="line">                    handleCommandEnd(<span class="keyword">false</span>); <span class="comment">//user code never ran</span></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (_cmd.commandState.compareAndSet(CommandState.USER_CODE_EXECUTED, CommandState.TERMINAL)) &#123;</span><br><span class="line">                    handleCommandEnd(<span class="keyword">true</span>); <span class="comment">//user code did run</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Action0 unsubscribeCommandCleanup = <span class="keyword">new</span> Action0() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (_cmd.commandState.compareAndSet(CommandState.OBSERVABLE_CHAIN_CREATED, CommandState.UNSUBSCRIBED)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!_cmd.executionResult.containsTerminalEvent()) &#123;</span><br><span class="line">                        _cmd.eventNotifier.markEvent(HystrixEventType.CANCELLED, _cmd.commandKey);</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            executionHook.onUnsubscribe(_cmd);</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (Throwable hookEx) &#123;</span><br><span class="line">                            logger.warn(<span class="string">"Error calling HystrixCommandExecutionHook.onUnsubscribe"</span>, hookEx);</span><br><span class="line">                        &#125;</span><br><span class="line">                        _cmd.executionResultAtTimeOfCancellation = _cmd.executionResult</span><br><span class="line">                                .addEvent((<span class="keyword">int</span>) (System.currentTimeMillis() - _cmd.commandStartTimestamp), HystrixEventType.CANCELLED);</span><br><span class="line">                    &#125;</span><br><span class="line">                    handleCommandEnd(<span class="keyword">false</span>); <span class="comment">//user code never ran</span></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (_cmd.commandState.compareAndSet(CommandState.USER_CODE_EXECUTED, CommandState.UNSUBSCRIBED)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!_cmd.executionResult.containsTerminalEvent()) &#123;</span><br><span class="line">                        _cmd.eventNotifier.markEvent(HystrixEventType.CANCELLED, _cmd.commandKey);</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            executionHook.onUnsubscribe(_cmd);</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (Throwable hookEx) &#123;</span><br><span class="line">                            logger.warn(<span class="string">"Error calling HystrixCommandExecutionHook.onUnsubscribe"</span>, hookEx);</span><br><span class="line">                        &#125;</span><br><span class="line">                        _cmd.executionResultAtTimeOfCancellation = _cmd.executionResult</span><br><span class="line">                                .addEvent((<span class="keyword">int</span>) (System.currentTimeMillis() - _cmd.commandStartTimestamp), HystrixEventType.CANCELLED);</span><br><span class="line">                    &#125;</span><br><span class="line">                    handleCommandEnd(<span class="keyword">true</span>); <span class="comment">//user code did run</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//当缓存特性未开启,或者缓存未命中时,使用 applyHystrixSemantics 传入 Observable#defer(...) 方法,声明执行命令的 Observable。</span></span><br><span class="line">        <span class="keyword">final</span> Func0&lt;Observable&lt;R&gt;&gt; applyHystrixSemantics = <span class="keyword">new</span> Func0&lt;Observable&lt;R&gt;&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Observable&lt;R&gt; <span class="title">call</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (commandState.get().equals(CommandState.UNSUBSCRIBED)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> Observable.never();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> applyHystrixSemantics(_cmd);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Func1&lt;R, R&gt; wrapWithAllOnNextHooks = <span class="keyword">new</span> Func1&lt;R, R&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> R <span class="title">call</span><span class="params">(R r)</span> </span>&#123;</span><br><span class="line">                R afterFirstApplication = r;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    afterFirstApplication = executionHook.onComplete(_cmd, r);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable hookEx) &#123;</span><br><span class="line">                    logger.warn(<span class="string">"Error calling HystrixCommandExecutionHook.onComplete"</span>, hookEx);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> executionHook.onEmit(_cmd, afterFirstApplication);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable hookEx) &#123;</span><br><span class="line">                    logger.warn(<span class="string">"Error calling HystrixCommandExecutionHook.onEmit"</span>, hookEx);</span><br><span class="line">                    <span class="keyword">return</span> afterFirstApplication;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Action0 fireOnCompletedHook = <span class="keyword">new</span> Action0() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    executionHook.onSuccess(_cmd);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable hookEx) &#123;</span><br><span class="line">                    logger.warn(<span class="string">"Error calling HystrixCommandExecutionHook.onSuccess"</span>, hookEx);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//声明缓存 Observable 。Hystrix 执行命令的 Observable 声明</span></span><br><span class="line">        <span class="keyword">return</span> Observable.defer(<span class="keyword">new</span> Func0&lt;Observable&lt;R&gt;&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Observable&lt;R&gt; <span class="title">call</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="comment">//一条命令只能执行一次</span></span><br><span class="line">                <span class="keyword">if</span> (!commandState.compareAndSet(CommandState.NOT_STARTED, CommandState.OBSERVABLE_CHAIN_CREATED)) &#123;</span><br><span class="line">                    IllegalStateException ex = <span class="keyword">new</span> IllegalStateException(<span class="string">"This instance can only be executed once. Please instantiate a new instance."</span>);</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> HystrixRuntimeException(FailureType.BAD_REQUEST_EXCEPTION, _cmd.getClass(), getLogMessagePrefix() + <span class="string">" command executed multiple times - this is not permitted."</span>, ex, <span class="keyword">null</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//记录命令开始时间戳</span></span><br><span class="line">                commandStartTimestamp = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (properties.requestLogEnabled().get()) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (currentRequestLog != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        currentRequestLog.addExecutedCommand(_cmd);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//缓存存开关、KEY 。</span></span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span> requestCacheEnabled = isRequestCachingEnabled();</span><br><span class="line">                <span class="keyword">final</span> String cacheKey = getCacheKey();</span><br><span class="line"></span><br><span class="line">                <span class="comment">//如果请求结果缓存这个特性被启用,并且缓存命中,则缓存的回应会立即通过一个 Observable 对象的形式返回。</span></span><br><span class="line">                <span class="keyword">if</span> (requestCacheEnabled) &#123;</span><br><span class="line">                    HystrixCommandResponseFromCache&lt;R&gt; fromCache = (HystrixCommandResponseFromCache&lt;R&gt;) requestCache.get(cacheKey);</span><br><span class="line">                    <span class="keyword">if</span> (fromCache != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        isResponseFromCache = <span class="keyword">true</span>;</span><br><span class="line">                        <span class="keyword">return</span> handleRequestCacheHitAndEmitValues(fromCache, _cmd);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 获得 执行命令Observable</span></span><br><span class="line">                Observable&lt;R&gt; hystrixObservable =</span><br><span class="line">                        Observable.defer(applyHystrixSemantics)</span><br><span class="line">                                .map(wrapWithAllOnNextHooks);</span><br><span class="line">                <span class="comment">// 获得 缓存Observable</span></span><br><span class="line">                Observable&lt;R&gt; afterCache;</span><br><span class="line"></span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (requestCacheEnabled &amp;&amp; cacheKey != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">//当缓存特性开启,并且缓存未命中时,创建订阅了执行命令的 Observable的 HystrixCommandResponseFromCache </span></span><br><span class="line">                    HystrixCachedObservable&lt;R&gt; toCache = HystrixCachedObservable.from(hystrixObservable, _cmd);</span><br><span class="line">                    HystrixCommandResponseFromCache&lt;R&gt; fromCache = (HystrixCommandResponseFromCache&lt;R&gt;) requestCache.putIfAbsent(cacheKey, toCache);</span><br><span class="line">                    <span class="keyword">if</span> (fromCache != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        toCache.unsubscribe();</span><br><span class="line">                        isResponseFromCache = <span class="keyword">true</span>; <span class="comment">// 标记 从缓存中结果</span></span><br><span class="line">                        <span class="keyword">return</span> handleRequestCacheHitAndEmitValues(fromCache, _cmd);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        </span><br><span class="line">                        afterCache = toCache.toObservable();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    afterCache = hystrixObservable;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> afterCache</span><br><span class="line">                        .doOnTerminate(terminateCommandCleanup)</span><br><span class="line">                        .doOnUnsubscribe(unsubscribeCommandCleanup)</span><br><span class="line">                        .doOnCompleted(fireOnCompletedHook);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="applyHystrixSemantics"><a href="#applyHystrixSemantics" class="headerlink" title="applyHystrixSemantics"></a>applyHystrixSemantics</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Func0&lt;Observable&lt;R&gt;&gt; applyHystrixSemantics = <span class="keyword">new</span> Func0&lt;Observable&lt;R&gt;&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Observable&lt;R&gt; <span class="title">call</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (commandState.get().equals(CommandState.UNSUBSCRIBED)) &#123;</span><br><span class="line">            <span class="keyword">return</span> Observable.never();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> applyHystrixSemantics(_cmd);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line"><span class="function"><span class="keyword">private</span> Observable&lt;R&gt; <span class="title">applyHystrixSemantics</span><span class="params">(<span class="keyword">final</span> AbstractCommand&lt;R&gt; _cmd)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    executionHook.onStart(_cmd);</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (circuitBreaker.allowRequest()) &#123;</span><br><span class="line">        <span class="comment">// 获得 信号量</span></span><br><span class="line">        <span class="keyword">final</span> TryableSemaphore executionSemaphore = getExecutionSemaphore();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 信号量释放Action</span></span><br><span class="line">        <span class="keyword">final</span> AtomicBoolean semaphoreHasBeenReleased = <span class="keyword">new</span> AtomicBoolean(<span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">final</span> Action0 singleSemaphoreRelease = <span class="keyword">new</span> Action0() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (semaphoreHasBeenReleased.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) &#123;</span><br><span class="line">                    executionSemaphore.release();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Action1&lt;Throwable&gt; markExceptionThrown = <span class="keyword">new</span> Action1&lt;Throwable&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Throwable t)</span> </span>&#123;</span><br><span class="line">                eventNotifier.markEvent(HystrixEventType.EXCEPTION_THROWN, commandKey);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 信号量 获得</span></span><br><span class="line">        <span class="keyword">if</span> (executionSemaphore.tryAcquire()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 标记 executionResult 调用开始时间</span></span><br><span class="line">                executionResult = executionResult.setInvocationStartTime(System.currentTimeMillis());</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 获得 执行Observable</span></span><br><span class="line">                <span class="keyword">return</span> executeCommandAndObserve(_cmd)</span><br><span class="line">                        .doOnError(markExceptionThrown)</span><br><span class="line">                        .doOnTerminate(singleSemaphoreRelease)</span><br><span class="line">                        .doOnUnsubscribe(singleSemaphoreRelease);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">                <span class="keyword">return</span> Observable.error(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> handleSemaphoreRejectionViaFallback();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//链路处于熔断状态,调用 #handleShortCircuitViaFallback() 方法,处理链路熔断的失败回退逻辑</span></span><br><span class="line">        <span class="keyword">return</span> handleShortCircuitViaFallback();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="executeCommandAndObserve"><a href="#executeCommandAndObserve" class="headerlink" title="executeCommandAndObserve"></a>executeCommandAndObserve</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Observable&lt;R&gt; <span class="title">executeCommandAndObserve</span><span class="params">(<span class="keyword">final</span> AbstractCommand&lt;R&gt; _cmd)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> HystrixRequestContext currentRequestContext = HystrixRequestContext.getContextForCurrentThread();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Action1&lt;R&gt; markEmits = <span class="keyword">new</span> Action1&lt;R&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(R r)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (shouldOutputOnNextEvents()) &#123;</span><br><span class="line">                executionResult = executionResult.addEvent(HystrixEventType.EMIT);</span><br><span class="line">                eventNotifier.markEvent(HystrixEventType.EMIT, commandKey);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (commandIsScalar()) &#123;</span><br><span class="line">                <span class="keyword">long</span> latency = System.currentTimeMillis() - executionResult.getStartTimestamp();</span><br><span class="line">                eventNotifier.markCommandExecution(getCommandKey(), properties.executionIsolationStrategy().get(), (<span class="keyword">int</span>) latency, executionResult.getOrderedList());</span><br><span class="line">                eventNotifier.markEvent(HystrixEventType.SUCCESS, commandKey);</span><br><span class="line">                executionResult = executionResult.addEvent((<span class="keyword">int</span>) latency, HystrixEventType.SUCCESS);</span><br><span class="line">                circuitBreaker.markSuccess();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Action0 markOnCompleted = <span class="keyword">new</span> Action0() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (!commandIsScalar()) &#123;</span><br><span class="line">                <span class="keyword">long</span> latency = System.currentTimeMillis() - executionResult.getStartTimestamp();</span><br><span class="line">                eventNotifier.markCommandExecution(getCommandKey(), properties.executionIsolationStrategy().get(), (<span class="keyword">int</span>) latency, executionResult.getOrderedList());</span><br><span class="line">                eventNotifier.markEvent(HystrixEventType.SUCCESS, commandKey);</span><br><span class="line">                executionResult = executionResult.addEvent((<span class="keyword">int</span>) latency, HystrixEventType.SUCCESS);</span><br><span class="line">                circuitBreaker.markSuccess();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 失败回退逻辑 Func1</span></span><br><span class="line">    <span class="keyword">final</span> Func1&lt;Throwable, Observable&lt;R&gt;&gt; handleFallback = <span class="keyword">new</span> Func1&lt;Throwable, Observable&lt;R&gt;&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Observable&lt;R&gt; <span class="title">call</span><span class="params">(Throwable t)</span> </span>&#123;</span><br><span class="line">            Exception e = getExceptionFromThrowable(t);</span><br><span class="line">            executionResult = executionResult.setExecutionException(e);</span><br><span class="line">            <span class="keyword">if</span> (e <span class="keyword">instanceof</span> RejectedExecutionException) &#123;</span><br><span class="line">                <span class="keyword">return</span> handleThreadPoolRejectionViaFallback(e);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (t <span class="keyword">instanceof</span> HystrixTimeoutException) &#123;</span><br><span class="line">                <span class="keyword">return</span> handleTimeoutViaFallback();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (t <span class="keyword">instanceof</span> HystrixBadRequestException) &#123;</span><br><span class="line">                <span class="keyword">return</span> handleBadRequestByEmittingError(e);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (e <span class="keyword">instanceof</span> HystrixBadRequestException) &#123;</span><br><span class="line">                    eventNotifier.markEvent(HystrixEventType.BAD_REQUEST, commandKey);</span><br><span class="line">                    <span class="keyword">return</span> Observable.error(e);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> handleFailureViaFallback(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 请求缓存</span></span><br><span class="line">    <span class="keyword">final</span> Action1&lt;Notification&lt;? <span class="keyword">super</span> R&gt;&gt; setRequestContext = <span class="keyword">new</span> Action1&lt;Notification&lt;? <span class="keyword">super</span> R&gt;&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Notification&lt;? <span class="keyword">super</span> R&gt; rNotification)</span> </span>&#123;</span><br><span class="line">            setRequestContextIfNeeded(currentRequestContext);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    Observable&lt;R&gt; execution;</span><br><span class="line">    <span class="keyword">if</span> (properties.executionTimeoutEnabled().get()) &#123;</span><br><span class="line">        execution = executeCommandWithSpecifiedIsolation(_cmd)</span><br><span class="line">                .lift(<span class="keyword">new</span> HystrixObservableTimeoutOperator&lt;R&gt;(_cmd));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        execution = executeCommandWithSpecifiedIsolation(_cmd);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> execution.doOnNext(markEmits)</span><br><span class="line">            .doOnCompleted(markOnCompleted)</span><br><span class="line">            .onErrorResumeNext(handleFallback)</span><br><span class="line">            .doOnEach(setRequestContext);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="executeCommandWithSpecifiedIsolation"><a href="#executeCommandWithSpecifiedIsolation" class="headerlink" title="executeCommandWithSpecifiedIsolation"></a>executeCommandWithSpecifiedIsolation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Observable&lt;R&gt; <span class="title">executeCommandWithSpecifiedIsolation</span><span class="params">(<span class="keyword">final</span> AbstractCommand&lt;R&gt; _cmd)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (properties.executionIsolationStrategy().get() == ExecutionIsolationStrategy.THREAD) &#123;</span><br><span class="line">    <span class="comment">//执行隔离策略为 Thread</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> Observable.defer(<span class="keyword">new</span> Func0&lt;Observable&lt;R&gt;&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Observable&lt;R&gt; <span class="title">call</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                executionResult = executionResult.setExecutionOccurred();</span><br><span class="line">                <span class="keyword">if</span> (!commandState.compareAndSet(CommandState.OBSERVABLE_CHAIN_CREATED, CommandState.USER_CODE_EXECUTED)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> Observable.error(<span class="keyword">new</span> IllegalStateException(<span class="string">"execution attempted while in state : "</span> + commandState.get().name()));</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                metrics.markCommandStart(commandKey, threadPoolKey, ExecutionIsolationStrategy.THREAD);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (isCommandTimedOut.get() == TimedOutStatus.TIMED_OUT) &#123;</span><br><span class="line">                    <span class="keyword">return</span> Observable.error(<span class="keyword">new</span> RuntimeException(<span class="string">"timed out before executing run()"</span>));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (threadState.compareAndSet(ThreadState.NOT_USING_THREAD, ThreadState.STARTED)) &#123;</span><br><span class="line">                    HystrixCounters.incrementGlobalConcurrentThreads();</span><br><span class="line">                    threadPool.markThreadExecution();</span><br><span class="line">                    endCurrentThreadExecutingCommand = Hystrix.startCurrentThreadExecutingCommand(getCommandKey());</span><br><span class="line">                    executionResult = executionResult.setExecutedInThread();</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        executionHook.onThreadStart(_cmd);</span><br><span class="line">                        executionHook.onRunStart(_cmd);</span><br><span class="line">                        executionHook.onExecutionStart(_cmd);</span><br><span class="line">                        <span class="keyword">return</span> getUserExecutionObservable(_cmd);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">                        <span class="keyword">return</span> Observable.error(ex);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> Observable.error(<span class="keyword">new</span> RuntimeException(<span class="string">"unsubscribed before executing run()"</span>));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).doOnTerminate(<span class="keyword">new</span> Action0() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (threadState.compareAndSet(ThreadState.STARTED, ThreadState.TERMINAL)) &#123;</span><br><span class="line">                    handleThreadEnd(_cmd);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (threadState.compareAndSet(ThreadState.NOT_USING_THREAD, ThreadState.TERMINAL)) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).doOnUnsubscribe(<span class="keyword">new</span> Action0() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (threadState.compareAndSet(ThreadState.STARTED, ThreadState.UNSUBSCRIBED)) &#123;</span><br><span class="line">                    handleThreadEnd(_cmd);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (threadState.compareAndSet(ThreadState.NOT_USING_THREAD, ThreadState.UNSUBSCRIBED)) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).subscribeOn(threadPool.getScheduler(<span class="keyword">new</span> Func0&lt;Boolean&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Boolean <span class="title">call</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> properties.executionIsolationThreadInterruptOnTimeout().get() &amp;&amp; _cmd.isCommandTimedOut.get() == TimedOutStatus.TIMED_OUT;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">//执行隔离策略为 SEMAPHORE </span></span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> Observable.defer(<span class="keyword">new</span> Func0&lt;Observable&lt;R&gt;&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Observable&lt;R&gt; <span class="title">call</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                executionResult = executionResult.setExecutionOccurred();</span><br><span class="line">                <span class="keyword">if</span> (!commandState.compareAndSet(CommandState.OBSERVABLE_CHAIN_CREATED, CommandState.USER_CODE_EXECUTED)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> Observable.error(<span class="keyword">new</span> IllegalStateException(<span class="string">"execution attempted while in state : "</span> + commandState.get().name()));</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                metrics.markCommandStart(commandKey, threadPoolKey, ExecutionIsolationStrategy.SEMAPHORE);</span><br><span class="line">                </span><br><span class="line">                </span><br><span class="line">                endCurrentThreadExecutingCommand = Hystrix.startCurrentThreadExecutingCommand(getCommandKey());</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    executionHook.onRunStart(_cmd);</span><br><span class="line">                    executionHook.onExecutionStart(_cmd);</span><br><span class="line">                    <span class="keyword">return</span> getUserExecutionObservable(_cmd);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">                    <span class="keyword">return</span> Observable.error(ex);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>

        
    </section>
</article>



<div class="comments">
    <div id="disqus_thread">
        <p class="comment-tips">国内查看评论需要代理~</p>
    </div>
    <script>
    window.disqus_config = function () {
        this.language = 'zh';
        this.page.url = 'http://www.coderss.cn/2017/05/16/springcloud/';
        this.page.title = 'SpringCloud源码详解';
        this.page.identifier = '2017/05/16/springcloud/';
    };
    (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        s.src = 'https://name.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>

</div>
        <footer class="footer">
    Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, Theme by <a href="https://github.com/sanonz/hexo-theme-concise" target="_blank">Concise</a>
</footer>

<script type="text/javascript" src="//s13.cnzz.com/z_stat.php?id=1234567890&amp;web_id=1234567890"></script>


    </div>

    <script type="text/javascript" src="https://cdn.bootcss.com/jquery/1.9.0/jquery.min.js"></script>
    
    <script type="text/javascript" src="/js/scrollspy.min.js"></script>
    
    <script type="text/javascript">
        $(function() {
            var nodes = {
                nav: $('#nav'),
                aside: $('#aside'),
                navTags: $('#nav-tags')
            };

            $('#open-panel, #aside-mask').on('click', function() {
                nodes.aside.toggleClass('panel-show');
            });
            $('#nav-tag').on('click', function(event) {
                event.preventDefault();console.log(nodes.navTags.attr('class'))
                nodes.navTags.toggleClass('tag-show');console.log(nodes.navTags.attr('class'))
            })/*.hover(function() {
                nodes.navTags.addClass('tag-show');
            }, function() {
                nodes.navTags.removeClass('tag-show');
            });*/

            
            $(document.body).scrollspy({target: '#aside-inner'});
            
        });
    </script>

</body>
</html>
