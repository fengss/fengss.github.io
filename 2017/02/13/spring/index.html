<!DOCTYPE html>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="UTF-8">

    

    

    <title>Spring详解 | Coderss</title>
    <meta name="author" content="coder">
    <meta name="version" content="1.0.0">
    <meta name="keywords" content="">
    <meta name="description" content="spring 详解笔记 
各变量说明


对象名
类  型
作    用
归属类




 aliasMap
Map&amp;lt;String, String&amp;gt;
存储Bean名称-&amp;gt;Bean别名映射关系
SimpleAliasRegistry


singletonObjects
Map&amp;lt;String, Object&amp;gt;
存储单例Bean名称-&amp;gt;单例Bean实现映射关系
DefaultSingletonBeanRegistry 


 singletonFactories
">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <meta name="baidu-site-verification" content="F0CXvmUgA9">

    
    
    <link rel="icon" href="/favicon.png">
    

    <link rel="stylesheet" href="/css/style.css">
</head>
<body>

    <div class="app">
        <header class="header clearfix">
    <div id="nav" class="nav">
    <button id="open-panel" class="open-panel"><i class="icon-library"></i></button>

    <nav class="nav-inner">

        
        
        <li class="nav-item">
            <a class="nav-link" href="/">首页</a>
        </li>
        
        
        
        <li class="nav-item">
            <a class="nav-link" href="/categories/back-end">Java前后端</a>
        </li>
        
        
        
        <li class="nav-item">
            <a class="nav-link" href="/categories/cpp">Cpp嵌入式</a>
        </li>
        
        
        
        <li class="nav-item">
            <a class="nav-link" href="/categories/go">Go云原生</a>
        </li>
        
        
        
        <li class="nav-item">
            <a class="nav-link" href="/categories/cloud">Linux安全</a>
        </li>
        
        
        
        <li class="nav-item">
            <a class="nav-link" href="/categories/reverse">Win安全</a>
        </li>
        
        
        
        <li class="nav-item">
            <a class="nav-link" href="/categories/data">数据与算法</a>
        </li>
        
        
        
        <li class="nav-item">
            <a class="nav-link" href="/categories/work">工作相关</a>
        </li>
        
        
        
        <li class="nav-item nav-item-tag">
            <a id="nav-tag" class="nav-link" href="#">文章标签</a>
            <div id="nav-tags" class="nav-tag-wrap">
                <i class="nav-tag-arrow"></i>
                
  <div class="widget-wrap">
    <h3 class="widget-title">
        <i class="icon-tag vm"></i>
        <span class="vm">Tags</span>
    </h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/AI/">AI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Boost库/">Boost库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Collection/">Collection</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cpp编程/">Cpp编程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Fescar/">Fescar</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Gc/">Gc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/K8s/">K8s</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MapReduce/">MapReduce</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Math/">Math</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Net/">Net</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nosql/">Nosql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python计算库/">Python计算库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Rust/">Rust</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Sharding-jdbc/">Sharding-jdbc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SkyWalking/">SkyWalking</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spark/">Spark</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TensorFlow/">TensorFlow</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Turi/">Turi</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Windows系统/">Windows系统</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Windows驱动/">Windows驱动</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Yarn/">Yarn</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/assembly/">assembly</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/c-cpp语言/">c/cpp语言</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/debug/">debug</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/design/">design</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dubbo/">dubbo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/eth/">eth</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/flume/">flume</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go/">go</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go-kernel/">go-kernel</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/io/">io</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/">java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/juc/">juc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kubernetes/">kubernetes</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/map/">map</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mfc/">mfc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/microservice/">microservice</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mybatis/">mybatis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/netty/">netty</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python-book/">python-book</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/qt/">qt</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sentinel/">sentinel</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/skycoin/">skycoin</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spring/">spring</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spring-cloud/">spring-cloud</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/stl/">stl</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tomcat/">tomcat</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/x86-Windows系统总结/">x86 Windows系统总结</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/中台/">中台</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/分布式文件系统/">分布式文件系统</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/多线程编程/">多线程编程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/嵌入式/">嵌入式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/架构/">架构</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/消息队列/">消息队列</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/网络编程/">网络编程</a></li></ul>
    </div>
  </div>


            </div>
        </li>
        
        
        
        <li class="nav-item">
            <a class="nav-link" href="/archives">历史归档</a>
        </li>
        
        
        

    </nav>
</div>

    <aside id="aside" class="aside">
    <div id="aside-mask" class="aside-mask"></div>
    <div id="aside-inner" class="aside-inner">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit"><i class="icon-search-stroke"></i></button><input type="hidden" name="sitesearch" value="http://www.coderss.cn"></form>

        
        
        
        
        

        
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#各变量说明"><span class="toc-number">1.</span> <span class="toc-text">各变量说明</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Ioc"><span class="toc-number">2.</span> <span class="toc-text">Ioc</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#BeanFactory-amp-amp-Application"><span class="toc-number">2.1.</span> <span class="toc-text">BeanFactory&amp;&amp;Application</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AbstractApplicationContext"><span class="toc-number">2.2.</span> <span class="toc-text">AbstractApplicationContext</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#refresh-方法解析"><span class="toc-number">2.2.1.</span> <span class="toc-text">refresh()方法解析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AbstractBeanFactory"><span class="toc-number">2.3.</span> <span class="toc-text">AbstractBeanFactory</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#doGetBean"><span class="toc-number">2.3.1.</span> <span class="toc-text">doGetBean</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#createBean"><span class="toc-number">2.3.2.</span> <span class="toc-text">createBean</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#BeanDefinitionReader"><span class="toc-number">2.4.</span> <span class="toc-text">BeanDefinitionReader</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#XmlBeanDefinitionReader"><span class="toc-number">2.4.1.</span> <span class="toc-text">XmlBeanDefinitionReader</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AnnotatedBeanDefinitionReader"><span class="toc-number">2.4.2.</span> <span class="toc-text">AnnotatedBeanDefinitionReader</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#生命周期"><span class="toc-number">2.5.</span> <span class="toc-text">生命周期</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#扩展"><span class="toc-number">3.</span> <span class="toc-text">扩展</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#InitialingBean"><span class="toc-number">3.1.</span> <span class="toc-text">InitialingBean</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DisposableBean"><span class="toc-number">3.2.</span> <span class="toc-text">DisposableBean</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#BeanNameAware"><span class="toc-number">3.3.</span> <span class="toc-text">BeanNameAware</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ApplicationContextAware"><span class="toc-number">3.4.</span> <span class="toc-text">ApplicationContextAware</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#BeanFactoryAware"><span class="toc-number">3.5.</span> <span class="toc-text">BeanFactoryAware</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FactoryBean"><span class="toc-number">3.6.</span> <span class="toc-text">FactoryBean</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#BeanPostProcess"><span class="toc-number">3.7.</span> <span class="toc-text">BeanPostProcess</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#BeanFactoryPostProcessor"><span class="toc-number">3.8.</span> <span class="toc-text">BeanFactoryPostProcessor</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#InstantiationAwareBeanPostProcessor"><span class="toc-number">3.9.</span> <span class="toc-text">InstantiationAwareBeanPostProcessor</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#BeanDefinitionRegistryPostProcessor"><span class="toc-number">3.10.</span> <span class="toc-text">BeanDefinitionRegistryPostProcessor</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#案例"><span class="toc-number">3.10.1.</span> <span class="toc-text">案例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ImportBeanDefinitionRegistrar"><span class="toc-number">3.11.</span> <span class="toc-text">ImportBeanDefinitionRegistrar</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#案例-1"><span class="toc-number">3.11.1.</span> <span class="toc-text">案例</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#工具类"><span class="toc-number">4.</span> <span class="toc-text">工具类</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#内置的resouce类型"><span class="toc-number">4.1.</span> <span class="toc-text">内置的resouce类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#常用工具"><span class="toc-number">4.2.</span> <span class="toc-text">常用工具</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#xml工具"><span class="toc-number">4.3.</span> <span class="toc-text">xml工具</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#其它工具集"><span class="toc-number">4.4.</span> <span class="toc-text">其它工具集</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#web相关"><span class="toc-number">4.5.</span> <span class="toc-text">web相关</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Aop"><span class="toc-number">5.</span> <span class="toc-text">Aop</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#AbstractAutoProxyCreator"><span class="toc-number">5.1.</span> <span class="toc-text">AbstractAutoProxyCreator</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#wrapIfNecessary"><span class="toc-number">5.2.</span> <span class="toc-text">wrapIfNecessary</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#createProxy"><span class="toc-number">5.3.</span> <span class="toc-text">createProxy</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#proxyFactory-getProxy"><span class="toc-number">5.4.</span> <span class="toc-text">proxyFactory.getProxy</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#JdkDynamicAopProxy"><span class="toc-number">5.4.1.</span> <span class="toc-text">JdkDynamicAopProxy</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ObjenesisCglibAopProxy"><span class="toc-number">5.4.2.</span> <span class="toc-text">ObjenesisCglibAopProxy</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#MVC"><span class="toc-number">6.</span> <span class="toc-text">MVC</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#DispatcherServlet-初始化体系"><span class="toc-number">6.1.</span> <span class="toc-text">DispatcherServlet 初始化体系</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ServletRegistrationBean"><span class="toc-number">6.1.1.</span> <span class="toc-text">ServletRegistrationBean</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FilterRegistrationBean"><span class="toc-number">6.1.2.</span> <span class="toc-text">FilterRegistrationBean</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#建立体系"><span class="toc-number">6.2.</span> <span class="toc-text">建立体系</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#RequestMappingHandlerMapping"><span class="toc-number">6.2.1.</span> <span class="toc-text">RequestMappingHandlerMapping</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RequestMappingHandlerAdapter"><span class="toc-number">6.2.2.</span> <span class="toc-text">RequestMappingHandlerAdapter</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#主体流程"><span class="toc-number">6.3.</span> <span class="toc-text">主体流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#获取处理器"><span class="toc-number">6.4.</span> <span class="toc-text">获取处理器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#执行流程"><span class="toc-number">6.5.</span> <span class="toc-text">执行流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HandlerMapping：处理器映射器"><span class="toc-number">6.6.</span> <span class="toc-text">HandlerMapping：处理器映射器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#为什么要引入适配器？"><span class="toc-number">6.7.</span> <span class="toc-text">为什么要引入适配器？</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#SpringBoot"><span class="toc-number">7.</span> <span class="toc-text">SpringBoot</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#自动配置"><span class="toc-number">7.1.</span> <span class="toc-text">自动配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SpringApplication-run-Boot启动函数"><span class="toc-number">7.2.</span> <span class="toc-text">SpringApplication#run Boot启动函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#EmbeddedWebApplicationContext-onRefresh-Spring上下文初始化-Servlet容器创造"><span class="toc-number">7.3.</span> <span class="toc-text">EmbeddedWebApplicationContext#onRefresh Spring上下文初始化+Servlet容器创造</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#createEmbeddedServletContainer-创建内部Servlet容器"><span class="toc-number">7.4.</span> <span class="toc-text">createEmbeddedServletContainer   创建内部Servlet容器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#getEmbeddedServletContainerFactory-获取Servlet容器工厂类"><span class="toc-number">7.4.1.</span> <span class="toc-text">getEmbeddedServletContainerFactory  获取Servlet容器工厂类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#containerFactory-getEmbeddedServletContainer-getSelfInitializer-工厂类获取Servlet容器"><span class="toc-number">7.4.2.</span> <span class="toc-text">containerFactory.getEmbeddedServletContainer(getSelfInitializer());  工厂类获取Servlet容器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#getSelfInitializer"><span class="toc-number">7.4.3.</span> <span class="toc-text">getSelfInitializer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#getEmbeddedServletContainer"><span class="toc-number">7.4.4.</span> <span class="toc-text">getEmbeddedServletContainer</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Tomcat准备"><span class="toc-number">7.4.4.1.</span> <span class="toc-text">Tomcat准备</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#获取Tomcat的Servlet容器TomcatEmbeddedServletContainer"><span class="toc-number">7.4.4.1.0.1.</span> <span class="toc-text">获取Tomcat的Servlet容器TomcatEmbeddedServletContainer</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Jar-in-Jar-Jar-Launcher"><span class="toc-number">7.5.</span> <span class="toc-text">Jar-in-Jar Jar Launcher</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Spring-Boot-Loader简介"><span class="toc-number">7.5.1.</span> <span class="toc-text">Spring-Boot-Loader简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#spring-boot-maven-plugin打包流程"><span class="toc-number">7.5.2.</span> <span class="toc-text">spring-boot-maven-plugin打包流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JarLauncher执行流程分析"><span class="toc-number">7.5.3.</span> <span class="toc-text">JarLauncher执行流程分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LaunchedURLClassLoader"><span class="toc-number">7.5.4.</span> <span class="toc-text">LaunchedURLClassLoader</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#总结"><span class="toc-number">7.5.5.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reactive"><span class="toc-number">7.6.</span> <span class="toc-text">Reactive</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Servlet3-1异步机制"><span class="toc-number">7.6.1.</span> <span class="toc-text">Servlet3.1异步机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#异步支持模式"><span class="toc-number">7.6.2.</span> <span class="toc-text">异步支持模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Rxjava-Deferred-Result"><span class="toc-number">7.6.3.</span> <span class="toc-text">Rxjava+Deferred Result</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#异步拦截"><span class="toc-number">7.6.4.</span> <span class="toc-text">异步拦截</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HTTP-Streaming"><span class="toc-number">7.6.5.</span> <span class="toc-text">HTTP Streaming</span></a></li></ol></li></ol>
        
    </div>
</aside>

</header>

        <div id="content" class="content"><article class="article" itemscope="" itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
           Spring详解
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="/2017/02/13/spring/">
    
    <i class="icon-calendar"></i>
    
    <time datetime="2017-02-13T15:58:10.000Z" itemprop="datePublished">2017-02-13</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag"></i>
    <a class="article-tag-link" href="/tags/spring/">spring</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <p>spring 详解笔记<br><a id="more"></a> </p>
<h1 id="各变量说明"><a href="#各变量说明" class="headerlink" title="各变量说明"></a>各变量说明</h1><table>
<thead>
<tr>
<th>对象名</th>
<th>类  型</th>
<th>作    用</th>
<th>归属类</th>
</tr>
</thead>
<tbody>
<tr>
<td> aliasMap</td>
<td>Map&lt;String, String&gt;</td>
<td>存储Bean名称-&gt;Bean别名映射关系</td>
<td>SimpleAliasRegistry</td>
</tr>
<tr>
<td>singletonObjects</td>
<td>Map&lt;String, Object&gt;</td>
<td>存储单例Bean名称-&gt;单例Bean实现映射关系</td>
<td>DefaultSingletonBeanRegistry </td>
</tr>
<tr>
<td> singletonFactories</td>
<td>Map&lt;String, ObjectFactory&gt;</td>
<td>存储Bean名称-&gt;ObjectFactory实现映射关系</td>
<td>DefaultSingletonBeanRegistry</td>
</tr>
<tr>
<td>earlySingletonObjects</td>
<td>Map&lt;String, Object&gt;</td>
<td>存储Bean名称-&gt;预加载Bean实现映射关系</td>
<td>DefaultSingletonBeanRegistry </td>
</tr>
<tr>
<td>registeredSingletons</td>
<td>Set<string></string></td>
<td>存储注册过的Bean名</td>
<td>DefaultSingletonBeanRegistry </td>
</tr>
<tr>
<td>singletonsCurrentlyInCreation</td>
<td>Set<string></string></td>
<td>存储当前正在创建的Bean名</td>
<td>DefaultSingletonBeanRegistry  </td>
</tr>
<tr>
<td> disposableBeans</td>
<td>Map&lt;String, Object&gt;</td>
<td>存储Bean名称-&gt;Disposable接口实现Bean实现映射关系</td>
<td>DefaultSingletonBeanRegistry   </td>
</tr>
<tr>
<td> factoryBeanObjectCache</td>
<td>Map&lt;String, Object&gt;</td>
<td>存储Bean名称-&gt;FactoryBean接口Bean实现映射关系</td>
<td>FactoryBeanRegistrySupport </td>
</tr>
<tr>
<td>propertyEditorRegistrars</td>
<td>Set<propertyeditorregistrar></propertyeditorregistrar></td>
<td>存储PropertyEditorRegistrar接口实现集合</td>
<td>AbstractBeanFactory </td>
</tr>
<tr>
<td> embeddedValueResolvers</td>
<td>List<stringvalueresolver></stringvalueresolver></td>
<td>存储StringValueResolver（字符串解析器）接口实现列表</td>
<td>AbstractBeanFactory </td>
</tr>
<tr>
<td>beanPostProcessors</td>
<td>List<beanpostprocessor></beanpostprocessor></td>
<td>存储 BeanPostProcessor接口实现列表</td>
<td>AbstractBeanFactory</td>
</tr>
<tr>
<td>mergedBeanDefinitions</td>
<td>Map&lt;String, RootBeanDefinition&gt;</td>
<td>存储Bean名称-&gt;合并过的根Bean定义映射关系</td>
<td>AbstractBeanFactory </td>
</tr>
<tr>
<td> alreadyCreated</td>
<td>Set<string></string></td>
<td>存储至少被创建过一次的Bean名集合</td>
<td>AbstractBeanFactory  </td>
</tr>
<tr>
<td>ignoredDependencyInterfaces</td>
<td>Set<class></class></td>
<td>存储不自动装配的接口Class对象集合  AbstractAutowireCapableBeanFactory </td>
</tr>
<tr>
<td> resolvableDependencies</td>
<td>Map&lt;Class, Object&gt;</td>
<td>存储修正过的依赖映射关系</td>
<td>DefaultListableBeanFactory </td>
</tr>
<tr>
<td>beanDefinitionMap</td>
<td>Map&lt;String, BeanDefinition&gt;</td>
<td>存储Bean名称–&gt;Bean定义映射关系</td>
<td>DefaultListableBeanFactory  </td>
</tr>
<tr>
<td>beanDefinitionNames</td>
<td>List<string></string></td>
<td>存储Bean定义名称列表</td>
<td>DefaultListableBeanFactory</td>
</tr>
</tbody>
</table>
<h1 id="Ioc"><a href="#Ioc" class="headerlink" title="Ioc"></a>Ioc</h1><h2 id="BeanFactory-amp-amp-Application"><a href="#BeanFactory-amp-amp-Application" class="headerlink" title="BeanFactory&amp;&amp;Application"></a>BeanFactory&amp;&amp;Application</h2><ul>
<li><p><code>BeanFactory</code>实现了容器的最基本功能<code>getBean</code>  </p>
</li>
<li><p><code>AutowireCapableBeanFactory</code>实现自动装配能力,为bean注入属性<code>autowireBeanProperties</code>,bean的实例化<code>initializeBean</code>,各类装配<code>autowire</code></p>
</li>
<li><p><code>HierarchicalBeanFactory</code>继承了<code>BeanFactory</code>的基本接口之后</p>
<ul>
<li>增加了<code>getParentBeanFactory()</code>的接口功能,使BeanFactory具备双亲IOC容器的管理功能      </li>
</ul>
</li>
<li><p><code>ConfigurableBeanFactory</code>接口中定义了一些对BeanFactory的配置功能</p>
<ul>
<li><code>setParentBeanFactory()</code>设置双亲IOC容器</li>
<li><code>addBeanPostProcessor()</code>配置Bean后置处理器  </li>
</ul>
</li>
<li><p><code>ListableBeanFactory</code>细化了很多BeanFactory的接口功能</p>
<ul>
<li><code>getBeanDefinitionNames()</code>接口方法      </li>
</ul>
</li>
</ul>
<ul>
<li><p><code>ApplicationContext</code>基于<code>HierarchicalBeanFactory</code>&amp;<code>ListableBeanFactory</code>而实现的并增加了</p>
<ul>
<li><code>MessageSource</code>国际化处理  </li>
<li><code>ResourceLoader</code>资源定位   </li>
<li><code>ApplicationEventPublisher</code>应用事件推送  </li>
</ul>
</li>
</ul>
<h2 id="AbstractApplicationContext"><a href="#AbstractApplicationContext" class="headerlink" title="AbstractApplicationContext"></a>AbstractApplicationContext</h2><p>整个Spring的声明周期类    </p>
<table>
<thead>
<tr>
<th>函数名</th>
<th>功能 </th>
</tr>
</thead>
<tbody>
<tr>
<td>prepareRefresh</td>
<td>容器预先准备,记录容器启动时间和标记  </td>
</tr>
<tr>
<td>obtainFreshBeanFactory</td>
<td>创建Bean工厂,有则销毁无则创建,实现了<code>beanDefinition</code>装载  </td>
</tr>
<tr>
<td>prepareBeanFactory</td>
<td>配置bean工厂标准上下文,如类装载器,PostProcesser等  </td>
</tr>
<tr>
<td>postProcessorBeanFactory</td>
<td>模板方法,提供后期准备</td>
</tr>
<tr>
<td>invokeBeanFactoryPostProcessor</td>
<td>传进来的是beanFactory,可以这个bean去获得各个beanDefinition并修改  </td>
</tr>
<tr>
<td>registerBeanPostProcessors</td>
<td>注册BeanPostProcessor  </td>
</tr>
<tr>
<td>initMessageSource</td>
<td>初始化MessageResource  </td>
</tr>
<tr>
<td>initApplicationEventMulticaster</td>
<td>初始化上下文事件广播  </td>
</tr>
<tr>
<td>onRefresh</td>
<td>最重要的方法,AnnotationConfigEmbeddedWebApplication是用来创建Servlet容器  </td>
</tr>
<tr>
<td>registerListeners</td>
<td>注册监听器,实现ApplicationListener的监听器  </td>
</tr>
<tr>
<td>finishBeanFactoryInitialization</td>
<td>preInstantiateSingletons让单例提前实例化  </td>
</tr>
<tr>
<td>finishRefresh</td>
<td>LifecycleProcessor().onRefresh() 实现LifecycleProcessor的进行refresh并且发出event  </td>
</tr>
</tbody>
</table>
<ul>
<li><code>obtainFreshBeanFactory --&gt; refreshBeanFactory</code>负责<code>BeanDefinition</code>资源的定位、读入和注册过程  </li>
<li><code>prepareBeanFactory</code><ul>
<li>ignoreDependencyInterface:设置了几个忽略自动装配的接口,主要功能是Bean如果是这些接口的实现类,则不会被自动装配,<code>ApplicationContextAwareProcessor</code>  </li>
<li>registerResolvableDependency:设置了几个忽略自动装配的接口,意思是修正依赖,这里是一些自动装配的特殊规则,比如是BeanFactory接口的实现类,则修正为当前BeanFactory  </li>
</ul>
</li>
</ul>
<h3 id="refresh-方法解析"><a href="#refresh-方法解析" class="headerlink" title="refresh()方法解析"></a>refresh()方法解析</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">refresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException, IllegalStateException </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>.startupShutdownMonitor) &#123;</span><br><span class="line">        <span class="comment">// 为刷新准备上下文,获取容器的startupDate时间,同时给容器设置closed=false/active=true标识</span></span><br><span class="line">        prepareRefresh();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获得内部bean工厂 --&gt; obtainFreshBeanFactory --&gt; refreshBeanFactory</span></span><br><span class="line">        <span class="comment">//refreshBeanFactory:委派设计模式，父类定义了抽象的refreshBeanFactory()方法,具体实现调用子类容器的refreshBeanFactory()方法</span></span><br><span class="line">        <span class="comment">//DefaultListableBeanFactory beanFactory = createBeanFactory();   创建IoC容器  </span></span><br><span class="line">        <span class="comment">//并且把当前的beanFactory通过getBeanFactory返回</span></span><br><span class="line">        ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory();</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">        <span class="comment">//给beanFactory注册一些标准组建，如ClassLoader，StandardEnvironment，BeanProcess  </span></span><br><span class="line">        prepareBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//为容器的某些子类指定特殊的postProcessor事件处理器,当前类暂未写代码实现</span></span><br><span class="line">            postProcessBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 调用所有注册的BeanFactoryPostProcessor的Bean  </span></span><br><span class="line">            invokeBeanFactoryPostProcessors(beanFactory);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 注册用于拦截bean创建的bean处理器</span></span><br><span class="line">            registerBeanPostProcessors(beanFactory);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 为上下文初始化信息源,和国际化相关.</span></span><br><span class="line">            initMessageSource();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 初始化上下文中的事件多路广播机制</span></span><br><span class="line">            initApplicationEventMulticaster();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 初始化指定context子类中的特殊bean</span></span><br><span class="line">            onRefresh();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 注册并检查bean监听器</span></span><br><span class="line">            registerListeners();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 初始化剩下的非延迟加载（non-lazy-init）单例beans</span></span><br><span class="line">            finishBeanFactoryInitialization(beanFactory);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 最后一步，发布相关的容器事件</span></span><br><span class="line">            finishRefresh();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">            <span class="keyword">if</span> (logger.isWarnEnabled()) &#123;</span><br><span class="line">                logger.warn(<span class="string">"Exception encountered during context initialization - "</span> +</span><br><span class="line">                        <span class="string">"cancelling refresh attempt: "</span> + ex);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 销毁已经创建的单例bean</span></span><br><span class="line">            destroyBeans();</span><br><span class="line">            <span class="comment">// 取消refresh操作，充值'activity'标志位</span></span><br><span class="line">            cancelRefresh(ex);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">throw</span> ex;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">finally</span> &#123;</span><br><span class="line">            resetCommonCaches();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="AbstractBeanFactory"><a href="#AbstractBeanFactory" class="headerlink" title="AbstractBeanFactory"></a>AbstractBeanFactory</h2><blockquote>
<p>有关循环依赖A中有依赖B,B中有依赖A的Spring解决方案    </p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">三级缓存分别指： </span><br><span class="line">singletonFactories ： 单例对象工厂的cache </span><br><span class="line">earlySingletonObjects ：提前暴光的单例对象的Cache </span><br><span class="line">singletonObjects：单例对象的cache</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">protected Object getSingleton(String beanName, boolean allowEarlyReference) &#123;</span><br><span class="line">    Object singletonObject = this.singletonObjects.get(beanName);</span><br><span class="line">    if (singletonObject == null &amp;&amp; isSingletonCurrentlyInCreation(beanName)) &#123;</span><br><span class="line">        synchronized (this.singletonObjects) &#123;</span><br><span class="line">            singletonObject = this.earlySingletonObjects.get(beanName);</span><br><span class="line">            if (singletonObject == null &amp;&amp; allowEarlyReference) &#123;</span><br><span class="line">                ObjectFactory&lt;?&gt; singletonFactory = this.singletonFactories.get(beanName);</span><br><span class="line">                if (singletonFactory != null) &#123;</span><br><span class="line">                    singletonObject = singletonFactory.getObject();</span><br><span class="line">                    this.earlySingletonObjects.put(beanName, singletonObject);</span><br><span class="line">                    this.singletonFactories.remove(beanName);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return (singletonObject != NULL_OBJECT ? singletonObject : null);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">protected void addSingletonFactory(String beanName, ObjectFactory&lt;?&gt; singletonFactory) &#123;</span><br><span class="line">    Assert.notNull(singletonFactory, &quot;Singleton factory must not be null&quot;);</span><br><span class="line">    synchronized (this.singletonObjects) &#123;</span><br><span class="line">        if (!this.singletonObjects.containsKey(beanName)) &#123;</span><br><span class="line">            this.singletonFactories.put(beanName, singletonFactory);</span><br><span class="line">            this.earlySingletonObjects.remove(beanName);</span><br><span class="line">            this.registeredSingletons.add(beanName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>A的某个field或者setter依赖了B的实例对象，同时B的某个field或者setter依赖了A的实例对象”这种循环依赖的情况。A首先完成了初始化的第一步，并且将自己提前曝光到singletonFactories中，此时进行初始化的第二步，发现自己依赖对象B，此时就尝试去get(B)，发现B还没有被create，所以走create流程，B在初始化第一步的时候发现自己依赖了对象A，于是尝试get(A)，尝试一级缓存singletonObjects(肯定没有，因为A还没初始化完全)，尝试二级缓存earlySingletonObjects（也没有），尝试三级缓存singletonFactories，由于A通过ObjectFactory将自己提前曝光了，所以B能够通过ObjectFactory.getObject拿到A对象(虽然A还没有初始化完全，但是总比没有好呀)，B拿到A对象后顺利完成了初始化阶段1、2、3，完全初始化之后将自己放入到一级缓存singletonObjects中。此时返回A中，A此时能拿到B的对象顺利完成自己的初始化阶段2、3，最终A也完成了初始化，进去了一级缓存singletonObjects中，而且更加幸运的是，由于B拿到了A的对象引用，所以B现在hold住的A对象完成了初始化。</p>
<h3 id="doGetBean"><a href="#doGetBean" class="headerlink" title="doGetBean"></a>doGetBean</h3><ul>
<li><p>1:转移对应beanName</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">这里传入的可能是aliasName(别名),也可能是FactoryBean,所以要进步一解析</span><br></pre></td></tr></table></figure>
</li>
<li><p>2:尝试从缓存中加载单例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">单例在spring的同一个容器内只会被创建一次,后续在获取bean,直接从缓存拿</span><br><span class="line">如果加载不成功,则再次从singletonFactory中加载,因为在创建单例bean的时候会存在依赖注入的情况,为了避免循环依赖</span><br><span class="line">spring中创建bean的原则是不等bean创建完成就创建bean的ObjectFactory提早曝光加入缓存中</span><br><span class="line">一旦下一个bean创建的时候需要依赖上一个bean则直接使用objectFactory</span><br></pre></td></tr></table></figure>
</li>
<li><p>3:bean的实例化</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">如果从缓存中得到bean的原始状态,则需要对bean进行实例化</span><br><span class="line">缓存中有原始的bean状态,并不是我们最终想要的bean</span><br><span class="line">比如我们工程bean进行处理,那么这里得到的其实是工厂bean的初始状态</span><br><span class="line">但是我们真正需要的是工厂bean中定义的factory-method方法中返回的bean</span><br><span class="line">而getObjectForBeanInstance就是做这个工作</span><br></pre></td></tr></table></figure>
</li>
<li><p>4:原型模式的依赖检查</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">只有在单例模式才会尝试解决循环依赖,如果存在A中有B的属性,B中有A的属性</span><br><span class="line">name当依赖注入的时候就会产生A还未创建完的时候因为B的创建再次返回创建A,造成循环依赖</span><br></pre></td></tr></table></figure>
</li>
<li><p>5:检查parentBeanFactory</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if (parentBeanFactory != null &amp;&amp; !containsBeanDefinition(beanName))</span><br><span class="line">这里面!containsBeanDefinition(beanName)检查当前的xml配置文件不包含beanName</span><br><span class="line">所对应的配置,就只能parentBeanFactory去尝试下了，然后再去递归的调用getBean方法</span><br></pre></td></tr></table></figure>
</li>
<li><p>6:将存储xml配置文件的GernericBeanDefinition转换为RootBeanDefinition</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">因为xml配置文件读取到的bean信息是存储在GernericBeanDefinition中的</span><br><span class="line">但是所有的bean后续处理都是针对RootBeanDefinition的,所以要转换,同时如果父类的bean不为空则会一并合并父类属性</span><br></pre></td></tr></table></figure>
</li>
<li><p>7:寻找必先依赖</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">因为bean的配置必须依赖于其他bean先实例化,那么这个时候就有必要先加载依赖的bean</span><br><span class="line">所以在加载顺序中, 会初始化某一个bean的时候先初始化这个bean所应对的依赖</span><br><span class="line"></span><br><span class="line">&lt;bean id=&quot;goods&quot; class=&quot;org.ifly.edu.spring.bean.dependOn.Goods&quot; depends-on=&quot;user&quot;/&gt; </span><br><span class="line">goods实例化前先实例化user</span><br></pre></td></tr></table></figure>
</li>
<li><p>8:针对不同的scope进行bean的实例化</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">默认是singleton,还有prototype,request之类的,会根据不同配置进行不同初始化策略</span><br></pre></td></tr></table></figure>
</li>
<li><p>9:类型转换</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">程序到这里返回bean基本结束了,通常对该方法的的调用参数requiredType是为空的</span><br><span class="line">但是如果返回的bean其实是个string,但是requiredType却传入Integer类型</span><br><span class="line">那么这个时候就会将bean转换成requiredType所指定的类型了</span><br></pre></td></tr></table></figure>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">protected</span> &lt;T&gt; <span class="function">T <span class="title">doGetBean</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> String name, <span class="keyword">final</span> Class&lt;T&gt; requiredType, <span class="keyword">final</span> Object[] args, <span class="keyword">boolean</span> typeCheckOnly)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//提取对应的beanName</span></span><br><span class="line">    <span class="keyword">final</span> String beanName = transformedBeanName(name);</span><br><span class="line">    Object bean;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 检查缓存中或者实例工厂中是否有对应的实例</span></span><br><span class="line"><span class="comment"> 为什么首先会使用这段代码呢</span></span><br><span class="line"><span class="comment"> 因为在创建单例bean的时候会存在依赖注入的情况,而在创建依赖的时候为了避免循环依赖</span></span><br><span class="line"><span class="comment"> Spring创建bean的原则不是等bean创建完成就会创建bean的objectFactory提早曝光</span></span><br><span class="line"><span class="comment"> 也就是将objectFactory加入到缓存中,一旦下个bean创建时候需要依赖上个bean则直接使用objectFactory</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">    Object sharedInstance = getSingleton(beanName);</span><br><span class="line">    <span class="keyword">if</span> (sharedInstance != <span class="keyword">null</span> &amp;&amp; args == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (isSingletonCurrentlyInCreation(beanName)) &#123;</span><br><span class="line">                logger.debug(<span class="string">"Returning eagerly cached instance of singleton bean '"</span> + beanName +</span><br><span class="line">                        <span class="string">"' that is not fully initialized yet - a consequence of a circular reference"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                logger.debug(<span class="string">"Returning cached instance of singleton bean '"</span> + beanName + <span class="string">"'"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//返回对应实例,有时候存在诸如BeanFactory的情况</span></span><br><span class="line"><span class="comment">//不是直接返回实例本身而是返回指定方法返回的实例</span></span><br><span class="line">        bean = getObjectForBeanInstance(sharedInstance, name, beanName, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">//只有在单例情况下才会尝试解决循环依赖,原型模式情况下,如果存在</span></span><br><span class="line"><span class="comment">//A中有B的属性,B中有A的属性,那么当依赖注入的时候,就会产生当A还没创建完的时候因为</span></span><br><span class="line"><span class="comment">//对于B的创建再次返回创建A,造成循环依赖,也就是下面的情况</span></span><br><span class="line">        <span class="keyword">if</span> (isPrototypeCurrentlyInCreation(beanName)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BeanCurrentlyInCreationException(beanName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">        BeanFactory parentBeanFactory = getParentBeanFactory();</span><br><span class="line"></span><br><span class="line"><span class="comment">//如果beanDefinitionMap中也就是在所有已经加载的类不包括beanName则尝试从parentBeanFactory</span></span><br><span class="line">        <span class="keyword">if</span> (parentBeanFactory != <span class="keyword">null</span> &amp;&amp; !containsBeanDefinition(beanName)) &#123;</span><br><span class="line">            String nameToLookup = originalBeanName(name);</span><br><span class="line"></span><br><span class="line"><span class="comment">//递归到BeanFactory中寻找</span></span><br><span class="line">            <span class="keyword">if</span> (args != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> (T) parentBeanFactory.getBean(nameToLookup, args);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> parentBeanFactory.getBean(nameToLookup, requiredType);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//如果不是仅仅做类型检查则创建Bean,这里进行记录</span></span><br><span class="line">        <span class="keyword">if</span> (!typeCheckOnly) &#123;</span><br><span class="line">            markBeanAsCreated(beanName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//将存储XML配置文件的GenericBeanDefinition转换为RootBeanDefinition</span></span><br><span class="line"><span class="comment">//如果指定BeanName是子Bean的话同时会合并到父类的相关属性</span></span><br><span class="line">            <span class="keyword">final</span> RootBeanDefinition mbd = getMergedLocalBeanDefinition(beanName);</span><br><span class="line">            checkMergedBeanDefinition(mbd, beanName, args);</span><br><span class="line"></span><br><span class="line">            String[] dependsOn = mbd.getDependsOn();</span><br><span class="line"><span class="comment">//如果存在依赖则需要递归实例化依赖的bean</span></span><br><span class="line">            <span class="keyword">if</span> (dependsOn != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (String dependsOnBean : dependsOn) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (isDependent(beanName, dependsOnBean)) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(mbd.getResourceDescription(), beanName,</span><br><span class="line">                                <span class="string">"Circular depends-on relationship between '"</span> + beanName + <span class="string">"' and '"</span> + dependsOnBean + <span class="string">"'"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    registerDependentBean(dependsOnBean, beanName);</span><br><span class="line">                    getBean(dependsOnBean);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//实例化依赖的bean后便可以实例化mbd了            </span></span><br><span class="line">            <span class="keyword">if</span> (mbd.isSingleton()) &#123;</span><br><span class="line">                sharedInstance = getSingleton(beanName, <span class="keyword">new</span> ObjectFactory&lt;Object&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">()</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="keyword">return</span> createBean(beanName, mbd, args);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">                            </span><br><span class="line">                            destroySingleton(beanName);</span><br><span class="line">                            <span class="keyword">throw</span> ex;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">                bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (mbd.isPrototype()) &#123;</span><br><span class="line"><span class="comment">//prototype模式的创建</span></span><br><span class="line">                Object prototypeInstance = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    beforePrototypeCreation(beanName);</span><br><span class="line">                    prototypeInstance = createBean(beanName, mbd, args);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">finally</span> &#123;</span><br><span class="line">                    afterPrototypeCreation(beanName);</span><br><span class="line">                &#125;</span><br><span class="line">                bean = getObjectForBeanInstance(prototypeInstance, name, beanName, mbd);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">//指定的scope上实例化bean</span></span><br><span class="line">                String scopeName = mbd.getScope();</span><br><span class="line">                <span class="keyword">final</span> Scope scope = <span class="keyword">this</span>.scopes.get(scopeName);</span><br><span class="line">                <span class="keyword">if</span> (scope == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"No Scope registered for scope name '"</span> + scopeName + <span class="string">"'"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Object scopedInstance = scope.get(beanName, <span class="keyword">new</span> ObjectFactory&lt;Object&gt;() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">()</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">                            beforePrototypeCreation(beanName);</span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                <span class="keyword">return</span> createBean(beanName, mbd, args);</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">finally</span> &#123;</span><br><span class="line">                                afterPrototypeCreation(beanName);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">                    bean = getObjectForBeanInstance(scopedInstance, name, beanName, mbd);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span> (IllegalStateException ex) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(beanName,</span><br><span class="line">                            <span class="string">"Scope '"</span> + scopeName + <span class="string">"' is not active for the current thread; consider "</span> +</span><br><span class="line">                            <span class="string">"defining a scoped proxy for this bean if you intend to refer to it from a singleton"</span>,</span><br><span class="line">                            ex);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">            cleanupAfterBeanCreationFailure(beanName);</span><br><span class="line">            <span class="keyword">throw</span> ex;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//检查需要的类型是否符合bean的实际类型</span></span><br><span class="line">    <span class="keyword">if</span> (requiredType != <span class="keyword">null</span> &amp;&amp; bean != <span class="keyword">null</span> &amp;&amp; !requiredType.isAssignableFrom(bean.getClass())) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> getTypeConverter().convertIfNecessary(bean, requiredType);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (TypeMismatchException ex) &#123;</span><br><span class="line">            <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(<span class="string">"Failed to convert bean '"</span> + name + <span class="string">"' to required type ["</span> +</span><br><span class="line">                        ClassUtils.getQualifiedName(requiredType) + <span class="string">"]"</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BeanNotOfRequiredTypeException(name, requiredType, bean.getClass());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (T) bean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="createBean"><a href="#createBean" class="headerlink" title="createBean"></a>createBean</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">先实例化createBeanInstance  </span><br><span class="line">后检测是否需要earlySingletonExposure,需要则加入addSingletonFactory</span><br><span class="line">再进行设置对象属性populateBean(后期对BeanWrapper进行applyPropertyValues)</span><br><span class="line">接下来进入initializeBean</span><br><span class="line"></span><br><span class="line">initializeBean主要进行四步骤</span><br><span class="line">- invokeAwareMethods(BeanNameAware,BeanClassLoaderAware,BeanFactoryAware进行各种资源set)   </span><br><span class="line">- BeanPostProcessor#postProcessBeforeInitialization</span><br><span class="line">- InitializingBean#afterPropertiesSet(如果当前的bean实现此接口就执行)</span><br><span class="line">- invokeInitMethods#invokeCustomInitMethod(如果有自定义init-method,则进行init-method实例化)  </span><br><span class="line">- BeanPostProcessor#postProcessAfterInitialization</span><br><span class="line"></span><br><span class="line">至此结束</span><br></pre></td></tr></table></figure>
<ul>
<li><code>createBeanInstance</code>: 创建<code>bean</code>的时候将会选取实例化策略<code>SimpleInstantiationStrategy</code>,<code>CglibSubclassingInstantiationStrategy</code>  <ul>
<li>通过<code>BeanUtils</code>,利用JVM的反射功能   </li>
<li>利用<code>CGLIB</code>去生成代理    <ul>
<li>如果有使用到<code>lookup-method</code>或<code>replace-method</code>,进入到<code>instantiateBean方法</code>可以看到如果有方法覆盖(<code>MethodOverride</code>)将调用cglib的<code>instantiateWithMethodInjection</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="BeanDefinitionReader"><a href="#BeanDefinitionReader" class="headerlink" title="BeanDefinitionReader"></a>BeanDefinitionReader</h2><h3 id="XmlBeanDefinitionReader"><a href="#XmlBeanDefinitionReader" class="headerlink" title="XmlBeanDefinitionReader"></a>XmlBeanDefinitionReader</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">AbstractWebApplicationContext#invokeBeanFactoryPostProcessors  ---&gt;  PostProcessorRegistrationDelegate#invokeBeanFactoryPostProcessors</span><br><span class="line">//invokeBeanDefinitionRegistryPostProcessors(priorityOrderedPostProcessors, registry);</span><br><span class="line">//调用BeanDefinitionRegistryPostProcessor#postProcessBeanDefinitionRegistry</span><br><span class="line">ConfigurationClassPostProcessor#processConfigBeanDefinitions</span><br><span class="line">//this.reader.loadBeanDefinitions(configClasses);</span><br><span class="line"></span><br><span class="line">由此引入XmlBeanDefinitionReader</span><br></pre></td></tr></table></figure>
<h3 id="AnnotatedBeanDefinitionReader"><a href="#AnnotatedBeanDefinitionReader" class="headerlink" title="AnnotatedBeanDefinitionReader"></a>AnnotatedBeanDefinitionReader</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SpringApplication#prepareContext ---&gt; SpringApplication#load</span><br></pre></td></tr></table></figure>
<h2 id="生命周期"><a href="#生命周期" class="headerlink" title="生命周期"></a>生命周期</h2><p><img src="/2017/02/13/spring/image-01.png" alt="img"></p>
<h1 id="扩展"><a href="#扩展" class="headerlink" title="扩展"></a>扩展</h1><h2 id="InitialingBean"><a href="#InitialingBean" class="headerlink" title="InitialingBean"></a>InitialingBean</h2><blockquote>
<p>InitialingBean是一个接口，提供了一个唯一的方法afterPropertiesSet()。  </p>
<blockquote>
<p>在Bean属性都设置完毕后调用afterPropertiesSet()方法做一些初始化的工作</p>
</blockquote>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">afterPropertiesSet方法在set属性之后执行</span><br></pre></td></tr></table></figure>
<h2 id="DisposableBean"><a href="#DisposableBean" class="headerlink" title="DisposableBean"></a>DisposableBean</h2><blockquote>
<p>DisposableBean也是一个接口，提供了一个唯一的方法destory()。  </p>
<blockquote>
<p>在Bean生命周期结束前调用destory()方法做一些收尾工作  </p>
</blockquote>
</blockquote>
<p>InitializingBean接口、Disposable接口底层进行直接方法调用<br>init-method、destory-method底层使用反射<br>前者和Spring耦合程度更高但效率高<br>后者解除了和Spring之间的耦合但是效率低</p>
<h2 id="BeanNameAware"><a href="#BeanNameAware" class="headerlink" title="BeanNameAware"></a>BeanNameAware</h2><blockquote>
<p>实现BeanNameAware接口的Bean，在Bean加载的过程中可以获取到该Bean的id</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBeanName</span><span class="params">(String beanName)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"Enter AwareBean.setBeanName(), beanName = "</span> + beanName + <span class="string">"\n"</span>);</span><br><span class="line">    <span class="keyword">this</span>.beanName = beanName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ApplicationContextAware"><a href="#ApplicationContextAware" class="headerlink" title="ApplicationContextAware"></a>ApplicationContextAware</h2><blockquote>
<p>Bean加载的过程中可以获取到Spring的ApplicationContext</p>
<blockquote>
<p>从ApplicationContext中可以获取包括任意的Bean在内的大量Spring容器内容和信息</p>
</blockquote>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> <span class="keyword">throws</span> BeansException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"Enter AwareBean.setApplicationContext(), applicationContext = "</span> + applicationContext + <span class="string">"\n"</span>);</span><br><span class="line">    <span class="keyword">this</span>.applicationContext = applicationContext;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="BeanFactoryAware"><a href="#BeanFactoryAware" class="headerlink" title="BeanFactoryAware"></a>BeanFactoryAware</h2><blockquote>
<p>Bean加载的过程中可以获取到加载该Bean的BeanFactory</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBeanFactory</span><span class="params">(BeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"Enter AwareBean.setBeanFactory(), beanfactory = "</span> + beanFactory + <span class="string">"\n"</span>);</span><br><span class="line">    <span class="keyword">this</span>.beanFactory = beanFactory;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="FactoryBean"><a href="#FactoryBean" class="headerlink" title="FactoryBean"></a>FactoryBean</h2><blockquote>
<p>FactoryBean,开发者可以个性化地定制自己想要实例化出来的Bean,方法就是实现FactoryBean接口。</p>
</blockquote>
<ol>
<li>getObject()方法是最重要的,控制Bean的实例化过程</li>
<li>getObjectType()方法获取接口返回的实例的class</li>
<li>isSingleton()方法获取该Bean是否为一个单例的Bean  </li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnimalFactoryBean</span> <span class="keyword">implements</span> <span class="title">FactoryBean</span>&lt;<span class="title">Animal</span>&gt;</span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String    animal;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> Animal <span class="title">getObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"Monkey"</span>.equals(animal))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Monkey();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"Tiger"</span>.equals(animal))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Tiger();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; getObjectType()&#123;</span><br><span class="line">        <span class="keyword">return</span> Animal.class;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isSingleton</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAnimal</span><span class="params">(String animal)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.animal = animal;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="BeanPostProcess"><a href="#BeanPostProcess" class="headerlink" title="BeanPostProcess"></a>BeanPostProcess</h2><ul>
<li><p>postProcessBeforeInitialization：在初始化Bean之前</p>
</li>
<li><p>postProcessAfterInitialization：在初始化Bean之后  </p>
</li>
</ul>
<p><code>不要返回null,否则getBean的时候拿不到对象</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PostProcessorBean</span> <span class="keyword">implements</span> <span class="title">BeanPostProcessor</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Enter ProcessorBean.postProcessAfterInitialization()\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Enter ProcessorBean.postProcessBeforeInitialization()"</span>);</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="BeanFactoryPostProcessor"><a href="#BeanFactoryPostProcessor" class="headerlink" title="BeanFactoryPostProcessor"></a>BeanFactoryPostProcessor</h2><p>PostProcessor之后的BeanFactoryPostProcessor  </p>
<ol>
<li><p>BeanFactoryPostProcessor的执行优先级高于BeanPostProcessor</p>
</li>
<li><p>BeanFactoryPostProcessor的postProcessBeanFactory()方法只会执行一次</p>
</li>
</ol>
<h2 id="InstantiationAwareBeanPostProcessor"><a href="#InstantiationAwareBeanPostProcessor" class="headerlink" title="InstantiationAwareBeanPostProcessor"></a>InstantiationAwareBeanPostProcessor</h2><ul>
<li>实例化:实例化的过程是一个创建Bean的过程,即调用Bean的构造函数,单例的Bean放入单例池中</li>
<li>初始化:初始化的过程是一个赋值的过程,即调用Bean的setter,设置Bean的属性</li>
</ul>
<h2 id="BeanDefinitionRegistryPostProcessor"><a href="#BeanDefinitionRegistryPostProcessor" class="headerlink" title="BeanDefinitionRegistryPostProcessor"></a>BeanDefinitionRegistryPostProcessor</h2><p>这个接口继承了<code>BeanFactoryPostProcessor</code>. 从名字上来看, 这个接口是<code>BeanDefinitionRegistry</code>的后处理器    </p>
<p>我们先介绍下BeanDefinitionRegistry.<br>BeanDefinitionRegistry是用来注册BeanDefinition的. BeanDefinition就是Bean的配置元数据或Bean的描述信息, 比如Bean的属性值, 构造方法的参数值等. 上面的BeanFactory的BeanDefinition也是由它注册的.  </p>
<p>BeanDefinitionRegistryPostProcessor是BeanFactoryPostProcessor的扩展, 允许在BeanFactoryPostProcessor被调用之前对BeanDefinition做一些操作, 尤其是它可以注册BeanFactoryPostProcessor的BeanDefinition. 它提供了一个方法postProcessBeanDefinitionRegistry(), 这个方法被调用的时候, 所有的BeanDefinition已经被加载了, 但是所有的Bean还没被创建.  </p>
<p>注意:  </p>
<p>所有的Bean生成都有个顺序: 定义 –&gt; 创建 –&gt; 初始化.<br>BeanDefinitionRegistryPostProcessor的postProcessBeanDefinitionRegistry方法在Bean被定义但还没被创建的时候执行.<br>BeanFactoryPostProcessor的postProcessBeanFactory方法在Bean被创建但还没被初始化的时候执行    </p>
<h3 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h3><p>Mybatis的<code>MapperScannerConfigurer</code>  </p>
<h2 id="ImportBeanDefinitionRegistrar"><a href="#ImportBeanDefinitionRegistrar" class="headerlink" title="ImportBeanDefinitionRegistrar"></a>ImportBeanDefinitionRegistrar</h2><blockquote>
<p>动态注册bean<br>Spring官方在动态注册bean时，大部分套路其实是使用ImportBeanDefinitionRegistrar接口。  </p>
</blockquote>
<p>所有实现了该接口的类的都会被ConfigurationClassPostProcessor处理,ConfigurationClassPostProcessor实现了BeanFactoryPostProcessor接口<br>所以ImportBeanDefinitionRegistrar中动态注册的bean是优先与依赖其的bean初始化的,也能被aop、validator等机制处理。    </p>
<h3 id="案例-1"><a href="#案例-1" class="headerlink" title="案例"></a>案例</h3><p>Apollo阿波罗配置框架<code>ApolloConfigRegistrar</code><br>Mybatis的<code>@MapperScan</code>中Import了<code>ImportBeanDefinitionRegistrar</code></p>
<p><br><br><br><br><br></p>
<h1 id="工具类"><a href="#工具类" class="headerlink" title="工具类"></a>工具类</h1><h2 id="内置的resouce类型"><a href="#内置的resouce类型" class="headerlink" title="内置的resouce类型"></a>内置的resouce类型</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">UrlResource</span><br><span class="line">ClassPathResource</span><br><span class="line">FileSystemResource</span><br><span class="line">ServletContextResource</span><br><span class="line">InputStreamResource</span><br><span class="line">ByteArrayResource</span><br><span class="line">EncodedResource     <span class="comment">//也就是Resource加上encoding, 可以认为是有编码的资源 VfsResource(在jboss里经常用到, 相应还有 工具类 VfsUtils)</span></span><br><span class="line">org.springframework.util.xml.ResourceUtils  <span class="comment">//用于处理表达资源字符串前缀描述资源的工具有 getURL, getFile, isFileURL, isJarURL, extractJarFileURL</span></span><br></pre></td></tr></table></figure>
<h2 id="常用工具"><a href="#常用工具" class="headerlink" title="常用工具"></a>常用工具</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.core.annotation.AnnotationUtils   处理注解</span><br><span class="line">org.springframework.core.io.support.PathMatchingResourcePatternResolver  用 于处理 ant 匹配风格(com<span class="comment">/*.jsp, com/**/</span>*.jsp),找出所有的资源, 结合上面的resource的概念一起使用,对于遍历文件很有用. 具体请详细查看javadoc</span><br><span class="line">org.springframework.core.io.support.PropertiesLoaderUtils 加载Properties资源工具类,和Resource结合  </span><br><span class="line">org.springframework.core.BridgeMethodResolver  桥接方法分析器.  关于桥接方法请参考: http:<span class="comment">//java.sun.com/docs/books/jls/third_edition/html/expressions.html#15.12.4.5  </span></span><br><span class="line">org.springframework.core.GenericTypeResolver  范型分析器, 在用于对范型方法, 参数分析.</span><br><span class="line">org.springframework.core.NestedExceptionUtils</span><br></pre></td></tr></table></figure>
<h2 id="xml工具"><a href="#xml工具" class="headerlink" title="xml工具"></a>xml工具</h2><p>org.springframework.util.xml.AbstractStaxContentHandler<br>org.springframework.util.xml.AbstractStaxXMLReader<br>org.springframework.util.xml.AbstractXMLReader<br>org.springframework.util.xml.AbstractXMLStreamReader<br>org.springframework.util.xml.DomUtils<br>org.springframework.util.xml.SimpleNamespaceContext<br>org.springframework.util.xml.SimpleSaxErrorHandler<br>org.springframework.util.xml.SimpleTransformErrorListener<br>org.springframework.util.xml.StaxUtils<br>org.springframework.util.xml.TransformerUtils</p>
<h2 id="其它工具集"><a href="#其它工具集" class="headerlink" title="其它工具集"></a>其它工具集</h2><p>org.springframework.util.xml.AntPathMatcher ant风格的处理<br>org.springframework.util.xml.AntPathStringMatcher<br>org.springframework.util.xml.Assert     断言,在我们的参数判断时应该经常用<br>org.springframework.util.xml.CachingMapDecorator<br>org.springframework.util.xml.ClassUtils     用于Class的处理<br>org.springframework.util.xml.CollectionUtils        用于处理集合的工具<br>org.springframework.util.xml.CommonsLogWriter<br>org.springframework.util.xml.CompositeIterator<br>org.springframework.util.xml.ConcurrencyThrottleSupport<br>org.springframework.util.xml.CustomizableThreadCreator<br>org.springframework.util.xml.DefaultPropertiesPersister<br>org.springframework.util.xml.DigestUtils        摘要处理, 这里有用于md5处理信息的<br>org.springframework.util.xml.FileCopyUtils      文件的拷贝处理, 结合Resource的概念一起来处理, 真的是很方便<br>org.springframework.util.xml.FileSystemUtils<br>org.springframework.util.xml.LinkedCaseInsensitiveMap   key值不区分大小写的LinkedMap<br>org.springframework.util.xml.LinkedMultiValueMap        一个key可以存放多个值的LinkedMap<br>org.springframework.util.xml.Log4jConfigurer            一个log4j的启动加载指定配制文件的工具类<br>org.springframework.util.xml.NumberUtils                处理数字的工具类, 有parseNumber 可以把字符串处理成我们指定的数字格式, 还支持format格式, convertNumberToTargetClass 可以实现Number类型的转化.<br>org.springframework.util.xml.ObjectUtils        有很多处理null object的方法. 如nullSafeHashCode, nullSafeEquals, isArray, containsElement, addObjectToArray, 等有用的方法<br>org.springframework.util.xml.PatternMatchUtils  spring里用于处理简单的匹配.<br>org.springframework.util.xml.PropertyPlaceholderHelper  用于处理占位符的替换<br>org.springframework.util.xml.ReflectionUtils    反映常用工具方法. 有 findField, setField, getField, findMethod, invokeMethod等有用的方法<br>org.springframework.util.xml.SerializationUtils 用于java的序列化与反序列化. serialize与deserialize方法<br>org.springframework.util.xml.StopWatch  一个很好的用于记录执行时间的工具类, 且可以用于任务分阶段的测试时间. 最后支持一个很好看的打印格式. 这个类应该经常用<br>org.springframework.util.xml.StringUtils<br>org.springframework.util.xml.SystemPropertyUtils<br>org.springframework.util.xml.TypeUtils  用于类型相容的判断. isAssignable<br>org.springframework.util.xml.WeakReferenceMonitor       弱引用的监控 </p>
<h2 id="web相关"><a href="#web相关" class="headerlink" title="web相关"></a>web相关</h2><p>org.springframework.web.util.CookieGenerator<br>org.springframework.web.util.HtmlCharacterEntityDecoder<br>org.springframework.web.util.HtmlCharacterEntityReferences<br>org.springframework.web.util.HtmlUtils<br>org.springframework.web.util.HttpUrlTemplate        //这个类用于用字符串模板构建url, 它会自动处理url里的汉字及其它相关的编码. 在读取别人提供的url资源时, 应该经常用<br>org.springframework.web.util.JavaScriptUtils<br>org.springframework.web.util.Log4jConfigListener //用listener的方式来配制log4j在web环境下的初始化<br>org.springframework.web.util.UriTemplate<br>org.springframework.web.util.UriUtils       处理uri里特殊字符的编码<br>org.springframework.web.util.WebUtils</p>
<h1 id="Aop"><a href="#Aop" class="headerlink" title="Aop"></a>Aop</h1><p>一个正常的提前实例化单例实例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sequenceDiagram</span><br><span class="line">AbstractApplicationContext-&gt;&gt;AbstractApplicationContext:refresh</span><br><span class="line">AbstractApplicationContext-&gt;&gt;AbstractApplicationContext:finishBeanFactoryInitialization</span><br><span class="line">AbstractApplicationContext-&gt;&gt;DefaultListableBeanFactory:preInstantiateSingletons</span><br><span class="line">DefaultListableBeanFactory-&gt;&gt;DefaultListableBeanFactory:getBean.......</span><br></pre></td></tr></table></figure>
<p><code>AbstractAutoProxyCreator</code>因继承<code>SmartInstantiationAwareBeanPostProcessor</code>,重写了<code>postProcessAfterInitialization</code>,让每个bean实例化后进入这里判断  </p>
<h2 id="AbstractAutoProxyCreator"><a href="#AbstractAutoProxyCreator" class="headerlink" title="AbstractAutoProxyCreator"></a>AbstractAutoProxyCreator</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (bean != <span class="keyword">null</span>) &#123;</span><br><span class="line">        Object cacheKey = getCacheKey(bean.getClass(), beanName);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.earlyProxyReferences.contains(cacheKey)) &#123;</span><br><span class="line">            <span class="keyword">return</span> wrapIfNecessary(bean, beanName, cacheKey);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> bean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="wrapIfNecessary"><a href="#wrapIfNecessary" class="headerlink" title="wrapIfNecessary"></a>wrapIfNecessary</h2><p>判断是否要初始化<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">wrapIfNecessary</span><span class="params">(Object bean, String beanName, Object cacheKey)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (beanName != <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.targetSourcedBeans.contains(beanName)) &#123;</span><br><span class="line"><span class="comment">//判断bean是否在postProcessBeforeInstantiation()中成功创建的代理对象都会将beanName加入到targetSourceBeans中。  </span></span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (Boolean.FALSE.equals(<span class="keyword">this</span>.advisedBeans.get(cacheKey))) &#123;</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (isInfrastructureClass(bean.getClass()) || shouldSkip(bean.getClass(), beanName)) &#123;</span><br><span class="line"><span class="comment">//对于实现了Advice，Advisor，AopInfrastructureBean接口的bean</span></span><br><span class="line"><span class="comment">//都认为是spring aop的基础框架类，不能对他们创建代理对象，同时子类也可以覆盖shouldSkip方法来指定不对哪些bean进行代理。    </span></span><br><span class="line">        <span class="keyword">this</span>.advisedBeans.put(cacheKey, Boolean.FALSE);</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    Object[] specificInterceptors = getAdvicesAndAdvisorsForBean(bean.getClass(), beanName, <span class="keyword">null</span>);</span><br><span class="line"><span class="comment">//判断当前bean是否需要进行代理，若需要则返回满足条件的Advice或者Advisor集合。</span></span><br><span class="line"><span class="comment">//根据getAdvicesAndAdvisorsForBean()方法的具体实现的不同，AbstractAutoProxyCreator又分成了两类自动代理机制。  </span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (specificInterceptors != DO_NOT_PROXY) &#123;</span><br><span class="line">        <span class="keyword">this</span>.advisedBeans.put(cacheKey, Boolean.TRUE);</span><br><span class="line"></span><br><span class="line"><span class="comment">//若需要代理，则调用createProxy方法创建代理对象，并将创建的代理的key缓存起来，避免重复创建           </span></span><br><span class="line">        Object proxy = createProxy(</span><br><span class="line">                bean.getClass(), beanName, specificInterceptors, <span class="keyword">new</span> SingletonTargetSource(bean));</span><br><span class="line">        <span class="keyword">this</span>.proxyTypes.put(cacheKey, proxy.getClass());</span><br><span class="line">        <span class="keyword">return</span> proxy;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.advisedBeans.put(cacheKey, Boolean.FALSE);</span><br><span class="line">    <span class="keyword">return</span> bean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="createProxy"><a href="#createProxy" class="headerlink" title="createProxy"></a>createProxy</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">createProxy</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            Class&lt;?&gt; beanClass, String beanName, Object[] specificInterceptors, TargetSource targetSource)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.beanFactory <span class="keyword">instanceof</span> ConfigurableListableBeanFactory) &#123;</span><br><span class="line">        AutoProxyUtils.exposeTargetClass((ConfigurableListableBeanFactory) <span class="keyword">this</span>.beanFactory, beanName, beanClass);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ProxyFactory proxyFactory = <span class="keyword">new</span> ProxyFactory();</span><br><span class="line">    proxyFactory.copyFrom(<span class="keyword">this</span>);</span><br><span class="line">    <span class="comment">//创建ProxyFactory实例，并复制当前类的相关配置</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!proxyFactory.isProxyTargetClass()) &#123;</span><br><span class="line">        <span class="comment">//检查当前类是否有实现基于类的代理,还是基于接口,以此来决定是否采用cglib来创建代理对象。</span></span><br><span class="line">        <span class="keyword">if</span> (shouldProxyTargetClass(beanClass, beanName)) &#123;</span><br><span class="line">            proxyFactory.setProxyTargetClass(<span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            evaluateProxyInterfaces(beanClass, proxyFactory);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    Advisor[] advisors = buildAdvisors(beanName, specificInterceptors);</span><br><span class="line">    <span class="comment">//整理合并Advisor,这里AbstractAutoProxyCreator定义了属性interceptorNames用于设置拦截器</span></span><br><span class="line">    <span class="comment">//同时子类通过getAdvicesAndAdvisorsForBean()方法也可以返回一组Advisor,</span></span><br><span class="line">    <span class="comment">//buildAdvisors()方法就是整理合并这些切面。</span></span><br><span class="line">    <span class="comment">//至于调用的先后顺序,通过applyCommonInterceptorsFirst参数可以进行设置</span></span><br><span class="line">    <span class="comment">//若applyCommonInterceptorsFirst为true,interceptorNames属性指定的Advisor优先调用。默认为true；</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (Advisor advisor : advisors) &#123;</span><br><span class="line">        proxyFactory.addAdvisor(advisor);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    proxyFactory.setTargetSource(targetSource);</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    customizeProxyFactory(proxyFactory);</span><br><span class="line">    <span class="comment">//通过customizeProxyFactory（）方法，子类可以对proxyFactory进行设置更改。</span></span><br><span class="line"></span><br><span class="line">    proxyFactory.setFrozen(<span class="keyword">this</span>.freezeProxy);</span><br><span class="line">    <span class="keyword">if</span> (advisorsPreFiltered()) &#123;</span><br><span class="line">        proxyFactory.setPreFiltered(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//最后调用proxyFactory.getProxy()方法返回代理对象。</span></span><br><span class="line">    <span class="keyword">return</span> proxyFactory.getProxy(getProxyClassLoader());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="proxyFactory-getProxy"><a href="#proxyFactory-getProxy" class="headerlink" title="proxyFactory.getProxy"></a>proxyFactory.getProxy</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">proxyFactory.getProxy(getProxyClassLoader());  </span></span><br><span class="line"><span class="comment">    |</span></span><br><span class="line"><span class="comment">    |</span></span><br><span class="line"><span class="comment">createAopProxy().getProxy(classLoader);   //创建代理工厂去进行代理对象 </span></span><br><span class="line"><span class="comment">    |</span></span><br><span class="line"><span class="comment">    |</span></span><br><span class="line"><span class="comment">DefaultAopProxyFactory.createAopProxy</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> AopProxy <span class="title">createAopProxy</span><span class="params">(AdvisedSupport config)</span> <span class="keyword">throws</span> AopConfigException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (config.isOptimize() || config.isProxyTargetClass() || hasNoUserSuppliedProxyInterfaces(config)) &#123;</span><br><span class="line">        Class&lt;?&gt; targetClass = config.getTargetClass();</span><br><span class="line">        <span class="keyword">if</span> (targetClass == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AopConfigException(<span class="string">"TargetSource cannot determine target class: "</span> +</span><br><span class="line">                    <span class="string">"Either an interface or a target is required for proxy creation."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (targetClass.isInterface() || Proxy.isProxyClass(targetClass)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> JdkDynamicAopProxy(config);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ObjenesisCglibAopProxy(config);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JdkDynamicAopProxy(config);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="JdkDynamicAopProxy"><a href="#JdkDynamicAopProxy" class="headerlink" title="JdkDynamicAopProxy"></a>JdkDynamicAopProxy</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getProxy</span><span class="params">(ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">        logger.debug(<span class="string">"Creating JDK dynamic proxy: target source is "</span> + <span class="keyword">this</span>.advised.getTargetSource());</span><br><span class="line">    &#125;</span><br><span class="line">    Class&lt;?&gt;[] proxiedInterfaces = AopProxyUtils.completeProxiedInterfaces(<span class="keyword">this</span>.advised);</span><br><span class="line">    findDefinedEqualsAndHashCodeMethods(proxiedInterfaces);</span><br><span class="line">    <span class="keyword">return</span> Proxy.newProxyInstance(classLoader, proxiedInterfaces, <span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    MethodInvocation invocation;</span><br><span class="line">    Object oldProxy = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">boolean</span> setProxyContext = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    TargetSource targetSource = <span class="keyword">this</span>.advised.targetSource;</span><br><span class="line">    Class&lt;?&gt; targetClass = <span class="keyword">null</span>;</span><br><span class="line">    Object target = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.equalsDefined &amp;&amp; AopUtils.isEqualsMethod(method)) &#123;</span><br><span class="line">            <span class="keyword">return</span> equals(args[<span class="number">0</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.hashCodeDefined &amp;&amp; AopUtils.isHashCodeMethod(method)) &#123;</span><br><span class="line">            <span class="keyword">return</span> hashCode();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.advised.opaque &amp;&amp; method.getDeclaringClass().isInterface() &amp;&amp;</span><br><span class="line">                method.getDeclaringClass().isAssignableFrom(Advised.class)) &#123;</span><br><span class="line">            <span class="keyword">return</span> AopUtils.invokeJoinpointUsingReflection(<span class="keyword">this</span>.advised, method, args);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Object retVal;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.advised.exposeProxy) &#123;</span><br><span class="line">            oldProxy = AopContext.setCurrentProxy(proxy);</span><br><span class="line">            setProxyContext = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        target = targetSource.getTarget();</span><br><span class="line">        <span class="keyword">if</span> (target != <span class="keyword">null</span>) &#123;</span><br><span class="line">            targetClass = target.getClass();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        List&lt;Object&gt; chain = <span class="keyword">this</span>.advised.getInterceptorsAndDynamicInterceptionAdvice(method, targetClass);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (chain.isEmpty()) &#123;</span><br><span class="line">            Object[] argsToUse = AopProxyUtils.adaptArgumentsIfNecessary(method, args);</span><br><span class="line">            retVal = AopUtils.invokeJoinpointUsingReflection(target, method, argsToUse);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            invocation = <span class="keyword">new</span> ReflectiveMethodInvocation(proxy, target, method, args, targetClass, chain);</span><br><span class="line">            retVal = invocation.proceed();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Class&lt;?&gt; returnType = method.getReturnType();</span><br><span class="line">        <span class="keyword">if</span> (retVal != <span class="keyword">null</span> &amp;&amp; retVal == target &amp;&amp; returnType.isInstance(proxy) &amp;&amp;</span><br><span class="line">                !RawTargetAccess.class.isAssignableFrom(method.getDeclaringClass())) &#123;</span><br><span class="line">            retVal = proxy;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (retVal == <span class="keyword">null</span> &amp;&amp; returnType != Void.TYPE &amp;&amp; returnType.isPrimitive()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AopInvocationException(</span><br><span class="line">                    <span class="string">"Null return value from advice does not match primitive return type for: "</span> + method);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> retVal;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (target != <span class="keyword">null</span> &amp;&amp; !targetSource.isStatic()) &#123;</span><br><span class="line">            targetSource.releaseTarget(target);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (setProxyContext) &#123;</span><br><span class="line">            AopContext.setCurrentProxy(oldProxy);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ObjenesisCglibAopProxy"><a href="#ObjenesisCglibAopProxy" class="headerlink" title="ObjenesisCglibAopProxy"></a>ObjenesisCglibAopProxy</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CglibAopProxy.getProxy</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getProxy</span><span class="params">(ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">        logger.debug(<span class="string">"Creating CGLIB proxy: target source is "</span> + <span class="keyword">this</span>.advised.getTargetSource());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Class&lt;?&gt; rootClass = <span class="keyword">this</span>.advised.getTargetClass();</span><br><span class="line">        Assert.state(rootClass != <span class="keyword">null</span>, <span class="string">"Target class must be available for creating a CGLIB proxy"</span>);</span><br><span class="line"></span><br><span class="line">        Class&lt;?&gt; proxySuperClass = rootClass;</span><br><span class="line">        <span class="keyword">if</span> (ClassUtils.isCglibProxyClass(rootClass)) &#123;</span><br><span class="line">            proxySuperClass = rootClass.getSuperclass();</span><br><span class="line">            Class&lt;?&gt;[] additionalInterfaces = rootClass.getInterfaces();</span><br><span class="line">            <span class="keyword">for</span> (Class&lt;?&gt; additionalInterface : additionalInterfaces) &#123;</span><br><span class="line">                <span class="keyword">this</span>.advised.addInterface(additionalInterface);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        validateClassIfNecessary(proxySuperClass, classLoader);</span><br><span class="line"></span><br><span class="line">        Enhancer enhancer = createEnhancer();</span><br><span class="line">        <span class="keyword">if</span> (classLoader != <span class="keyword">null</span>) &#123;</span><br><span class="line">            enhancer.setClassLoader(classLoader);</span><br><span class="line">            <span class="keyword">if</span> (classLoader <span class="keyword">instanceof</span> SmartClassLoader &amp;&amp;</span><br><span class="line">                    ((SmartClassLoader) classLoader).isClassReloadable(proxySuperClass)) &#123;</span><br><span class="line">                enhancer.setUseCache(<span class="keyword">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        enhancer.setSuperclass(proxySuperClass);</span><br><span class="line">        enhancer.setInterfaces(AopProxyUtils.completeProxiedInterfaces(<span class="keyword">this</span>.advised));</span><br><span class="line">        enhancer.setNamingPolicy(SpringNamingPolicy.INSTANCE);</span><br><span class="line">        enhancer.setStrategy(<span class="keyword">new</span> ClassLoaderAwareUndeclaredThrowableStrategy(classLoader));</span><br><span class="line"></span><br><span class="line">        Callback[] callbacks = getCallbacks(rootClass);</span><br><span class="line">        Class&lt;?&gt;[] types = <span class="keyword">new</span> Class&lt;?&gt;[callbacks.length];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> x = <span class="number">0</span>; x &lt; types.length; x++) &#123;</span><br><span class="line">            types[x] = callbacks[x].getClass();</span><br><span class="line">        &#125;</span><br><span class="line">        enhancer.setCallbackFilter(<span class="keyword">new</span> ProxyCallbackFilter(</span><br><span class="line">                <span class="keyword">this</span>.advised.getConfigurationOnlyCopy(), <span class="keyword">this</span>.fixedInterceptorMap, <span class="keyword">this</span>.fixedInterceptorOffset));</span><br><span class="line">        enhancer.setCallbackTypes(types);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> createProxyClassAndInstance(enhancer, callbacks);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (CodeGenerationException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> AopConfigException(<span class="string">"Could not generate CGLIB subclass of class ["</span> +</span><br><span class="line">                <span class="keyword">this</span>.advised.getTargetClass() + <span class="string">"]: "</span> +</span><br><span class="line">                <span class="string">"Common causes of this problem include using a final class or a non-visible class"</span>,</span><br><span class="line">                ex);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (IllegalArgumentException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> AopConfigException(<span class="string">"Could not generate CGLIB subclass of class ["</span> +</span><br><span class="line">                <span class="keyword">this</span>.advised.getTargetClass() + <span class="string">"]: "</span> +</span><br><span class="line">                <span class="string">"Common causes of this problem include using a final class or a non-visible class"</span>,</span><br><span class="line">                ex);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> AopConfigException(<span class="string">"Unexpected AOP exception"</span>, ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//ObjenesisCglibAopProxy.createProxyClassAndInstance</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">createProxyClassAndInstance</span><span class="params">(Enhancer enhancer, Callback[] callbacks)</span> </span>&#123;</span><br><span class="line">    Class&lt;?&gt; proxyClass = enhancer.createClass();</span><br><span class="line">    Object proxyInstance = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (objenesis.isWorthTrying()) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            proxyInstance = objenesis.newInstance(proxyClass, enhancer.getUseCache());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">            logger.debug(<span class="string">"Unable to instantiate proxy using Objenesis, "</span> +</span><br><span class="line">                    <span class="string">"falling back to regular proxy construction"</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (proxyInstance == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            proxyInstance = (<span class="keyword">this</span>.constructorArgs != <span class="keyword">null</span> ?</span><br><span class="line">                    proxyClass.getConstructor(<span class="keyword">this</span>.constructorArgTypes).newInstance(<span class="keyword">this</span>.constructorArgs) :</span><br><span class="line">                    proxyClass.newInstance());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AopConfigException(<span class="string">"Unable to instantiate proxy using Objenesis, "</span> +</span><br><span class="line">                    <span class="string">"and regular proxy instantiation via default constructor fails as well"</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ((Factory) proxyInstance).setCallbacks(callbacks);</span><br><span class="line">    <span class="keyword">return</span> proxyInstance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="MVC"><a href="#MVC" class="headerlink" title="MVC"></a>MVC</h1><p><img src="/2017/02/13/spring/image-02.png" alt="img"></p>
<p>根据http请求选择合适的controller是MVC中一项十分关键的功能</p>
<ul>
<li>SimpleUrlHandlerMapping    //使用定义在spring应用上下文的属性集合,将控制器映射到url上</li>
<li>RequestMappingHandlerMapping    //使用@RequestMapping注解以前叫DefaultAnnotationHandlerMapping</li>
<li>ControllerClassNameHandlerMapping    //使用控制器的类名作为URL基础将控制器映射到URL上</li>
<li>ControllerBeanNamHandlerMapping    //根据控制器Bean的名字作为URL基础将控制器映射到URL上</li>
</ul>
<p>获取相关的handler,HandlerExecutionChain(执行链)</p>
<h2 id="DispatcherServlet-初始化体系"><a href="#DispatcherServlet-初始化体系" class="headerlink" title="DispatcherServlet 初始化体系"></a>DispatcherServlet 初始化体系</h2><p>EmbeddedWebApplicationContext中selfInitialize<br>当TomcatEmbeddedServletContainer初始化到最后一层Wrapper后调用selfInitialize添加servlet,filter<br>后期各类pipeline的vavle一直从server-&gt;service-&gt;engine-&gt;host-&gt;context-&gt;wrapper-&gt;filterChain-&gt;servlet<br>其他HandlerMapping如:SimpleUrl,RequestMapping等会等到AbstractApplicationContext#finishBeanFactoryInitialization实例化<br>执行各类HandlerMapping#afterPropertiesSet—&gt;initHandlerMethods为每个method添加到相关的handlerMapping    </p>
<blockquote>
<p>selfInitialize<br>初始化方法,wrapper最后会进行这个selfInitialize    </p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (ServletContextInitializer beans : getServletContextInitializerBeans()) &#123;</span><br><span class="line">    beans.onStartup(servletContext);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ServletRegistrationBean 专门注册Servlet</span></span><br><span class="line"><span class="comment">//FilterRegistractionBean 专门注册Filter</span></span><br></pre></td></tr></table></figure>
<p>由此bean的onStartUp展开了对dispatcher的加载        </p>
<h3 id="ServletRegistrationBean"><a href="#ServletRegistrationBean" class="headerlink" title="ServletRegistrationBean"></a>ServletRegistrationBean</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">ServletRegistrationBean#onStartup</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStartup</span><span class="params">(ServletContext servletContext)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">    String name = getServletName();</span><br><span class="line">    </span><br><span class="line">    .....</span><br><span class="line">    </span><br><span class="line">    Dynamic added = servletContext.addServlet(name, <span class="keyword">this</span>.servlet);</span><br><span class="line">    <span class="comment">//this.servlet = dispatcherServlet</span></span><br><span class="line">    <span class="comment">//servletContext就是Tomcat的context组件     </span></span><br><span class="line">    </span><br><span class="line">    configure(added);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> ServletRegistration.<span class="function">Dynamic <span class="title">addServlet</span><span class="params">(String servletName,</span></span></span><br><span class="line"><span class="function"><span class="params">            String servletClass, Servlet servlet)</span> <span class="keyword">throws</span> IllegalStateException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//context就是Tomcat的Context的组件为StandardEngine[Tomcat].StandardHost[localhost].TomcatEmbeddedContext[]</span></span><br><span class="line">        Wrapper wrapper = (Wrapper) context.findChild(servletName);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (wrapper == <span class="keyword">null</span>) &#123;</span><br><span class="line">            wrapper = context.createWrapper();</span><br><span class="line">            wrapper.setName(servletName);</span><br><span class="line">            context.addChild(wrapper);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (wrapper.getName() != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                    wrapper.getServletClass() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (wrapper.isOverridable()) &#123;</span><br><span class="line">                    wrapper.setOverridable(<span class="keyword">false</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (servlet == <span class="keyword">null</span>) &#123;</span><br><span class="line">            wrapper.setServletClass(servletClass);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            wrapper.setServletClass(servlet.getClass().getName());</span><br><span class="line">            wrapper.setServlet(servlet);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> context.dynamicServletAdded(wrapper);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="FilterRegistrationBean"><a href="#FilterRegistrationBean" class="headerlink" title="FilterRegistrationBean"></a>FilterRegistrationBean</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">AbstractFilterRegistrationBean#onStartup</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStartup</span><span class="params">(ServletContext servletContext)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">    Filter filter = getFilter();</span><br><span class="line">    String name = getOrDeduceName(filter);</span><br><span class="line">    </span><br><span class="line">    FilterRegistration.Dynamic added = servletContext.addFilter(name, filter);</span><br><span class="line">    </span><br><span class="line">    configure(added);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="建立体系"><a href="#建立体系" class="headerlink" title="建立体系"></a>建立体系</h2><h3 id="RequestMappingHandlerMapping"><a href="#RequestMappingHandlerMapping" class="headerlink" title="RequestMappingHandlerMapping"></a><code>RequestMappingHandlerMapping</code></h3><p><code>RequestMappingHandlerMapping</code>继承了<code>InitializingBean</code>实现了<code>afterPropertiesSet</code></p>
<blockquote>
<p>往上一级 AbstractHandlerMethodMapping<br>super.afterPropertiesSet();<br>执行<code>initHandlerMethods();</code>-&gt;<code>detectHandlerMethods</code>-&gt;<code>getMappingForMethod</code>-&gt;<code>registerHandlerMethod</code>  </p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//handlerMethod的注册操作  </span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initHandlerMethods</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">        logger.debug(<span class="string">"Looking for request mappings in application context: "</span> + getApplicationContext());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//从springMVC容器中获取所有的beanName  </span></span><br><span class="line">    String[] beanNames = (<span class="keyword">this</span>.detectHandlerMethodsInAncestorContexts ?</span><br><span class="line">            BeanFactoryUtils.beanNamesForTypeIncludingAncestors(getApplicationContext(), Object.class) :</span><br><span class="line">            getApplicationContext().getBeanNamesForType(Object.class));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//注册从容器中获取的beanName</span></span><br><span class="line">    <span class="keyword">for</span> (String beanName : beanNames) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!beanName.startsWith(SCOPED_TARGET_NAME_PREFIX)) &#123;</span><br><span class="line">            Class&lt;?&gt; beanType = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                beanType = getApplicationContext().getType(beanName);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">                <span class="comment">// An unresolvable bean type, probably from a lazy bean - let's ignore it.</span></span><br><span class="line">                <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">                    logger.debug(<span class="string">"Could not resolve target class for bean with name '"</span> + beanName + <span class="string">"'"</span>, ex);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (beanType != <span class="keyword">null</span> &amp;&amp; isHandler(beanType)) &#123;</span><br><span class="line">                detectHandlerMethods(beanName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    handlerMethodsInitialized(getHandlerMethods());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">detectHandlerMethods</span><span class="params">(<span class="keyword">final</span> Object handler)</span> </span>&#123;  </span><br><span class="line">    <span class="comment">//获取bean实例  </span></span><br><span class="line">    Class&lt;?&gt; handlerType =  (handler <span class="keyword">instanceof</span> String ? getApplicationContext().getType((String) handler) : handler.getClass());  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Map&lt;Method, T&gt; mappings = <span class="keyword">new</span> IdentityHashMap&lt;Method, T&gt;();  </span><br><span class="line">    <span class="keyword">final</span> Class&lt;?&gt; userType = ClassUtils.getUserClass(handlerType);  </span><br><span class="line"></span><br><span class="line">    Set&lt;Method&gt; methods = HandlerMethodSelector.selectMethods(userType, <span class="keyword">new</span> MethodFilter() &#123;  </span><br><span class="line">        <span class="meta">@Override</span>  </span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(Method method)</span> </span>&#123;  </span><br><span class="line">            <span class="comment">//创建RequestMappingInfo  </span></span><br><span class="line">            T mapping = getMappingForMethod(method, userType);  </span><br><span class="line">            <span class="keyword">if</span> (mapping != <span class="keyword">null</span>) &#123;  </span><br><span class="line">                mappings.put(method, mapping);  </span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;  </span><br><span class="line">            &#125;  </span><br><span class="line">            <span class="keyword">else</span> &#123;  </span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;);  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">for</span> (Method method : methods) &#123;  </span><br><span class="line">        registerHandlerMethod(handler, method, mappings.get(method));  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//注册beanName和method及RequestMappingInfo之间的关系，RequestMappingInfo会保存url信息  </span></span><br><span class="line"><span class="meta">@Deprecated</span>  </span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">registerHandlerMethod</span><span class="params">(Object handler, Method method, T mapping)</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">this</span>.mappingRegistry.register(mapping, handler, method);  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="function"><span class="keyword">protected</span> RequestMappingInfo <span class="title">getMappingForMethod</span><span class="params">(Method method, Class&lt;?&gt; handlerType)</span> </span>&#123;  </span><br><span class="line">    RequestMappingInfo info = createRequestMappingInfo(method);  </span><br><span class="line">    <span class="keyword">if</span> (info != <span class="keyword">null</span>) &#123;  </span><br><span class="line">        RequestMappingInfo typeInfo = createRequestMappingInfo(handlerType);  </span><br><span class="line">        <span class="keyword">if</span> (typeInfo != <span class="keyword">null</span>) &#123;  </span><br><span class="line">            info = typeInfo.combine(info);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> info;  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> RequestMappingInfo <span class="title">createRequestMappingInfo</span><span class="params">(AnnotatedElement element)</span> </span>&#123;  </span><br><span class="line">    RequestMapping requestMapping = AnnotatedElementUtils.findMergedAnnotation(element, RequestMapping.class);  </span><br><span class="line">    RequestCondition&lt;?&gt; condition = (element <span class="keyword">instanceof</span> Class&lt;?&gt; ?  </span><br><span class="line">            getCustomTypeCondition((Class&lt;?&gt;) element) : getCustomMethodCondition((Method) element));  </span><br><span class="line">    <span class="keyword">return</span> (requestMapping != <span class="keyword">null</span> ? createRequestMappingInfo(requestMapping, condition) : <span class="keyword">null</span>);  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//这样就简单实现了将 url 和 HandlerMethod 的对应关系注册到 mappingRegistry 中。</span></span><br><span class="line"><span class="comment">//MappingRegistry中的注册实现如下，并且MappingRegistry定义了几个map结构，用来存储注册信息</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;T, MappingRegistration&lt;T&gt;&gt; registry = <span class="keyword">new</span> HashMap&lt;T, MappingRegistration&lt;T&gt;&gt;();  </span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;T, HandlerMethod&gt; mappingLookup = <span class="keyword">new</span> LinkedHashMap&lt;T, HandlerMethod&gt;();  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> MultiValueMap&lt;String, T&gt; urlLookup = <span class="keyword">new</span> LinkedMultiValueMap&lt;String, T&gt;();  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, List&lt;HandlerMethod&gt;&gt; nameLookup =  <span class="keyword">new</span> ConcurrentHashMap&lt;String, List&lt;HandlerMethod&gt;&gt;();  </span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;HandlerMethod, CorsConfiguration&gt; corsLookup =  <span class="keyword">new</span> ConcurrentHashMap&lt;HandlerMethod, CorsConfiguration&gt;();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//注册beanName和method及RequestMappingInfo之间的关系，RequestMappingInfo中有url信息  </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(T mapping, Object handler, Method method)</span> </span>&#123;  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.readWriteLock.writeLock().lock();  </span><br><span class="line">    <span class="keyword">try</span> &#123;  </span><br><span class="line">        <span class="comment">//创建HandlerMethod  </span></span><br><span class="line">        HandlerMethod handlerMethod = createHandlerMethod(handler, method);  </span><br><span class="line">        assertUniqueMethodMapping(handlerMethod, mapping);  </span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (logger.isInfoEnabled()) &#123;  </span><br><span class="line">            logger.info(<span class="string">"Mapped \""</span> + mapping + <span class="string">"\" onto "</span> + handlerMethod);  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="comment">//保存url和handlerMethod之间的对应关系  </span></span><br><span class="line">        <span class="keyword">this</span>.mappingLookup.put(mapping, handlerMethod);  </span><br><span class="line">        <span class="comment">//保存url和RequestMappingInfo对应关系  </span></span><br><span class="line">        List&lt;String&gt; directUrls = getDirectUrls(mapping);  </span><br><span class="line">        <span class="keyword">for</span> (String url : directUrls) &#123;  </span><br><span class="line">            <span class="keyword">this</span>.urlLookup.add(url, mapping);  </span><br><span class="line">        &#125;  </span><br><span class="line"></span><br><span class="line">        String name = <span class="keyword">null</span>;  </span><br><span class="line">        <span class="keyword">if</span> (getNamingStrategy() != <span class="keyword">null</span>) &#123;  </span><br><span class="line">            name = getNamingStrategy().getName(handlerMethod, mapping);  </span><br><span class="line">            addMappingName(name, handlerMethod);  </span><br><span class="line">        &#125;  </span><br><span class="line"></span><br><span class="line">        CorsConfiguration corsConfig = initCorsConfiguration(handler, method, mapping);  </span><br><span class="line">        <span class="keyword">if</span> (corsConfig != <span class="keyword">null</span>) &#123;  </span><br><span class="line">            <span class="keyword">this</span>.corsLookup.put(handlerMethod, corsConfig);  </span><br><span class="line">        &#125;  </span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.registry.put(mapping, <span class="keyword">new</span> MappingRegistration&lt;T&gt;(mapping, handlerMethod, directUrls, name));  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">finally</span> &#123;  </span><br><span class="line">        <span class="keyword">this</span>.readWriteLock.writeLock().unlock();  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<h3 id="RequestMappingHandlerAdapter"><a href="#RequestMappingHandlerAdapter" class="headerlink" title="RequestMappingHandlerAdapter"></a><code>RequestMappingHandlerAdapter</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Do this first, it may add ResponseBody advice beans</span></span><br><span class="line">    initControllerAdviceCache();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.argumentResolvers == <span class="keyword">null</span>) &#123;</span><br><span class="line">        List&lt;HandlerMethodArgumentResolver&gt; resolvers = getDefaultArgumentResolvers();</span><br><span class="line">        <span class="keyword">this</span>.argumentResolvers = <span class="keyword">new</span> HandlerMethodArgumentResolverComposite().addResolvers(resolvers);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.initBinderArgumentResolvers == <span class="keyword">null</span>) &#123;</span><br><span class="line">        List&lt;HandlerMethodArgumentResolver&gt; resolvers = getDefaultInitBinderArgumentResolvers();</span><br><span class="line">        <span class="keyword">this</span>.initBinderArgumentResolvers = <span class="keyword">new</span> HandlerMethodArgumentResolverComposite().addResolvers(resolvers);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.returnValueHandlers == <span class="keyword">null</span>) &#123;</span><br><span class="line">        List&lt;HandlerMethodReturnValueHandler&gt; handlers = getDefaultReturnValueHandlers();</span><br><span class="line">        <span class="keyword">this</span>.returnValueHandlers = <span class="keyword">new</span> HandlerMethodReturnValueHandlerComposite().addHandlers(handlers);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>初始化各类<code>argumentResolvers</code>  </li>
<li>初始化各类<code>returnValueHandlers</code>  </li>
</ul>
<p><br></p>
<blockquote>
<p>忽略ViewName视图解析,Json数据返回  </p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleReturnValue</span><span class="params">(Object returnValue, MethodParameter returnType,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  ModelAndViewContainer mavContainer, NativeWebRequest webRequest)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> IOException, HttpMediaTypeNotAcceptableException, HttpMessageNotWritableException </span>&#123;</span><br><span class="line"></span><br><span class="line">    mavContainer.setRequestHandled(<span class="keyword">true</span>);</span><br><span class="line">    ServletServerHttpRequest inputMessage = createInputMessage(webRequest);</span><br><span class="line">    ServletServerHttpResponse outputMessage = createOutputMessage(webRequest);</span><br><span class="line">    writeWithMessageConverters(returnValue, returnType, inputMessage, outputMessage);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>mavContainer.setRequestHandled(true);</code> 设置true  </p>
<ul>
<li><p><code>RequestMappingHandlerAdapter#getModelAndView</code>直接返回空的<code>ModelAndView</code>    </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (mavContainer.isRequestHandled()) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>applyDefaultViewName</code>如果<code>mv==null</code>就不设置viewName了</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">applyDefaultViewName</span><span class="params">(HttpServletRequest request, ModelAndView mv)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mv != <span class="keyword">null</span> &amp;&amp; !mv.hasView()) &#123;</span><br><span class="line">        mv.setViewName(getDefaultViewName(request));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p><code>writeWithMessageConverters(returnValue, returnType, inputMessage, outputMessage);</code>:会进行<code>HttpMessageConverter#write</code>操作,直接将信息write出去  </p>
<ul>
<li><code>FastJsonHttpMessageConverter</code>是<code>HttpMessageConverter</code>实现类  </li>
<li><code>FastJsonHttpMessageConverter</code>是<code>HttpMessageConverter</code>实现类   </li>
</ul>
</li>
</ul>
<p><br></p>
<h2 id="主体流程"><a href="#主体流程" class="headerlink" title="主体流程"></a>主体流程</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">DispatcherServlet</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">---&gt;doService---&gt;doDispatcher()</span><br><span class="line"></span><br><span class="line">----&gt;mappedHandler = getHandler(request)： </span><br><span class="line"><span class="comment">// 从各类HandlerMapping里获取合适的Handler-&gt;从mappingRegistry拿之前初始化注册的</span></span><br><span class="line"><span class="comment">// 再拼装各类addInterceptor, 追加CorsInterceptor, 形成HandlerExecutionChain返回</span></span><br><span class="line"></span><br><span class="line">----&gt;getHandlerAdapter(mappedHandler.getHandler());</span><br><span class="line"><span class="comment">// 选取合适的HandlerAdapter</span></span><br><span class="line"></span><br><span class="line">-----&gt;mappedHandler.applyPreHandle</span><br><span class="line"><span class="comment">// Intercetptor前置执行</span></span><br><span class="line"></span><br><span class="line">-----&gt; ha.handle(processedRequest, response, mappedHandler.getHandler());</span><br><span class="line"><span class="comment">// 执行主体逻辑 </span></span><br><span class="line">        -----&gt; handleInternal----&gt; invokeHandlerMethod </span><br><span class="line">        <span class="comment">// 封装invocableMethod  元素`argumentResolvers`,`returnValueHandlers`  </span></span><br><span class="line">        ------&gt; invokeAndHandle  -----&gt; invokeForRequest  </span><br><span class="line">                -----&gt; getMethodArgumentValues <span class="comment">//参数解析</span></span><br><span class="line">                -----&gt; doInvoke    <span class="comment">//反射调用</span></span><br><span class="line">        -------&gt; returnValueHandlers    <span class="comment">//返回值分装</span></span><br><span class="line"></span><br><span class="line">-----&gt; applyDefaultViewName(processedRequest, mv);</span><br><span class="line"><span class="comment">// 视图解析,如果mv为null则不必要解析View</span></span><br><span class="line"></span><br><span class="line">-----&gt;mappedHandler.applyPreHandle</span><br><span class="line"><span class="comment">// Intercetptor前置执行</span></span><br></pre></td></tr></table></figure>
<h2 id="获取处理器"><a href="#获取处理器" class="headerlink" title="获取处理器"></a>获取处理器</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> HandlerExecutionChain <span class="title">getHandler</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (HandlerMapping hm : <span class="keyword">this</span>.handlerMappings) &#123;</span><br><span class="line">        <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">            logger.trace(</span><br><span class="line">                    <span class="string">"Testing handler map ["</span> + hm + <span class="string">"] in DispatcherServlet with name '"</span> + getServletName() + <span class="string">"'"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line">        HandlerExecutionChain handler = hm.getHandler(request);</span><br><span class="line">        <span class="keyword">if</span> (handler != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> handler;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> HandlerExecutionChain <span class="title">getHandler</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">//主要获取handler</span></span><br><span class="line">    <span class="comment">//getHandlerInternal---&gt;lookupHandlerMethod---&gt;mappingRegistry里获取相关信息(之前也从注册于此)</span></span><br><span class="line">    Object handler = getHandlerInternal(request);</span><br><span class="line">    <span class="keyword">if</span> (handler == <span class="keyword">null</span>) &#123;</span><br><span class="line">        handler = getDefaultHandler();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (handler == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (handler <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">        String handlerName = (String) handler;</span><br><span class="line">        handler = getApplicationContext().getBean(handlerName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//执行链再此形成</span></span><br><span class="line">    HandlerExecutionChain executionChain = getHandlerExecutionChain(handler, request);</span><br><span class="line">    <span class="keyword">if</span> (CorsUtils.isCorsRequest(request)) &#123;</span><br><span class="line">        CorsConfiguration globalConfig = <span class="keyword">this</span>.corsConfigSource.getCorsConfiguration(request);</span><br><span class="line">        CorsConfiguration handlerConfig = getCorsConfiguration(handler, request);</span><br><span class="line">        CorsConfiguration config = (globalConfig != <span class="keyword">null</span> ? globalConfig.combine(handlerConfig) : handlerConfig);</span><br><span class="line">        executionChain = getCorsHandlerExecutionChain(request, executionChain, config);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> executionChain;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="执行流程"><a href="#执行流程" class="headerlink" title="执行流程"></a>执行流程</h2><blockquote>
<p>DispatcherServlet-&gt;&gt;DispatcherServlet:doDispatch<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">mv = ha.handle(processedRequest, response, mappedHandler.getHandler());</span><br><span class="line">|</span><br><span class="line">|</span><br><span class="line">|</span><br><span class="line"><span class="keyword">return</span> handleInternal(request, response, (HandlerMethod) handler);</span><br><span class="line">|</span><br><span class="line">|</span><br><span class="line">|</span><br><span class="line">mav = invokeHandlerMethod(request, response, handlerMethod);</span><br><span class="line">|</span><br><span class="line">|</span><br><span class="line">|</span><br><span class="line">########    ServletInvocableHandlerMethod   ########</span><br><span class="line">invocableMethod.invokeAndHandle(webRequest, mavContainer);</span><br><span class="line">|</span><br><span class="line">|</span><br><span class="line">|</span><br><span class="line">########    InvocableHandlerMethod          ########</span><br><span class="line">Object returnValue = invokeForRequest(webRequest, mavContainer, providedArgs);</span><br><span class="line">|</span><br><span class="line">|</span><br><span class="line">|</span><br><span class="line">Object returnValue = doInvoke(args);</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h2 id="HandlerMapping：处理器映射器"><a href="#HandlerMapping：处理器映射器" class="headerlink" title="HandlerMapping：处理器映射器"></a>HandlerMapping：处理器映射器</h2><p>作用:根据【请求】找到【处理器Handler】，但并不是简单的返回处理器，而是<br>将处理器和拦截器封装，形成一个处理器执行链(HandlerExecuteChain)。</p>
<p>HandlerExecuteChain包含以下:</p>
<ul>
<li>interceptorList: 拦截器列表</li>
<li>handler: 执行器</li>
</ul>
<p>DispatcherServlet 拿着执行链去寻找对应的处理器适配器(HandlerAdapter)</p>
<h2 id="为什么要引入适配器？"><a href="#为什么要引入适配器？" class="headerlink" title="为什么要引入适配器？"></a>为什么要引入适配器？</h2><p>因为处理器(Handler)有很多种，DispatcherServlet没办法统一管理，所以出现了适配器。  </p>
<p>让适配器统一处理Handler，而DispatcherServlet统一处理适配器。  </p>
<p>根据请求去找对应的handler  </p>
<p><br><br><br><br><br></p>
<h1 id="SpringBoot"><a href="#SpringBoot" class="headerlink" title="SpringBoot"></a>SpringBoot</h1><h2 id="自动配置"><a href="#自动配置" class="headerlink" title="自动配置"></a>自动配置</h2><p><img src="/2017/02/13/spring/image-06.png" alt="img"></p>
<p><img src="/2017/02/13/spring/image-05.png" alt="img"></p>
<p>可以发现其最终实现了ImportSelector(选择器)和BeanClassLoaderAware(bean类加载器中间件)</p>
<p><img src="/2017/02/13/spring/image-08.png" alt="img"></p>
<p>重点关注一下AutoConfigurationImportSelector的selectImports方法</p>
<p><img src="/2017/02/13/spring/image-07.png" alt="img"></p>
<p><img src="/2017/02/13/spring/image-09.png" alt="img"></p>
<p><img src="/2017/02/13/spring/image-10.png" alt="img"></p>
<p><img src="/2017/02/13/spring/image-11.png" alt="img"></p>
<p><img src="/2017/02/13/spring/image-12.png" alt="img"></p>
<p>最终会根据@ConditionOnXXX各类条件</p>
<p><br></p>
<p><br></p>
<h2 id="SpringApplication-run-Boot启动函数"><a href="#SpringApplication-run-Boot启动函数" class="headerlink" title="SpringApplication#run Boot启动函数"></a>SpringApplication#run Boot启动函数</h2><p><code>SpringApplication.run()</code>会启动一个<code>AnnotationConfigEmbeddedWebApplicationContext</code>  </p>
<p>如果是SpringCloud项目会在<code>environmentPrepared</code>函数作用下通过消息引导<code>BootstrapApplicationListener</code>起<code>AnnotationConfigApplicationContext</code>应用上下文,后期再启<code>AnnotationConfigEmbeddedWebApplicationContext</code>  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ConfigurableApplicationContext <span class="title">run</span><span class="params">(String... args)</span> </span>&#123;</span><br><span class="line">    StopWatch stopWatch = <span class="keyword">new</span> StopWatch();</span><br><span class="line">    stopWatch.start();</span><br><span class="line">    ConfigurableApplicationContext context = <span class="keyword">null</span>;</span><br><span class="line">    FailureAnalyzers analyzers = <span class="keyword">null</span>;</span><br><span class="line">    configureHeadlessProperty();</span><br><span class="line">    SpringApplicationRunListeners listeners = getRunListeners(args);</span><br><span class="line">    listeners.starting();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ApplicationArguments applicationArguments = <span class="keyword">new</span> DefaultApplicationArguments(</span><br><span class="line">                args);</span><br><span class="line">        ConfigurableEnvironment environment = prepareEnvironment(listeners,</span><br><span class="line">                applicationArguments);</span><br><span class="line">        Banner printedBanner = printBanner(environment);</span><br><span class="line">        context = createApplicationContext();</span><br><span class="line">        analyzers = <span class="keyword">new</span> FailureAnalyzers(context);</span><br><span class="line">        prepareContext(context, environment, listeners, applicationArguments,</span><br><span class="line">                printedBanner);</span><br><span class="line">        refreshContext(context);</span><br><span class="line">        afterRefresh(context, applicationArguments);</span><br><span class="line">        listeners.finished(context, <span class="keyword">null</span>);</span><br><span class="line">        stopWatch.stop();</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.logStartupInfo) &#123;</span><br><span class="line">            <span class="keyword">new</span> StartupInfoLogger(<span class="keyword">this</span>.mainApplicationClass)</span><br><span class="line">                    .logStarted(getApplicationLog(), stopWatch);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> context;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">        handleRunFailure(context, listeners, analyzers, ex);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>环境整理:<code>prepareEnvironment</code>,主要设定<code>webEnvironment</code>并执行预设环境的<code>listener</code>  </li>
<li>创建上下文context:<code>AnnotationConfigEmbeddedWebApplicationContext</code>    </li>
<li>刷新上下文context:<code>refreshContext</code>  </li>
<li>结束刷新上下文context: 主要去调用一些接口实现<code>ApplicationRunner</code>,<code>CommandLineRunner</code>  </li>
</ul>
<h2 id="EmbeddedWebApplicationContext-onRefresh-Spring上下文初始化-Servlet容器创造"><a href="#EmbeddedWebApplicationContext-onRefresh-Spring上下文初始化-Servlet容器创造" class="headerlink" title="EmbeddedWebApplicationContext#onRefresh Spring上下文初始化+Servlet容器创造"></a>EmbeddedWebApplicationContext#onRefresh Spring上下文初始化+Servlet容器创造</h2><p><code>AbstractApplicationContext#refresh</code>—&gt;<code>AnnotationEmbeddedWebApplication#onRefresh</code>—&gt;<code>EmbeddedWebApplicationContext##onRefresh</code>    </p>
<blockquote>
<p> 创建Servlet容器   </p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onRefresh</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onRefresh();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        createEmbeddedServletContainer();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ApplicationContextException(<span class="string">"Unable to start embedded container"</span>,</span><br><span class="line">                ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="createEmbeddedServletContainer-创建内部Servlet容器"><a href="#createEmbeddedServletContainer-创建内部Servlet容器" class="headerlink" title="createEmbeddedServletContainer   创建内部Servlet容器"></a>createEmbeddedServletContainer   创建内部Servlet容器</h2><blockquote>
<p>具体步骤  </p>
</blockquote>
<ul>
<li>获取ServletContainer工厂类</li>
<li>从工厂类获取ServletContainer</li>
<li>ServletContainer获取的时候会实例化各个tomcat组件   </li>
</ul>
<h3 id="getEmbeddedServletContainerFactory-获取Servlet容器工厂类"><a href="#getEmbeddedServletContainerFactory-获取Servlet容器工厂类" class="headerlink" title="getEmbeddedServletContainerFactory  获取Servlet容器工厂类"></a>getEmbeddedServletContainerFactory  获取Servlet容器工厂类</h3><p>获取当前环境下的ServletContainer工厂类,默认为<code>tomcatEmbeddedServletContainerFactory</code>    </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//EmbeddedWebApplicationContext#getEmbeddedServletContainerFactory</span></span><br><span class="line"><span class="comment">//获取到当前的tomcatEmbeddedServletContainerFactory的servletContainer工厂类</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> EmbeddedServletContainerFactory <span class="title">getEmbeddedServletContainerFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String[] beanNames = getBeanFactory()</span><br><span class="line">            .getBeanNamesForType(EmbeddedServletContainerFactory.class);</span><br><span class="line">    <span class="keyword">if</span> (beanNames.length == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ApplicationContextException(</span><br><span class="line">                <span class="string">"Unable to start EmbeddedWebApplicationContext due to missing "</span></span><br><span class="line">                        + <span class="string">"EmbeddedServletContainerFactory bean."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (beanNames.length &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ApplicationContextException(</span><br><span class="line">                <span class="string">"Unable to start EmbeddedWebApplicationContext due to multiple "</span></span><br><span class="line">                        + <span class="string">"EmbeddedServletContainerFactory beans : "</span></span><br><span class="line">                        + StringUtils.arrayToCommaDelimitedString(beanNames));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> getBeanFactory().getBean(beanNames[<span class="number">0</span>],</span><br><span class="line">            EmbeddedServletContainerFactory.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="containerFactory-getEmbeddedServletContainer-getSelfInitializer-工厂类获取Servlet容器"><a href="#containerFactory-getEmbeddedServletContainer-getSelfInitializer-工厂类获取Servlet容器" class="headerlink" title="containerFactory.getEmbeddedServletContainer(getSelfInitializer());  工厂类获取Servlet容器"></a>containerFactory.getEmbeddedServletContainer(getSelfInitializer());  工厂类获取Servlet容器</h3><ul>
<li>丢初始化函数</li>
<li><code>tomcatEmbeddedServletContainerFactory</code>获取Servlet容器   </li>
</ul>
<h3 id="getSelfInitializer"><a href="#getSelfInitializer" class="headerlink" title="getSelfInitializer"></a>getSelfInitializer</h3><blockquote>
<p>设置初始化函数,给以后各个Servlet进行OnStartUp</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> org.springframework.boot.web.servlet.<span class="function">ServletContextInitializer <span class="title">getSelfInitializer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ServletContextInitializer() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStartup</span><span class="params">(ServletContext servletContext)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">            selfInitialize(servletContext);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">selfInitialize</span><span class="params">(ServletContext servletContext)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">    prepareEmbeddedWebApplicationContext(servletContext);</span><br><span class="line">    ConfigurableListableBeanFactory beanFactory = getBeanFactory();</span><br><span class="line">    ExistingWebApplicationScopes existingScopes = <span class="keyword">new</span> ExistingWebApplicationScopes(</span><br><span class="line">            beanFactory);</span><br><span class="line">    WebApplicationContextUtils.registerWebApplicationScopes(beanFactory,</span><br><span class="line">            getServletContext());</span><br><span class="line">    existingScopes.restore();</span><br><span class="line">    WebApplicationContextUtils.registerEnvironmentBeans(beanFactory,</span><br><span class="line">            getServletContext());</span><br><span class="line">    <span class="keyword">for</span> (ServletContextInitializer beans : getServletContextInitializerBeans()) &#123;</span><br><span class="line">        beans.onStartup(servletContext);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="getEmbeddedServletContainer"><a href="#getEmbeddedServletContainer" class="headerlink" title="getEmbeddedServletContainer"></a>getEmbeddedServletContainer</h3><h4 id="Tomcat准备"><a href="#Tomcat准备" class="headerlink" title="Tomcat准备"></a>Tomcat准备</h4><ul>
<li>实例化Tomcat,并设置<code>setBaseDir(/var/folders/dd/hx_wl3v56_l_bb49fkyd759h0000gn/T/tomcat.7376236981941697730.8171)</code>  </li>
<li>实例化Connector,并设置<code>protocolHandler</code>为<code>org.apache.coyote.http11.Http11NioProtocol</code>  </li>
<li>Tomcat的Service关联相关的Connector:<code>tomcat.getService().addConnector(connector);</code><ul>
<li><code>tomcat.getService()</code>会实例化<code>StandardServer</code>和<code>StandardService</code>,并<code>server.addService(service)</code>把service添加到server  </li>
<li>从tomcat的server返回此Service并且添加一个Connector</li>
</ul>
</li>
<li><p><code>configureEngine(tomcat.getEngine());</code> 取<code>Engine</code>并配置<code>Engine</code></p>
<ul>
<li><p><code>Service</code>取<code>Container</code>有则返回无则实例化<code>StandardEngine</code>并添加<code>service</code>:</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">在TomcatEmbeddedServletContainer中Service的Container就是StandardEngine</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置<code>Engine</code>   </p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">engine.getPipeline().addValve(engineValves);</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p><code>prepareContext(tomcat.getHost(), initializers);</code>预设上下文</p>
<ul>
<li><p>从<code>Engine</code>中取<code>Host</code>如若存在则返回,否则实例化<code>StandardHost</code>并添加到<code>Engine</code></p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;localhost&quot; -&gt; &quot;StandardEngine[Tomcat].StandardHost[localhost]&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>整理<code>TomcatEmbeddedContext</code>,添加各类<code>listener</code></p>
</li>
</ul>
</li>
</ul>
<h6 id="获取Tomcat的Servlet容器TomcatEmbeddedServletContainer"><a href="#获取Tomcat的Servlet容器TomcatEmbeddedServletContainer" class="headerlink" title="获取Tomcat的Servlet容器TomcatEmbeddedServletContainer"></a>获取Tomcat的Servlet容器TomcatEmbeddedServletContainer</h6><blockquote>
<p><code>return getTomcatEmbeddedServletContainer(tomcat);</code>  </p>
</blockquote>
<p>实例化<code>TomcatEmbeddedServletContainer</code><br>并在构造函数初始化    </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">()</span> <span class="keyword">throws</span> EmbeddedServletContainerException </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>.monitor) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            addInstanceIdToEngineName();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//遍历之前各个service下的connectors并clone一份新的放入serviceConnectors的map中然后service.removeConnector(connector);</span></span><br><span class="line">                removeServiceConnectors();</span><br><span class="line"></span><br><span class="line">                <span class="comment">//开启服务并触发各类监听器</span></span><br><span class="line">                <span class="keyword">this</span>.tomcat.start();</span><br><span class="line"></span><br><span class="line">                rethrowDeferredStartupExceptions();</span><br><span class="line"></span><br><span class="line">                <span class="comment">//寻找上下文并设置类加载器</span></span><br><span class="line">                Context context = findContext();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    ContextBindings.bindClassLoader(context, getNamingToken(context),</span><br><span class="line">                            getClass().getClassLoader());</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span> (NamingException ex) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                startDaemonAwaitThread();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                containerCounter.decrementAndGet();</span><br><span class="line">                <span class="keyword">throw</span> ex;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> EmbeddedServletContainerException(</span><br><span class="line">                    <span class="string">"Unable to start embedded Tomcat"</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p> 接下来相关Tomcat具体的步骤由Tomcat篇目解答</p>
</blockquote>
<p><br><br></p>
<h2 id="Jar-in-Jar-Jar-Launcher"><a href="#Jar-in-Jar-Jar-Launcher" class="headerlink" title="Jar-in-Jar Jar Launcher"></a>Jar-in-Jar Jar Launcher</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">maven打包之后，会生成两个jar文件：</span><br><span class="line">demo-0.0.1-SNAPSHOT.jar</span><br><span class="line">demo-0.0.1-SNAPSHOT.jar.original</span><br><span class="line">demo-0.0.1-SNAPSHOT.jar.original是默认的maven-jar-plugin生成的包。</span><br><span class="line"></span><br><span class="line">demo-0.0.1-SNAPSHOT.jar是spring boot maven插件生成的jar包,里面包含了应用的依赖，以及spring boot相关的类称之为fat jar。</span><br></pre></td></tr></table></figure>
<blockquote>
<p>组织架构</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">├── BOOT-INF</span><br><span class="line">│   ├── classes</span><br><span class="line">│   │   ├── application.properties</span><br><span class="line">│   │   └── cn</span><br><span class="line">│   │       └── coderss</span><br><span class="line">│   │           └── reactive</span><br><span class="line">│   │               ├── WebApplication.class</span><br><span class="line">│   │               ├── bean</span><br><span class="line">│   │               │   ├── BO</span><br><span class="line">│   │               │   │   ├── IndexBO$IndexBOBuilder.class</span><br><span class="line">│   │               │   │   └── IndexBO.class</span><br><span class="line">│   │               │   ├── DO</span><br><span class="line">│   │               │   │   ├── UserDO$UserDOBuilder.class</span><br><span class="line">│   │               │   │   └── UserDO.class</span><br><span class="line">│   │               │   └── VO</span><br><span class="line">│   │               │       ├── IndexVO$IndexVOBuilder.class</span><br><span class="line">│   │               │       ├── IndexVO.class</span><br><span class="line">│   │               │       ├── UserVO$UserVOBuilder.class</span><br><span class="line">│   │               │       └── UserVO.class</span><br><span class="line">│   │               ├── config</span><br><span class="line">│   │               │   ├── WebMvcConfig.class</span><br><span class="line">│   │               │   └── handler</span><br><span class="line">│   │               │       ├── ObservableReturnValueHandler$ObservableAdapter.class</span><br><span class="line">│   │               │       └── ObservableReturnValueHandler.class</span><br><span class="line">│   │               ├── controller</span><br><span class="line">│   │               │   ├── IndexController.class</span><br><span class="line">│   │               │   ├── OtherController.class</span><br><span class="line">│   │               │   └── UserController.class</span><br><span class="line">│   │               ├── dao</span><br><span class="line">│   │               │   └── UserRepository.class</span><br><span class="line">│   │               └── service</span><br><span class="line">│   │                   ├── IIndexService.class</span><br><span class="line">│   │                   ├── IUserService.class</span><br><span class="line">│   │                   └── impl</span><br><span class="line">│   │                       ├── IndexServiceImpl.class</span><br><span class="line">│   │                       └── UserServiceImpl.class</span><br><span class="line">│   └── lib</span><br><span class="line">│       ├── bson-3.6.4.jar</span><br><span class="line">│       ..........</span><br><span class="line">│       └── validation-api-2.0.1.Final.jar</span><br><span class="line">├── META-INF</span><br><span class="line">│   ├── MANIFEST.MF</span><br><span class="line">│   └── maven</span><br><span class="line">│       └── cn.coderss</span><br><span class="line">│           └── reactive</span><br><span class="line">│               ├── pom.properties</span><br><span class="line">│               └── pom.xml</span><br><span class="line">└── org</span><br><span class="line">    └── springframework</span><br><span class="line">        └── boot</span><br><span class="line">            └── loader</span><br><span class="line">                ├── ExecutableArchiveLauncher$1.class</span><br><span class="line">                ├── ExecutableArchiveLauncher.class</span><br><span class="line">                ├── JarLauncher.class</span><br><span class="line">				........</span><br><span class="line">                ├── PropertiesLauncher.class</span><br><span class="line">                ├── WarLauncher.class</span><br><span class="line">                ├── archive</span><br><span class="line">                │   ├── Archive$Entry.class</span><br><span class="line">				........</span><br><span class="line">                │   └── JarFileArchive.class</span><br><span class="line">                ├── data</span><br><span class="line">                │   ├── ByteArrayRandomAccessData.class</span><br><span class="line">				...........</span><br><span class="line">                │   └── RandomAccessDataFile.class</span><br><span class="line">                ├── jar</span><br><span class="line">                │   ├── AsciiBytes.class</span><br><span class="line">				...........</span><br><span class="line">                │   └── ZipInflaterInputStream.class</span><br><span class="line">                └── util</span><br><span class="line">                    └── SystemPropertyUtils.class</span><br></pre></td></tr></table></figure>
<h3 id="Spring-Boot-Loader简介"><a href="#Spring-Boot-Loader简介" class="headerlink" title="Spring-Boot-Loader简介"></a>Spring-Boot-Loader简介</h3><p>Springboot中jar文件格式固定如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">archive.jar</span><br><span class="line"> |</span><br><span class="line"> +-META-INF（1）</span><br><span class="line"> |  +-MANIFEST.MF</span><br><span class="line"> +-org（2）</span><br><span class="line"> |  +-springframework</span><br><span class="line"> |     +-boot</span><br><span class="line"> |        +-loader</span><br><span class="line"> |           +-&lt;spring boot loader classes&gt;</span><br><span class="line"> +-com（3）</span><br><span class="line"> |  +-mycompany</span><br><span class="line"> |     + project</span><br><span class="line"> |        +-YouClasses.class</span><br><span class="line"> +-lib（4）</span><br><span class="line">    +-dependency1.jar</span><br><span class="line">    +-dependency2.jar</span><br></pre></td></tr></table></figure>
<ul>
<li>结构（1）jar文件中MANIFEST.MF文件存放处</li>
<li>结构（2） Spring-boot-loader本身需要的class放置处</li>
<li>结构（3） 应用本身的文件放置处</li>
<li>结构（4）应用依赖的jar固定放到lib目录。</li>
</ul>
<p>那么spring-boot是如何去按照这个结构加载资源那？</p>
<ul>
<li>首先在打包时候会使用spring-boot-maven-plugin插件重写打成的jar文件，会设置META-INF/MANIFEST.MF中的<br><code>Main-Class: org.springframework.boot.loader.JarLauncher</code><br><code>Start-Class: com.mycompany.project.MyApplication</code><br>并拷贝spring-boot-loader包里面的class文件到结构（2），应用依赖拷贝到（4）应用类拷贝到（3）</li>
<li>通过java -jar archive.jar 运行时候Launcher会去加载JarLauncher类并执行其中的main函数，JarLauncher主要关心构造一个合适的URLClassLoader加载器用来调用我们应用程序（MyApplication）的main方法。</li>
</ul>
<h3 id="spring-boot-maven-plugin打包流程"><a href="#spring-boot-maven-plugin打包流程" class="headerlink" title="spring-boot-maven-plugin打包流程"></a>spring-boot-maven-plugin打包流程</h3><p><img src="/2017/02/13/spring/image-13.png" alt="img"></p>
<h3 id="JarLauncher执行流程分析"><a href="#JarLauncher执行流程分析" class="headerlink" title="JarLauncher执行流程分析"></a>JarLauncher执行流程分析</h3><p><img src="/2017/02/13/spring/image-14.png" alt="img"></p>
<p>如流程图首先使用Appclassloader加载了JarLauncher类并创建了LaunchedURLClassLoader类</p>
<p>而LaunchedURLClassLoader是属于spring-boot-loader.jar包里面的</p>
<p>而Appclassloader是普通的加载器不能加载嵌套的jar里面的文件</p>
<p>所以如果把spring-boot-loader.jar放到lib 目录下,Appclassloader将找不到LaunchedURLClassLoader。</p>
<p>所以在打包时候 拷贝本来应该放入到lib里面的spring-boot-loader.jar里面的class到结构(2)</p>
<h3 id="LaunchedURLClassLoader"><a href="#LaunchedURLClassLoader" class="headerlink" title="LaunchedURLClassLoader"></a>LaunchedURLClassLoader</h3><p> LaunchedURLClassLoader和普通的URLClassLoader的不同之处是，它提供了从JarFile里加载.class的能力。结合Archive提供的getEntries函数，就可以获取到JarFile里的Resource。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Jar URL</span><br><span class="line">jar:file:/tmp/target/demo-<span class="number">0.0</span>.1-SNAPSHOT.jar!/com/example/SpringBootDemoApplication.class</span><br></pre></td></tr></table></figure>
<p>jar包里的资源的URL;可以看到对于Jar里的资源，定义以’!/’来分隔。原始的JarFile URL只支持一个’!/’。</p>
<p>Spring boot扩展了这个协议，让它支持多个’!/’，就可以表示jar in jar，jar in directory的资源了。</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Jar URL</span><br><span class="line">jar:file:/tmp/target/demo-<span class="number">0.0</span>.1-SNAPSHOT.jar!/lib/spring-beans-<span class="number">4.2</span>.3.RELEASE.jar!/META-INF/MANIFEST.MF</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Spring boot通过注册了一个自定义的Handler类来处理多重jar in jar的逻辑。</p>
<p>自定义URLStreamHandler,扩展JarFile和JarURLConnection</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//org.springframework.boot.loader.jar.Handler</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Handler</span> <span class="keyword">extends</span> <span class="title">URLStreamHandler</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SEPARATOR = <span class="string">"!/"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> SoftReference&lt;Map&lt;File, JarFile&gt;&gt; rootFileCache;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> URLConnection <span class="title">openConnection</span><span class="params">(URL url)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.jarFile != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> JarURLConnection(url, <span class="keyword">this</span>.jarFile);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> JarURLConnection(url, getRootJarFileFromUrl(url));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            <span class="keyword">return</span> openFallbackConnection(url, ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> JarFile <span class="title">getRootJarFileFromUrl</span><span class="params">(URL url)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        String spec = url.getFile();</span><br><span class="line">        <span class="keyword">int</span> separatorIndex = spec.indexOf(SEPARATOR);</span><br><span class="line">        <span class="keyword">if</span> (separatorIndex == -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> MalformedURLException(<span class="string">"Jar URL does not contain !/ separator"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        String name = spec.substring(<span class="number">0</span>, separatorIndex);</span><br><span class="line">        <span class="keyword">return</span> getRootJarFile(name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Spring boot构造LaunchedURLClassLoader时，传递了一个URL[]数组。数组里是lib目录下面的jar的URL</p>
<p>实际流程如下:</p>
<ul>
<li>LaunchedURLClassLoader.loadClass</li>
<li>URL.getContent()</li>
<li>URL.openConnection()</li>
<li><p>Handler.openConnection(URL)</p>
<p>最终调用的是<code>JarURLConnection</code>的<code>getInputStream()</code>函数。</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//org.springframework.boot.loader.jar.JarURLConnection</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> InputStream <span class="title">getInputStream</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    connect();</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.jarEntryName.isEmpty()) &#123;</span><br><span class="line">    	<span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"no entry name specified"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.jarEntryData.getInputStream();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>从一个URL，到最终读取到URL里的内容，整个过程是比较复杂的，总结下：</p>
<ul>
<li>spring boot注册了一个Handler来处理”jar:”这种协议的URL</li>
<li>spring boot扩展了JarFile和JarURLConnection，内部处理jar in jar的情况</li>
<li>在处理多重jar in jar的URL时，spring boot会循环处理，并缓存已经加载到的JarFile</li>
<li>对于多重jar in jar，实际上是解压到了临时目录来处理，可以参考JarFileArchive里的代码</li>
<li>在获取URL的InputStream时，最终获取到的是JarFile里的JarEntryData</li>
</ul>
<p><br></p>
<p><br></p>
<h2 id="Reactive"><a href="#Reactive" class="headerlink" title="Reactive"></a>Reactive</h2><h3 id="Servlet3-1异步机制"><a href="#Servlet3-1异步机制" class="headerlink" title="Servlet3.1异步机制"></a>Servlet3.1异步机制</h3><ul>
<li>一个<code>ServletRequest</code>可以通过调用 <code>request.startAsync()</code>被放到一个异步的模块中.这样做的主要作用是Servlet,以及任何过滤器,可以退出,但是响应仍将允许开放直到处理完成后。</li>
<li>调用<code>request.startAsync()</code>返回<code>AsyncContext</code>可以用于进一步控制异步处理。例如,它提供一个方法叫<code>dispatch</code>,这个类似于Servlet API,并且它允许应用程序通过Servlet容器线程继续请求处理。</li>
<li><code>ServletRequest</code>提供获取当前<code>DispatcherType</code>的接口.DispatcherType可以用来区分处理初始请求,一个异步分发,forward,以及其他分发类型。</li>
</ul>
<p>记住上面的,下面是通过<code>Callable</code>异步请求处理事件的序列:</p>
<ul>
<li>Controller返回一个<code>Callable</code>对象.</li>
<li>Spring MVC开始异步处理并且提交<code>Callable</code>到<code>TaskExecutor</code>在一个单独的线程中进行处理。</li>
<li><code>DispatcherServlet</code>与所有的Filter的Servlet容器线程退出,但Response仍然开放。</li>
<li><code>Callable</code>产生结果并且Spring MVC分发请求给Servlet容器继续处理.</li>
<li><code>DispatcherServlet</code>再次被调用并且继续异步的处理由Callable产生的结果</li>
</ul>
<p><code>DeferredResult</code>的处理顺序与Callable十分相似,由应用程序多线程产生异步结果:</p>
<ul>
<li>Controller返回一个<code>DeferredResult</code>对象,并且把它保存在内在队列当中或者可以访问它的列表中。</li>
<li>Spring MVC开始异步处理.</li>
<li><code>DispatcherServlet</code>与所有的Filter的Servlet容器线程退出,但Response仍然开放。</li>
<li><code>application</code>通过多线程返回<code>DeferredResult</code>中sets值.并且Spring MVC分发<code>request</code>给<code>Servlet</code>容器</li>
<li><code>DispatcherServlet</code>再次被调用并且继续异步的处理产生的结果.</li>
</ul>
<h3 id="异步支持模式"><a href="#异步支持模式" class="headerlink" title="异步支持模式"></a>异步支持模式</h3><p>SpringMVC对Servlet3异步请求的支持有两种方式</p>
<ul>
<li><p>Callable</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">返回方法是Callable类型时会默认发起异步请求</span><br><span class="line">并使用一个TaskExecutor来调用返回的Callable</span><br><span class="line">之后的处理就跟正常的SpringMVC请求是一样的</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"callable"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Callable&lt;String&gt; <span class="title">callable</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ()-&gt;&#123;</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"callable"</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//执行流程</span></span><br><span class="line">RequestMappingHandlerAdapter#handleInternal-&gt;RequestMappingHandlerAdapter#invokeHandlerMethod</span><br><span class="line">ServletInvocableHandlerMethod#invokeAndHandle</span><br><span class="line">CallableMethodReturnValueHandler#handleReturnValue</span><br><span class="line"></span><br><span class="line"><span class="comment">//产生结果并且Spring MVC分发请求给Servlet容器继续处理</span></span><br><span class="line">WebAsyncManager#setConcurrentResultAndDispatch</span><br><span class="line">WebAsyncManager#this.asyncWebRequest.dispatch();</span><br><span class="line"></span><br><span class="line"><span class="comment">//Servlet容器拿取结果</span></span><br><span class="line"><span class="comment">//DispatcherServlet再次被调用并且继续异步的处理产生的结果</span></span><br><span class="line">RequestMappingHandlerAdapter#invokeHandlerMethod</span><br><span class="line"><span class="keyword">if</span> (asyncManager.hasConcurrentResult()) &#123;</span><br><span class="line">    Object result = asyncManager.getConcurrentResult();</span><br><span class="line">    mavContainer = (ModelAndViewContainer) asyncManager.getConcurrentResultContext()[<span class="number">0</span>];</span><br><span class="line">    asyncManager.clearConcurrentResult();</span><br><span class="line">	<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">		logger.debug(<span class="string">"Found concurrent result value ["</span> + result + <span class="string">"]"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	invocableMethod = invocableMethod.wrapConcurrentResult(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>DeferredResult</p>
<p> 步骤如上差不多</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"deferredResult"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> DeferredResult&lt;String&gt; <span class="title">deferredResult</span><span class="params">()</span></span>&#123;</span><br><span class="line">    DeferredResult&lt;String&gt; deferredResult = <span class="keyword">new</span> DeferredResult&lt;&gt;();</span><br><span class="line">    <span class="keyword">new</span> Thread(() -&gt; deferredResult.setResult(<span class="string">"ok"</span>)).start();</span><br><span class="line"></span><br><span class="line">    deferredResult.onCompletion(()-&gt;&#123;</span><br><span class="line">    	log.info(<span class="string">"completion"</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> deferredResult;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="Rxjava-Deferred-Result"><a href="#Rxjava-Deferred-Result" class="headerlink" title="Rxjava+Deferred Result"></a>Rxjava+Deferred Result</h3><blockquote>
<p>利用Rxjava的线程调度</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebMvcConfig</span> <span class="keyword">extends</span> <span class="title">WebMvcConfigurerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addResourceHandlers</span><span class="params">(ResourceHandlerRegistry registry)</span> </span>&#123;</span><br><span class="line">        registry.addResourceHandler(<span class="string">"/resources/**"</span>).addResourceLocations(<span class="string">"static"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addReturnValueHandlers</span><span class="params">(List&lt;HandlerMethodReturnValueHandler&gt; returnValueHandlers)</span> </span>&#123;</span><br><span class="line">        returnValueHandlers.add(<span class="keyword">new</span> ObservableReturnValueHandler());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ObservableReturnValueHandler</span>  <span class="keyword">implements</span> <span class="title">AsyncHandlerMethodReturnValueHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAsyncReturnValue</span><span class="params">(Object returnValue, MethodParameter returnType)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> supportsReturnType(returnType);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supportsReturnType</span><span class="params">(MethodParameter returnType)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Observable.class.isAssignableFrom(returnType.getParameterType());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleReturnValue</span><span class="params">(Object returnValue, MethodParameter returnType, ModelAndViewContainer mavContainer,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  NativeWebRequest webRequest)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Observable&lt;?&gt; observable = Observable.class.cast(returnValue);</span><br><span class="line">        WebAsyncUtils.getAsyncManager(webRequest)</span><br><span class="line">                .startDeferredResultProcessing(<span class="keyword">new</span> ObservableAdapter&lt;&gt;(observable), mavContainer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ObservableAdapter</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">DeferredResult</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">        ObservableAdapter(Observable&lt;T&gt; observable) &#123;</span><br><span class="line">            observable.subscribe(<span class="keyword">this</span>::setResult, <span class="keyword">this</span>::setErrorResult);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Observable&lt;IndexVO&gt; <span class="title">index</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> indexService</span><br><span class="line">        .getMessage(<span class="string">"San"</span>)</span><br><span class="line">        .map((data)-&gt;IndexVO.builder().message(data.getMessage()).build());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="异步拦截"><a href="#异步拦截" class="headerlink" title="异步拦截"></a>异步拦截</h3><p>一个<code>HandlerInterceptor</code>可样也可以实现<code>AsyncHandlerInterceptor</code>,通过实现它的<code>afterConcurrentHandlingStarted</code>方法进行回调.当进行异步处理的时候,将会调用<code>afterConcurrentHandlingStarted</code>而不是<code>postHandle</code>和<code>afterCompletion</code>.</p>
<p>一个<code>HandlerInterceptor</code>同样可以注册<code>CallableProcessingInterceptor</code>或者一个<code>DeferredResultProcessingInterceptor</code>用于更深度的集成异步request的生命周期.例如处理一个timeout事件.你可以参看<code>AsyncHandlerInterceptor</code>的Javadoc了解更多细节.</p>
<p><code>DeferredResult</code>类也提供了方法,像<code>onTimeout(Runnable)</code>和<code>onCompletion(Runnable)</code>.可以看DeferredResult了解更多细节.</p>
<p>当使用<code>Callable</code>的时候,你可以通过<code>WebAsyncTask</code>来对它进行包装.这样也可以提供注册timeout与completion方法.</p>
<h3 id="HTTP-Streaming"><a href="#HTTP-Streaming" class="headerlink" title="HTTP Streaming"></a>HTTP Streaming</h3><p><code>ResponseBodyEmitter</code>允许通过<code>HttpMessageConverter</code>把发送的events写到对象到response中</p>
<p>例如写JSON数据.可是有时候它被用来绕开message转换直接写入到response的<code>OutputStream</code>。</p>
<p>例如文件下载.这样可以通过返回<code>StreamingResponseBody</code>类型的值做到.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/events"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ResponseBodyEmitter <span class="title">handle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ResponseBodyEmitter emitter = <span class="keyword">new</span> ResponseBodyEmitter();</span><br><span class="line">    <span class="comment">// Save the emitter somewhere..</span></span><br><span class="line">    <span class="keyword">return</span> emitter;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// In some other thread</span></span><br><span class="line">emitter.send(<span class="string">"Hello once"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// and again later on</span></span><br><span class="line">emitter.send(<span class="string">"Hello again"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// and done at some point</span></span><br><span class="line">emitter.complete();</span><br></pre></td></tr></table></figure>
<p><code>转自csdn</code></p>

        
    </section>
</article>



<div class="comments">
    <div id="disqus_thread">
        <p class="comment-tips">国内查看评论需要代理~</p>
    </div>
    <script>
    window.disqus_config = function () {
        this.language = 'zh';
        this.page.url = 'http://www.coderss.cn/2017/02/13/spring/';
        this.page.title = 'Spring详解';
        this.page.identifier = '2017/02/13/spring/';
    };
    (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        s.src = 'https://name.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>

</div>
        <footer class="footer">
    Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, Theme by <a href="https://github.com/sanonz/hexo-theme-concise" target="_blank">Concise</a>
</footer>

<script type="text/javascript" src="//s13.cnzz.com/z_stat.php?id=1234567890&amp;web_id=1234567890"></script>


    </div>

    <script type="text/javascript" src="https://cdn.bootcss.com/jquery/1.9.0/jquery.min.js"></script>
    
    <script type="text/javascript" src="/js/scrollspy.min.js"></script>
    
    <script type="text/javascript">
        $(function() {
            var nodes = {
                nav: $('#nav'),
                aside: $('#aside'),
                navTags: $('#nav-tags')
            };

            $('#open-panel, #aside-mask').on('click', function() {
                nodes.aside.toggleClass('panel-show');
            });
            $('#nav-tag').on('click', function(event) {
                event.preventDefault();console.log(nodes.navTags.attr('class'))
                nodes.navTags.toggleClass('tag-show');console.log(nodes.navTags.attr('class'))
            })/*.hover(function() {
                nodes.navTags.addClass('tag-show');
            }, function() {
                nodes.navTags.removeClass('tag-show');
            });*/

            
            $(document.body).scrollspy({target: '#aside-inner'});
            
        });
    </script>

</body>
</html>
