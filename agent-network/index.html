<!DOCTYPE html>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="UTF-8">

    

    

    <title>Agent优化意见 | Coderss</title>
    <meta name="author" content="coder">
    <meta name="version" content="1.0.0">
    <meta name="keywords" content="">
    <meta name="description" content="技术笔记">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <meta name="baidu-site-verification" content="F0CXvmUgA9">

    
    
    <link rel="icon" href="/favicon.png">
    

    <link rel="stylesheet" href="/css/style.css">
</head>
<body>

    <div class="app">
        <header class="header clearfix">
    <div id="nav" class="nav">
    <button id="open-panel" class="open-panel"><i class="icon-library"></i></button>

    <nav class="nav-inner">

        
        
        <li class="nav-item">
            <a class="nav-link" href="/">首页</a>
        </li>
        
        
        
        <li class="nav-item">
            <a class="nav-link" href="/categories/back-end">Java前后端</a>
        </li>
        
        
        
        <li class="nav-item">
            <a class="nav-link" href="/categories/cpp">Cpp嵌入式</a>
        </li>
        
        
        
        <li class="nav-item">
            <a class="nav-link" href="/categories/go">Go云原生</a>
        </li>
        
        
        
        <li class="nav-item">
            <a class="nav-link" href="/categories/cloud">Linux安全</a>
        </li>
        
        
        
        <li class="nav-item">
            <a class="nav-link" href="/categories/reverse">Win安全</a>
        </li>
        
        
        
        <li class="nav-item">
            <a class="nav-link" href="/categories/data">数据与算法</a>
        </li>
        
        
        
        <li class="nav-item">
            <a class="nav-link" href="/categories/work">工作相关</a>
        </li>
        
        
        
        <li class="nav-item nav-item-tag">
            <a id="nav-tag" class="nav-link" href="#">文章标签</a>
            <div id="nav-tags" class="nav-tag-wrap">
                <i class="nav-tag-arrow"></i>
                
  <div class="widget-wrap">
    <h3 class="widget-title">
        <i class="icon-tag vm"></i>
        <span class="vm">Tags</span>
    </h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/AI/">AI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Boost库/">Boost库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Collection/">Collection</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cpp编程/">Cpp编程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Fescar/">Fescar</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Gc/">Gc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/K8s/">K8s</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MapReduce/">MapReduce</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Math/">Math</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Net/">Net</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nosql/">Nosql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python计算库/">Python计算库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Rust/">Rust</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Sharding-jdbc/">Sharding-jdbc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SkyWalking/">SkyWalking</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spark/">Spark</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TensorFlow/">TensorFlow</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Turi/">Turi</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Windows系统/">Windows系统</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Windows驱动/">Windows驱动</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Yarn/">Yarn</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/assembly/">assembly</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/c-cpp语言/">c/cpp语言</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/debug/">debug</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/design/">design</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dubbo/">dubbo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/eth/">eth</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/flume/">flume</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go/">go</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go-kernel/">go-kernel</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/io/">io</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/">java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/juc/">juc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kubernetes/">kubernetes</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/map/">map</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mfc/">mfc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/microservice/">microservice</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mybatis/">mybatis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/netty/">netty</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python-book/">python-book</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/qt/">qt</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sentinel/">sentinel</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/skycoin/">skycoin</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spring/">spring</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spring-cloud/">spring-cloud</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/stl/">stl</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tomcat/">tomcat</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/x86-Windows系统总结/">x86 Windows系统总结</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/中台/">中台</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/分布式文件系统/">分布式文件系统</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/多线程编程/">多线程编程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/嵌入式/">嵌入式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/架构/">架构</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/消息队列/">消息队列</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/网络编程/">网络编程</a></li></ul>
    </div>
  </div>


            </div>
        </li>
        
        
        
        <li class="nav-item">
            <a class="nav-link" href="/archives">历史归档</a>
        </li>
        
        
        

    </nav>
</div>

    <aside id="aside" class="aside">
    <div id="aside-mask" class="aside-mask"></div>
    <div id="aside-inner" class="aside-inner">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit"><i class="icon-search-stroke"></i></button><input type="hidden" name="sitesearch" value="http://www.coderss.cn"></form>

        
        
        
        
        

        
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#威胁转移优化"><span class="toc-number">1.</span> <span class="toc-text">威胁转移优化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#现状"><span class="toc-number">1.1.</span> <span class="toc-text">现状</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#改进点"><span class="toc-number">1.2.</span> <span class="toc-text">改进点</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#网络优化点"><span class="toc-number">2.</span> <span class="toc-text">网络优化点</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#存在的问题"><span class="toc-number">2.1.</span> <span class="toc-text">存在的问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#消息体编码优化方向"><span class="toc-number">2.2.</span> <span class="toc-text">消息体编码优化方向</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ProtoBuf3"><span class="toc-number">2.2.1.</span> <span class="toc-text">ProtoBuf3</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#分析"><span class="toc-number">2.2.1.1.</span> <span class="toc-text">分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#总结"><span class="toc-number">2.2.1.2.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#编码原理"><span class="toc-number">2.2.1.3.</span> <span class="toc-text">编码原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#增加编码方式方案"><span class="toc-number">2.2.1.4.</span> <span class="toc-text">增加编码方式方案</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#网络通信优化方向"><span class="toc-number">2.3.</span> <span class="toc-text">网络通信优化方向</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#通信框架选型"><span class="toc-number">2.3.1.</span> <span class="toc-text">通信框架选型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NettyClient设计"><span class="toc-number">2.3.2.</span> <span class="toc-text">NettyClient设计</span></a></li></ol></li></ol></li></ol>
        
    </div>
</aside>

</header>

        <div id="content" class="content"><article class="article" itemscope="" itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
           Agent优化意见
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="/agent-network/index.html">
    
    <i class="icon-calendar"></i>
    
    <time datetime="2022-05-10T03:05:45.000Z" itemprop="datePublished">2022-05-10</time>
</a>

            

        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <h1 id="威胁转移优化"><a href="#威胁转移优化" class="headerlink" title="威胁转移优化"></a>威胁转移优化</h1><p>威胁转移, 优化再深, 但是如果漏洞检测和计算逻辑附属在业务进程上, 威胁隐患始终存在</p>
<h2 id="现状"><a href="#现状" class="headerlink" title="现状"></a>现状</h2><blockquote>
<p>现状涉及的危险项</p>
</blockquote>
<ul>
<li>隔离性: 业务进程和SecpointAgent处于同一个进程空间, 漏洞检测逻辑和业务进程无法进行资源上的隔离, 虽然有资源熔断, 但是风险极高<ul>
<li>内存: 占用大量的Hook点, 计算逻辑所需的内存</li>
<li>CPU: 污染源拆分计算消耗大量的Cpu</li>
<li>网络: 上报漏洞占用带宽资源</li>
<li>异常: 异常崩溃会想到了</li>
<li>云原生: 违背了云原生提倡的容器隔离, 容器资源限制方向(漏洞采样检测与我业务进程同一份共享资源下, 我无法去限制漏洞采样检测的硬件资源, 限制他等同于限制我自身)</li>
</ul>
</li>
<li>工作职责: Agent大多数只负责采样, 不负责逻辑计算工作, 但是Astp服务资源有限, 无法将计算资源挪上云端, 计算资源放置何处?</li>
<li>重复冗余工作: 每开发一个Agent, 应当只负责当前语言栈的Hook点插桩, 而搜集上来的污点数据处理都是重复工作, 应当制定一套统一的污点数据协议标准, 把污点数据汇聚到统一的进程</li>
</ul>
<h2 id="改进点"><a href="#改进点" class="headerlink" title="改进点"></a>改进点</h2><p><img src="/agent-network/index/image-01.png" width="900px"></p>
<blockquote>
<p>具体的改进情景</p>
</blockquote>
<p>用Golang+Cgo新写一个漏洞处理进程, 主要负责一个<code>”挪&quot;</code>,三个<code>通信</code></p>
<ul>
<li>挪:  一定要将有风险、有资源占用、影响业务进程的逻辑提取出来, 污染源拆分以及漏洞汇报等(等同于除采样逻辑外基本全都移到当前进程)</li>
<li>通信一: 漏洞处理进程与Agent进程的业务数据得以内存物理页共享的方式达到采样的污点数据完全实时</li>
<li>通信二: 漏洞处理进程留出UDS(Unix Domain Socket)通道, 跟采样端-沟通策略管理和特性管理功能参数的设定</li>
<li>通信三: 漏洞处理进程要与ASTP汇报漏洞数据</li>
</ul>
<p>原有的SecpointAgent砍的剩以下功能</p>
<ul>
<li>创建内存物理页共享映射区</li>
<li>Policy解析及Hook点插桩</li>
<li>将Hook点的数据流转到<code>内存共享映射区</code></li>
<li>需要业务逻辑通过UDS(Unix Domain Socket)通道/Pipeline通道通知<code>漏洞处理进程 - 处理污点漏洞数据</code></li>
<li>接收USD(Unix Domain Socket)通道的指令<code>策略管理-采样方向</code></li>
</ul>
<blockquote>
<p>优势 </p>
</blockquote>
<ul>
<li>隔离性: 正式和业务进程解耦, 脱离业务进程资源占用, 增加用户业务方信任感</li>
<li>自身风险: 自身除了有熔断, 可符合云原生 docker cgroup进行cpu、内存上的资源限制, 符合k8s的sidecar设计</li>
<li>增值服务: 到时候拓展 漏洞处理进程的能力, 结合部分eBPF 插桩程序, 可往HIDS方向侧拓展, 增加公司增值业务</li>
<li>规划标准: 漏洞检测程序可规划标准, 各个语言栈遵守标准, 只负责采样工作, 开发量下降, 消除冗余工作</li>
</ul>
<p><br><br><br></p>
<h1 id="网络优化点"><a href="#网络优化点" class="headerlink" title="网络优化点"></a>网络优化点</h1><h2 id="存在的问题"><a href="#存在的问题" class="headerlink" title="存在的问题"></a>存在的问题</h2><ul>
<li>1、消息一旦过多(不是消息过大),就会出现丢失消息的情况</li>
<li>2、Agent网络断开重连,就1013错误码然后Agent自主认为可通信, Astp断开, 造成单个应用单个Agent网络不好的情况下多服务器场景</li>
<li>3、漏洞打主动验证的标, 但是漏洞竟然不存在, Agent认为传输过去了,Astp没有收到, 这个和第一个问题应该是一样的</li>
</ul>
<blockquote>
<p>新出现现象</p>
</blockquote>
<ul>
<li>1: download资源下载会卡住, outputstream.write connectect reset by peer</li>
<li>2: 逻辑问题: 报道和下载,  我们先下载后报道</li>
<li>3: websocket: secpointId的seesion会话丢失, Websocket IoException </li>
</ul>
<blockquote>
<p>解决思路</p>
</blockquote>
<ul>
<li><p>1、针对第一个问题</p>
<ul>
<li>可能消息编码上进行压缩, 先让传输的字节数据尽量小 </li>
<li><p>现有流程从queue中取数据在write&amp;flush, queue可能会在阻塞情况下出现丢失现象</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">从这里看其实这个不算是问题, 类似CAP理论一样, 性能和一致性肯定是不能两者都取</span><br><span class="line">可以牺牲一定的数据一致性, 让应用更加稳定(内存占用少)和高性能(CPU逻辑处理少)</span><br></pre></td></tr></table></figure>
</li>
<li><p>(需要Tcp层新的通信框架支持)将编码后的字节数组, 在数组长度超过一定阈值时, 提前在用户空间buffer传输到内核协议栈buffer时进行数组切片, 以免用户态Buffer过大内存出现抖动, 在接收端ByteToMessage处理这类的数据包,防止粘和过半出现消息问题</p>
</li>
</ul>
</li>
</ul>
<ul>
<li>2、针对第二个问题<ul>
<li>Registry注册, 唯一值的确认(这个困扰了后端的问题, 并且确定唯一值, 后端能够在大并发模式下不大量操作Agent表引起Mysql的性能问题)</li>
<li>Agent端的处理Host主机模式下确认唯一的一台主机而不重复,让其Secpoint固定下来, 后端的处理二分钟内不允许1013(现状发现重复大多数一分钟内还有老的secpointId通信)</li>
</ul>
</li>
</ul>
<h2 id="消息体编码优化方向"><a href="#消息体编码优化方向" class="headerlink" title="消息体编码优化方向"></a>消息体编码优化方向</h2><blockquote>
<p>可选择多种编码方式</p>
</blockquote>
<ul>
<li>json</li>
<li>protobuf</li>
</ul>
<h3 id="ProtoBuf3"><a href="#ProtoBuf3" class="headerlink" title="ProtoBuf3"></a>ProtoBuf3</h3><h4 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h4><blockquote>
<p>数据模板</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">message Data &#123;</span><br><span class="line">	message DataItem &#123;</span><br><span class="line">		int32 id = 1;</span><br><span class="line">		string string_id = 2;</span><br><span class="line">		repeated string string_arr = 3;</span><br><span class="line">		double double_id = 4;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	int32 id = 1;</span><br><span class="line">	string string_id = 2;</span><br><span class="line">	repeated string string_arr = 3;</span><br><span class="line">	double double_id = 4;</span><br><span class="line">	repeated double double_arr_id = 5;</span><br><span class="line">	DataItem data_item = 6;</span><br><span class="line">	repeated DataItem data_item_arr = 7;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>压缩比率差</p>
</blockquote>
<table>
<thead>
<tr>
<th>ProtoBuf3</th>
<th>Json数据 </th>
</tr>
</thead>
<tbody>
<tr>
<td><img src="/agent-network/index/image-02.png" width="400px"></td>
<td><img src="/agent-network/index/image-03.png" width="400px"></td>
</tr>
</tbody>
</table>
<blockquote>
<p>压缩速度</p>
</blockquote>
<p>混杂模式下(整数、浮点、对象、多对象、字符串):<br>ProtoBuf 当前一百万次复杂对象编码及解码完成,耗时:814ms<br>Json 当前一百万次复杂编码及解码完成,耗时:2240ms<br>编码效率差距在两三倍左右</p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>首先压缩比率上面, JSON肯定没有Protobuf压缩率好的, 基本最少也得有一倍的差距<br>其次在压缩速度上面, 如果原先的JSON有很多整数或浮点数据, 压缩速度上的提升很明显, 但是如果字符串占大头的话, 压缩的效率并没有提升很多可能在2倍之内的情况</p>
<h4 id="编码原理"><a href="#编码原理" class="headerlink" title="编码原理"></a>编码原理</h4><h4 id="增加编码方式方案"><a href="#增加编码方式方案" class="headerlink" title="增加编码方式方案"></a>增加编码方式方案</h4><p>这里建议先从攻击日志及漏洞上报看增加protobuf编码后是否有性能改善,试错成本较小<br>毕竟在上面编码方案总结上, JSON中含有大量的字符串数据, 压缩比率和压缩速度上并没有占多大的好处</p>
<p>前期也不需要.proto文件, 利用protostuff直接对POJO进行序列化和反序列化, 主要看这个编码形式能否对传输造成一定的优化</p>
<blockquote>
<p>Agent端处理</p>
</blockquote>
<img src="http://www.plantuml.com/plantuml/svg/XLJTJXf15BxVfzW7m1VWmaHjqhHfgoccJHflbcKqLjqXxD3KEq1KvB-2jA95RA3W1LeJYyAYF4ptpEo-HOSEu4AtwSrcPyxvlltETyvP5MiaX3Vb1RorXJL97HvzI5t2wnfPu6VqaJZltoA_3wiRQ13Ja4fmQ1oTy-iafAY4P_qTNC01fCu5b211ZvTB8KomFxpw4kcwiePUh1CaIKBBpEoK2AyS3WOKWjw4DpLTjledrdcQzdBqfcBU9Mco_Z_SQqKFpX6Yg1iZSD60VMC8bgPGBZHhZffbMktGp2NixTexJPh-P4SE89-m8p5MZblz2itMxKZPZXPSQV-sq2lhI0iyKOWoqjPEqEWLv3XnL7A5pCowsUsLkRKVK8WCk9Rn_3P1-WGbwvLODIffc20PyqGPhyhkHAQHjVh7zdwQvWvXjmwrCcja19oMEj3ByLAX5cVvFJXkJhRNZN1crfdYbP6cylElI9HVyXTwz8FxAJbpfX4qViREwd1VW8CCQvNOKTt3RQUfYx7pGXsNCrdV90ryZz7AgPD6i8ncKP1uP4WSG-y8zhkJWG7xf4gN8HwqWQVGIXoChaECQwfepoWq7rxV30YW1phjSN1r41Gk3OLqscQlolL1wxELZF4GC-8hsh1dVmYu9IDQyov2huhyoKSMBZkiTM0QjyzzYwyM_UzvVrOqg6KWqQQ5Z7b_2hahQ-VUx9NjI9KcylQthr0h3ThDiQqlS9XUK-6aGejj6cdmHCcbhEdc3QKAruL-XspkTZxBZ9QezkcxPqkGJR7U1UIIKBiPh5ZnONaxYDYr0PNKbF_kuoke12sNBfmJ2qL_HbapzOyfTMSBO1zVK472Ix4U2ewkkaEOqU2V5X3-Cp3xvqCFRklSOezrUG6xRQlRXTFcUBlXElQezQx1_qs_0G00">
<blockquote>
<p>Server端处理</p>
</blockquote>
<img src="http://www.plantuml.com/plantuml/svg/PO_1IW9H58RtynJt0V85NBHeKRa81Wo2TkDuZLBkYJkt67TQGumpwGn4OnI5qPIrI0qa4grUfdFl-1ODQ0IwF1__-Ny-4vZWK24xj907iqn5dl9ZoZLppctRtZHOiP8YRI6JMLq0MG9iYrgMiKVNWQzL1RM8V7TblO-neyAp37wrqHtWQplnJkJbG8qTZO6W1D9d0YMor2Sx8zdiMTJKOP-9N17T67lN-7c1ZQQywcFuf7CGK3WggKcaEdKPZN0IhAXXLxOUrMqj-Rv9xiytTdDwqdt0be-1X_5mUlgCGRHTFQJgROnt_hBOltMMOEYaiVav4_dvyAQrXlHV_jRJzdIT02S7XbcsWCt0Bm00">
<p><br><br><br></p>
<h2 id="网络通信优化方向"><a href="#网络通信优化方向" class="headerlink" title="网络通信优化方向"></a>网络通信优化方向</h2><ul>
<li>协议的选型<ul>
<li>websocket协议</li>
<li>quic协议</li>
<li>tcp协议</li>
<li>http/2</li>
</ul>
</li>
<li>通信框架的优化<ul>
<li>JavaAgent端Netty</li>
</ul>
</li>
</ul>
<h3 id="通信框架选型"><a href="#通信框架选型" class="headerlink" title="通信框架选型"></a>通信框架选型</h3><p>现状如果选用Netty进行通信的好处</p>
<ul>
<li>可以基于多个协议进行切换, 不会造成于一个框架依赖于一个协议</li>
<li>多连接通道性能会突出一点(占用资源也会大一点)</li>
<li>事件即来即发</li>
</ul>
<p><img src="/agent-network/index/image-04.png" width="1000px"></p>
<blockquote>
<p>Agent和Server端需要引入的Java库文件</p>
</blockquote>
<p><img src="/agent-network/index/image-05.png" width="300px"></p>
<ul>
<li>由于是Netty框架要兼容多种场景, 而我们Agent端根据自己的情况阉割很多类似Logging和container部分</li>
</ul>
<h3 id="NettyClient设计"><a href="#NettyClient设计" class="headerlink" title="NettyClient设计"></a>NettyClient设计</h3><p>有了以上的Netty阉割简洁之后,开始适配我们的传输模块, 主要由<code>SecPointContext#getConnector()</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IAbstractSecConnector</span></span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">reconnect</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">sendData</span><span class="params">(Object message, IServerDataType dataType)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">sendData</span><span class="params">(Object message, IServerDataType dataType, <span class="keyword">boolean</span> isCompressor)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">disconnect</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

        
    </section>
</article>



<div class="comments">
    <div id="disqus_thread">
        <p class="comment-tips">国内查看评论需要代理~</p>
    </div>
    <script>
    window.disqus_config = function () {
        this.language = 'zh';
        this.page.url = 'http://www.coderss.cn/agent-network/index.html';
        this.page.title = 'Agent优化意见';
        this.page.identifier = 'agent-network/index.html';
    };
    (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        s.src = 'https://name.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>

</div>
        <footer class="footer">
    Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, Theme by <a href="https://github.com/sanonz/hexo-theme-concise" target="_blank">Concise</a>
</footer>

<script type="text/javascript" src="//s13.cnzz.com/z_stat.php?id=1234567890&amp;web_id=1234567890"></script>


    </div>

    <script type="text/javascript" src="https://cdn.bootcss.com/jquery/1.9.0/jquery.min.js"></script>
    
    <script type="text/javascript">
        $(function() {
            var nodes = {
                nav: $('#nav'),
                aside: $('#aside'),
                navTags: $('#nav-tags')
            };

            $('#open-panel, #aside-mask').on('click', function() {
                nodes.aside.toggleClass('panel-show');
            });
            $('#nav-tag').on('click', function(event) {
                event.preventDefault();console.log(nodes.navTags.attr('class'))
                nodes.navTags.toggleClass('tag-show');console.log(nodes.navTags.attr('class'))
            })/*.hover(function() {
                nodes.navTags.addClass('tag-show');
            }, function() {
                nodes.navTags.removeClass('tag-show');
            });*/

            
        });
    </script>

</body>
</html>
