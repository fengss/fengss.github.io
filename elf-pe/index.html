<!DOCTYPE html>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="UTF-8">

    

    

    <title>ELF_PE文件格式 | Coderss</title>
    <meta name="author" content="coder">
    <meta name="version" content="1.0.0">
    <meta name="keywords" content="">
    <meta name="description" content="技术笔记">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <meta name="baidu-site-verification" content="F0CXvmUgA9">

    
    
    <link rel="icon" href="/favicon.png">
    

    <link rel="stylesheet" href="/css/style.css">
</head>
<body>

    <div class="app">
        <header class="header clearfix">
    <div id="nav" class="nav">
    <button id="open-panel" class="open-panel"><i class="icon-library"></i></button>

    <nav class="nav-inner">

        
        
        <li class="nav-item">
            <a class="nav-link" href="/">首页</a>
        </li>
        
        
        
        <li class="nav-item">
            <a class="nav-link" href="/categories/back-end">Java栈</a>
        </li>
        
        
        
        <li class="nav-item">
            <a class="nav-link" href="/categories/cpp">C/C++</a>
        </li>
        
        
        
        <li class="nav-item">
            <a class="nav-link" href="/categories/go">Go/Rust</a>
        </li>
        
        
        
        <li class="nav-item">
            <a class="nav-link" href="/categories/cloud">系统内核</a>
        </li>
        
        
        
        <li class="nav-item">
            <a class="nav-link" href="/categories/reverse">威胁追踪</a>
        </li>
        
        
        
        <li class="nav-item">
            <a class="nav-link" href="/categories/data">数据库</a>
        </li>
        
        
        
        <li class="nav-item nav-item-tag">
            <a id="nav-tag" class="nav-link" href="#">标签</a>
            <div id="nav-tags" class="nav-tag-wrap">
                <i class="nav-tag-arrow"></i>
                
  <div class="widget-wrap">
    <h3 class="widget-title">
        <i class="icon-tag vm"></i>
        <span class="vm">Tags</span>
    </h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/AI/">AI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Boost库/">Boost库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Collection/">Collection</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cpp编程/">Cpp编程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Fescar/">Fescar</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Gc/">Gc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/K8s/">K8s</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MapReduce/">MapReduce</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Math/">Math</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python计算库/">Python计算库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Sharding-jdbc/">Sharding-jdbc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SkyWalking/">SkyWalking</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spark/">Spark</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TensorFlow/">TensorFlow</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Turi/">Turi</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Windows系统/">Windows系统</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Windows驱动/">Windows驱动</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Yarn/">Yarn</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/assembly/">assembly</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/c-cpp语言/">c/cpp语言</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/debug/">debug</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/design/">design</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dubbo/">dubbo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/eth/">eth</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/flume/">flume</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go/">go</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go-kernel/">go-kernel</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/io/">io</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/">java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/juc/">juc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kubernetes/">kubernetes</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/map/">map</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mfc/">mfc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/microservice/">microservice</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mybatis/">mybatis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/netty/">netty</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python-book/">python-book</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/qt/">qt</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sentinel/">sentinel</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/skycoin/">skycoin</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spring/">spring</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spring-cloud/">spring-cloud</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/stl/">stl</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tomcat/">tomcat</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/x86-Windows系统总结/">x86 Windows系统总结</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/中台/">中台</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/分布式文件系统/">分布式文件系统</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/多线程编程/">多线程编程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/架构/">架构</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/消息队列/">消息队列</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/网络编程/">网络编程</a></li></ul>
    </div>
  </div>


            </div>
        </li>
        
        
        
        <li class="nav-item">
            <a class="nav-link" href="/archives">归档</a>
        </li>
        
        
        

    </nav>
</div>

    <aside id="aside" class="aside">
    <div id="aside-mask" class="aside-mask"></div>
    <div id="aside-inner" class="aside-inner">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit"><i class="icon-search-stroke"></i></button><input type="hidden" name="sitesearch" value="http://www.coderss.cn"></form>

        
        
        
        
        

        
        <div class="author-meta">
            
            <div class="author-avatar">
                <a href="/">
                    <img src="/images/avatar.jpg" title="Sanonz">
                </a>
            </div>
            
            <div class="author-name">Coderss</div>
            <div class="author-work">愉快的敲代码</div>
            <div class="author-location">
                <i class="icon-location vm"></i>
                <span class="vm">HangZhou, China</span>
            </div>
            
            <div class="author-thread-wrap">
                <div class="author-threads clearfix">
                    
                    <a class="thread-item" href="https://github.com" target="_blank" rel="noopener"><i class="icon-github"></i></a>
                    
                    
                    <a class="thread-item" href="/business" target="_blank" rel="noopener"><i class="icon-circle-more"></i></a>
                    
                    
                    <a class="thread-item" href="https://twitter.com/Coder_1818" target="_blank" rel="noopener"><i class="icon-twitter"></i></a>
                    
                </div>
            </div>
            
        </div>
        
    </div>
</aside>

</header>

        <div id="content" class="content"><article class="article" itemscope="" itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            ELF_PE文件格式
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="/elf-pe/index.html">
    
    <i class="icon-calendar"></i>
    
    <time datetime="2022-05-24T09:24:55.000Z" itemprop="datePublished">2022-05-24</time>
</a>

            

        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <p>Winddows下的PE文件格式如下<br><img src="/elf-pe/index/image-01.png" width="1300px"></p>
<p>Linux下的ELF文件格式如下<br><img src="/elf-pe/index/image-02.png" width="700px"><br>关于文件格式解析的文章网上很多, 可以预览相关技术文章</p>
<p>这两种文件是这两个平台下相关的执行文件最终态<br>我现在的想法是如果根据这种文件格式的最终态<br>取调试符号信息,就能解析出当前执行文件的函数头, 如果去掉了符号信息则取引入的库函数信息<br>有这些函数之后,根据这些函数进行查找碰库, 一定的概率能搜罗到具体的第三方库情况<br>从这里看是否有开源许可风险等策略</p>
<p>linux官方库有readelf、ldd等命令支持,Windows有大量的PE区段读取支持</p>
<p>Linux平台读取Elf文件解析symtab及ld相关信息代码如下<br>使用方法: 官方可使用readelf、也可以拿我的编译为 elf “文件路径”</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;malloc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;elf.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">fileheader</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *pbuff)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">secheader</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *pbuff)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">tableheader</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *pbuff)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">outputsyminfo</span><span class="params">(<span class="keyword">const</span> Elf64_Sym *psym, <span class="keyword">const</span> <span class="keyword">char</span> *pbuffstr, <span class="keyword">int</span> ncount)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">proheader</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *pbuff)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">relocheader</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *pbuff)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (argc &lt; <span class="number">2</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//open file</span></span><br><span class="line">    <span class="keyword">int</span> fd = open(argv[<span class="number">1</span>], O_RDONLY, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span>  == fd)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">"open file error!\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//calc file size</span></span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">int</span> end = lseek(fd, <span class="number">0</span>, SEEK_END);</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">int</span> begin = lseek(fd, <span class="number">0</span>, SEEK_SET);</span><br><span class="line">    <span class="comment">//alloc size</span></span><br><span class="line">    <span class="keyword">char</span>* pbuff = <span class="built_in">malloc</span>(end);</span><br><span class="line">    <span class="keyword">if</span>(!pbuff)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"alloc fail\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memset</span>(pbuff, <span class="number">0</span>, end);</span><br><span class="line">    <span class="comment">//read file</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == read(fd, pbuff, end))</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">"read fail"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//strcmp command</span></span><br><span class="line">    <span class="keyword">if</span> (argc == <span class="number">3</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="built_in">strcmp</span>(argv[<span class="number">2</span>], <span class="string">"-h"</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//read File Header</span></span><br><span class="line">            fileheader(pbuff);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(!<span class="built_in">strcmp</span>(argv[<span class="number">2</span>], <span class="string">"-S"</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//read Section Header</span></span><br><span class="line">            secheader(pbuff);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="built_in">strcmp</span>(argv[<span class="number">2</span>], <span class="string">"-l"</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//read program header</span></span><br><span class="line">   			proheader(pbuff);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="built_in">strcmp</span>(argv[<span class="number">2</span>], <span class="string">"-r"</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//read reloc header</span></span><br><span class="line">            relocheader(pbuff);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    fileheader(pbuff);</span><br><span class="line">    secheader(pbuff);</span><br><span class="line">    <span class="comment">//read symbol table</span></span><br><span class="line">    tableheader(pbuff);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//read reloc header</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">relocheader</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *pbuff)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//get sectionheader</span></span><br><span class="line">    Elf64_Ehdr* pfilehead = (Elf64_Ehdr*)pbuff;</span><br><span class="line">    Elf64_Shdr* psecheader = (Elf64_Shdr*)(pbuff + pfilehead-&gt;e_shoff);</span><br><span class="line">    Elf64_Shdr* pshstr = (Elf64_Shdr*)(psecheader + pfilehead-&gt;e_shstrndx);</span><br><span class="line">    <span class="keyword">char</span>* pstrbuff = (<span class="keyword">char</span>*)(pbuff + pshstr-&gt;sh_offset);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i&lt;pfilehead-&gt;e_shnum;++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="built_in">strncmp</span>(psecheader[i].sh_name + pstrbuff, <span class="string">".rel"</span>, <span class="number">4</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">int</span> ncount = psecheader[i].sh_size / psecheader[i].sh_entsize;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"\r\nRelocation section '%s' at offset %0lX contains %d entries:\r\n"</span>, psecheader[i].sh_name + pstrbuff, psecheader[i].sh_offset,</span><br><span class="line">                   ncount);</span><br><span class="line">            Elf64_Rela* preltable = (Elf64_Rela*)(pbuff + psecheader[i].sh_offset);</span><br><span class="line"></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"%-16s  %-16s  %-16s  %-16s  %-16s\r\n"</span>, <span class="string">"Offset"</span>, <span class="string">"Info"</span>, <span class="string">"Type"</span>, <span class="string">"Sym.Value"</span>, <span class="string">"Sym.Name + Addend"</span>);</span><br><span class="line">            <span class="keyword">int</span> symnum = psecheader[i].sh_link;</span><br><span class="line">            <span class="keyword">int</span> strnum = psecheader[symnum].sh_link;</span><br><span class="line">            <span class="comment">//str addr</span></span><br><span class="line">            <span class="keyword">char</span>* prelstrbuf = (<span class="keyword">char</span>*)(psecheader[strnum].sh_offset + pbuff);</span><br><span class="line">            <span class="comment">//symbol</span></span><br><span class="line">            Elf64_Sym* psym = (Elf64_Sym*)(pbuff + psecheader[symnum].sh_offset);</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> n = <span class="number">0</span>;n&lt;ncount;++n)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%016lX  %016lX  "</span>, preltable[n].r_offset, preltable[n].r_info);</span><br><span class="line">                <span class="keyword">switch</span>(ELF64_R_TYPE(preltable[n].r_info))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">case</span> R_386_NONE:</span><br><span class="line">                        <span class="built_in">printf</span>(<span class="string">"%-16s"</span>, <span class="string">"R_386_NONE"</span>);<span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> R_386_32:</span><br><span class="line">                        <span class="built_in">printf</span>(<span class="string">"%-16s"</span>, <span class="string">"R_386_32"</span>);<span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> R_386_PC32:</span><br><span class="line">                        <span class="built_in">printf</span>(<span class="string">"%-16s"</span>, <span class="string">"R_386_PC32"</span>);<span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> R_386_GOT32:</span><br><span class="line">                        <span class="built_in">printf</span>(<span class="string">"%-16s"</span>, <span class="string">"R_386_GOT32"</span>);<span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> R_386_PLT32:</span><br><span class="line">                        <span class="built_in">printf</span>(<span class="string">"%-16s"</span>, <span class="string">"R_386_PLT32"</span>);<span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> R_386_COPY:</span><br><span class="line">                        <span class="built_in">printf</span>(<span class="string">"%-16s"</span>, <span class="string">"R_386_COPY"</span>);<span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> R_386_GLOB_DAT:</span><br><span class="line">                        <span class="built_in">printf</span>(<span class="string">"%-16s"</span>, <span class="string">"R_386_GLOB_DAT"</span>);<span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> R_386_JMP_SLOT:</span><br><span class="line">                        <span class="built_in">printf</span>(<span class="string">"%-16s"</span>, <span class="string">"R_386_JMP_SLOT"</span>);<span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> R_386_RELATIVE:</span><br><span class="line">                        <span class="built_in">printf</span>(<span class="string">"%-16s"</span>, <span class="string">"R_386_RELATIVE"</span>);<span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> R_386_GOTOFF:</span><br><span class="line">                        <span class="built_in">printf</span>(<span class="string">"%-16s"</span>, <span class="string">"R_386_GOTOFF"</span>);<span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> R_386_GOTPC:</span><br><span class="line">                        <span class="built_in">printf</span>(<span class="string">"%-16s"</span>, <span class="string">"R_386_GOTPC"</span>);<span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">default</span>:</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"  %016lX  "</span>, (psym + ELF64_R_SYM(preltable[n].r_info))-&gt;st_value);</span><br><span class="line"></span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%s + %lu\r\n"</span>, (<span class="keyword">char</span>*)(prelstrbuf + (psym + ELF64_R_SYM(preltable[n].r_info))-&gt;st_name), preltable[n].r_addend);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//read program header</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">proheader</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *pbuff)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//get program header</span></span><br><span class="line">    Elf64_Ehdr* pfilehead = (Elf64_Ehdr*)pbuff;</span><br><span class="line">    Elf64_Phdr* pproheader = (Elf64_Phdr*)(pbuff + pfilehead-&gt;e_phoff);</span><br><span class="line">    Elf64_Shdr* psecheader = (Elf64_Shdr*)(pbuff + pfilehead-&gt;e_shoff);</span><br><span class="line">    Elf64_Shdr* pshstr = (Elf64_Shdr*)(psecheader + pfilehead-&gt;e_shstrndx);</span><br><span class="line">    <span class="keyword">char</span>* pstrbuff = (<span class="keyword">char</span>*)(pbuff + pshstr-&gt;sh_offset);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Elf file type is"</span>);</span><br><span class="line">    <span class="keyword">switch</span>(pfilehead-&gt;e_type)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">" No file type\r\n"</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">" Relocatable file\r\n"</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">" Executable file\r\n"</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">" Shared object file\r\n"</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">" Core file\r\n"</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">" ERROR\r\n"</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Entry point 0X%0lX\r\n"</span>, pfilehead-&gt;e_entry);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"There are %d program headers, starting at offset %lu\r\n\r\n"</span>, pfilehead-&gt;e_phnum, pfilehead-&gt;e_phoff);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Program Headers:\r\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"  %-14s  %-16s  %-16s  %-16s\r\n"</span>, <span class="string">"Type"</span>, <span class="string">"Offset"</span>, <span class="string">"VirtAddr"</span>, <span class="string">"PhysAddr"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"  %-14s  %-16s  %-16s  %-6s  %-6s\r\n"</span>, <span class="string">""</span>, <span class="string">"FileSiz"</span>, <span class="string">"MemSiz"</span>, <span class="string">"Flags"</span>, <span class="string">"Align"</span>);</span><br><span class="line">    <span class="comment">//travelist program</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;pfilehead-&gt;e_phnum;++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//type</span></span><br><span class="line">        <span class="keyword">switch</span>(pproheader[i].p_type)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> PT_NULL:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"  %-14s  %016lX  %016lX  %016lX\r\n  %-14s  %016lX  %016lX  "</span>, <span class="string">""</span>, pproheader[i].p_offset, pproheader[i].p_vaddr,</span><br><span class="line">                       pproheader[i].p_paddr, <span class="string">""</span>, pproheader[i].p_filesz, pproheader[i].p_memsz);<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> PT_LOAD:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"  %-14s  %016lX  %016lX  %016lX\r\n  %-14s  %016lX  %016lX  "</span>, <span class="string">"LOAD"</span>, pproheader[i].p_offset, pproheader[i].p_vaddr,</span><br><span class="line">                       pproheader[i].p_paddr, <span class="string">""</span>, pproheader[i].p_filesz, pproheader[i].p_memsz);<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> PT_DYNAMIC:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"  %-14s  %016lX  %016lX  %016lX\r\n  %-14s  %016lX  %016lX  "</span>, <span class="string">"DYNAMIC"</span>, pproheader[i].p_offset, pproheader[i].p_vaddr,</span><br><span class="line">                       pproheader[i].p_paddr, <span class="string">""</span>, pproheader[i].p_filesz, pproheader[i].p_memsz);<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> PT_INTERP:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"  %-14s  %016lX  %016lX  %016lX\r\n  %-14s  %016lX  %016lX  "</span>, <span class="string">"INTERP"</span>, pproheader[i].p_offset, pproheader[i].p_vaddr,</span><br><span class="line">                       pproheader[i].p_paddr, <span class="string">""</span>, pproheader[i].p_filesz, pproheader[i].p_memsz);<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> PT_NOTE:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"  %-14s  %016lX  %016lX  %016lX\r\n  %-14s  %016lX  %016lX  "</span>, <span class="string">"NOTE"</span>, pproheader[i].p_offset, pproheader[i].p_vaddr,</span><br><span class="line">                       pproheader[i].p_paddr, <span class="string">""</span>, pproheader[i].p_filesz, pproheader[i].p_memsz);<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> PT_SHLIB:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"  %-14s  %016lX  %016lX  %016lX\r\n  %-14s  %016lX  %016lX  "</span>, <span class="string">"SHLIB"</span>, pproheader[i].p_offset, pproheader[i].p_vaddr,</span><br><span class="line">                       pproheader[i].p_paddr, <span class="string">""</span>, pproheader[i].p_filesz, pproheader[i].p_memsz);<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> PT_PHDR:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"  %-14s  %016lX  %016lX  %016lX\r\n  %-14s  %016lX  %016lX  "</span>, <span class="string">"PHDR"</span>, pproheader[i].p_offset, pproheader[i].p_vaddr,</span><br><span class="line">                       pproheader[i].p_paddr, <span class="string">""</span>, pproheader[i].p_filesz, pproheader[i].p_memsz);<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> PT_TLS:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"  %-14s  %016lX  %016lX  %016lX\r\n  %-14s  %016lX  %016lX  "</span>, <span class="string">"TLS"</span>, pproheader[i].p_offset, pproheader[i].p_vaddr,</span><br><span class="line">                       pproheader[i].p_paddr, <span class="string">""</span>, pproheader[i].p_filesz, pproheader[i].p_memsz);<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> PT_NUM:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"  %-14s  %016lX  %016lX  %016lX\r\n  %-14s  %016lX  %016lX  "</span>, <span class="string">"NUM"</span>, pproheader[i].p_offset, pproheader[i].p_vaddr,</span><br><span class="line">                       pproheader[i].p_paddr, <span class="string">""</span>, pproheader[i].p_filesz, pproheader[i].p_memsz);<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> PT_GNU_EH_FRAME:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"  %-14s  %016lX  %016lX  %016lX\r\n  %-14s  %016lX  %016lX  "</span>, <span class="string">"GNU_EH_FRAME"</span>, pproheader[i].p_offset, pproheader[i].p_vaddr,</span><br><span class="line">                       pproheader[i].p_paddr, <span class="string">""</span>, pproheader[i].p_filesz, pproheader[i].p_memsz);<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> PT_GNU_RELRO:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"  %-14s  %016lX  %016lX  %016lX\r\n  %-14s  %016lX  %016lX  "</span>, <span class="string">"GNU_RELRO"</span>, pproheader[i].p_offset, pproheader[i].p_vaddr,</span><br><span class="line">                       pproheader[i].p_paddr, <span class="string">""</span>, pproheader[i].p_filesz, pproheader[i].p_memsz);<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> PT_GNU_STACK:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"  %-14s  %016lX  %016lX  %016lX\r\n  %-14s  %016lX  %016lX  "</span>, <span class="string">"GNU_STACK"</span>, pproheader[i].p_offset, pproheader[i].p_vaddr,</span><br><span class="line">                       pproheader[i].p_paddr, <span class="string">""</span>, pproheader[i].p_filesz, pproheader[i].p_memsz);<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="keyword">switch</span>(pproheader[i].p_flags)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> PF_X:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%-6s  %-lX\r\n"</span>, <span class="string">"  E"</span>, pproheader[i].p_align);<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> PF_W:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%-6s  %-lX\r\n"</span>, <span class="string">" W "</span>, pproheader[i].p_align);<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> PF_R:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%-6s  %-lX\r\n"</span>, <span class="string">"R  "</span>, pproheader[i].p_align);<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> PF_X|PF_W:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%-6s  %-lX\r\n"</span>, <span class="string">" WE"</span>, pproheader[i].p_align);<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> PF_X|PF_R:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%-6s  %-lX\r\n"</span>, <span class="string">"R E"</span>, pproheader[i].p_align);<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> PF_W|PF_R:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%-6s  %-lX\r\n"</span>, <span class="string">"RW "</span>, pproheader[i].p_align);<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> PF_X|PF_R|PF_W:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%-6s  %-lX\r\n"</span>, <span class="string">"RWE"</span>, pproheader[i].p_align);<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"\r\n"</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(PT_INTERP == pproheader[i].p_type)</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"      [Requesting program interpreter: %s]\r\n"</span>, (<span class="keyword">char</span>*)(pbuff + pproheader[i].p_offset));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\r\n Section to Segment mapping:\r\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"  Segment Sections...\r\n"</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;pfilehead-&gt;e_phnum;++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"   %-7d"</span>, i);</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> n = <span class="number">0</span>;n&lt;pfilehead-&gt;e_shnum;++n)</span><br><span class="line">        &#123;</span><br><span class="line">            Elf64_Off temp = psecheader[n].sh_addr + psecheader[n].sh_size;</span><br><span class="line">            <span class="keyword">if</span>((psecheader[n].sh_addr&gt;pproheader[i].p_vaddr &amp;&amp; psecheader[n].sh_addr&lt;pproheader[i].p_vaddr + pproheader[i].p_memsz)  ||</span><br><span class="line">               (temp &gt; pproheader[i].p_vaddr &amp;&amp; temp&lt;=pproheader[i].p_vaddr + pproheader[i].p_memsz))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%s "</span>, (<span class="keyword">char</span>*)(psecheader[n].sh_name + pstrbuff));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"\r\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//read symbol table</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">tableheader</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *pbuff)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//get sectionheader</span></span><br><span class="line">    Elf64_Ehdr* pfilehead = (Elf64_Ehdr*)pbuff;</span><br><span class="line">    Elf64_Half eshstrndx = pfilehead-&gt;e_shstrndx;<span class="comment">//shstrndex num</span></span><br><span class="line">    Elf64_Shdr* psecheader = (Elf64_Shdr*)(pbuff + pfilehead-&gt;e_shoff);</span><br><span class="line">    Elf64_Shdr* pshstr = (Elf64_Shdr*)(psecheader + eshstrndx);</span><br><span class="line">    <span class="keyword">char</span>* pshstrbuff = (<span class="keyword">char</span> *)(pbuff + pshstr-&gt;sh_offset);<span class="comment">//str addr</span></span><br><span class="line">    <span class="comment">//find .symtab/  .dynsym</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i&lt;pfilehead-&gt;e_shnum;++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//Is .dynsym</span></span><br><span class="line">        <span class="keyword">if</span>(!<span class="built_in">strcmp</span>(psecheader[i].sh_name + pshstrbuff, <span class="string">".dynsym"</span>) || !<span class="built_in">strcmp</span>(psecheader[i].sh_name + pshstrbuff, <span class="string">".symtab"</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//get address</span></span><br><span class="line">            Elf64_Sym* psym = (Elf64_Sym*)(pbuff + psecheader[i].sh_offset);</span><br><span class="line">            <span class="comment">//get num</span></span><br><span class="line">            <span class="keyword">int</span> ncount = psecheader[i].sh_size / psecheader[i].sh_entsize;</span><br><span class="line">            <span class="comment">//get str add</span></span><br><span class="line">            <span class="keyword">char</span>* pbuffstr = (<span class="keyword">char</span>*)((psecheader + psecheader[i].sh_link)-&gt;sh_offset + pbuff);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"Symbol table '%s' contains %d entries:\r\n"</span>, psecheader[i].sh_name + pshstrbuff, ncount);</span><br><span class="line">            outputsyminfo(psym, pbuffstr, ncount);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//output syminfo</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">outputsyminfo</span><span class="params">(<span class="keyword">const</span> Elf64_Sym *psym, <span class="keyword">const</span> <span class="keyword">char</span> *pbuffstr, <span class="keyword">int</span> ncount)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%7s  %-8s          %s  %s    %s   %s      %s  %s\r\n"</span>,</span><br><span class="line">           <span class="string">"Num:"</span>, <span class="string">"Value"</span>, <span class="string">"Size"</span>, <span class="string">"Type"</span>, <span class="string">"Bind"</span>, <span class="string">"Vis"</span>, <span class="string">"Ndx"</span>, <span class="string">"Name"</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i&lt;ncount;++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%6d:  %016lx  %-6lu"</span>, i, psym[i].st_value, psym[i].st_size);</span><br><span class="line">        <span class="keyword">char</span> typelow = ELF32_ST_TYPE(psym[i].st_info);</span><br><span class="line">        <span class="keyword">char</span> bindhig = ELF32_ST_BIND(psym[i].st_info);</span><br><span class="line">        <span class="keyword">switch</span>(typelow)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> STT_NOTYPE:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%-8s"</span>, <span class="string">"NOTYPE"</span>);<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> STT_OBJECT:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%-8s"</span>, <span class="string">"OBJECT"</span>);<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> STT_FUNC:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%-8s"</span>, <span class="string">"FUNC"</span>);<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> STT_SECTION:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%-8s"</span>, <span class="string">"SECTION"</span>);<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> STT_FILE:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%-8s"</span>, <span class="string">"FILE"</span>);<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">switch</span>(bindhig)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> STB_LOCAL:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%-8s"</span>, <span class="string">"LOCAL"</span>); <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> STB_GLOBAL:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%-8s"</span>, <span class="string">"GLOBAL"</span>); <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> STB_WEAK:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%-8s"</span>, <span class="string">"WEAK"</span>); <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%-8d"</span>, psym[i].st_other);</span><br><span class="line">        <span class="keyword">switch</span>(psym[i].st_shndx)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> SHN_UNDEF:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%s  %s\r\n"</span>, <span class="string">"UND"</span>, psym[i].st_name + pbuffstr);<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> SHN_ABS:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%s  %s\r\n"</span>, <span class="string">"ABS"</span>, psym[i].st_name + pbuffstr);<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> SHN_COMMON:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%s  %s\r\n"</span>, <span class="string">"COM"</span>, psym[i].st_name + pbuffstr);<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%3d  %s\r\n"</span>, psym[i].st_shndx, psym[i].st_name + pbuffstr);<span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//read Section Header</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">secheader</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *pbuff)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//get number Section</span></span><br><span class="line">    <span class="keyword">int</span> nNumSec = *(Elf64_Half*)(pbuff + <span class="number">60</span>);</span><br><span class="line">    <span class="comment">//get shstrndex</span></span><br><span class="line">    Elf64_Ehdr* pfilehead = (Elf64_Ehdr*)pbuff;</span><br><span class="line">    Elf64_Half eshstrndx = pfilehead-&gt;e_shstrndx;</span><br><span class="line">    <span class="comment">//get section offset</span></span><br><span class="line">    Elf64_Shdr* psecheader = (Elf64_Shdr*)(pbuff + pfilehead-&gt;e_shoff);</span><br><span class="line">    Elf64_Shdr* pshstr = (Elf64_Shdr*)(psecheader + eshstrndx);</span><br><span class="line">    <span class="keyword">char</span>* pshstrbuff = (<span class="keyword">char</span> *)(pbuff + pshstr-&gt;sh_offset);</span><br><span class="line">    <span class="comment">//output info</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"There are %d section headers, starting at offset 0x%lx:\r\n\r\n"</span>,</span><br><span class="line">           nNumSec, *(Elf64_Off*)(pbuff + <span class="number">40</span>));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Section Headers:\r\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"  [Nr] %-16s  %-16s  %-16s  %-16s\r\n"</span>, <span class="string">"Name"</span>, <span class="string">"Type"</span>, <span class="string">"Address"</span>, <span class="string">"Offset"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"       %-16s  %-16s  %-5s  %-5s  %-5s  %-5s\r\n"</span>, <span class="string">"Size"</span>, <span class="string">"EntSize"</span>, <span class="string">"Flags"</span>, <span class="string">"Link"</span>, <span class="string">"Info"</span>, <span class="string">"Align"</span>);</span><br><span class="line">    <span class="comment">//travlest</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i&lt;nNumSec;++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"  [%2d] %-16s  "</span>, i, (<span class="keyword">char</span> *)(psecheader[i].sh_name + pshstrbuff));</span><br><span class="line">        <span class="comment">//Type</span></span><br><span class="line">        <span class="keyword">switch</span>(psecheader[i].sh_type)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> SHT_NULL:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%-16s  "</span>, <span class="string">"NULL"</span>);<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> SHT_PROGBITS:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%-16s  "</span>, <span class="string">"PROGBITS"</span>);<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> SHT_SYMTAB:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%-16s  "</span>, <span class="string">"SYMTAB"</span>);<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> SHT_STRTAB:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%-16s  "</span>, <span class="string">"STRTAB"</span>);<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> SHT_RELA:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%-16s  "</span>, <span class="string">"RELA"</span>);<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> SHT_HASH:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%-16s  "</span>, <span class="string">"GNU_HASH"</span>);<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> SHT_DYNAMIC:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%-16s  "</span>, <span class="string">"DYNAMIC"</span>);<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> SHT_NOTE:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%-16s  "</span>, <span class="string">"NOTE"</span>);<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> SHT_NOBITS:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%-16s  "</span>, <span class="string">"NOBITS"</span>);<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> SHT_REL:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%-16s  "</span>, <span class="string">"REL"</span>);<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> SHT_SHLIB:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%-16s  "</span>, <span class="string">"SHLIB"</span>);<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> SHT_DYNSYM:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%-16s  "</span>, <span class="string">"DYNSYM"</span>);<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> SHT_INIT_ARRAY:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%-16s  "</span>, <span class="string">"INIT_ARRY"</span>);<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> SHT_FINI_ARRAY:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%-16s  "</span>, <span class="string">"FINI_ARRY"</span>);<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> SHT_PREINIT_ARRAY:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%-16s  "</span>, <span class="string">"PREINIT_ARRAY"</span>);<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> SHT_GNU_HASH:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%-16s  "</span>, <span class="string">"GNU_HASH"</span>);<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> SHT_GNU_ATTRIBUTES:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%-16s  "</span>, <span class="string">"GNU_ATTRIBUTES"</span>);<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> SHT_GNU_LIBLIST:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%-16s  "</span>, <span class="string">"GNU_LIBLIST"</span>);<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> SHT_GNU_verdef:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%-16s  "</span>, <span class="string">"GNU_verdef"</span>);<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> SHT_GNU_verneed:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%-16s  "</span>, <span class="string">"GNU_verneed"</span>);<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> SHT_GNU_versym:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%-16s  "</span>, <span class="string">"GNU_versym"</span>);<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%-16s  "</span>, <span class="string">"NONE"</span>);<span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%016lX  %08lX\r\n"</span>, psecheader[i].sh_addr, psecheader[i].sh_offset);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"       %016lX  %016lx  "</span>, psecheader[i].sh_size, psecheader[i].sh_entsize);</span><br><span class="line">        <span class="keyword">switch</span> (psecheader[i].sh_flags) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%3s    %4u  %4u  %4lu\r\n"</span>,</span><br><span class="line">                       <span class="string">""</span>, psecheader[i].sh_link, psecheader[i].sh_info, psecheader[i].sh_addralign);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%3s    %4u  %4u  %4lu\r\n"</span>,</span><br><span class="line">                       <span class="string">"W"</span>, psecheader[i].sh_link, psecheader[i].sh_info, psecheader[i].sh_addralign);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%3s    %4u  %4u  %4lu\r\n"</span>,</span><br><span class="line">                       <span class="string">"A"</span>, psecheader[i].sh_link, psecheader[i].sh_info, psecheader[i].sh_addralign);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%3s    %4u  %4u  %4lu\r\n"</span>,</span><br><span class="line">                       <span class="string">"X"</span>, psecheader[i].sh_link, psecheader[i].sh_info, psecheader[i].sh_addralign);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%3s    %4u  %4u  %4lu\r\n"</span>,</span><br><span class="line">                       <span class="string">"WA"</span>, psecheader[i].sh_link, psecheader[i].sh_info, psecheader[i].sh_addralign);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">5</span>:<span class="comment">//WX</span></span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%3s    %4u  %4u  %4lu\r\n"</span>,</span><br><span class="line">                       <span class="string">"WX"</span>, psecheader[i].sh_link, psecheader[i].sh_info, psecheader[i].sh_addralign);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">6</span>:<span class="comment">//AX</span></span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%3s    %4u  %4u  %4lu\r\n"</span>,</span><br><span class="line">                       <span class="string">"AX"</span>, psecheader[i].sh_link, psecheader[i].sh_info, psecheader[i].sh_addralign);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">7</span>:<span class="comment">//WAX</span></span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%3s    %4u  %4u  %4lu\r\n"</span>,</span><br><span class="line">                       <span class="string">"WAX"</span>, psecheader[i].sh_link, psecheader[i].sh_info, psecheader[i].sh_addralign);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> SHF_MASKPROC:<span class="comment">//MS</span></span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%3s    %4u  %4u  %4lu\r\n"</span>,</span><br><span class="line">                       <span class="string">"MS"</span>, psecheader[i].sh_link, psecheader[i].sh_info, psecheader[i].sh_addralign);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"NONE\r\n"</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Key to Flags:\r\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"  W (write), A (alloc), X (execute), M (merge), S (strings), l (large)\r\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"  I (info), L (link order), G (group), T (TLS), E (exclude), x (unknown)\r\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"  O (extra OS processing required) o (OS specific), p (processor specific)\r\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//read File Header</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">fileheader</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *pbuff)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"ELF Header:\r\n"</span>);</span><br><span class="line">    <span class="comment">//Magic</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"  Magic:   "</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i&lt;EI_NIDENT;++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%02X"</span>, pbuff[i]);</span><br><span class="line">        <span class="built_in">putchar</span>(<span class="string">' '</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\r\n"</span>);</span><br><span class="line">    <span class="comment">//Class</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"  %-33s:"</span>, <span class="string">"Class"</span>);</span><br><span class="line">    <span class="keyword">switch</span>(pbuff[<span class="number">4</span>])</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">" Invalid class\r\n"</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">" ELF32\r\n"</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">" ELF64\r\n"</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">" ERROR\r\n"</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//Data</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"  %-33s:"</span>, <span class="string">"Data"</span>);</span><br><span class="line">    <span class="keyword">switch</span>(pbuff[<span class="number">5</span>])</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">" Invalid data encoding\r\n"</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">" 2's complement, little endian\r\n"</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">" 2's complement, big endian\r\n"</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">" ERROR\r\n"</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//Version</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"  %-33s: %s\r\n"</span>, <span class="string">"Version"</span>, <span class="string">"1(current)"</span>);</span><br><span class="line">    <span class="comment">//OS/ABI</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"  %-33s: %s\r\n"</span>, <span class="string">"OS/ABI"</span>, <span class="string">"UNIX - System V"</span>);</span><br><span class="line">    <span class="comment">//ABI Version</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"  %-33s: %s\r\n"</span>, <span class="string">"ABI Version"</span>, <span class="string">"0"</span>);</span><br><span class="line">    pbuff += EI_NIDENT;</span><br><span class="line">    <span class="comment">//Type</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"  %-33s:"</span>, <span class="string">"Type"</span>);</span><br><span class="line">    <span class="keyword">switch</span>(*(<span class="keyword">uint16_t</span>*)pbuff)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">" No file type\r\n"</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">" Relocatable file\r\n"</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">" Executable file\r\n"</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">" Shared object file\r\n"</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">" Core file\r\n"</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">" ERROR\r\n"</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    pbuff += <span class="keyword">sizeof</span>(<span class="keyword">uint16_t</span>);</span><br><span class="line">    <span class="comment">//Machine</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"  %-33s:"</span>, <span class="string">"Machine"</span>);</span><br><span class="line">    <span class="keyword">switch</span>(*(<span class="keyword">uint16_t</span>*)pbuff)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> EM_386:</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">" Intel 80386\r\n"</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> EM_ARM:</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">" ARM\r\n"</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> EM_X86_64:</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">" AMD X86-64 arrchitecture\r\n"</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">" ERROR\r\n"</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    pbuff += <span class="keyword">sizeof</span>(<span class="keyword">uint16_t</span>);</span><br><span class="line">    <span class="comment">//Version</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"  %-33s: %s\r\n"</span>, <span class="string">"version"</span>, <span class="string">"0X1"</span>);</span><br><span class="line">    pbuff += <span class="keyword">sizeof</span>(<span class="keyword">uint32_t</span>);</span><br><span class="line">    <span class="comment">//Entry point address</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"  %-33s: 0X%lx\r\n"</span>, <span class="string">"Entry point address"</span>, *(<span class="keyword">uint64_t</span>*)pbuff);</span><br><span class="line">    pbuff += <span class="keyword">sizeof</span>(<span class="keyword">uint64_t</span>);</span><br><span class="line">    <span class="comment">//Start of program headers</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"  %-33s: %lu (bytes into file)\r\n"</span>, <span class="string">"Start of program headers"</span>, *(<span class="keyword">uint64_t</span>*)pbuff);</span><br><span class="line">    pbuff += <span class="keyword">sizeof</span>(<span class="keyword">uint64_t</span>);</span><br><span class="line">    <span class="comment">//Start of section headers</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"  %-33s: %lu (bytes into file)\r\n"</span>, <span class="string">"Start of section headers"</span>, *(<span class="keyword">uint64_t</span>*)pbuff);</span><br><span class="line">    pbuff += <span class="keyword">sizeof</span>(<span class="keyword">uint64_t</span>);</span><br><span class="line">    <span class="comment">//Flags</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"  %-33s: 0X0\r\n"</span>, <span class="string">"Flags"</span>);</span><br><span class="line">    pbuff += <span class="keyword">sizeof</span>(Elf32_Word);</span><br><span class="line">    <span class="comment">//Size of this header</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"  %-33s: %d (bytes)\r\n"</span>, <span class="string">"Size of this header"</span>, *(Elf32_Half*)pbuff);</span><br><span class="line">    pbuff += <span class="keyword">sizeof</span>(Elf32_Half);</span><br><span class="line">    <span class="comment">//Size of program headers</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"  %-33s: %d (bytes)\r\n"</span>, <span class="string">"Size of program headers"</span>, *(Elf32_Half*)pbuff);</span><br><span class="line">    pbuff += <span class="keyword">sizeof</span>(Elf32_Half);</span><br><span class="line">    <span class="comment">//Number of program headers</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"  %-33s: %d\r\n"</span>, <span class="string">"Number of program headers"</span>, *(Elf32_Half*)pbuff);</span><br><span class="line">    pbuff += <span class="keyword">sizeof</span>(Elf32_Half);</span><br><span class="line">    <span class="comment">//Size of section headers</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"  %-33s: %d (bytes)\r\n"</span>, <span class="string">"Size of section headers"</span>, *(Elf32_Half*)pbuff);</span><br><span class="line">    pbuff += <span class="keyword">sizeof</span>(Elf32_Half);</span><br><span class="line">    <span class="comment">//Number of section headers</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"  %-33s: %d\r\n"</span>, <span class="string">"Number of section headers"</span>, *(Elf32_Half*)pbuff);</span><br><span class="line">    pbuff += <span class="keyword">sizeof</span>(Elf32_Half);</span><br><span class="line">    <span class="comment">//Section header string table index</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"  %-33s: %d\r\n"</span>, <span class="string">"Section header string table index"</span>, *(Elf32_Half*)pbuff);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>WindowsPE解析器较多, PE解析代码输出如下</p>
<p>使用方法: PE主要看ImportTable, 看用了哪些第三方包和第三方函数信息<br>由于检测目标都是服务器所以忽略Windows平台</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 编码为 GBK</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PE_PATH <span class="meta-string">"1.exe"</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="comment">//////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">ReadPEToMemory</span><span class="params">(IN <span class="keyword">const</span> <span class="keyword">char</span> *pPEPath, OUT DWORD *SizeOfPE)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UnReadPEToMemory</span><span class="params">(IN <span class="keyword">void</span> *pFileBuf)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PrintPEInfomatiaon</span><span class="params">(IN <span class="keyword">void</span> *pFileBuf)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">ReadFileBufToImageBuf</span><span class="params">(IN <span class="keyword">const</span> <span class="keyword">char</span> *pPEPath)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UnReadFileBufToImageBuf</span><span class="params">(IN <span class="keyword">void</span> *pImageBuf)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DumpImageBufToDisk</span><span class="params">(IN <span class="keyword">void</span> *pImageBuf, IN <span class="keyword">const</span> <span class="keyword">char</span> *outName)</span></span>;</span><br><span class="line"><span class="function">DWORD <span class="title">RVATORAW</span><span class="params">(IN <span class="keyword">const</span> <span class="keyword">char</span> *pPEPath, DWORD offset, IN BOOL RVA2RAW)</span></span>;</span><br><span class="line"><span class="function">DWORD <span class="title">RVATORAWEx</span><span class="params">(IN <span class="keyword">const</span> <span class="keyword">void</span> *pFileBuf, IN DWORD dwOffset, IN BOOL bRVATORAW)</span></span>;</span><br><span class="line"><span class="function">BOOL <span class="title">AddShellCode</span><span class="params">(IN <span class="keyword">const</span> <span class="keyword">char</span> *pPEPath, IN BYTE *pShellCode, IN <span class="keyword">int</span> SectionIndex, IN <span class="keyword">const</span> <span class="keyword">char</span> *outName)</span></span>;</span><br><span class="line"><span class="function">BOOL <span class="title">PrintExportTable</span><span class="params">(IN <span class="keyword">const</span> <span class="keyword">char</span> *pPEPath)</span></span>;</span><br><span class="line"><span class="function">BOOL <span class="title">PrintImportTable</span><span class="params">(IN <span class="keyword">const</span> <span class="keyword">char</span> *pPEPath)</span></span>;</span><br><span class="line"><span class="function">BOOL <span class="title">PrintRelocateTable</span><span class="params">(IN <span class="keyword">const</span> <span class="keyword">char</span> *pPEPath)</span></span>;</span><br><span class="line"><span class="comment">//////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(argc &lt; <span class="number">2</span>)&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="keyword">char</span>* pePath = argv[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1.PE -&gt; FileBuf, 打印相关信息</span></span><br><span class="line">    <span class="comment">// void *pFileBuf = ReadPEToMemory(pePath, NULL);</span></span><br><span class="line">    <span class="comment">// PrintPEInfomatiaon(pFileBuf);</span></span><br><span class="line">    <span class="comment">// UnReadPEToMemory(pFileBuf);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.扩展 FileBuf -&gt; ImageBuf</span></span><br><span class="line">    <span class="comment">// void *pImageBuf = ReadFileBufToImageBuf(pePath);</span></span><br><span class="line">    <span class="comment">// UnReadFileBufToImageBuf(pImageBuf);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. ImageBuf -&gt; 硬盘 ，可执行</span></span><br><span class="line">    <span class="comment">// void *pImageBuf = ReadFileBufToImageBuf(pePath);</span></span><br><span class="line">    <span class="comment">// DumpImageBufToDisk(pImageBuf, "3.exe");</span></span><br><span class="line">    <span class="comment">// UnReadFileBufToImageBuf(pImageBuf);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4.RVA -&gt; RAW(FOA)</span></span><br><span class="line">    <span class="comment">// DWORD a = RVATORAW(pePath, 0xA0E1, true);</span></span><br><span class="line">    <span class="comment">// printf("RAW:%p\n", a);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5.往指定节里添加Shellcode(代码)（未完成）</span></span><br><span class="line">    <span class="comment">// 6.添加节（未完成）</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 7. 打印导出表</span></span><br><span class="line">    <span class="comment">// PrintExportTable(pePath);</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 8.打印重定位</span></span><br><span class="line">    <span class="comment">// PrintRelocateTable(pePath);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 9. 打印导入表</span></span><br><span class="line">    PrintImportTable(pePath);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 10.移动导出表</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//功能：加载PE文件到内存</span></span><br><span class="line"><span class="comment">//参数：pPEPath:文件路径</span></span><br><span class="line"><span class="comment">//返回值:文件缓存</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">ReadPEToMemory</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *pPEPath, OUT DWORD *SizeOfPE)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FILE *fp = fopen(pPEPath, <span class="string">"rb"</span>);</span><br><span class="line">    <span class="keyword">if</span> (fp == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"ReadPeToMemory:参数为空"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    fseek(fp, <span class="number">0</span>, SEEK_END);</span><br><span class="line">    DWORD dwSizeOfFile = ftell(fp);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (SizeOfPE)</span><br><span class="line">        *SizeOfPE = dwSizeOfFile;</span><br><span class="line"></span><br><span class="line">    fseek(fp, <span class="number">0</span>, SEEK_SET);</span><br><span class="line">    <span class="keyword">void</span> *pFileBuf = (<span class="keyword">void</span> *)<span class="built_in">malloc</span>(dwSizeOfFile);</span><br><span class="line">    fread(pFileBuf, dwSizeOfFile, <span class="number">1</span>, fp);</span><br><span class="line"></span><br><span class="line">    fclose(fp);</span><br><span class="line">    <span class="keyword">return</span> pFileBuf;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//功能：释放PE所分配的堆空间</span></span><br><span class="line"><span class="comment">//参数：pFileBuf</span></span><br><span class="line"><span class="comment">//返回值:无</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UnReadPEToMemory</span><span class="params">(IN <span class="keyword">void</span> *pFileBuf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (pFileBuf == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"FreePEFromMemory:参数为空"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">free</span>(pFileBuf);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//功能：解析PE文件</span></span><br><span class="line"><span class="comment">//参数：PE的文件缓存地址</span></span><br><span class="line"><span class="comment">//返回值:无</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PrintPEInfomatiaon</span><span class="params">(IN <span class="keyword">void</span> *pFileBuf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!pFileBuf)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"PrintPEInfomatiaon:参数为空"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    IMAGE_DOS_HEADER *pIDH = (IMAGE_DOS_HEADER *)pFileBuf;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"\n--------------IMAGE_DOS_HEADER--------------"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"magic:0x%X\nlfanew:0x%X(NT头的偏移)\n"</span>, pIDH-&gt;e_magic, pIDH-&gt;e_lfanew);</span><br><span class="line"></span><br><span class="line">    IMAGE_NT_HEADERS *pINH = (IMAGE_NT_HEADERS *)((DWORD)pIDH + pIDH-&gt;e_lfanew);</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"\n--------------IMAGE_NT_HEADER--------------"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Signature(4550:PE):0x%X\n"</span>, pINH-&gt;Signature);</span><br><span class="line"></span><br><span class="line">    IMAGE_FILE_HEADER IFH = pINH-&gt;FileHeader;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"\n--------------IMAGE_FILE_HEADER--------------"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"NumberOfSections:%d(节区数量)\n"</span>, IFH.NumberOfSections);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"SizeOfOptionalHeader:%d(IMAGE_OPTIONAL_HEADER大小)\n"</span>, IFH.SizeOfOptionalHeader);</span><br><span class="line"></span><br><span class="line">    IMAGE_OPTIONAL_HEADER IOH = pINH-&gt;OptionalHeader;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"\n--------------IMAGE_OPTIONAL_HEADER--------------"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Magic:0x%X\n"</span>, IOH.Magic);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"SizeOfCode:0x%X(代码节(.test)大小，有多个的话是总和)\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"SizeOfInitializedData:0x%X(已初始化数据节的大小，有多个的话是总和)\n"</span>, IOH.SizeOfInitializedData);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"SizeOfUninitializedData:0x%X(未初始化数据节的大小，有多个的话是总和)\n"</span>, IOH.SizeOfUninitializedData);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"AddressOfEntryPoint:0x%X(EntryPoint,RVA)\n"</span>, IOH.AddressOfEntryPoint);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"BaseOfCode:0x%X(内存中代码节的开头相对于映像基址ImageBase的偏移地址)\n"</span>, IOH.BaseOfCode);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"ImageBase:0x%X(载入内存时优先装载的地址)\n"</span>, IOH.ImageBase);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"SectionAlignment:0x%X(节区在内存中的最小单位)\n"</span>, IOH.SectionAlignment);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"FileAlignment:0x%X(节区在磁盘文件中的最小单位)\n"</span>, IOH.FileAlignment);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"SizeOfImage:0x%X(指定了PE Image在虚拟内存中所占空间的大小)\n"</span>, IOH.SizeOfImage);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"SizeOfHeaders:0x%X(整个PE头的大小)\n"</span>, IOH.SizeOfHeaders);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"NumberOfRvaAndSizes:0x%X(DataDirectory数量)\n"</span>, IOH.NumberOfRvaAndSizes);</span><br><span class="line"></span><br><span class="line">    IMAGE_SECTION_HEADER *pISH = (IMAGE_SECTION_HEADER *)((DWORD)pFileBuf + pIDH-&gt;e_lfanew + <span class="keyword">sizeof</span>(IMAGE_NT_HEADERS));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n--------------IMAGE_SECTION_HEADER--------------\n"</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; IFH.NumberOfSections; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"++++++++++++++++++++++%u Section++++++++++++++++++++++++++\n"</span>, i + <span class="number">1</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Section name: %s\n"</span>, pISH-&gt;Name);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"VirtualSize:0x%X(载入内存时此节区的大小)\n"</span>, pISH-&gt;Misc.VirtualSize);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"VirtualAddress:0x%X(内存中节区起始地址(RVA))\n"</span>, pISH-&gt;VirtualAddress);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"SizeOfRawData:0x%X(磁盘中节区所占大小)\n"</span>, pISH-&gt;SizeOfRawData);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"PointerToRawData:0x%X(磁盘中本节对于文件头的距离)\n"</span>, pISH-&gt;PointerToRawData);</span><br><span class="line">        pISH++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//功能：拉伸PE至内存,从FileBuf---&gt;ImageBuf</span></span><br><span class="line"><span class="comment">//参数：exe文件路径</span></span><br><span class="line"><span class="comment">//返回值:拉伸后的堆地址</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">ReadFileBufToImageBuf</span><span class="params">(IN <span class="keyword">const</span> <span class="keyword">char</span> *pPEPath)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">void</span> *pFileBuf = ReadPEToMemory(PE_PATH, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">void</span> *pImageBuf;</span><br><span class="line">    <span class="keyword">if</span> (pFileBuf == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    IMAGE_DOS_HEADER *pIDH = (IMAGE_DOS_HEADER *)pFileBuf;</span><br><span class="line">    IMAGE_NT_HEADERS *pINH = (IMAGE_NT_HEADERS *)((DWORD)pIDH + pIDH-&gt;e_lfanew);</span><br><span class="line">    IMAGE_FILE_HEADER IFH = pINH-&gt;FileHeader;</span><br><span class="line">    IMAGE_OPTIONAL_HEADER IOH = pINH-&gt;OptionalHeader;</span><br><span class="line">    IMAGE_SECTION_HEADER *pISH = (IMAGE_SECTION_HEADER *)((DWORD)pFileBuf + pIDH-&gt;e_lfanew + <span class="keyword">sizeof</span>(IMAGE_NT_HEADERS));</span><br><span class="line">    DWORD SectionNumber = IFH.NumberOfSections;</span><br><span class="line">    pImageBuf = (<span class="keyword">void</span> *)<span class="built_in">malloc</span>(IOH.SizeOfImage);</span><br><span class="line">    <span class="built_in">memset</span>(pImageBuf, <span class="number">0</span>, IOH.SizeOfImage);</span><br><span class="line">    DWORD SectionAlignment = IOH.SectionAlignment;</span><br><span class="line">    DWORD FileAlignment = IOH.FileAlignment;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> *pFileBufTmp = pFileBuf;</span><br><span class="line">    <span class="keyword">void</span> *pImageBufTmp = pImageBuf;</span><br><span class="line">    <span class="comment">// copy PE头</span></span><br><span class="line">    <span class="built_in">memcpy</span>(pImageBufTmp, pFileBuf, IOH.SizeOfHeaders);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// copy 节区</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; SectionNumber; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        pFileBufTmp = (<span class="keyword">void</span> *)((DWORD)pFileBuf + pISH-&gt;PointerToRawData);</span><br><span class="line">        pImageBufTmp = (<span class="keyword">void</span> *)((DWORD)pImageBuf + pISH-&gt;VirtualAddress);</span><br><span class="line">        <span class="built_in">memcpy</span>(pImageBufTmp, pFileBufTmp, pISH-&gt;SizeOfRawData);</span><br><span class="line">        pISH++;</span><br><span class="line">    &#125;</span><br><span class="line">    UnReadPEToMemory(pFileBuf);</span><br><span class="line">    <span class="keyword">return</span> pImageBuf;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//功能：释放拉伸PE所占据的内存(pImageBuf)</span></span><br><span class="line"><span class="comment">//参数：pImageBuf</span></span><br><span class="line"><span class="comment">//返回值:无</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UnReadFileBufToImageBuf</span><span class="params">(IN <span class="keyword">void</span> *pImageBuf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!pImageBuf)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"UnReadFileBufToImageBuf:参数为空"</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">free</span>(pImageBuf);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//功能：将ImageBuf Dump 到磁盘</span></span><br><span class="line"><span class="comment">//参数：pImageBuf，Dump名字</span></span><br><span class="line"><span class="comment">//返回值:无</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DumpImageBufToDisk</span><span class="params">(IN <span class="keyword">void</span> *pImageBuf, IN <span class="keyword">const</span> <span class="keyword">char</span> *outName)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    IMAGE_DOS_HEADER *pIDH = (IMAGE_DOS_HEADER *)pImageBuf;</span><br><span class="line">    IMAGE_NT_HEADERS *pINH = (IMAGE_NT_HEADERS *)((DWORD)pIDH + pIDH-&gt;e_lfanew);</span><br><span class="line">    IMAGE_FILE_HEADER IFH = pINH-&gt;FileHeader;</span><br><span class="line">    IMAGE_OPTIONAL_HEADER IOH = pINH-&gt;OptionalHeader;</span><br><span class="line">    IMAGE_SECTION_HEADER *pISH = (IMAGE_SECTION_HEADER *)((DWORD)pImageBuf + pIDH-&gt;e_lfanew + <span class="keyword">sizeof</span>(IMAGE_NT_HEADERS));</span><br><span class="line"></span><br><span class="line">    DWORD SectionNumber = IFH.NumberOfSections;</span><br><span class="line">    IMAGE_SECTION_HEADER *pISHTmp = pISH;</span><br><span class="line">    DWORD FileSize = IOH.SizeOfHeaders; <span class="comment">//头 + 各节区，节区在下面</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; SectionNumber; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        FileSize += pISHTmp-&gt;SizeOfRawData;</span><br><span class="line">        pISHTmp++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> *pFileBuf = (<span class="keyword">void</span> *)<span class="built_in">malloc</span>(FileSize);</span><br><span class="line">    <span class="keyword">void</span> *pFileBufTmp = pFileBuf;</span><br><span class="line">    <span class="keyword">void</span> *pImageBufTmp = pImageBuf;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(pFileBuf, <span class="number">0</span>, FileSize);</span><br><span class="line">    <span class="built_in">memcpy</span>(pFileBufTmp, pImageBufTmp, IOH.SizeOfHeaders);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; SectionNumber; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        pFileBufTmp = (<span class="keyword">void</span> *)((DWORD)pFileBuf + pISH-&gt;PointerToRawData);</span><br><span class="line">        pImageBufTmp = (<span class="keyword">void</span> *)((DWORD)pImageBuf + pISH-&gt;VirtualAddress);</span><br><span class="line">        <span class="built_in">memcpy</span>(pFileBufTmp, pImageBufTmp, pISH-&gt;SizeOfRawData);</span><br><span class="line">        pISH++;</span><br><span class="line">    &#125;</span><br><span class="line">    FILE *fp = fopen(outName, <span class="string">"wb"</span>);</span><br><span class="line">    fwrite(pFileBuf, FileSize, <span class="number">1</span>, fp);</span><br><span class="line">    fclose(fp);</span><br><span class="line">    <span class="built_in">free</span>(pFileBuf);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//功能：RVA与RAW的相互转换</span></span><br><span class="line"><span class="comment">//参数：pPEPath:PE文件路径，</span></span><br><span class="line"><span class="comment">//        bRVATORAW: TRUE, RVA to RAW</span></span><br><span class="line"><span class="comment">//			         FALSE,RAW to RVA</span></span><br><span class="line"><span class="comment">//返回值:转换后的值，为0则转换失败</span></span><br><span class="line"><span class="function">DWORD <span class="title">RVATORAW</span><span class="params">(IN <span class="keyword">const</span> <span class="keyword">char</span> *pPEPath, DWORD offset, IN BOOL RVA2RAW)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">void</span> *pFileBuf = ReadPEToMemory(pPEPath, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (pFileBuf == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"RVATORAW:文件出错\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    IMAGE_DOS_HEADER *pIDH = (IMAGE_DOS_HEADER *)pFileBuf;</span><br><span class="line">    IMAGE_NT_HEADERS *pINH = (IMAGE_NT_HEADERS *)((DWORD)pIDH + pIDH-&gt;e_lfanew);</span><br><span class="line">    IMAGE_FILE_HEADER IFH = pINH-&gt;FileHeader;</span><br><span class="line">    IMAGE_OPTIONAL_HEADER IOH = pINH-&gt;OptionalHeader;</span><br><span class="line">    IMAGE_SECTION_HEADER *pISH = (IMAGE_SECTION_HEADER *)((DWORD)pFileBuf + pIDH-&gt;e_lfanew + <span class="keyword">sizeof</span>(IMAGE_NT_HEADERS));</span><br><span class="line">    DWORD SectionNumber = IFH.NumberOfSections;</span><br><span class="line"></span><br><span class="line">    IMAGE_SECTION_HEADER *pISHTmp = pISH;</span><br><span class="line">    <span class="comment">// 两种情况，如果offset小于PE头，则RVA==FOA</span></span><br><span class="line">    <span class="keyword">if</span> (offset == IOH.SizeOfHeaders)</span><br><span class="line">        <span class="keyword">return</span> offset;</span><br><span class="line">    <span class="comment">// RVA --&gt; FOA</span></span><br><span class="line">    <span class="keyword">if</span> (RVA2RAW)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; SectionNumber; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (pISHTmp-&gt;VirtualAddress &lt;= offset &amp;&amp; offset &lt;= pISHTmp-&gt;VirtualAddress + pISHTmp-&gt;SizeOfRawData)</span><br><span class="line">                <span class="keyword">return</span> offset - pISHTmp-&gt;VirtualAddress + pISHTmp-&gt;PointerToRawData;</span><br><span class="line">            pISHTmp++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="comment">// FOA -&gt; RVA</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (DWORD i = <span class="number">0</span>; i &lt; SectionNumber; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (pISHTmp-&gt;VirtualAddress &lt;= offset &amp;&amp; offset &lt;= pISHTmp-&gt;VirtualAddress + pISHTmp-&gt;SizeOfRawData)</span><br><span class="line">                <span class="keyword">return</span> offset + pISHTmp-&gt;VirtualAddress - pISHTmp-&gt;PointerToRawData;</span><br><span class="line">            pISHTmp++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    UnReadPEToMemory(pFileBuf);</span><br><span class="line">    <span class="keyword">return</span> offset;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">DWORD <span class="title">RVATORAWEx</span><span class="params">(IN <span class="keyword">const</span> <span class="keyword">void</span> *pFileBuf, IN DWORD dwOffset, IN BOOL bRVATORAW)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    IMAGE_DOS_HEADER *pIDH = (IMAGE_DOS_HEADER *)pFileBuf;</span><br><span class="line">    IMAGE_NT_HEADERS *pINGS = (IMAGE_NT_HEADERS *)((DWORD)pFileBuf + pIDH-&gt;e_lfanew);</span><br><span class="line">    IMAGE_FILE_HEADER IFH = pINGS-&gt;FileHeader;</span><br><span class="line">    DWORD dwNumberOfSecs = IFH.NumberOfSections;</span><br><span class="line">    IMAGE_OPTIONAL_HEADER IOH = pINGS-&gt;OptionalHeader;</span><br><span class="line">    IMAGE_SECTION_HEADER *pISH = (IMAGE_SECTION_HEADER *)((DWORD)pFileBuf + pIDH-&gt;e_lfanew + <span class="keyword">sizeof</span>(IMAGE_NT_HEADERS));</span><br><span class="line">    <span class="comment">//计算需要分配的FileBuf大小;</span></span><br><span class="line">    IMAGE_SECTION_HEADER *pISHTmp = pISH;</span><br><span class="line">    <span class="comment">//若dwOffset，则说明在PE头中，RVA==RAW</span></span><br><span class="line">    <span class="keyword">if</span> (dwOffset &lt; IOH.SizeOfHeaders)</span><br><span class="line">        <span class="keyword">return</span> dwOffset;</span><br><span class="line">    <span class="comment">//进行RVA----&gt;RAW</span></span><br><span class="line">    <span class="keyword">if</span> (bRVATORAW)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (DWORD i = <span class="number">0</span>; i &lt; dwNumberOfSecs; i++)</span><br><span class="line">        &#123; <span class="comment">//这个比较公式很重要  好好理解为何是SizeOfRawData，哈哈这才是精髓</span></span><br><span class="line">            <span class="keyword">if</span> (pISHTmp-&gt;VirtualAddress &lt;= dwOffset &amp;&amp; dwOffset &lt;= pISHTmp-&gt;VirtualAddress + pISHTmp-&gt;SizeOfRawData)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> dwOffset - pISHTmp-&gt;VirtualAddress + pISHTmp-&gt;PointerToRawData;</span><br><span class="line">            &#125;</span><br><span class="line">            pISHTmp++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//进行RAW----&gt;RVA</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (DWORD i = <span class="number">0</span>; i &lt; dwNumberOfSecs; i++)</span><br><span class="line">        &#123; <span class="comment">//这个比较公式很重要  好好理解为何是取pISHTmp-&gt;SizeOfRawData   pISHTmp-&gt;Misc.VirtualSize中大的，哈哈这才是精髓</span></span><br><span class="line">            <span class="keyword">if</span> (pISHTmp-&gt;PointerToRawData &lt;= dwOffset &amp;&amp; dwOffset &lt;= pISHTmp-&gt;VirtualAddress + (pISHTmp-&gt;SizeOfRawData &gt; pISHTmp-&gt;Misc.VirtualSize ? pISHTmp-&gt;SizeOfRawData : pISHTmp-&gt;Misc.VirtualSize))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> dwOffset - pISHTmp-&gt;PointerToRawData + pISHTmp-&gt;VirtualAddress;</span><br><span class="line">            &#125;</span><br><span class="line">            pISHTmp++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">BOOL <span class="title">AddShellCode</span><span class="params">(IN <span class="keyword">const</span> <span class="keyword">char</span> *pPEPath, IN BYTE *pShellCode, IN <span class="keyword">int</span> SectionIndex, IN <span class="keyword">const</span> <span class="keyword">char</span> *outName)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">void</span> *pImageBuf = ReadFileBufToImageBuf(pPEPath);</span><br><span class="line">    <span class="keyword">if</span> (!pImageBuf)</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line"></span><br><span class="line">    IMAGE_DOS_HEADER *pIDH = (IMAGE_DOS_HEADER *)pImageBuf;</span><br><span class="line">    IMAGE_NT_HEADERS *pINH = (IMAGE_NT_HEADERS *)((DWORD)pIDH + pIDH-&gt;e_lfanew);</span><br><span class="line">    IMAGE_FILE_HEADER IFH = pINH-&gt;FileHeader;</span><br><span class="line">    IMAGE_OPTIONAL_HEADER IOH = pINH-&gt;OptionalHeader;</span><br><span class="line">    IMAGE_SECTION_HEADER *pISH = (IMAGE_SECTION_HEADER *)((DWORD)pImageBuf + pIDH-&gt;e_lfanew + <span class="keyword">sizeof</span>(IMAGE_NT_HEADERS));</span><br><span class="line"></span><br><span class="line">    DWORD SectionNumber = IFH.NumberOfSections;</span><br><span class="line">    IMAGE_SECTION_HEADER *pISHTmp = pISH;</span><br><span class="line">    DWORD FileSize = IOH.SizeOfHeaders; <span class="comment">//头 + 各节区，节区在下面</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 打印导出表</span></span><br><span class="line"><span class="function">BOOL <span class="title">PrintExportTable</span><span class="params">(IN <span class="keyword">const</span> <span class="keyword">char</span> *pPEPath)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">void</span> *pFileBuf = ReadPEToMemory(pPEPath, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (!pFileBuf)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    IMAGE_DOS_HEADER *pIDH = (IMAGE_DOS_HEADER *)pFileBuf;</span><br><span class="line">    IMAGE_NT_HEADERS *pINH = (IMAGE_NT_HEADERS *)((DWORD)pIDH + pIDH-&gt;e_lfanew);</span><br><span class="line">    IMAGE_OPTIONAL_HEADER IOH = pINH-&gt;OptionalHeader;</span><br><span class="line">    <span class="comment">// 第一个就是重定位表</span></span><br><span class="line">    DWORD Size = IOH.DataDirectory[<span class="number">0</span>].Size;</span><br><span class="line">    DWORD RVAVirtualAddresss = IOH.DataDirectory[<span class="number">0</span>].VirtualAddress;</span><br><span class="line">    <span class="keyword">if</span> (Size == <span class="number">0</span> || RVAVirtualAddresss == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"没有导出表\n"</span>);</span><br><span class="line">        UnReadPEToMemory(pFileBuf);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    DWORD RWAAddress = RVATORAWEx(pFileBuf, RVAVirtualAddresss, <span class="literal">true</span>);</span><br><span class="line">    IMAGE_EXPORT_DIRECTORY *pIED = (IMAGE_EXPORT_DIRECTORY *)((DWORD)pFileBuf + RWAAddress);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"---------------------导出表头信息------------------\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Name:%s\n"</span>, (DWORD)pFileBuf + RVATORAWEx(pFileBuf, pIED-&gt;Name, <span class="literal">true</span>));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"NumberOfFunctions:0x%X\n"</span>, pIED-&gt;NumberOfFunctions);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"NumberOfNames:0x%X\n"</span>, pIED-&gt;NumberOfNames);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Base:%u\n"</span>, pIED-&gt;Base);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"AddressOfFunctions(RVA):0x%X(导出函数地址，数组)\n"</span>, pIED-&gt;AddressOfFunctions);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"AddressOfNames(RVA):0x%X(导出函数名，数组)\n"</span>, pIED-&gt;AddressOfNames);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"AddressOfNameOrdinals(RVA):0x%X(Ordinals地址，数组)\n"</span>, pIED-&gt;AddressOfNameOrdinals);</span><br><span class="line"></span><br><span class="line">    DWORD *pAddFunRAW = (DWORD *)((DWORD)pFileBuf + RVATORAWEx(pFileBuf, pIED-&gt;AddressOfFunctions, <span class="literal">true</span>));</span><br><span class="line">    DWORD *pAddNameRAW = (DWORD *)((DWORD)pFileBuf + RVATORAWEx(pFileBuf, pIED-&gt;AddressOfNames, <span class="literal">true</span>));</span><br><span class="line">    <span class="comment">// 注意这里是word</span></span><br><span class="line">    WORD *pAddNameOrdRAW = (WORD *)((DWORD)pFileBuf + RVATORAWEx(pFileBuf, pIED-&gt;AddressOfNameOrdinals, <span class="literal">true</span>));</span><br><span class="line">    BOOL bOrdNameFun = FALSE; <span class="comment">//用于判断是不是AddressOfFunctions表中的项在AddressOfNameOrdinals都有</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%X %X %X\n"</span>, *pAddFunRAW, *pAddNameOrdRAW, *pAddNameOrdRAW);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"FunAddress\t\tOrdinal\t\tName\n"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (DWORD i = <span class="number">0</span>; i &lt; pIED-&gt;NumberOfFunctions; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        DWORD j;</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; pIED-&gt;NumberOfNames; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (pAddNameOrdRAW[j] == i)</span><br><span class="line">            &#123;</span><br><span class="line">                bOrdNameFun = TRUE;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (bOrdNameFun)</span><br><span class="line">        &#123;</span><br><span class="line">            bOrdNameFun = <span class="literal">false</span>;</span><br><span class="line">            DWORD AddName = RVATORAWEx(pFileBuf, pAddNameRAW[j], TRUE);</span><br><span class="line"></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"%X\t\t%X\t\t%s\n"</span>, pAddFunRAW[i], pIED-&gt;Base + j, (DWORD)pFileBuf + AddName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"%X\t\t--\t\t--\n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    UnReadPEToMemory(pFileBuf);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">BOOL <span class="title">PrintImportTable</span><span class="params">(IN <span class="keyword">const</span> <span class="keyword">char</span> *pPEPath)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">void</span> *pFileBuf = ReadPEToMemory(pPEPath, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (!pFileBuf)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    IMAGE_DOS_HEADER *pIDH = (IMAGE_DOS_HEADER *)pFileBuf;</span><br><span class="line">    IMAGE_NT_HEADERS *pINH = (IMAGE_NT_HEADERS *)((DWORD)pIDH + pIDH-&gt;e_lfanew);</span><br><span class="line">    IMAGE_OPTIONAL_HEADER IOH = pINH-&gt;OptionalHeader;</span><br><span class="line">    <span class="comment">// 第二个是导入表</span></span><br><span class="line">    DWORD Size = IOH.DataDirectory[<span class="number">1</span>].Size;</span><br><span class="line">    DWORD RVAVirtualAddresss = IOH.DataDirectory[<span class="number">1</span>].VirtualAddress;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (Size == <span class="number">0</span> || RVAVirtualAddresss == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"没有导入表\n"</span>);</span><br><span class="line">        UnReadPEToMemory(pFileBuf);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    DWORD RWAAddress = RVATORAWEx(pFileBuf, RVAVirtualAddresss, <span class="literal">true</span>);</span><br><span class="line">    IMAGE_IMPORT_DESCRIPTOR *pIID = (IMAGE_IMPORT_DESCRIPTOR *)((DWORD)pFileBuf + RWAAddress);</span><br><span class="line">    DWORD NumOfImport = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (pIID-&gt;Name != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"---------------------导出表头信息:%d------------------\n"</span>, NumOfImport++);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"INT address(RVA):0x%X\n"</span>, pIID-&gt;OriginalFirstThunk);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Name:%s\n"</span>, (DWORD)pFileBuf + RVATORAWEx(pFileBuf, pIID-&gt;Name, <span class="literal">true</span>));</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"FirstThunk(RVA:0x%X)\n"</span>, pIID-&gt;FirstThunk);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"---------------------INT头信息------------------\n"</span>);</span><br><span class="line">        DWORD *INT = (DWORD *)((DWORD)pFileBuf + RVATORAWEx(pFileBuf, pIID-&gt;OriginalFirstThunk, <span class="literal">true</span>));</span><br><span class="line">        <span class="keyword">while</span> (*INT)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//判断最高位，如果是1，则是序号导入，否则是名字导入</span></span><br><span class="line">            <span class="comment">// IMAGE_THUNK_DATA32 是一个4字节数据</span></span><br><span class="line">            <span class="comment">// 如果最高位是1，那么除去最高位就是导出序号</span></span><br><span class="line">            <span class="comment">// 如果最高位是0，那么这个值是RVA 指向 IMAGE_IMPORT_BY_NAME</span></span><br><span class="line">            <span class="keyword">if</span> (((*INT) &amp; <span class="number">0x80000000</span>) == <span class="number">0x80000000</span>)</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"以序号导入:0x%X\n"</span>, (*INT) &amp; (<span class="number">0x7fffffff</span>));</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                IMAGE_IMPORT_BY_NAME *pIIBN = (IMAGE_IMPORT_BY_NAME *)((DWORD)pFileBuf + RVATORAWEx(pFileBuf, *INT, <span class="literal">true</span>));</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"Hint:%X  name:%s\n"</span>, pIIBN-&gt;Hint, pIIBN-&gt;Name);</span><br><span class="line">            &#125;</span><br><span class="line">            INT++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"---------------------IAT头信息------------------\n"</span>);</span><br><span class="line">        DWORD *IAT = (DWORD *)((DWORD)pFileBuf + RVATORAWEx(pFileBuf, pIID-&gt;FirstThunk, <span class="literal">true</span>));</span><br><span class="line">        <span class="keyword">while</span> (*IAT)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// IMAGE_THUNK_DATA32 是一个4字节数据</span></span><br><span class="line">            <span class="comment">// 如果最高位是1，那么除去最高位就是导出序号</span></span><br><span class="line">            <span class="comment">// 如果最高位是0，那么这个值是RVA 指向 IMAGE_IMPORT_BY_NAME</span></span><br><span class="line">            <span class="keyword">if</span> (((*INT) &amp; <span class="number">0x80000000</span>) == <span class="number">0x80000000</span>)</span><br><span class="line"></span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"以序号导入:0x%X\n"</span>, (*IAT) &amp; (<span class="number">0x7fffffff</span>));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                IMAGE_IMPORT_BY_NAME *pIIBN = (IMAGE_IMPORT_BY_NAME *)((DWORD)pFileBuf + RVATORAWEx(pFileBuf, *IAT, <span class="literal">true</span>));</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"Hint:%X  name:%s\n"</span>, pIIBN-&gt;Hint, pIIBN-&gt;Name);</span><br><span class="line">            &#125;</span><br><span class="line">            IAT++;</span><br><span class="line">        &#125;</span><br><span class="line">        pIID++;</span><br><span class="line">    &#125;</span><br><span class="line">    UnReadPEToMemory(pFileBuf);</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">BOOL <span class="title">PrintRelocateTable</span><span class="params">(IN <span class="keyword">const</span> <span class="keyword">char</span> *pPEPath)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">void</span> *pFileBuf = ReadPEToMemory(pPEPath, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (!pFileBuf)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    IMAGE_DOS_HEADER *pIDH = (IMAGE_DOS_HEADER *)pFileBuf;</span><br><span class="line">    IMAGE_NT_HEADERS *pINH = (IMAGE_NT_HEADERS *)((DWORD)pIDH + pIDH-&gt;e_lfanew);</span><br><span class="line">    IMAGE_OPTIONAL_HEADER IOH = pINH-&gt;OptionalHeader;</span><br><span class="line">    <span class="comment">// 第六个是重定位</span></span><br><span class="line">    DWORD Size = IOH.DataDirectory[<span class="number">5</span>].Size;</span><br><span class="line">    DWORD RVAVirtualAddresss = IOH.DataDirectory[<span class="number">5</span>].VirtualAddress;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (Size == <span class="number">0</span> || RVAVirtualAddresss == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"没有重定位\n"</span>);</span><br><span class="line">        UnReadPEToMemory(pFileBuf);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    DWORD RWAAddress = RVATORAWEx(pFileBuf, RVAVirtualAddresss, <span class="literal">true</span>);</span><br><span class="line">    IMAGE_BASE_RELOCATION *pIBR = (IMAGE_BASE_RELOCATION *)((DWORD)pFileBuf + RWAAddress);</span><br><span class="line">    DWORD RelocNum = <span class="number">1</span>;</span><br><span class="line">    WORD *pRelocItem = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">while</span> (pIBR-&gt;SizeOfBlock &amp;&amp; pIBR-&gt;VirtualAddress)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"\n------------第 %u 个重定位块-------------\n"</span>, RelocNum);</span><br><span class="line">        pRelocItem = (WORD *)((DWORD)pIBR + <span class="keyword">sizeof</span>(IMAGE_BASE_RELOCATION));</span><br><span class="line">        DWORD ItemNm = (pIBR-&gt;SizeOfBlock - <span class="keyword">sizeof</span>(IMAGE_BASE_RELOCATION)) / <span class="number">2</span>;</span><br><span class="line">        DWORD NewLine = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (DWORD i = <span class="number">0</span>; i &lt; ItemNm; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 最高4位为3的时候才重定位</span></span><br><span class="line">            <span class="keyword">if</span> ((*pRelocItem &amp; <span class="number">0x3000</span>) == <span class="number">0x3000</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (NewLine == <span class="number">10</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">"\n"</span>);</span><br><span class="line">                    NewLine = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%X "</span>, pIBR-&gt;VirtualAddress + (*pRelocItem &amp; <span class="number">0x0fff</span>));</span><br><span class="line">                NewLine++;</span><br><span class="line">            &#125;</span><br><span class="line">            pRelocItem++;</span><br><span class="line">        &#125;</span><br><span class="line">        RelocNum++;</span><br><span class="line">        pIBR = (IMAGE_BASE_RELOCATION *)((DWORD)pIBR + pIBR-&gt;SizeOfBlock);</span><br><span class="line">    &#125;</span><br><span class="line">    UnReadPEToMemory(pFileBuf);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
        
    </section>
</article>



<div class="comments">
    <div id="disqus_thread">
        <p class="comment-tips">国内查看评论需要代理~</p>
    </div>
    <script>
    window.disqus_config = function () {
        this.language = 'zh';
        this.page.url = 'http://www.coderss.cn/elf-pe/index.html';
        this.page.title = 'ELF_PE文件格式';
        this.page.identifier = 'elf-pe/index.html';
    };
    (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        s.src = 'https://name.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>

</div>
        <footer class="footer">
    Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, Theme by <a href="https://github.com/sanonz/hexo-theme-concise" target="_blank">Concise</a>
</footer>

<script type="text/javascript" src="//s13.cnzz.com/z_stat.php?id=1234567890&amp;web_id=1234567890"></script>


    </div>

    <script type="text/javascript" src="https://cdn.bootcss.com/jquery/1.9.0/jquery.min.js"></script>
    
    <script type="text/javascript">
        $(function() {
            var nodes = {
                nav: $('#nav'),
                aside: $('#aside'),
                navTags: $('#nav-tags')
            };

            $('#open-panel, #aside-mask').on('click', function() {
                nodes.aside.toggleClass('panel-show');
            });
            $('#nav-tag').on('click', function(event) {
                event.preventDefault();console.log(nodes.navTags.attr('class'))
                nodes.navTags.toggleClass('tag-show');console.log(nodes.navTags.attr('class'))
            })/*.hover(function() {
                nodes.navTags.addClass('tag-show');
            }, function() {
                nodes.navTags.removeClass('tag-show');
            });*/

            
        });
    </script>

</body>
</html>
